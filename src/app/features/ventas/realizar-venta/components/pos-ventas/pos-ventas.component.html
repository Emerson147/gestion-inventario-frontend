<!-- Contenido de POS -->
<div class="h-screen bg-gray-50 dark:bg-gray-900 flex flex-col transition-colors duration-300">
  <!-- Sistema de Notificaciones Toast Modernas -->
  <app-toast-notification 
    [toasts]="toastService.getCurrentToasts()"
    (toastDismissed)="onToastDismissed($event)"
  ></app-toast-notification>

  <!-- Header POS Moderno - Estilo Square/Stripe (Azul Premium) -->
  <header class="bg-gradient-to-r from-slate-900 via-blue-900 to-slate-900 dark:from-gray-900 dark:via-gray-800 dark:to-gray-900 text-white shadow-2xl border-b-2 border-blue-400/40 dark:border-gray-600/40 relative overflow-hidden transition-all duration-300">
    <!-- Efectos visuales premium inspirados en Square POS -->
    <div class="absolute inset-0 bg-gradient-to-r from-blue-600/10 via-cyan-500/8 to-blue-600/10"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_30%_40%,rgba(59,130,246,0.15),transparent_70%)]"></div>
    <div class="absolute inset-0 bg-[radial-gradient(circle_at_70%_60%,rgba(14,165,233,0.12),transparent_70%)]"></div>
    
    <!-- Contenido principal del header -->
    <div class="relative z-10 flex justify-between items-center p-6">
      <!-- ZONA IZQUIERDA: Branding y Estado del Sistema -->
      <div class="flex items-center gap-8">
        <!-- Branding Principal -->
        <div class="flex items-center gap-4">
          <div class="relative group">
            <!-- Logo principal con gradiente Square-style -->
            <div class="w-14 h-14 bg-gradient-to-br from-blue-500 to-blue-700 rounded-xl flex items-center justify-center shadow-lg transition-all duration-300 group-hover:scale-105 group-hover:shadow-xl group-hover:from-blue-400 group-hover:to-blue-600">
              <i class="pi pi-shop text-white text-2xl"></i>
            </div>
            <!-- Indicador de conexiÃ³n con color accent -->
            <div class="absolute -top-1 -right-1 w-4 h-4 bg-cyan-400 rounded-full border-2 border-white animate-pulse shadow-md"></div>
          </div>

          <!-- InformaciÃ³n empresarial -->
          <div class="space-y-1">
            <h1 class="text-xl font-bold text-white tracking-wide">SISTEMA POS EMPRESARIAL</h1>
            <div class="flex items-center gap-4 text-xs text-slate-300">
              <span class="flex items-center gap-1.5 bg-slate-800/60 px-2 py-1 rounded-md border border-blue-400/20">
                <i class="pi pi-building text-blue-400"></i>
                <span>RUC: 20123456789</span>
              </span>
              <span class="flex items-center gap-1.5 bg-slate-800/60 px-2 py-1 rounded-md border border-cyan-400/20">
                <i class="pi pi-desktop text-cyan-400"></i>
                <span>Terminal: POS-001</span>
              </span>
            </div>
          </div>
        </div>

        <!-- Estados del Sistema con colores Square -->
        <div class="flex items-center gap-3">
          <!-- Estado SUNAT -->
          <div class="flex items-center gap-2 bg-cyan-600/90 backdrop-blur px-3 py-2 rounded-lg shadow-md border border-cyan-400/30">
            <div class="w-2 h-2 bg-cyan-300 rounded-full animate-pulse"></div>
            <span class="text-xs font-medium text-white">SUNAT</span>
          </div>
          
          <!-- Usuario activo -->
          <div class="flex items-center gap-2 bg-blue-600/90 backdrop-blur px-3 py-2 rounded-lg shadow-md border border-blue-400/30">
            <i class="pi pi-user text-xs text-white"></i>
            <span class="text-xs font-medium text-white">Emerson147</span>
          </div>
        </div>
      </div>

      <!-- ZONA CENTRAL: Panel de Venta Activa -->
      <div class="flex-1 max-w-md mx-8">
        <div class="bg-slate-800/80 backdrop-blur rounded-2xl p-6 border border-blue-400/20 shadow-xl">
          <!-- Header del panel de venta -->
          <div class="flex justify-between items-center mb-3">
            <div class="flex items-center gap-2 text-sm text-slate-300">
              <i class="pi pi-user-plus text-cyan-400"></i>
              <span>{{ clienteSeleccionado?.nombres || "Cliente General" }}</span>
            </div>
            <button
              *ngIf="!clienteSeleccionado"
              class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 shadow-md border border-blue-400/30"
              (click)="openClientModal()"
            >
              <i class="pi pi-plus mr-1"></i>Asignar
            </button>
          </div>

          <!-- Total de venta destacado con color Square -->
          <div class="text-center space-y-2">
            <div class="text-3xl font-mono font-bold text-cyan-400 tracking-wider">
              {{ formatearMoneda(totalVenta) }}
            </div>
            <div class="flex justify-center items-center gap-4 text-xs text-slate-400">
              <span class="flex items-center gap-1">
                <i class="pi pi-hashtag"></i>
                {{ getNumeroVenta() }}
              </span>
              <span>â€¢</span>
              <span class="flex items-center gap-1">
                <i class="pi pi-shopping-cart"></i>
                {{ carrito.length }} items
              </span>
              <span>â€¢</span>
              <span>{{ getCurrentDateTime() }}</span>
            </div>
          </div>
        </div>
      </div> 
    </div>

    <!-- Barra de Estado Inteligente -->
    <div class="relative z-10 bg-slate-950/80 backdrop-blur px-6 py-2 border-t border-slate-700/50">
      <div class="flex justify-between items-center text-xs">
        <!-- InformaciÃ³n temporal con iconos temÃ¡ticos -->
        <div class="flex items-center gap-6">
          <span class="flex items-center gap-2 text-slate-300">
            <i class="pi pi-calendar text-cyan-400"></i>
            <span class="font-medium">{{ getCurrentTime() }}</span>
          </span>
          <span class="flex items-center gap-2 text-slate-300">
            <i class="pi pi-clock text-blue-400"></i>
            <span>Turno: {{ horaInicioTurno }}</span>
          </span>
        </div>

        <!-- Estado del sistema con colores Square -->
        <div class="flex items-center gap-4">
          <div class="flex items-center gap-2 bg-cyan-600/20 text-cyan-300 px-3 py-1 rounded-full border border-cyan-400/30">
            <i class="pi pi-check-circle text-xs"></i>
            <span class="font-medium">Sistema Operativo</span>
          </div>
          <span class="text-slate-500 font-mono">v2.1.0 â€¢ Build 2025-09-15</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Contenido Principal Moderno - Layout con scroll vertical -->
  <main class="flex-1 flex min-h-0">
    <!-- Panel Izquierdo: Productos (65%) -->
    <section class="w-[65%] flex flex-col p-4 space-y-4">
      <!-- BÃºsqueda Principal Optimizada -->
      <div class="bg-white rounded-xl p-6 shadow-lg border border-gray-200">
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
          <!-- BÃºsqueda por cÃ³digo -->
          <div class="lg:col-span-2">
            <label
              for="codigoInput"
              class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <i class="pi pi-qrcode text-blue-600"></i>
              CÃ³digo de Producto
            </label>
            <div class="flex gap-2">
              <input
                #codigoInput
                pInputText
                [(ngModel)]="codigoBusqueda"
                placeholder="Escanear o escribir cÃ³digo..."
                (keyup.enter)="buscarProductoPorCodigo()"
                class="flex-1 text-lg font-mono p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200 transition-all"
              />
              <p-button
                icon="pi pi-search"
                severity="info"
                styleClass="px-4 py-3"
                (click)="buscarProductoPorCodigo()"
              ></p-button>
            </div>
          </div>

          <!-- Cantidad -->
          <div>
            <label
              for="cantidadInput"
              class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <i class="pi pi-hashtag text-green-600"></i>
              Cantidad
            </label>
            <p-inputNumber
              [(ngModel)]="cantidadInput"
              [min]="1"
              [max]="999"
              [showButtons]="true"
              inputStyleClass="p-3"
              styleClass="w-full"
            ></p-inputNumber>
          </div>

          <!-- Scanner -->
          <div>
            <label
              for="scannerButton"
              class="text-sm font-semibold text-gray-700 mb-3 flex items-center gap-2"
            >
              <i class="pi pi-camera text-purple-600"></i>
              EscÃ¡ner
            </label>
            <p-button
              icon="pi pi-camera"
              label="F8"
              [outlined]="true"
              severity="secondary"
              styleClass="w-full h-12"
              (click)="activarScanner()"
            ></p-button>
          </div>
        </div>

        <!-- BÃºsqueda avanzada optimizada -->
        <div class="mt-6">
          <div class="flex items-center justify-between mb-3">
            <label
              for="autoComplete"
              class="text-sm font-semibold text-gray-700 flex items-center gap-2"
            >
              <i class="pi pi-search text-indigo-600"></i>
              BÃºsqueda Avanzada
            </label>
            
            <!-- BotÃ³n de refrescar inventarios -->
            <button
              type="button"
              class="flex items-center gap-2 px-3 py-1.5 bg-blue-500 hover:bg-blue-600 text-white rounded-lg text-xs font-medium transition-all duration-200 hover:scale-105 shadow-md"
              (click)="refrescarDatos()"
              title="Refrescar inventarios disponibles"
            >
              <i class="pi pi-refresh text-xs"></i>
              <span>Actualizar</span>
            </button>
          </div>
          <p-autoComplete
            [(ngModel)]="productoBusqueda"
            [suggestions]="productosAutoComplete"
            (completeMethod)="buscarProductosAutoComplete($event)"
            (onSelect)="seleccionarProductoAutoComplete($event)"
            field="displayLabel"
            placeholder="Buscar por nombre, cÃ³digo o descripciÃ³n..."
            styleClass="w-full"
            [dropdown]="true"
            scrollHeight="300px"
            [showClear]="true"
            [minLength]="1"
            [delay]="300"
            [forceSelection]="false"
          >
            <ng-template let-producto pTemplate="item">
              <div class="flex items-center gap-3 p-2">
                <div class="flex-1">
                  <div class="font-medium text-gray-900">
                    {{ producto.producto?.codigo }} - {{ producto.producto?.nombre }}
                  </div>
                  <div class="text-sm text-gray-600">
                    {{ producto.color?.nombre }} â€¢ {{ producto.talla?.numero }} â€¢ Stock: {{ producto.cantidad }}
                  </div>
                </div>
              </div>
            </ng-template>
          </p-autoComplete>
        </div>
      </div>

      <!-- Scanner Optimizado -->
      <div *ngIf="scannerActive" class="bg-gray-900 rounded-xl p-4 shadow-lg">
        <div class="relative h-64 rounded-lg overflow-hidden bg-black">
          <video #videoElement class="w-full h-full object-cover"></video>
          <div
            class="absolute inset-0 flex items-center justify-center pointer-events-none"
          >
            <div class="scanner-overlay">
              <div class="w-48 h-48 border-4 border-red-500 relative">
                <div
                  class="absolute top-0 left-0 w-8 h-8 border-t-4 border-l-4 border-red-400"
                ></div>
                <div
                  class="absolute top-0 right-0 w-8 h-8 border-t-4 border-r-4 border-red-400"
                ></div>
                <div
                  class="absolute bottom-0 left-0 w-8 h-8 border-b-4 border-l-4 border-red-400"
                ></div>
                <div
                  class="absolute bottom-0 right-0 w-8 h-8 border-b-4 border-r-4 border-red-400"
                ></div>
                <div
                  class="absolute top-1/2 left-0 right-0 h-0.5 bg-red-500 animate-pulse"
                ></div>
              </div>
            </div>
          </div>
          <button
            class="absolute top-4 right-4 bg-red-500 hover:bg-red-600 text-white p-2 rounded-full transition-colors"
            (click)="cerrarScanner()"
          >
            <i class="pi pi-times"></i>
          </button>
        </div>
      </div>

      <!-- Productos Populares Optimizado -->
      <!-- <div
        *ngIf="productosPopulares.length > 0 && !scannerActive"
        class="flex-1"
      >
        <div
          class="bg-white rounded-xl p-6 shadow-lg h-full flex flex-col border border-gray-200"
        >
          <div class="flex items-center gap-3 mb-6">
            <div
              class="w-8 h-8 bg-yellow-500 rounded-lg flex items-center justify-center"
            >
              <i class="pi pi-star-fill text-white"></i>
            </div>
            <h3 class="text-lg font-bold text-gray-800">Productos Populares</h3>
            <span
              class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded-full text-xs font-medium"
            >
              {{ productosPopulares.length }} productos
            </span>
          </div>

          <div
            class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 flex-1"
          >
            <div
              *ngFor="
                let producto of productosPopulares;
                trackBy: trackByProductoPopularId
              "
              class="bg-gray-50 hover:bg-blue-50 border-2 border-gray-200 hover:border-blue-400 rounded-xl p-4 cursor-pointer transition-all duration-200 hover:shadow-lg hover:-translate-y-1"
              (click)="seleccionarProductoPopular(producto)"
              (keydown.enter)="seleccionarProductoPopular(producto)"
              (keydown.space)="seleccionarProductoPopular(producto)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Seleccionar ' + producto.producto.nombre"
            >
              <div class="text-center">
                <div class="relative mb-3">
                  <img
                    [src]="
                      producto.producto.imagen ||
                      '/assets/images/product-placeholder.svg'
                    "
                    [alt]="producto.producto.nombre"
                    class="w-full h-20 object-cover rounded-lg border border-gray-200"
                    onerror="this.src='/assets/images/product-placeholder.svg'"
                  />
                  <span
                    class="absolute -top-2 -right-2 bg-blue-600 text-white text-xs px-2 py-1 rounded-full font-bold shadow-md"
                  >
                    {{ producto.cantidad }}
                  </span>
                </div>
                <div
                  class="text-sm font-semibold text-gray-700 truncate mb-2"
                  [title]="producto.producto.nombre"
                >
                  {{ producto.producto.nombre }}
                </div>
                <div class="text-lg font-bold text-blue-600">
                  {{
                    formatearMoneda(
                      obtenerPrecioProducto(producto.producto.id || 0)
                    )
                  }}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div> -->

    </section>

    <!-- Panel Derecho: Carrito y Pago - CON SCROLL PROPIO -->
    <aside
      class="min-w-[400px] w-[35%] max-w-[500px] bg-white border-l border-gray-200 flex flex-col shadow-lg resize-x overflow-y-auto"
      style="resize: horizontal; height: calc(100vh - 200px);"
    >
      <!-- Cliente Actual Optimizado - FIJO -->
      <div class="p-6 border-b border-gray-200 bg-blue-50 flex-shrink-0">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <div
              class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center shadow-md"
            >
              <i class="pi pi-user text-white text-lg"></i>
            </div>
            <div>
              <div class="font-bold text-gray-900">
                {{
                  clienteSeleccionado
                    ? clienteSeleccionado.nombres +
                      " " +
                      clienteSeleccionado.apellidos
                    : "Cliente General"
                }}
              </div>
              <div class="text-sm text-gray-600" *ngIf="clienteSeleccionado">
                {{ clienteSeleccionado.dni || clienteSeleccionado.ruc }}
              </div>
            </div>
          </div>
          <p-button
            icon="pi pi-user-edit"
            severity="info"
            [outlined]="true"
            size="small"
            styleClass="hover:scale-105 transition-transform"
            (click)="openClientModal()"
          ></p-button>
        </div>
      </div>

      <!-- Header del Carrito - FIJO -->
      <div class="p-6 border-b border-gray-200 bg-gray-50 flex-shrink-0">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-gray-800 flex items-center gap-2">
            <div
              class="w-8 h-8 bg-green-600 rounded-lg flex items-center justify-center"
            >
              <i class="pi pi-shopping-cart text-white"></i>
            </div>
            Carrito
            <span
              class="bg-green-100 text-green-800 px-2 py-1 rounded-full text-sm font-bold"
            >
              {{ carrito.length }}
            </span>
          </h3>
          
          <!-- BotÃ³n para vista expandida -->
          <div class="flex items-center gap-2">
            <button
              *ngIf="carrito.length > 3"
              class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded-lg text-xs font-medium transition-colors"
              (click)="mostrarCarritoExpandido = true"
              title="Ver carrito completo"
            >
              <i class="pi pi-external-link mr-1"></i>
              Expandir
            </button>
            <p-button
              *ngIf="carrito.length > 0"
              icon="pi pi-trash"
              severity="danger"
              [outlined]="true"
            size="small"
            styleClass="hover:scale-105 transition-transform"
            (click)="limpiarCarrito()"
          ></p-button>
          </div>
        </div>
      </div>

      <!-- Items del carrito - EXPANSIÃ“N NATURAL -->
      <div class="flex-grow">
          <!-- Carrito vacÃ­o -->
          <div
            *ngIf="carrito.length === 0"
            class="p-8 text-center text-gray-500"
          >
            <div
              class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4"
            >
              <i class="pi pi-shopping-cart text-4xl text-gray-400"></i>
            </div>
            <p class="font-semibold text-lg mb-2">Carrito VacÃ­o</p>
            <p class="text-sm">Agregue productos para comenzar</p>
          </div>

          <!-- Lista de productos -->
          <div *ngIf="carrito.length > 0" class="p-3 space-y-3">
            <div
              *ngFor="
                let item of carrito;
                trackBy: trackByItemCarritoId;
                let i = index
              "
              class="bg-gray-50 rounded-lg p-3 border border-gray-200 hover:shadow-sm transition-shadow"
            >
              <div class="flex items-start gap-3">
                <!-- Imagen -->
                <div class="relative flex-shrink-0">
                  <img
                    *ngIf="item.producto?.imagen"
                    [src]="item.producto.imagen"
                    [alt]="item.producto.nombre"
                    class="w-12 h-12 object-cover rounded-lg border border-gray-200"
                    onerror="this.src='/assets/images/product-placeholder.jpg'"
                  />
                  <div
                    *ngIf="!item.producto?.imagen"
                    class="w-12 h-12 bg-gray-200 flex items-center justify-center rounded-lg"
                  >
                    <i class="pi pi-image text-gray-400 text-xs"></i>
                  </div>
                  <span
                    class="absolute -top-1 -left-1 bg-blue-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold"
                  >
                    {{ i + 1 }}
                  </span>
                </div>

                <!-- Info del producto -->
                <div class="flex-1 min-w-0">
                  <div class="font-semibold text-gray-900 truncate mb-2 text-base">
                    {{ item.producto.nombre }}
                  </div>
                  <div class="flex gap-1 flex-wrap mb-2">
                    <span
                      class="text-sm bg-blue-100 text-blue-700 px-2 py-1 rounded-full font-medium"
                      >{{ item.color.nombre }}</span
                    >
                    <span
                      class="text-sm bg-green-100 text-green-700 px-2 py-1 rounded-full font-medium"
                      >{{ item.talla.numero }}</span
                    >
                  </div>
                  <div class="text-sm text-gray-500 mb-3">
                    {{ item.codigoCompleto }}
                  </div>

                  <!-- Controles de cantidad -->
                  <div class="flex items-center gap-1">
                    <button
                      class="w-6 h-6 bg-gray-300 hover:bg-gray-400 rounded text-xs flex items-center justify-center transition-colors"
                      [disabled]="item.cantidad <= 1"
                      (click)="actualizarCantidadItem(item, item.cantidad - 1)"
                    >
                      <i class="pi pi-minus" style="font-size: 8px;"></i>
                    </button>

                    <input
                      type="number"
                      [(ngModel)]="item.cantidad"
                      (blur)="actualizarCantidadItem(item, item.cantidad)"
                      min="1"
                      [max]="item.stock"
                      class="w-10 text-center text-xs border border-gray-300 rounded px-1 py-1 font-mono"
                    />

                    <button
                      class="w-6 h-6 bg-gray-300 hover:bg-gray-400 rounded text-xs flex items-center justify-center transition-colors"
                      [disabled]="item.cantidad >= item.stock"
                      (click)="actualizarCantidadItem(item, item.cantidad + 1)"
                    >
                      <i class="pi pi-plus" style="font-size: 8px;"></i>
                    </button>

                    <div
                      class="text-xs text-gray-500 ml-1 bg-gray-200 px-1 py-1 rounded"
                    >
                      {{ item.stock }}
                    </div>
                  </div>
                </div>

                <!-- Precio y eliminar -->
                <div class="text-right flex-shrink-0">
                  <div class="font-bold text-green-600 text-xl mb-1">
                    {{ formatearMoneda(item.subtotal) }}
                  </div>
                  <div class="text-sm text-gray-500 mb-2">
                    {{ formatearMoneda(item.precioUnitario) }} c/u
                  </div>
                  <button
                    class="text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-colors"
                    (click)="eliminarItemCarrito(item)"
                  >
                    <i class="pi pi-trash"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

      <!-- Resumen y Pago Optimizado - AL FINAL -->
      <div class="border-t border-gray-200 p-6 space-y-4 bg-gray-50 flex-shrink-0 mt-auto">
        <!-- Totales con IGV desglosado -->
        <div
          class="space-y-3 text-sm bg-white rounded-lg p-4 border border-gray-200"
        >
          <div class="flex justify-between text-gray-600">
            <span>Op. Gravada:</span>
            <span class="font-semibold">{{
              formatearMoneda(operacionGravada)
            }}</span>
          </div>
          <div class="flex justify-between text-blue-600">
            <span>IGV (18%):</span>
            <span class="font-semibold">{{
              formatearMoneda(igvVenta)
            }}</span>
          </div>
          <div
            *ngIf="descuentoVenta > 0"
            class="flex justify-between text-orange-600"
          >
            <span>Descuento:</span>
            <span class="font-semibold"
              >-{{ formatearMoneda(descuentoVenta) }}</span
            >
          </div>
          <div class="border-t pt-3 flex justify-between text-xl font-bold">
            <span>TOTAL:</span>
            <span class="text-green-600">{{
              formatearMoneda(totalVenta)
            }}</span>
          </div>
        </div>

        <!-- Descuento rÃ¡pido -->
        <div
          class="flex items-center gap-3 bg-white rounded-lg p-3 border border-gray-200"
        >
          <input
            type="checkbox"
            [(ngModel)]="aplicarDescuento"
            (change)="toggleDescuento()"
            class="rounded"
          />
          <label for="descuentoCheckbox" class="text-sm font-semibold"
            >Descuento</label
          >
          <input
            *ngIf="aplicarDescuento"
            type="number"
            [(ngModel)]="porcentajeDescuento"
            (input)="calcularDescuento()"
            min="0"
            max="100"
            step="0.1"
            placeholder="%"
            class="w-20 px-2 py-1 text-sm border rounded ml-auto"
          />
        </div>

        <!-- Comprobante -->
        <div class="grid grid-cols-2 gap-3">
          <select
            [(ngModel)]="nuevaVenta.tipoComprobante"
            (change)="onComprobanteChange()"
            class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
          >
            <option value="">Tipo</option>
            <option *ngFor="let tipo of tiposComprobante" [value]="tipo.value">
              {{ tipo.label }}
            </option>
          </select>

          <select
            [(ngModel)]="nuevaVenta.serieComprobante"
            [disabled]="!nuevaVenta.tipoComprobante"
            class="px-3 py-2 text-sm border border-gray-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
          >
            <option value="">Serie</option>
            <option
              *ngFor="let serie of seriesComprobante"
              [value]="serie.value"
            >
              {{ serie.label }}
            </option>
          </select>
        </div>

        <!-- Observaciones -->
        <textarea
          [(ngModel)]="nuevaVenta.observaciones"
          placeholder="Observaciones..."
          rows="2"
          class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg resize-none focus:border-blue-500 focus:ring-2 focus:ring-blue-200"
        ></textarea>

        <!-- Botones de Pago -->
        <div class="space-y-3">
          <!-- BotÃ³n principal -->
          <button
            class="w-full bg-green-600 hover:bg-green-700 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all duration-200 hover:shadow-lg disabled:bg-gray-400 disabled:cursor-not-allowed"
            [disabled]="!canProcessPayment()"
            (click)="iniciarPago()"
          >
            ðŸ’³ PROCESAR PAGO - {{ formatearMoneda(totalVenta) }}
          </button>

          <!-- MÃ©todos rÃ¡pidos -->
          <div class="grid grid-cols-3 gap-2">
            <button
              class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-3 rounded-lg text-sm font-semibold transition-colors hover:shadow-md"
              [disabled]="!canProcessPayment()"
              (click)="pagoRapido('EFECTIVO')"
            >
              ðŸ’µ Efectivo
            </button>
            <button
              class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-3 rounded-lg text-sm font-semibold transition-colors hover:shadow-md"
              [disabled]="!canProcessPayment()"
              (click)="pagoRapido('TARJETA_DEBITO')"
            >
              ðŸ’³ Tarjeta
            </button>
            <button
              class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-3 rounded-lg text-sm font-semibold transition-colors hover:shadow-md"
              [disabled]="!canProcessPayment()"
              (click)="pagoRapido('YAPE')"
            >
              ðŸ“± Digital
            </button>
          </div>
        </div>

        <!-- Venta a crÃ©dito -->
        <div class="flex items-center gap-3 text-sm bg-white rounded-lg p-3 border border-gray-200">
          <input type="checkbox" [(ngModel)]="esVentaCredito" class="rounded" />
          <label for="esVentaCredito" class="font-medium">Venta a crÃ©dito</label>
          <select
            *ngIf="esVentaCredito"
            [(ngModel)]="cuotasCredito"
            class="ml-auto px-2 py-1 text-xs border rounded"
          >
            <option *ngFor="let cuota of opcionesCuotas" [value]="cuota.value">
              {{ cuota.label }}
            </option>
          </select>
        </div>
      </div>
    </aside>
  </main>


  <!-- ðŸ’³ Loading de Procesamiento de Pago -->
  <div
    *ngIf="procesandoPago"
    class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-2xl p-8 text-center max-w-md mx-4 shadow-2xl">
      <!-- Icono animado -->
      <div
        class="w-20 h-20 mx-auto mb-6 bg-green-100 rounded-full flex items-center justify-center relative"
      >
        <i class="pi pi-credit-card text-3xl text-green-600"></i>

        <!-- Anillo de progreso optimizado -->
        <svg
          class="absolute inset-0 w-20 h-20 transform -rotate-90"
          viewBox="0 0 80 80"
        >
          <circle
            cx="40"
            cy="40"
            r="35"
            stroke="#e5e7eb"
            stroke-width="6"
            fill="none"
          ></circle>
          <circle
            cx="40"
            cy="40"
            r="35"
            stroke="#10b981"
            stroke-width="6"
            fill="none"
            stroke-linecap="round"
            [style.stroke-dasharray]="220"
            [style.stroke-dashoffset]="220 - (220 * progressPercentage) / 100"
            class="transition-all duration-500 ease-out"
          ></circle>
        </svg>

        <!-- Porcentaje -->
        <span class="absolute text-xs font-bold text-green-600"
          >{{ progressPercentage }}%</span
        >
      </div>

      <!-- Mensaje principal -->
      <h3 class="text-xl font-bold text-gray-800 mb-2">Procesando Pago</h3>
      <div class="text-2xl font-mono font-bold text-green-600 mb-4">
        {{ formatearMoneda(totalVenta) }}
      </div>

      <!-- Mensaje de progreso -->
      <p class="text-gray-600 mb-4">{{ loadingMessage }}</p>

      <!-- Advertencia -->
      <div
        class="text-sm text-orange-600 bg-orange-50 p-3 rounded-lg border border-orange-200"
      >
        <i class="pi pi-exclamation-triangle mr-2"></i>
        No interrumpa este proceso
      </div>
    </div>
  </div>

<!-- Modal de Cliente - Estilo Empresarial Optimizado -->
<p-dialog
  [(visible)]="showClientModal"
  [modal]="true"
  [closable]="true"
  [style]="{ width: '850px', height: 'auto' }"
  styleClass="cliente-dialog-optimizado"
  [blockScroll]="true"
>
  <!-- HEADER OPTIMIZADO -->
  <ng-template pTemplate="header">
    <div
      class="flex items-center justify-between w-full bg-indigo-600 text-white p-6 -mx-6 -mt-6 mb-6"
    >
      <div class="flex items-center gap-4">
        <div
          class="w-14 h-14 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center shadow-lg"
        >
          <i class="pi pi-users text-white text-2xl"></i>
        </div>
        <div>
          <div class="text-sm text-indigo-100 font-medium">
            ðŸ‘¥ GestiÃ³n de Cliente
          </div>
          <div class="text-2xl font-bold">
            {{
              clienteSeleccionado
                ? "Cliente Seleccionado"
                : "Buscar o Crear Cliente"
            }}
          </div>
        </div>
      </div>

      <!-- CONTADOR DE CLIENTES -->
      <div
        class="flex items-center gap-2 bg-white bg-opacity-10 rounded-full px-4 py-2"
      >
        <i class="pi pi-database text-white"></i>
        <span class="text-sm font-medium"
          >{{ clientesFiltrados.length || 0 }} clientes</span
        >
      </div>
    </div>
  </ng-template>

  <div class="p-6 space-y-6 max-h-96 overflow-y-auto">
    <!-- CONTENIDO DINÃMICO BASADO EN ESTADO -->
    <div *ngIf="!clienteSeleccionado">
      <!-- SECCIÃ“N DE BÃšSQUEDA -->
      <div class="space-y-4">
        <div class="flex items-center gap-3 mb-4">
          <div
            class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center"
          >
            <i class="pi pi-search text-white text-sm"></i>
          </div>
          <h4 class="text-lg font-bold text-gray-900">Buscar Cliente</h4>
        </div>

        <!-- BUSCADOR AVANZADO -->
        <div class="relative">
          <p-autoComplete
            [(ngModel)]="clienteBusqueda"
            [suggestions]="clientesFiltrados"
            (completeMethod)="buscarClientes($event)"
            (onSelect)="onClienteSelect($event)"
            field="nombres"
            placeholder="ðŸ” Buscar por nombre, DNI, RUC o email..."
            styleClass="w-full"
            [dropdown]="true"
            [showClear]="true"
            scrollHeight="250px"
            [minLength]="0"
            [completeOnFocus]="true"
          >
            <ng-template let-cliente pTemplate="item">
              <div
                class="flex items-center gap-4 p-3 hover:bg-blue-50 rounded-lg transition-colors cursor-pointer"
              >
                <div class="flex-shrink-0">
                  <div
                    class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-white font-bold shadow-md"
                  >
                    {{ cliente.nombres?.charAt(0) || "C"
                    }}{{ cliente.apellidos?.charAt(0) || "L" }}
                  </div>
                </div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">
                    {{ cliente.nombres }} {{ cliente.apellidos }}
                  </div>
                  <div class="text-sm text-gray-500 flex items-center gap-2">
                    <i class="pi pi-id-card text-xs"></i>
                    {{ cliente.dni || cliente.ruc }}
                    <span *ngIf="cliente.email" class="flex items-center gap-1">
                      <i class="pi pi-envelope text-xs"></i>
                      {{ cliente.email }}
                    </span>
                  </div>
                  <div
                    *ngIf="cliente.telefono"
                    class="text-xs text-gray-400 flex items-center gap-1"
                  >
                    <i class="pi pi-phone"></i>
                    {{ cliente.telefono }}
                  </div>
                </div>
                <div class="text-right">
                  <div class="text-sm font-semibold text-green-600">
                    {{ cliente.compras || 0 }} compras
                  </div>
                  <div class="text-xs text-gray-500">
                    {{ formatearMoneda(cliente.totalCompras || 0) }}
                  </div>
                </div>
              </div>
            </ng-template>
          </p-autoComplete>
        </div>

        <!-- FILTROS RÃPIDOS -->
        <div class="flex gap-2 flex-wrap">
          <button
            class="px-3 py-1 text-xs bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200 transition-colors"
            (click)="filtrarClientesPorTipo('frecuentes')"
          >
            ðŸŒŸ Frecuentes
          </button>
          <button
            class="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors"
            (click)="filtrarClientesPorTipo('nuevos')"
          >
            ðŸ†• Nuevos
          </button>
          <button
            class="px-3 py-1 text-xs bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200 transition-colors"
            (click)="filtrarClientesPorTipo('vip')"
          >
            ðŸ’Ž VIP
          </button>
        </div>
      </div>

      <!-- CLIENTES RECIENTES -->
      <div *ngIf="clientesRecientes.length > 0">
        <div class="flex items-center gap-3 mb-4">
          <div
            class="w-8 h-8 bg-orange-500 rounded-lg flex items-center justify-center"
          >
            <i class="pi pi-clock text-white text-sm"></i>
          </div>
          <h4 class="text-lg font-bold text-gray-900">Clientes Recientes</h4>
          <span
            class="text-xs bg-orange-100 text-orange-700 px-2 py-1 rounded-full font-medium"
            >{{ clientesRecientes.length }}</span
          >
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <button
            *ngFor="let cliente of clientesRecientes.slice(0, 6)"
            class="text-left p-4 border-2 border-gray-200 rounded-xl hover:border-blue-400 hover:bg-blue-50 transition-all duration-200 hover:shadow-md"
            (click)="seleccionarCliente(cliente)"
          >
            <div class="flex items-center gap-3">
              <div
                class="w-10 h-10 bg-orange-500 rounded-xl flex items-center justify-center text-white font-bold text-sm"
              >
                {{ cliente.nombres.charAt(0) || "C"
                }}{{ cliente.apellidos.charAt(0) || "L" }}
              </div>
              <div class="flex-1">
                <div class="font-semibold text-gray-900">
                  {{ cliente.nombres }} {{ cliente.apellidos }}
                </div>
                <div class="text-xs text-gray-500 flex items-center gap-2">
                  <span>{{ cliente.dni || cliente.ruc }}</span>
                  <span
                    *ngIf="cliente.compras"
                    class="bg-gray-100 px-2 py-0.5 rounded-full"
                  >
                    {{ cliente.compras }} compras
                  </span>
                </div>
              </div>
              <i class="pi pi-arrow-right text-gray-400"></i>
            </div>
          </button>
        </div>
      </div>

      <!-- CREAR NUEVO CLIENTE -->
      <div
        class="text-center py-8 bg-green-50 rounded-2xl border-2 border-dashed border-green-300"
      >
        <div
          class="w-16 h-16 bg-green-500 rounded-2xl flex items-center justify-center mx-auto mb-4"
        >
          <i class="pi pi-user-plus text-white text-2xl"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Â¿Cliente Nuevo?</h3>
        <p class="text-gray-600 mb-4 text-sm">
          Crea un nuevo perfil en segundos
        </p>
        <button
          class="bg-green-500 hover:bg-green-600 text-white py-3 px-8 rounded-xl font-semibold transition-colors shadow-lg"
          (click)="nuevoCliente()"
        >
          <i class="pi pi-plus mr-2"></i>
          Crear Nuevo Cliente
        </button>
      </div>
    </div>

    <!-- CLIENTE SELECCIONADO -->
    <div *ngIf="clienteSeleccionado">
      <!-- HEADER DEL CLIENTE -->
      <div class="bg-green-500 rounded-2xl p-6 text-white shadow-lg">
        <div class="flex items-center gap-4 mb-4">
          <div
            class="w-16 h-16 bg-white bg-opacity-20 rounded-2xl flex items-center justify-center text-2xl font-bold shadow-md"
          >
            {{ clienteSeleccionado.nombres.charAt(0) || "C"
            }}{{ clienteSeleccionado.apellidos.charAt(0) || "L" }}
          </div>
          <div class="flex-1">
            <div class="text-2xl font-bold mb-1">
              {{ clienteSeleccionado.nombres }}
              {{ clienteSeleccionado.apellidos }}
            </div>
            <div class="text-green-100 flex items-center gap-2">
              <i class="pi pi-id-card"></i>
              {{ clienteSeleccionado.dni ? "DNI" : "RUC" }}:
              {{ clienteSeleccionado.dni || clienteSeleccionado.ruc }}
            </div>
          </div>
          <div class="text-right">
            <div class="text-3xl font-bold">
              {{ clienteSeleccionado.compras || 0 }}
            </div>
            <div class="text-sm text-green-100">compras realizadas</div>
          </div>
        </div>

        <!-- INDICADORES DE ESTADO -->
        <div class="flex gap-2">
          <span
            class="bg-white bg-opacity-20 px-3 py-1 rounded-full text-sm font-medium"
          >
            âœ… Cliente Activo
          </span>
          <span
            *ngIf="(clienteSeleccionado.compras || 0) > 5"
            class="bg-yellow-400 text-yellow-900 px-3 py-1 rounded-full text-sm font-medium"
          >
            ðŸŒŸ Cliente Frecuente
          </span>
          <span
            *ngIf="(clienteSeleccionado.totalCompras || 0) > 1000"
            class="bg-purple-500 text-white px-3 py-1 rounded-full text-sm font-medium"
          >
            ðŸ’Ž Cliente VIP
          </span>
        </div>
      </div>

      <!-- INFORMACIÃ“N DETALLADA -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- DATOS DE CONTACTO -->
        <div class="bg-blue-50 rounded-xl p-5 border border-blue-200">
          <div class="flex items-center gap-2 mb-4">
            <div
              class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center"
            >
              <i class="pi pi-address-book text-white text-sm"></i>
            </div>
            <h5 class="font-bold text-gray-900">InformaciÃ³n de Contacto</h5>
          </div>

          <div class="space-y-3">
            <div
              *ngIf="clienteSeleccionado.email"
              class="flex items-center gap-3"
            >
              <i class="pi pi-envelope text-blue-500"></i>
              <div>
                <div class="text-xs text-gray-500">Email</div>
                <div class="font-medium text-gray-900">
                  {{ clienteSeleccionado.email }}
                </div>
              </div>
            </div>

            <div
              *ngIf="clienteSeleccionado.telefono"
              class="flex items-center gap-3"
            >
              <i class="pi pi-phone text-blue-500"></i>
              <div>
                <div class="text-xs text-gray-500">TelÃ©fono</div>
                <div class="font-medium text-gray-900">
                  {{ clienteSeleccionado.telefono }}
                </div>
              </div>
            </div>

            <div
              *ngIf="clienteSeleccionado.direccion"
              class="flex items-center gap-3"
            >
              <i class="pi pi-map-marker text-blue-500"></i>
              <div>
                <div class="text-xs text-gray-500">DirecciÃ³n</div>
                <div class="font-medium text-gray-900">
                  {{ clienteSeleccionado.direccion }}
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ESTADÃSTICAS DE COMPRAS -->
        <div class="bg-purple-50 rounded-xl p-5 border border-purple-200">
          <div class="flex items-center gap-2 mb-4">
            <div
              class="w-8 h-8 bg-purple-500 rounded-lg flex items-center justify-center"
            >
              <i class="pi pi-chart-bar text-white text-sm"></i>
            </div>
            <h5 class="font-bold text-gray-900">Historial de Compras</h5>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div class="text-center p-3 bg-white rounded-lg">
              <div class="text-2xl font-bold text-purple-600">
                {{ clienteSeleccionado.compras || 0 }}
              </div>
              <div class="text-xs text-gray-600">Compras</div>
            </div>

            <div class="text-center p-3 bg-white rounded-lg">
              <div class="text-lg font-bold text-green-600">
                {{ formatearMoneda(clienteSeleccionado.totalCompras || 0) }}
              </div>
              <div class="text-xs text-gray-600">Total</div>
            </div>

            <div class="text-center p-3 bg-white rounded-lg">
              <div class="text-lg font-bold text-blue-600">
                {{ formatearMoneda(getPromedioCompras(clienteSeleccionado)) }}
              </div>
              <div class="text-xs text-gray-600">Promedio</div>
            </div>

            <div class="text-center p-3 bg-white rounded-lg">
              <div class="text-sm font-bold text-orange-600">
                {{
                  clienteSeleccionado.ultimaCompra
                    ? (clienteSeleccionado.ultimaCompra | date : "dd/MM")
                    : "N/A"
                }}
              </div>
              <div class="text-xs text-gray-600">Ãšltima</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ACCIONES DEL CLIENTE -->
      <div class="flex gap-3 mt-6">
        <button
          class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors shadow-md flex items-center justify-center gap-2"
          (click)="editarCliente()"
        >
          <i class="pi pi-pencil"></i>
          Editar Cliente
        </button>

        <button
          class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors shadow-md flex items-center justify-center gap-2"
          (click)="limpiarClienteSeleccionado()"
        >
          <i class="pi pi-refresh"></i>
          Cambiar Cliente
        </button>

        <button
          class="bg-orange-500 hover:bg-orange-600 text-white py-3 px-4 rounded-xl font-semibold transition-colors shadow-md"
          (click)="verHistorialCliente()"
        >
          <i class="pi pi-history"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- FOOTER -->
  <ng-template pTemplate="footer">
    <div
      class="flex justify-between items-center p-6 bg-gray-50 -mx-6 -mb-6 mt-6 border-t border-gray-200"
    >
      <!-- INFO RÃPIDA -->
      <div class="flex items-center gap-4 text-sm">
        <div class="flex items-center gap-2">
          <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
          <span class="text-gray-600">Cliente:</span>
          <span class="font-bold text-gray-900">
            {{
              clienteSeleccionado
                ? clienteSeleccionado.nombres +
                  " " +
                  clienteSeleccionado.apellidos
                : "No seleccionado"
            }}
          </span>
        </div>
      </div>

      <!-- BOTONES DE ACCIÃ“N -->
      <div class="flex gap-3">
        <p-button
          label="Cancelar"
          icon="pi pi-times"
          severity="secondary"
          [outlined]="true"
          (click)="showClientModal = false"
          styleClass="px-6 py-2"
        >
        </p-button>

        <p-button
          [label]="
            clienteSeleccionado ? 'Confirmar Cliente' : 'Seleccionar Cliente'
          "
          [icon]="clienteSeleccionado ? 'pi pi-check' : 'pi pi-user'"
          severity="success"
          [disabled]="!clienteSeleccionado"
          (click)="confirmarCliente()"
          styleClass="px-8 py-2 shadow-lg"
        >
        </p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Ayuda de Teclado -->
<p-dialog
  header="âŒ¨ï¸ Atajos de Teclado"
  [(visible)]="showKeyboardHelp"
  [modal]="true"
  [closable]="true"
  [draggable]="false"
  [resizable]="false"
  styleClass="w-11/12 max-w-2xl"
>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Funciones Principales -->
    <div>
      <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
        <i class="pi pi-cog text-blue-600"></i>
        Funciones Principales
      </h4>
      <div class="space-y-2">
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Buscar Producto</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono">F2</kbd>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Seleccionar Cliente</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono">F3</kbd>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Aplicar Descuento</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono">F4</kbd>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Activar EscÃ¡ner</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono">F8</kbd>
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Abrir Caja</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono">F9</kbd>
        </div>
        <div
          class="flex justify-between items-center p-2 bg-green-50 rounded border border-green-200"
        >
          <span class="text-sm font-medium">Procesar Pago</span>
          <kbd class="px-2 py-1 bg-green-200 rounded text-xs font-mono"
            >F12</kbd
          >
        </div>
      </div>
    </div>

    <!-- Pagos RÃ¡pidos -->
    <div>
      <h4 class="font-semibold text-gray-800 mb-3 flex items-center gap-2">
        <i class="pi pi-credit-card text-green-600"></i>
        Pagos RÃ¡pidos
      </h4>
      <div class="space-y-2">
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">ðŸ’µ Pago Efectivo</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
            >Ctrl+1</kbd
          >
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">ðŸ’³ Pago Tarjeta</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
            >Ctrl+2</kbd
          >
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">ðŸ“± Pago Digital</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
            >Ctrl+3</kbd
          >
        </div>
      </div>

      <h4 class="font-semibold text-gray-800 mb-3 mt-6 flex items-center gap-2">
        <i class="pi pi-wrench text-purple-600"></i>
        Utilidades
      </h4>
      <div class="space-y-2">
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Limpiar Carrito</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
            >Ctrl+Del</kbd
          >
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Aumentar Cantidad</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
            >Ctrl++</kbd
          >
        </div>
        <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
          <span class="text-sm">Disminuir Cantidad</span>
          <kbd class="px-2 py-1 bg-gray-200 rounded text-xs font-mono"
            >Ctrl+-</kbd
          >
        </div>
        <div
          class="flex justify-between items-center p-2 bg-red-50 rounded border border-red-200"
        >
          <span class="text-sm">Cancelar / Salir</span>
          <kbd class="px-2 py-1 bg-red-200 rounded text-xs font-mono">ESC</kbd>
        </div>
      </div>
    </div>
  </div>

  <div class="mt-6 p-4 bg-blue-50 rounded-lg border border-blue-200">
    <p class="text-sm text-blue-800">
      <i class="pi pi-info-circle mr-2"></i>
      <strong>Tip profesional:</strong> Los atajos funcionan desde cualquier
      parte del sistema, excepto cuando estÃ©s escribiendo en un campo de texto.
    </p>
  </div>

  <ng-template pTemplate="footer">
    <div class="flex justify-center">
      <button
        class="bg-blue-600 text-white px-6 py-2 rounded font-medium"
        (click)="showKeyboardHelp = false"
      >
        Entendido
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- DIÃLOGO: COMPROBANTE FINAL -->
<p-dialog 
  [(visible)]="comprobanteDialog" 
  [header]="'Venta Completada'" 
  [modal]="true" 
  [style]="{width: '700px'}" 
  [draggable]="false" 
  [resizable]="false"
  styleClass="border-0 shadow-2xl comprobante-dialog"
  [closable]="true"
  [blockScroll]="true"
>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 bg-gradient-to-r from-green-500 to-emerald-600 rounded-xl flex items-center justify-center shadow-lg">
        <i class="pi pi-check-circle text-white text-xl"></i>
      </div>
      <div>
        <div class="text-sm text-gray-500">Venta #{{ventaParaComprobante?.numeroVenta}}</div>
        <div class="text-2xl font-bold text-gray-800">Â¡Venta Completada!</div>
      </div>
    </div>
  </ng-template>
  
  <div class="p-5">
    <!-- Vista previa del comprobante -->
    <div class="comprobante-preview" *ngIf="ventaParaComprobante">
      <!-- Encabezado del comprobante -->
      <div class="text-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 mb-1">{{getTipoComprobanteLabel(ventaParaComprobante.tipoComprobante)}}</h3>
        <div class="text-lg font-mono font-semibold text-blue-600">
          {{ventaParaComprobante.serieComprobante}}-{{ventaParaComprobante.numeroComprobante || ventaParaComprobante.numeroVenta || 'GENERANDO...'}}
        </div>
        <div class="text-sm text-gray-600 mt-2">
          Fecha: {{ventaParaComprobante.fechaCreacion | date:'dd/MM/yyyy HH:mm'}}
        </div>
      </div>
      
      <!-- InformaciÃ³n del cliente -->
      <div class="bg-blue-50/60 backdrop-blur-sm rounded-lg p-4 mb-4 border border-blue-100">
        <div class="flex items-start justify-between">
          <div>
            <h5 class="font-bold text-blue-800 mb-1">Datos del Cliente</h5>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-1 text-sm">
              <div><span class="text-gray-500">Nombre:</span> <span class="font-medium">{{ventaParaComprobante.cliente.nombres}} {{ventaParaComprobante.cliente.apellidos}}</span></div>
              <div><span class="text-gray-500">Documento:</span> <span class="font-medium">{{ventaParaComprobante.cliente.documento}}</span></div>
            </div>
          </div>
          
          <div class="text-right">
            <div class="bg-blue-100 rounded-lg py-1 px-3 text-blue-800 font-medium text-sm inline-block">
              <i class="pi pi-user-plus mr-1"></i>
              Cliente registrado
            </div>
          </div>
        </div>
      </div>
      
      <!-- Detalle de productos -->
      <div class="mb-4">
        <h5 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
          <i class="pi pi-shopping-bag text-purple-600"></i>
          Detalle de Productos
        </h5>
        
        <div class="overflow-auto max-h-48">
          <table class="w-full">
            <thead>
              <tr class="bg-gray-50 text-left">
                <th class="p-2 border-b border-gray-200 text-gray-600 text-sm font-semibold">Producto</th>
                <th class="p-2 border-b border-gray-200 text-gray-600 text-sm font-semibold text-center">Cant.</th>
                <th class="p-2 border-b border-gray-200 text-gray-600 text-sm font-semibold text-right">P. Unit.</th>
                <th class="p-2 border-b border-gray-200 text-gray-600 text-sm font-semibold text-right">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let detalle of ventaParaComprobante.detalles" class="border-b border-gray-100">
                <td class="p-2">
                  <div class="font-medium text-gray-800">{{detalle.producto.nombre}}</div>
                  <div class="text-xs text-gray-500">
                    {{detalle.color.nombre}} - {{detalle.talla.numero}} - {{detalle.producto.codigo}}
                  </div>
                </td>
                <td class="p-2 text-center font-medium">{{detalle.cantidad}}</td>
                <td class="p-2 text-right font-mono">{{formatearMoneda(detalle.precioUnitario)}}</td>
                <td class="p-2 text-right font-mono font-medium text-blue-700">{{formatearMoneda(detalle.subtotal)}}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Totales con IGV desglosado -->
      <div class="bg-gray-50/60 backdrop-blur-sm rounded-lg p-4 border border-gray-200">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <div class="text-sm text-gray-500 mb-1">MÃ©todo de pago</div>
            <div class="flex items-center gap-2">
              <i class="pi pi-wallet text-blue-600"></i>
              <span class="font-medium">{{getMetodoPagoLabel(pagoActual.metodoPago)}}</span>
            </div>
          </div>
          
          <div>
            <div class="space-y-2">
              <div class="flex justify-between text-sm">
                <span class="text-gray-600">Op. Gravada:</span>
                <span class="font-mono">{{formatearMoneda(ventaParaComprobante.subtotal)}}</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-blue-600">IGV (18%):</span>
                <span class="font-mono text-blue-600">{{formatearMoneda(ventaParaComprobante.igv)}}</span>
              </div>
              <div class="flex justify-between font-medium pt-2 border-t border-gray-300">
                <span class="text-gray-800">TOTAL:</span>
                <span class="font-mono text-xl text-emerald-600">{{formatearMoneda(ventaParaComprobante.total)}}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Observaciones -->
      <div *ngIf="ventaParaComprobante.observaciones" class="mt-4 p-3 bg-yellow-50 rounded-lg border border-yellow-100">
        <h5 class="font-semibold text-yellow-800 mb-1 flex items-center gap-2">
          <i class="pi pi-comment"></i>
          Observaciones:
        </h5>
        <p class="text-sm text-yellow-700">{{ventaParaComprobante.observaciones}}</p>
      </div>
      
      <!-- Mensajes finales -->
      <div class="mt-6 text-center">
        <div class="text-gray-500 text-sm mb-2">Vendedor: {{ventaParaComprobante.usuario.nombre}}</div>
        <div class="text-gray-400 text-xs">Â¡Gracias por su compra!</div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center px-3">
      <div class="flex gap-2">
        <p-button 
          label="Imprimir" 
          icon="pi pi-print" 
          severity="secondary"
          [outlined]="true"
          (click)="imprimirComprobante(ventaParaComprobante!)"
        ></p-button>
        
        <p-button 
          label="Enviar" 
          icon="pi pi-envelope" 
          severity="info"
          [outlined]="true"
          (click)="enviarComprobantePorEmail(ventaParaComprobante!)"
        ></p-button>
        
        <p-button 
          label="Descargar PDF" 
          icon="pi pi-file-pdf" 
          severity="danger"
          [outlined]="true"
          (click)="descargarComprobantePDF(ventaParaComprobante!)"
        ></p-button>
      </div>
      
      <div class="flex gap-2">
        <p-button 
          label="Cerrar" 
          icon="pi pi-times" 
          severity="secondary"
          (click)="cerrarComprobante()"
        ></p-button>
        
        <p-button 
          label="Nueva Venta" 
          icon="pi pi-plus" 
          severity="success"
          (click)="nuevaVentaRapida()"
        ></p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>


<!-- Modal de Carrito para MÃ³vil/Tablet -->
<div 
  *ngIf="showMobileCart"
  class="fixed inset-0 z-50 lg:hidden"
  (click)="closeMobileCart()"
>
  <!-- Overlay -->
  <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity duration-300"></div>
  
  <!-- Modal deslizante desde abajo -->
  <div 
    class="absolute bottom-0 left-0 right-0 bg-white dark:bg-gray-800 rounded-t-2xl shadow-2xl mobile-cart-modal max-h-[85vh] flex flex-col"
    (click)="$event.stopPropagation()"
  >
    <!-- Handle para arrastrar -->
    <div class="flex justify-center py-3">
      <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full drag-handle"></div>
    </div>
    
    <!-- Header del modal -->
    <div class="flex items-center justify-between px-4 pb-4 border-b border-gray-200 dark:border-gray-700">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-emerald-400 to-emerald-500 rounded-xl flex items-center justify-center shadow-lg">
          <i class="pi pi-shopping-cart text-white text-base"></i>
        </div>
        <div>
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Mi Carrito</h3>
          <p class="text-sm text-gray-500 dark:text-gray-400">{{ carrito.length }} productos</p>
        </div>
      </div>
      <button 
        (click)="closeMobileCart()"
        class="w-10 h-10 bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded-xl flex items-center justify-center transition-colors"
      >
        <i class="pi pi-times text-gray-600 dark:text-gray-300 text-base"></i>
      </button>
    </div>
    
    <!-- Contenido del carrito -->
    <div class="flex-1 overflow-y-auto p-4 mobile-cart-content">
      <div class="space-y-3">
        <div
          *ngFor="let item of carrito; trackBy: trackByItemCarritoId"
          class="bg-gray-50 dark:bg-gray-700/50 p-4 rounded-xl border border-gray-200 dark:border-gray-600 mobile-cart-item"
        >
          <div class="flex items-center gap-4">
            <!-- Imagen -->
            <div class="w-16 h-16 rounded-xl overflow-hidden bg-gray-100 dark:bg-gray-600 flex-shrink-0">
              <img
                [src]="item.producto.imagen || '/assets/images/product-placeholder.jpg'"
                [alt]="item.producto.nombre"
                class="w-full h-full object-cover"
                onerror="this.src='/assets/images/product-placeholder.jpg'"
              />
            </div>
            
            <!-- Info del producto -->
            <div class="flex-1 min-w-0">
              <div class="text-base font-semibold text-gray-900 dark:text-white truncate">
                {{ item.producto.nombre }}
              </div>
              <div class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                {{ formatearMoneda(item.precioUnitario) }} c/u
              </div>
              <div class="text-xs text-gray-400 dark:text-gray-500">
                Stock: {{ item.cantidad }}
              </div>
            </div>
            
            <!-- Controles de cantidad -->
            <div class="flex items-center gap-3 quantity-controls">
              <button
                (click)="decrementarCantidadItem(item)"
                class="w-10 h-10 bg-white dark:bg-gray-600 hover:bg-gray-100 dark:hover:bg-gray-500 rounded-xl flex items-center justify-center border border-gray-200 dark:border-gray-500 transition-colors"
                [disabled]="(item.cantidad || 1) <= 1"
              >
                <i class="pi pi-minus text-sm text-gray-600 dark:text-gray-300"></i>
              </button>
              
              <span class="text-lg font-bold text-gray-900 dark:text-white min-w-[30px] text-center">
                {{ item.cantidad || 1 }}
              </span>
              
              <button
                (click)="incrementarCantidadItem(item)"
                class="w-10 h-10 bg-emerald-500 hover:bg-emerald-600 rounded-xl flex items-center justify-center text-white transition-colors"
                [disabled]="(item.cantidad || 1) >= item.cantidad"
              >
                <i class="pi pi-plus text-sm"></i>
              </button>
            </div>
            
            <!-- Precio total y eliminar -->
            <div class="text-right">
              <div class="text-lg font-bold text-emerald-600 dark:text-emerald-400">
                {{ formatearMoneda(item.precioUnitario * (item.cantidad || 1)) }}
              </div>
              <button
                (click)="eliminarItemCarrito(item)"
                class="text-red-500 hover:text-red-700 mt-2 p-1"
                title="Eliminar producto"
              >
                <i class="pi pi-trash text-sm"></i>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Estado vacÃ­o -->
        <div *ngIf="carrito.length === 0" class="text-center py-12">
          <div class="w-20 h-20 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center mx-auto mb-4">
            <i class="pi pi-shopping-cart text-gray-400 dark:text-gray-500 text-2xl"></i>
          </div>
          <p class="text-gray-500 dark:text-gray-400 text-lg font-medium">Tu carrito estÃ¡ vacÃ­o</p>
          <p class="text-gray-400 dark:text-gray-500 text-sm mt-1">Agrega productos para comenzar</p>
        </div>
      </div>
    </div>
    
    <!-- Footer con totales -->
    <div *ngIf="carrito.length > 0" class="p-4 border-t border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-700/50">
      <!-- Resumen de totales -->
      <div class="space-y-2 mb-4">
        <div class="flex justify-between text-base text-gray-600 dark:text-gray-400">
          <span>Subtotal:</span>
          <span>{{ formatearMoneda(calcularSubtotal()) }}</span>
        </div>
        <div class="flex justify-between text-base text-gray-600 dark:text-gray-400">
          <span>Descuento:</span>
          <span>-{{ formatearMoneda(descuentoVenta) }}</span>
        </div>
        <div class="flex justify-between text-xl font-bold text-gray-900 dark:text-white border-t border-gray-200 dark:border-gray-600 pt-2">
          <span>Total:</span>
          <span class="text-emerald-600 dark:text-emerald-400">{{ formatearMoneda(calcularTotal()) }}</span>
        </div>
      </div>
      
      <!-- Botones de acciÃ³n -->
      <div class="space-y-3">
        <button
          (click)="procesarVentaDesdeCarrito(); closeMobileCart()"
          class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 text-white py-4 px-6 rounded-xl font-bold text-lg transition-all shadow-lg active:scale-95"
          [disabled]="carrito.length === 0 || procesandoVenta"
        >
          <i class="pi pi-check mr-2"></i>
          {{ procesandoVenta ? 'Procesando...' : 'Procesar Venta' }}
        </button>
        
        <div class="flex gap-3">
          <button
            (click)="abrirModalDescuento()"
            class="flex-1 bg-blue-100 dark:bg-blue-900/30 hover:bg-blue-200 dark:hover:bg-blue-800/40 text-blue-700 dark:text-blue-300 py-3 px-4 rounded-xl font-semibold transition-colors"
          >
            <i class="pi pi-percentage mr-2"></i>
            Descuento
          </button>
          
          <button
            (click)="limpiarCarrito()"
            class="flex-1 bg-red-100 dark:bg-red-900/30 hover:bg-red-200 dark:hover:bg-red-800/40 text-red-600 dark:text-red-400 py-3 px-4 rounded-xl font-semibold transition-colors"
          >
            <i class="pi pi-trash mr-2"></i>
            Limpiar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Carrito Expandido -->
<div
  *ngIf="mostrarCarritoExpandido"
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  (click)="mostrarCarritoExpandido = false"
>
  <div
    class="bg-white rounded-xl shadow-2xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto"
    (click)="$event.stopPropagation()"
  >
    <!-- Header del Modal -->
    <div class="sticky top-0 bg-white border-b border-gray-200 p-6 rounded-t-xl">
      <div class="flex justify-between items-center">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-green-600 rounded-lg flex items-center justify-center">
            <i class="pi pi-shopping-cart text-white text-lg"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold text-gray-900">Carrito de Compras</h3>
            <p class="text-sm text-gray-500">{{ carrito.length }} productos agregados</p>
          </div>
        </div>
        <button
          class="text-gray-400 hover:text-gray-600 p-2"
          (click)="mostrarCarritoExpandido = false"
        >
          <i class="pi pi-times text-xl"></i>
        </button>
      </div>
    </div>

    <!-- Contenido del Modal -->
    <div class="p-6">
      <!-- Lista de productos expandida -->
      <div *ngIf="carrito.length > 0" class="space-y-4">
        <div
          *ngFor="let item of carrito; trackBy: trackByItemCarritoId; let i = index"
          class="bg-gray-50 rounded-xl p-6 border border-gray-200 hover:shadow-md transition-shadow"
        >
          <div class="flex items-start gap-6">
            <!-- Imagen mÃ¡s grande -->
            <div class="relative flex-shrink-0">
              <img
                *ngIf="item.producto?.imagen"
                [src]="item.producto.imagen"
                [alt]="item.producto.nombre"
                class="w-24 h-24 object-cover rounded-lg border border-gray-200"
                onerror="this.src='/assets/images/product-placeholder.jpg'"
              />
              <div
                *ngIf="!item.producto?.imagen"
                class="w-24 h-24 bg-gray-200 flex items-center justify-center rounded-lg"
              >
                <i class="pi pi-image text-gray-400 text-2xl"></i>
              </div>
              <span
                class="absolute -top-2 -left-2 bg-blue-600 text-white text-sm w-8 h-8 rounded-full flex items-center justify-center font-bold"
              >
                {{ i + 1 }}
              </span>
            </div>

            <!-- Info del producto expandida -->
            <div class="flex-1 min-w-0">
              <div class="font-bold text-gray-900 text-xl mb-3">
                {{ item.producto.nombre }}
              </div>
              <div class="flex gap-2 flex-wrap mb-3">
                <span class="bg-blue-100 text-blue-700 px-3 py-1 rounded-full font-medium">
                  {{ item.color.nombre }}
                </span>
                <span class="bg-green-100 text-green-700 px-3 py-1 rounded-full font-medium">
                  Talla {{ item.talla.numero }}
                </span>
              </div>
              <div class="text-gray-500 mb-4">
                CÃ³digo: {{ item.codigoCompleto }}
              </div>

              <!-- Controles de cantidad expandidos -->
              <div class="flex items-center gap-4">
                <button
                  class="w-10 h-10 bg-gray-300 hover:bg-gray-400 rounded-lg flex items-center justify-center transition-colors"
                  [disabled]="item.cantidad <= 1"
                  (click)="actualizarCantidadItem(item, item.cantidad - 1)"
                >
                  <i class="pi pi-minus"></i>
                </button>

                <input
                  type="number"
                  [(ngModel)]="item.cantidad"
                  (blur)="actualizarCantidadItem(item, item.cantidad)"
                  min="1"
                  [max]="item.stock"
                  class="w-20 text-center border border-gray-300 rounded-lg px-3 py-2 font-mono text-lg"
                />

                <button
                  class="w-10 h-10 bg-gray-300 hover:bg-gray-400 rounded-lg flex items-center justify-center transition-colors"
                  [disabled]="item.cantidad >= item.stock"
                  (click)="actualizarCantidadItem(item, item.cantidad + 1)"
                >
                  <i class="pi pi-plus"></i>
                </button>

                <div class="text-gray-500 bg-gray-200 px-3 py-2 rounded-lg">
                  Stock disponible: {{ item.stock }}
                </div>
              </div>
            </div>

            <!-- Precio y eliminar expandido -->
            <div class="text-right flex-shrink-0">
              <div class="font-bold text-green-600 text-2xl mb-2">
                {{ formatearMoneda(item.subtotal) }}
              </div>
              <div class="text-gray-500 mb-4">
                {{ formatearMoneda(item.precioUnitario) }} c/u
              </div>
              <button
                class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg transition-colors"
                (click)="eliminarItemCarrito(item)"
              >
                <i class="pi pi-trash mr-2"></i>
                Eliminar
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer del Modal con totales -->
    <div class="sticky bottom-0 bg-gray-50 border-t border-gray-200 p-6 rounded-b-xl">
      <div class="flex justify-between items-center">
        <div class="text-lg">
          <span class="text-gray-600">Total de productos: </span>
          <span class="font-bold">{{ carrito.length }}</span>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold text-green-600">
            {{ formatearMoneda(totalVenta) }}
          </div>
          <div class="text-sm text-gray-500">Total de la venta</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BotÃ³n flotante para Panel de Pruebas de Ticketera -->
<button
  *ngIf="mostrarBotonPruebas"
  class="fixed bottom-6 right-6 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white p-4 rounded-full shadow-lg hover:shadow-xl transition-all duration-300 z-50 group"
  (click)="mostrarPanelPruebas()"
  title="Panel de Pruebas Ticketera"
>
  <i class="pi pi-cog text-xl group-hover:rotate-90 transition-transform duration-300"></i>
</button>

<!-- Panel de Pruebas de Ticketera -->
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" *ngIf="panelPruebasVisible">
  <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-hidden">
    <!-- Header del Panel -->
    <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white p-6">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-2xl font-bold">ðŸ–¨ï¸ Panel de Pruebas - Ticketera XPrinter</h2>
          <p class="text-blue-100 mt-1">Sistema de pruebas para XPrinter XP-V320M</p>
        </div>
        <button 
          class="text-white hover:text-gray-200 text-xl p-2"
          (click)="cerrarPanelPruebas()"
        >
          <i class="pi pi-times"></i>
        </button>
      </div>
    </div>

    <!-- Contenido del Panel -->
    <div class="p-6 max-h-[70vh] overflow-y-auto">
      <!-- Estado de ConexiÃ³n -->
      <div class="mb-6">
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h3 class="font-semibold text-gray-800 mb-3 flex items-center">
            <i class="pi pi-info-circle mr-2 text-blue-600"></i>
            Estado de la Ticketera
          </h3>
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
              <div class="flex items-center">
                <div class="w-3 h-3 rounded-full mr-2" 
                     [class]="estadoConexion.conectada ? 'bg-green-500' : 'bg-red-500'"></div>
                <span class="font-medium">
                  {{ estadoConexion.conectada ? 'Conectada' : 'Desconectada' }}
                </span>
              </div>
              <div class="text-sm text-gray-600">
                Puerto: {{ estadoConexion.puerto || 'No detectado' }}
              </div>
            </div>
            <button 
              class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition-colors"
              (click)="verificarConexionTicketera()"
              [disabled]="verificandoConexion"
            >
              <i class="pi pi-refresh mr-2" [class.pi-spin]="verificandoConexion"></i>
              {{ verificandoConexion ? 'Verificando...' : 'Verificar' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Secciones de Pruebas -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        
        <!-- Pruebas BÃ¡sicas -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
            <i class="pi pi-play mr-2 text-green-600"></i>
            Pruebas BÃ¡sicas
          </h3>
          <div class="space-y-3">
            <button 
              class="w-full bg-green-600 hover:bg-green-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="imprimirTicketPrueba()"
            >
              <i class="pi pi-print mr-2"></i>
              Ticket de Prueba
            </button>
            
            <button 
              class="w-full bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="probarTextoSimple()"
            >
              <i class="pi pi-file-edit mr-2"></i>
              Texto Simple
            </button>
            
            <button 
              class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="probarFormatos()"
            >
              <i class="pi pi-palette mr-2"></i>
              Formatos de Texto
            </button>
          </div>
        </div>

        <!-- Pruebas de Hardware -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
            <i class="pi pi-cog mr-2 text-orange-600"></i>
            Hardware
          </h3>
          <div class="space-y-3">
            <button 
              class="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="cortarPapelPrueba()"
            >
              <i class="pi pi-scissors mr-2"></i>
              Cortar Papel
            </button>
            
            <button 
              class="w-full bg-red-600 hover:bg-red-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="abrirCajonPrueba()"
            >
              <i class="pi pi-box mr-2"></i>
              Abrir CajÃ³n
            </button>
            
            <button 
              class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="obtenerEstadoTicketera()"
            >
              <i class="pi pi-info mr-2"></i>
              Estado Detallado
            </button>
          </div>
        </div>

        <!-- ConfiguraciÃ³n -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
            <i class="pi pi-wrench mr-2 text-gray-600"></i>
            ConfiguraciÃ³n
          </h3>
          <div class="space-y-3">
            <button 
              class="w-full bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="detectarPuertos()"
              [disabled]="detectandoPuertos"
            >
              <i class="pi pi-search mr-2" [class.pi-spin]="detectandoPuertos"></i>
              {{ detectandoPuertos ? 'Detectando...' : 'Detectar Puertos' }}
            </button>
            
            <div class="space-y-2" *ngIf="puertosDisponibles.length > 0">
              <label class="block text-sm font-medium text-gray-700">Puerto:</label>
              <select 
                class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                [(ngModel)]="puertoSeleccionado"
              >
                <option value="">Seleccionar puerto...</option>
                <option *ngFor="let puerto of puertosDisponibles" [value]="puerto">
                  {{ puerto }}
                </option>
              </select>
              <button 
                class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-lg transition-colors"
                (click)="configurarPuertoSeleccionado()"
                [disabled]="!puertoSeleccionado"
              >
                <i class="pi pi-check mr-2"></i>
                Configurar Puerto
              </button>
            </div>
          </div>
        </div>

        <!-- Pruebas con Datos Reales -->
        <div class="bg-gray-50 rounded-lg p-4 border">
          <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
            <i class="pi pi-shopping-cart mr-2 text-cyan-600"></i>
            Datos Reales
          </h3>
          <div class="space-y-3">
            <button 
              class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="imprimirVentaActual()"
              [disabled]="carrito.length === 0"
            >
              <i class="pi pi-receipt mr-2"></i>
              Imprimir Venta Actual
            </button>
            
            <button 
              class="w-full bg-teal-600 hover:bg-teal-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="crearVentaPrueba()"
            >
              <i class="pi pi-plus mr-2"></i>
              Crear Venta de Prueba
            </button>
            
            <button 
              class="w-full bg-emerald-600 hover:bg-emerald-700 text-white py-3 px-4 rounded-lg transition-colors flex items-center justify-center"
              (click)="imprimirUltimaVenta()"
            >
              <i class="pi pi-history mr-2"></i>
              Ãšltima Venta
            </button>
          </div>
        </div>
      </div>

      <!-- Log de Pruebas -->
      <div class="mt-6 bg-gray-900 rounded-lg p-4">
        <h3 class="font-semibold text-white mb-3 flex items-center">
          <i class="pi pi-list mr-2 text-green-400"></i>
          Log de Pruebas
        </h3>
        <div class="bg-black rounded p-3 h-40 overflow-y-auto font-mono text-sm">
          <div *ngFor="let log of logPruebas; trackBy: trackByIndex" 
               class="mb-1" 
               [class]="getLogClass(log.tipo)">
            <span class="text-gray-500">[{{ log.timestamp }}]</span>
            <span class="ml-2">{{ log.mensaje }}</span>
          </div>
          <div *ngIf="logPruebas.length === 0" class="text-gray-500 text-center py-8">
            No hay logs de pruebas aÃºn...
          </div>
        </div>
        <div class="mt-3 flex justify-end">
          <button 
            class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors text-sm"
            (click)="limpiarLogs()"
          >
            <i class="pi pi-trash mr-2"></i>
            Limpiar Logs
          </button>
        </div>
      </div>
    </div>

    <!-- Footer del Panel -->
    <div class="bg-gray-50 border-t p-4 flex justify-between items-center">
      <div class="text-sm text-gray-600">
        <i class="pi pi-info-circle mr-1"></i>
        Utiliza estas pruebas para verificar el funcionamiento de tu ticketera
      </div>
      <button 
        class="bg-gray-600 hover:bg-gray-700 text-white px-6 py-2 rounded-lg transition-colors"
        (click)="cerrarPanelPruebas()"
      >
        Cerrar
      </button>
    </div>
  </div>
</div>

<!-- ðŸ”§ DIÃLOGOS FUERA DEL CONTENEDOR PRINCIPAL -->
<!-- DIÃLOGO: PROCESAMIENTO DE PAGO -->
  <p-dialog 
    [(visible)]="pagoDialog" 
    [modal]="true" 
    [style]="{width: '750px', maxHeight: '90vh'}" 
    [draggable]="false" 
    [resizable]="false"
    styleClass="modern-dialog"
    [closable]="!procesandoPago"
    [closeOnEscape]="!procesandoPago"
    [blockScroll]="true"
    (onHide)="onPagoDialogHide()"
  >
    <!-- Header Limpio -->
    <ng-template pTemplate="header">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-500 rounded-xl flex items-center justify-center">
          <i class="pi pi-credit-card text-white text-xl"></i>
        </div>
        <div>
          <h2 class="text-xl font-bold text-gray-900">Procesar Pago</h2>
          <p class="text-sm text-gray-600">Total: {{formatearMoneda(totalVenta)}}</p>
        </div>
      </div>
    </ng-template>
    
    <div class="p-6 space-y-6">
      
      <!-- Resumen de Venta Simplificado -->
      <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-8 h-8 bg-blue-500 rounded-lg flex items-center justify-center">
            <i class="pi pi-shopping-cart text-white text-sm"></i>
          </div>
          <h4 class="text-lg font-semibold text-gray-900">Resumen de Venta</h4>
        </div>
        
        <div class="grid grid-cols-3 gap-3">
          <div class="text-center p-3 bg-white rounded-lg border border-gray-200">
            <div class="text-xl font-bold text-blue-600">{{carrito.length}}</div>
            <div class="text-xs text-gray-600">Productos</div>
          </div>
          
          <div class="text-center p-3 bg-white rounded-lg border border-gray-200">
            <div class="text-xl font-bold text-green-600">{{getTotalItems()}}</div>
            <div class="text-xs text-gray-600">Unidades</div>
          </div>
          
          <div class="text-center p-3 bg-white rounded-lg border border-gray-200">
            <div class="text-sm font-semibold text-purple-600">{{getTipoComprobanteLabel(nuevaVenta.tipoComprobante)}}</div>
            <div class="text-xs text-gray-600">{{nuevaVenta.serieComprobante}}</div>
          </div>
        </div>
        
        <!-- Cliente Info -->
        <div class="mt-4 p-3 bg-white rounded-lg border border-gray-200">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm">
              {{clienteSeleccionado?.nombres?.charAt(0)}}{{clienteSeleccionado?.apellidos?.charAt(0)}}
            </div>
            <div class="flex-1">
              <div class="font-semibold text-gray-900 text-sm">{{clienteSeleccionado?.nombres}} {{clienteSeleccionado?.apellidos}}</div>
              <div class="text-xs text-gray-600">{{clienteSeleccionado?.dni || clienteSeleccionado?.ruc}}</div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- MÃ©todos de Pago -->
      <div class="space-y-4">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 bg-green-500 rounded-lg flex items-center justify-center">
            <i class="pi pi-wallet text-white text-sm"></i>
          </div>
          <h4 class="text-lg font-semibold text-gray-900">MÃ©todo de Pago</h4>
        </div>
        
        <!-- Botones de MÃ©todos -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-3">
          <div *ngFor="let metodo of metodosPago; trackBy: trackByMetodoPago"
               class="cursor-pointer transition-all duration-200"
               [class.active]="pagoActual.metodoPago === metodo.value"
               (click)="seleccionarMetodoPago(metodo.value)"
               tabindex="0"
               role="button"
               [attr.aria-label]="'Seleccionar mÃ©todo de pago: ' + metodo.label"
               [attr.aria-pressed]="pagoActual.metodoPago === metodo.value">
            <div class="p-4 rounded-xl border-2 transition-all duration-200"
                 [class]="pagoActual.metodoPago === metodo.value ? 
                         'border-blue-500 bg-blue-50' : 
                         'border-gray-200 bg-white hover:border-gray-300 hover:bg-gray-50'">
              <div class="flex flex-col items-center gap-2">
                <!-- Iconos -->
                <div class="w-10 h-10 rounded-lg flex items-center justify-center"
                     [class]="getMetodoPagoStyle(metodo.value)">
                  <i [class]="getMetodoPagoIcon(metodo.value) + ' text-lg text-white'"></i>
                </div>
                <span class="text-sm font-medium text-center"
                      [class]="pagoActual.metodoPago === metodo.value ? 'text-blue-700' : 'text-gray-700'">
                  {{metodo.label}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- FORMULARIO DE PAGO DINÃMICO -->
      <div class="space-y-4 animate-fade-in">
        
        <!-- MONTO A PAGAR - SIEMPRE VISIBLE CON MEJOR ACCESIBILIDAD -->
        <div class="relative">
          <label for="montoPagado" 
                 class="flex items-center gap-2 text-sm font-semibold text-gray-700 mb-2">
            <i class="pi pi-dollar text-green-500" aria-hidden="true"></i>
            Monto Recibido
            <span class="text-red-500" aria-label="campo requerido">*</span>
          </label>
          <div class="relative">
            <p-inputNumber 
              id="montoPagado"
              [(ngModel)]="montoPagado" 
              mode="currency" 
              currency="PEN" 
              locale="es-PE"
              [min]="0"
              placeholder="S/ 0.00"
              styleClass="w-full pago-input-modern"
              (onInput)="calcularVuelto()"
              [class.border-red-300]="montoPagado < totalVenta"
              [attr.aria-describedby]="'monto-help monto-validation'"
              [attr.aria-invalid]="montoPagado < totalVenta"
              required>
            </p-inputNumber>
            
            <!-- VALIDACIÃ“N VISUAL MEJORADA -->
            <div *ngIf="montoPagado < totalVenta" 
                 id="monto-validation"
                 class="absolute -bottom-6 left-0 flex items-center gap-1 text-red-500 text-xs animate-shake"
                 role="alert"
                 aria-live="polite">
              <i class="pi pi-exclamation-triangle" aria-hidden="true"></i>
              <span>Monto insuficiente. MÃ­nimo: {{formatearMoneda(totalVenta)}}</span>
            </div>
            
            <div *ngIf="montoPagado >= totalVenta" 
                 id="monto-validation"
                 class="absolute -bottom-6 left-0 flex items-center gap-1 text-green-500 text-xs"
                 role="status"
                 aria-live="polite">
              <i class="pi pi-check-circle" aria-hidden="true"></i>
              <span>Monto vÃ¡lido</span>
            </div>
            
            <div id="monto-help" class="sr-only">
              Ingrese el monto recibido del cliente. Debe ser igual o mayor al total de la venta.
            </div>
          </div>
        </div>
        
        <!-- CAMPOS ESPECÃFICOS POR MÃ‰TODO -->
        <div class="mt-8">
          
          <!-- TARJETAS CON ACCESIBILIDAD MEJORADA -->
          <div *ngIf="pagoActual.metodoPago === 'TARJETA_CREDITO' || pagoActual.metodoPago === 'TARJETA_DEBITO'"  
               class="space-y-4 animate-slide-down">
            
            <div class="bg-gradient-to-r from-gray-800 to-gray-900 rounded-2xl p-5 text-white shadow-xl">
              <div class="flex items-center gap-3 mb-4">
                <i class="pi pi-credit-card text-2xl" aria-hidden="true"></i>
                <span class="font-bold">InformaciÃ³n de Tarjeta</span>
              </div>
              
              <div class="space-y-4">
                <div>
                  <label for="nombreTarjeta" class="text-sm text-gray-300 mb-1 block">
                    Nombre del Titular
                    <span class="text-yellow-400 ml-1" aria-label="campo requerido">*</span>
                  </label>
                  <input 
                    id="nombreTarjeta"
                    pInputText 
                    [(ngModel)]="pagoActual.nombreTarjeta" 
                    placeholder="JUAN PÃ‰REZ GARCÃA"
                    class="card-input w-full"
                    maxlength="50"
                    autocomplete="cc-name"
                    [attr.aria-describedby]="'nombre-help'"
                    required
                  />
                  <div id="nombre-help" class="sr-only">
                    Ingrese el nombre completo como aparece en la tarjeta
                  </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                  <div>
                    <label for="ultimos4Digitos" class="text-sm text-gray-300 mb-1 block">
                      Ãšltimos 4 dÃ­gitos
                      <span class="text-yellow-400 ml-1" aria-label="campo requerido">*</span>
                    </label>
                    <p-inputMask 
                      id="ultimos4Digitos"
                      [(ngModel)]="pagoActual.ultimos4Digitos" 
                      mask="9999" 
                      placeholder="****"
                      styleClass="w-full card-input"
                      autocomplete="cc-number"
                      [attr.aria-describedby]="'digitos-help'"
                      required>
                    </p-inputMask>
                    <div id="digitos-help" class="sr-only">
                      Ingrese solo los Ãºltimos 4 dÃ­gitos de la tarjeta
                    </div>
                  </div>
                  
                  <div>
                    <label for="numeroReferenciaTarjeta" class="text-sm text-gray-300 mb-1 block">
                      NÂ° OperaciÃ³n
                      <span class="text-yellow-400 ml-1" aria-label="campo requerido">*</span>
                    </label>
                    <input 
                      id="numeroReferenciaTarjeta"
                      pInputText 
                      [(ngModel)]="pagoActual.numeroReferencia" 
                      placeholder="123456789"
                      class="card-input w-full"
                      maxlength="20"
                      [attr.aria-describedby]="'referencia-help'"
                      required
                    />
                    <div id="referencia-help" class="sr-only">
                      NÃºmero de referencia u operaciÃ³n proporcionado por el terminal
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- TRANSFERENCIAS DIGITALES CON ACCESIBILIDAD MEJORADA -->
          <div *ngIf="pagoActual.metodoPago === 'TRANSFERENCIA' || 
                     pagoActual.metodoPago === 'YAPE' || 
                     pagoActual.metodoPago === 'PLIN'" 
               class="animate-slide-down">
            
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl p-5 border border-blue-200/50">
              <div class="flex items-center gap-3 mb-3">
                <div [class]="getMetodoPagoStyle(pagoActual.metodoPago) + ' w-8 h-8 rounded-lg flex items-center justify-center'">
                  <i [class]="getMetodoPagoIcon(pagoActual.metodoPago) + ' text-white text-sm'" aria-hidden="true"></i>
                </div>
                <span class="font-bold text-gray-800">
                  Referencia de {{getMetodoLabel(pagoActual.metodoPago)}}
                </span>
              </div>
              
              <div>
                <label for="numeroReferenciaTransferencia" 
                       class="text-sm font-medium text-gray-700 mb-2 block">
                  NÃºmero de OperaciÃ³n
                  <span class="text-red-500 ml-1" aria-label="campo requerido">*</span>
                </label>
                <input 
                  id="numeroReferenciaTransferencia"
                  pInputText 
                  [(ngModel)]="pagoActual.numeroReferencia" 
                  placeholder="Ingresa el cÃ³digo de operaciÃ³n"
                  class="w-full border-2 border-blue-200 rounded-lg px-4 py-3 focus:border-blue-500 transition-colors focus:ring-custom"
                  maxlength="30"
                  [attr.aria-describedby]="'transferencia-help'"
                  required
                />
                <div id="transferencia-help" class="sr-only">
                  CÃ³digo de operaciÃ³n proporcionado por la aplicaciÃ³n {{getMetodoLabel(pagoActual.metodoPago)}}
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- VUELTO DESTACADO -->
        <div *ngIf="pagoActual.metodoPago === 'EFECTIVO' && vuelto > 0" 
             class="bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl p-5 border-2 border-green-200 animate-bounce-gentle">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-green-500 rounded-2xl flex items-center justify-center animate-pulse">
                <i class="pi pi-money-bill text-white text-xl"></i>
              </div>
              <div>
                <div class="text-sm font-semibold text-green-700">ðŸ’° Vuelto para el Cliente</div>
                <div class="text-xs text-green-600">Cambio a entregar</div>
              </div>
            </div>
            <div class="text-right">
              <div class="text-3xl font-bold text-green-600">{{formatearMoneda(vuelto)}}</div>
              <div class="text-xs text-green-500 font-medium">PEN</div>
            </div>
          </div>
        </div>
        
        <!-- OBSERVACIONES MEJORADAS CON ACCESIBILIDAD -->
        <div class="space-y-2">
          <label for="observacionesPago" 
                 class="flex items-center gap-2 text-sm font-semibold text-gray-700">
            <i class="pi pi-comment text-blue-500" aria-hidden="true"></i>
            Observaciones del Pago
            <span class="text-gray-400 text-xs">(Opcional)</span>
          </label>
          <textarea 
            id="observacionesPago"
            pInputTextarea 
            [(ngModel)]="pagoActual.observaciones" 
            placeholder="Agregar notas o comentarios adicionales..."
            rows="2"
            maxlength="200"
            class="w-full border-2 border-gray-200 rounded-lg px-4 py-3 focus:border-blue-500 transition-colors resize-none focus:ring-custom"
            [attr.aria-describedby]="'observaciones-help'"
          ></textarea>
          <div id="observaciones-help" class="text-xs text-gray-500">
            MÃ¡ximo 200 caracteres. Incluya informaciÃ³n adicional sobre el pago si es necesario.
          </div>
        </div>
      </div>
    </div>
    
    <!-- FOOTER MODERNO -->
    <ng-template pTemplate="footer">
      <div class="flex justify-between items-center p-6 bg-gray-50 -mx-6 -mb-6 mt-6 border-t border-gray-200">
        
        <!-- RESUMEN RÃPIDO -->
        <div class="flex items-center gap-4 text-sm">
          <div class="flex items-center gap-2">
            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
            <span class="text-gray-600">Total:</span>
            <span class="font-bold text-gray-900">{{formatearMoneda(totalVenta)}}</span>
          </div>
          
          <div *ngIf="montoPagado > 0" class="flex items-center gap-2">
            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            <span class="text-gray-600">Recibido:</span>
            <span class="font-bold text-gray-900">{{formatearMoneda(montoPagado)}}</span>
          </div>
        </div>
        
        <!-- BOTONES MEJORADOS -->
        <div class="flex gap-3">
          <p-button 
            label="Cancelar" 
            icon="pi pi-times" 
            severity="secondary"
            [outlined]="true"
            [disabled]="procesandoPago"
            (click)="cancelarPago()"
            styleClass="px-6 py-2 hover:scale-105 transition-transform"
          ></p-button>
          
          <p-button 
            [label]="procesandoPago ? 'Procesando...' : 'Confirmar Venta'" 
            [icon]="procesandoPago ? 'pi pi-spin pi-spinner' : 'pi pi-check'" 
            severity="success"
            [loading]="procesandoPago"
            [disabled]="!isPagoValid()"
            (click)="procesarVenta()"
            styleClass="px-8 py-2 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 hover:scale-105 transition-all duration-300 shadow-lg"
          ></p-button>
        </div>
      </div>
    </ng-template>
  </p-dialog>