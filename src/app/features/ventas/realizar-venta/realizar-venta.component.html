<!-- Toast y confirmaciones con animaciones mejoradas -->
<p-confirmDialog 
  [style]="{width: '500px'}"
  styleClass="custom-confirm-dialog"
  role="dialog"
  aria-modal="true">
</p-confirmDialog>

  <app-toast-notification 
    [toasts]="toastService.getCurrentToasts()"
    (toastDismissed)="onToastDismissed($event)"
  ></app-toast-notification>

<!-- Skeleton Loader para estados de carga -->
<app-skeleton-loader 
  *ngIf="isLoading"
  [showHeader]="true"
  [showCards]="true"
  [cardCount]="4">
</app-skeleton-loader>

<!-- Contenedor Principal con Centrado Condicional -->
<div [class]="!cajaAbierta ? 'min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-blue-900 dark:to-indigo-900 p-4' : 'min-h-screen'">

  <!-- Header Componente Modular -->
  <app-header-ventas
    *ngIf="!isLoading"
    [cajaAbierta]="cajaAbierta"
    [totalVentasDelDia]="getTotalVentasDelDia()"
    [contarVentasDelDia]="contarVentasDelDia()"
    [promedioVenta]="getPromedioVenta()"
    [currentTime]="getCurrentTime()"
    (irAPOS)="irAPOS()"
    (imprimirReporteCaja)="imprimirReporteCaja()"
    (verTotalesDelDia)="verTotalesDelDia()"
    (cerrarCaja)="cerrarCaja()"
    (abrirCaja)="abrirCaja()">
  </app-header-ventas>

<!-- Navegaci√≥n por pesta√±as - Solo cuando la caja est√° abierta -->
<div *ngIf="cajaAbierta" class="relative mb-6 h-full flex flex-col">
  <!-- Container Principal Moderno - Ocupar todo el espacio -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex-1 flex flex-col min-h-[calc(100vh-280px)]">
    
    <!-- Barra de Estado Simplificada -->
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6">
          <!-- Estado de Conexi√≥n -->
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
            <span class="text-sm font-medium text-gray-700">Sistema Activo</span>
          </div>
          
          <!-- Cliente Actual -->
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <i class="pi pi-user text-gray-400"></i>
            <span>{{clienteSeleccionado ? clienteSeleccionado.nombres + ' ' + clienteSeleccionado.apellidos : 'Sin cliente seleccionado'}}</span>
          </div>
          
          <!-- Carrito Info -->
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <i class="pi pi-shopping-bag text-gray-400"></i>
            <span>{{carrito.length}} art√≠culo{{carrito.length !== 1 ? 's' : ''}}</span>
            <span *ngIf="totalVenta > 0" class="text-blue-600 font-medium">- {{formatearMoneda(totalVenta)}}</span>
          </div>
        </div>
        
        <!-- Informaci√≥n Temporal -->
        <div class="flex items-center gap-3 text-sm text-gray-500">
          <span>{{getCurrentTime() | date:'HH:mm'}}</span>
          <span class="text-gray-300">‚Ä¢</span>
          <span>{{getCurrentTime() | date:'dd/MM/yyyy'}}</span>
        </div>
      </div>
    </div>

    <!-- TabView Moderno con Dise√±o Mejorado - Ocupar todo el espacio -->
    <p-tabView 
      [(activeIndex)]="activeTabIndex" 
      styleClass="modern-tabs-enhanced full-height"
      (onChange)="onTabChange($event)"
      [scrollable]="true"
      class="bg-white flex-1 flex flex-col"
      >
    
      <!-- PESTA√ëA 1: PUNTO DE VENTA -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <!-- Contenedor principal del tab -->
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- √çcono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 0">
                  <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-shopping-cart text-white text-lg font-bold"></i>
                  </div>
                  <!-- Badge din√°mico de productos en carrito -->
                  <div *ngIf="carrito.length > 0" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-red-500 to-red-600 
                              text-white text-xs font-bold rounded-full flex items-center justify-center 
                              shadow-lg animate-pulse border-2 border-white">
                    {{carrito.length}}
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 0">
                  Punto de Venta
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 0">
                  {{totalVenta > 0 ? formatearMoneda(totalVenta) : 'Seleccionar productos'}}
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 0">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
              </div>
              
              <!-- L√≠nea de activaci√≥n -->
              <div *ngIf="activeTabIndex === 0" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-blue-500 to-blue-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>

        <div class="tab-content-container-fullheight">
          <app-pos-ventas 
            (procesarPago)="onProcesarPagoDesdePOS($any($event))">
          </app-pos-ventas>
        </div>
      </p-tabPanel>

      <!-- PESTA√ëA 2: HISTORIAL -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- √çcono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 1">
                  <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-history text-white text-lg font-bold"></i>
                  </div>
                  <!-- Badge de pendientes -->
                  <div *ngIf="ventasPendientesCount > 0" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-orange-500 to-orange-600 
                              text-white text-xs font-bold rounded-full flex items-center justify-center 
                              shadow-lg animate-bounce border-2 border-white">
                    {{ventasPendientesCount}}
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 1">
                  Historial de Ventas
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 1">
                  {{ventasFiltradas.length || 0}} transacciones registradas
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 1">
                <div class="w-3 h-3 bg-indigo-500 rounded-full" 
                     [class.animate-pulse]="ventasPendientesCount > 0"></div>
              </div>
              
              <!-- L√≠nea de activaci√≥n -->
              <div *ngIf="activeTabIndex === 1" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-indigo-500 to-indigo-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>
      
        <div class="tab-content-container-fullheight">
          <app-historial-ventas></app-historial-ventas>
        </div>
      </p-tabPanel>
      
      <!-- PESTA√ëA 3: REPORTES -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- √çcono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 2">
                  <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-chart-line text-white text-lg font-bold"></i>
                  </div>
                  <!-- Indicador de carga -->
                  <div *ngIf="loadingReportes" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-blue-500 to-blue-600 
                              rounded-full flex items-center justify-center border-2 border-white">
                    <i class="pi pi-spin pi-spinner text-white text-xs"></i>
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 2">
                  Reportes y Analytics
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 2">
                  An√°lisis detallado y estad√≠sticas
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 2">
                <div class="w-3 h-3 bg-emerald-500 rounded-full" 
                     [class.animate-pulse]="loadingReportes"></div>
              </div>
              
              <!-- L√≠nea de activaci√≥n -->
              <div *ngIf="activeTabIndex === 2" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-emerald-500 to-emerald-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>
      
        <div class="tab-content-container-fullheight">
          <app-reporte-ventas></app-reporte-ventas>
        </div>
      </p-tabPanel>
      
      <!-- PESTA√ëA 4: CONFIGURACI√ìN -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- √çcono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 3">
                  <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-cog text-white text-lg font-bold"></i>
                  </div>
                  <!-- Badge de configuraciones pendientes -->
                  <div *ngIf="configPendientes > 0" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-yellow-500 to-yellow-600 
                              text-white text-xs font-bold rounded-full flex items-center justify-center 
                              shadow-lg animate-pulse border-2 border-white">
                    {{configPendientes}}
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 3">
                  Configuraci√≥n
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 3">
                  Ajustes y preferencias del sistema
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 3">
                <div class="w-3 h-3 bg-purple-500 rounded-full" 
                     [class.animate-pulse]="configPendientes > 0"></div>
              </div>
              
              <!-- L√≠nea de activaci√≥n -->
              <div *ngIf="activeTabIndex === 3" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-purple-500 to-purple-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>
        
        <div class="tab-content-container-fullheight">
          <app-configuracion></app-configuracion>
        </div>
      </p-tabPanel>
    </p-tabView>
    
    <!-- Barra de Acciones Simplificada -->
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
      <div class="flex items-center justify-between">
        <!-- Estado actual -->
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
          <span class="text-sm font-medium text-gray-700">{{getTabStatus()}}</span>
        </div>
        
        <!-- Acciones principales -->
        <div class="flex items-center gap-2">
          <!-- Refrescar -->
          <button 
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
            pTooltip="Actualizar (F5)"
            (click)="refrescarPestanaActual()">
            <i class="pi pi-refresh text-sm"></i>
          </button>
          
          <!-- Ayuda -->
          <button 
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
            pTooltip="Ayuda"
            (click)="mostrarAyuda()">
            <i class="pi pi-question-circle text-sm"></i>
          </button>
          
          <!-- Cerrar sesi√≥n -->
          <button 
            class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors text-sm font-medium"
            (click)="cerrarCaja()">
            Finalizar Sesi√≥n
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Navegaci√≥n M√≥vil Moderna y Mejorada -->
  <div class="fixed bottom-4 left-1/2 transform -translate-x-1/2 md:hidden z-50 w-full max-w-sm px-4">
    <!-- Container principal con glassmorphism -->
    <div class="bg-white/90 backdrop-blur-lg border border-gray-200/50 rounded-3xl shadow-2xl p-3">
      <div class="flex items-center justify-between gap-2">
        <button 
          *ngFor="let tab of tabsInfo; let i = index"
          (click)="activeTabIndex = i"
          [class]="'relative flex-1 flex flex-col items-center py-3 px-2 rounded-2xl transition-all duration-300 transform ' + 
                   (activeTabIndex === i ? 
                   'bg-gradient-to-br from-blue-500 to-blue-600 text-white shadow-lg scale-105' : 
                   'text-gray-500 hover:bg-gray-100 hover:text-gray-700 active:scale-95')">
          
          <!-- √çcono principal -->
          <div class="relative">
            <i [class]="tab.icon + ' text-xl font-bold mb-1'"></i>
            
            <!-- Badges espec√≠ficos para m√≥vil -->
            <div *ngIf="i === 0 && carrito.length > 0" 
                 class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 text-white text-xs 
                        font-bold rounded-full flex items-center justify-center 
                        shadow-md animate-pulse border border-white">
              {{carrito.length}}
            </div>
            
            <div *ngIf="i === 1 && ventasPendientesCount > 0" 
                 class="absolute -top-2 -right-2 w-5 h-5 bg-orange-500 text-white text-xs 
                        font-bold rounded-full flex items-center justify-center 
                        shadow-md animate-bounce border border-white">
              {{ventasPendientesCount}}
            </div>
            
            <div *ngIf="i === 2 && loadingReportes" 
                 class="absolute -top-2 -right-2 w-5 h-5 bg-blue-500 rounded-full 
                        flex items-center justify-center border border-white">
              <i class="pi pi-spin pi-spinner text-white text-xs"></i>
            </div>
            
            <div *ngIf="i === 3 && configPendientes > 0" 
                 class="absolute -top-2 -right-2 w-5 h-5 bg-yellow-500 text-white text-xs 
                        font-bold rounded-full flex items-center justify-center 
                        shadow-md animate-pulse border border-white">
              {{configPendientes}}
            </div>
          </div>
          
          <!-- Label abreviado para m√≥vil -->
          <span class="text-xs font-medium truncate max-w-full">
            {{tab.shortLabel || tab.label}}
          </span>
          
          <!-- Indicador de activaci√≥n -->
          <div *ngIf="activeTabIndex === i" 
               class="absolute -bottom-1 left-1/2 transform -translate-x-1/2 
                      w-8 h-1 bg-white rounded-full shadow-sm">
          </div>
        </button>
      </div>
      
      <!-- Indicador de conexi√≥n en m√≥vil -->
      <div class="flex items-center justify-center mt-2 pt-2 border-t border-gray-200/50">
        <div class="flex items-center gap-2 text-xs text-gray-500">
          <div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div>
          <span>Sistema Activo</span>
          <span class="text-gray-300">‚Ä¢</span>
          <span>{{getCurrentTime() | date:'HH:mm'}}</span>
        </div>
      </div>
    </div>
  </div>
  
</div>


<!-- DI√ÅLOGO: DEVOLUCIONES - SECCI√ìN CORREGIDA -->
<p-dialog 
  [(visible)]="devolucionDialog" 
  [header]="'Procesar Devoluci√≥n'" 
  [modal]="true" 
  [style]="{width: '800px'}" 
  [draggable]="false" 
  [resizable]="false"
  styleClass="border-0 shadow-2xl"
>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-2 rounded-lg">
        <i class="pi pi-refresh text-white text-xl"></i>
      </div>
      <span class="font-bold text-xl">Procesar Devoluci√≥n</span>
    </div>
  </ng-template>
  
  <div *ngIf="ventaDevolucion" class="p-5">
    <!-- Informaci√≥n de la venta -->
    <div class="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
      <h4 class="font-bold text-blue-800 mb-2">Informaci√≥n de la Venta</h4>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div><strong>N¬∞ Venta:</strong> {{ventaDevolucion.numeroVenta}}</div>
        <div><strong>Fecha:</strong> {{ventaDevolucion.fechaCreacion | date:'dd/MM/yyyy'}}</div>
        <div><strong>Cliente:</strong> {{ventaDevolucion.cliente.nombres}} {{ventaDevolucion.cliente.apellidos}}</div>
        <div><strong>Total:</strong> {{formatearMoneda(ventaDevolucion.total)}}</div>
      </div>
    </div>
    
    <!-- Productos a devolver -->
    <div class="mb-4">
      <h4 class="font-bold text-neutral-800 mb-3">Seleccionar Productos a Devolver</h4>
      
      <div class="space-y-3">
        <div *ngFor="let item of itemsDevolucion" 
             class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <div class="flex items-center gap-4">
            <!-- Checkbox de selecci√≥n -->
            <p-checkbox 
              [(ngModel)]="item.seleccionado" 
              [binary]="true"
            />
            
            <!-- Informaci√≥n del producto -->
            <div class="flex-1">
              <div class="font-semibold">{{item.producto.nombre}}</div>
              <div class="text-sm text-neutral-600">
                {{item.color.nombre}} - {{item.talla.numero}} - {{item.producto.codigo}}
              </div>
              <div class="text-sm">
                <span class="text-neutral-500">Cantidad vendida:</span> 
                <span class="font-mono font-semibold">{{item.cantidad}}</span>
              </div>
            </div>
            
            <!-- Cantidad a devolver -->
            <div class="w-32">
              <label for="cantidadDevolver" class="text-xs text-neutral-600 block mb-1">Cant. a devolver</label>
              <p-inputNumber 
                [(ngModel)]="item.cantidadDevolver" 
                [min]="0" 
                [max]="item.cantidad"
                [disabled]="!item.seleccionado"
                styleClass="w-full"
                [showButtons]="true"
                buttonLayout="horizontal"
              />
            </div>
            
            <!-- Precio -->
            <div class="w-24 text-right">
              <div class="text-sm text-neutral-500">Precio Unit.</div>
              <div class="font-semibold">{{formatearMoneda(item.precioUnitario)}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Motivo de devoluci√≥n -->
    <div class="mb-4">
      <label for="motivoDevolucion" class="flex text-sm font-medium text-neutral-700 mb-2">
        <i class="pi pi-comment text-orange-600 mr-2"></i>
        Motivo de la Devoluci√≥n
      </label>
      <textarea 
        pInputTextarea 
        [(ngModel)]="motivoDevolucion" 
        placeholder="Explique el motivo de la devoluci√≥n..."
        rows="3"
        class="w-full"
        required
      ></textarea>
    </div>
    
    <!-- Resumen de devoluci√≥n -->
    <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
      <h5 class="font-semibold text-orange-800 mb-2">Resumen de Devoluci√≥n</h5>
      <div class="text-sm space-y-1">
        <div class="flex justify-between">
          <span>Items seleccionados:</span>
          <span class="font-semibold">{{getItemsSeleccionados()}}</span>
        </div>
        <div class="flex justify-between">
          <span>Cantidad total a devolver:</span>
          <span class="font-semibold">{{getCantidadTotalDevolver()}}</span>
        </div>
        <div class="flex justify-between font-bold text-lg pt-2 border-t border-orange-300">
          <span>Monto a devolver:</span>
          <span class="text-orange-600">{{formatearMoneda(getMontoTotalDevolver())}}</span>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between gap-3 px-3">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        [outlined]="true"
        (click)="devolucionDialog = false"
      />
      
      <p-button 
        label="Procesar Devoluci√≥n" 
        icon="pi pi-check" 
        severity="danger"
        [disabled]="!isDevolucionValid()"
        (click)="procesarDevolucion()"
      />
    </div>
  </ng-template>
</p-dialog>

<!-- DIALOGO: DASHBOARD GERENCIAL  -->
<p-dialog 
  [(visible)]="showDashboard" 
  [modal]="true" 
  [closable]="true"
  [maximizable]="true"
  [style]="{width: '95vw', height: '90vh'}" 
  styleClass="dashboard-modal-empresarial"
  header="üìä Dashboard Analytics">
  
  <div class="dashboard-content p-6 h-full overflow-auto">
    
    <!-- KPIs Principales usando tu interfaz -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      
      <div *ngFor="let metrica of metricas" 
           class="bg-gradient-to-br {{getColorMetrica(metrica.color)}} rounded-2xl p-6 text-white shadow-xl relative overflow-hidden">
        
        <!-- Loading overlay -->
        <div *ngIf="metrica.loading" 
             class="absolute inset-0 bg-black/20 flex items-center justify-center backdrop-blur-sm">
          <i class="pi pi-spin pi-spinner text-2xl"></i>
        </div>
        
        <!-- Header de la m√©trica -->
        <div class="flex items-center justify-between mb-4">
          <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
            <i class="pi {{metrica.icono}} text-2xl"></i>
          </div>
          
          <!-- Tendencia -->
          <div *ngIf="metrica.tendencia" class="text-right">
            <div class="text-xs opacity-80">{{metrica.tendencia.periodo}}</div>
            <div class="flex items-center gap-1 text-lg font-bold opacity-90">
              <i class="pi {{getIconoTendencia(metrica.tendencia)}} text-sm"></i>
              {{metrica.tendencia.porcentaje}}%
            </div>
          </div>
        </div>
        
        <!-- Valor principal -->
        <div class="text-3xl font-bold mb-2">
            <span *ngIf="typeof metrica.valor === 'number'">
            {{metrica.categoria === 'ventas' || metrica.categoria === 'financiero' ? 
                formatearMoneda(typeof metrica.valor === 'number' ? metrica.valor : +metrica.valor) : 
                metrica.valor}}
          </span>
          <span *ngIf="typeof metrica.valor === 'string'">{{metrica.valor}}</span>
        </div>
        
        <!-- T√≠tulo -->
        <div class="text-sm opacity-90 mb-2">{{metrica.titulo}}</div>
        
        <!-- Objetivo si existe -->
        <div *ngIf="metrica.objetivo" class="text-xs opacity-70">
          Meta: {{metrica.categoria === 'ventas' || metrica.categoria === 'financiero' ? formatearMoneda(metrica.objetivo.valor) : metrica.objetivo.valor}} 
          ({{metrica.objetivo.progreso.toFixed(1)}}%)
        </div>
        
        <!-- Alerta cr√≠tica -->
        <div *ngIf="metrica.alertaCritica?.activa" 
             class="mt-2 bg-red-500/30 border border-red-300 rounded-lg p-2">
          <div class="flex items-center gap-2 text-xs">
            <i class="pi pi-exclamation-triangle"></i>
            {{metrica.alertaCritica?.mensaje}}
          </div>
        </div>
        
        <!-- √öltima actualizaci√≥n -->
        <div class="absolute bottom-2 right-2 text-xs opacity-60">
          {{metrica.ultimaActualizacion | date:'HH:mm:ss'}}
        </div>
      </div>
    </div>
    
    <!-- Detalles expandidos -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      
      <!-- Desglose de Ventas -->
      <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-800">üí∞ Desglose de Ventas</h3>
          <button class="text-sm text-blue-600 hover:text-blue-800" 
                  (click)="verDetalleVentas()">
            Ver detalle
          </button>
        </div>
        
        <div *ngFor="let item of metricas[0]?.desglose" 
             class="flex items-center justify-between py-3 border-b border-gray-100 last:border-b-0">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded-full" [style.background-color]="item.color"></div>
            <span class="font-medium text-gray-700">{{item.label}}</span>
          </div>
          <div class="text-right">
            <div class="font-bold text-gray-800">{{formatearMoneda(item.valor)}}</div>
            <div class="text-xs text-gray-500">{{item.porcentaje}}%</div>
          </div>
        </div>
        
        <!-- Gr√°fico placeholder -->
        <div class="mt-4 h-32 bg-gray-50 rounded-lg flex items-center justify-center">
          <span class="text-gray-400 text-sm">üìä Gr√°fico circular pr√≥ximamente</span>
        </div>
      </div>
      
      <!-- Productos por Categor√≠a -->
      <div class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
        <div class="flex items-center justify-between mb-6">
          <h3 class="text-xl font-bold text-gray-800">üì¶ Productos por Categor√≠a</h3>
          <button class="text-sm text-blue-600 hover:text-blue-800" 
                  (click)="verStockCritico()">
            Stock cr√≠tico
          </button>
        </div>
        
        <div *ngFor="let item of metricas[3]?.desglose" 
             class="flex items-center justify-between py-3">
          <div class="flex items-center gap-3">
            <div class="w-4 h-4 rounded-full" [style.background-color]="item.color"></div>
            <span class="font-medium text-gray-700">{{item.label}}</span>
          </div>
          <div class="text-right">
            <div class="font-bold text-gray-800">{{item.valor}} uds</div>
            <div class="text-xs text-gray-500">{{item.porcentaje}}%</div>
          </div>
        </div>
        
        <!-- Barra de progreso total -->
        <div class="mt-4 bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-500 to-green-500 h-2 rounded-full" 
               style="width: 87%"></div>
        </div>
        <div class="text-xs text-gray-500 mt-1 text-center">87% del objetivo diario</div>
      </div>
    </div>
    
    <!-- M√©tricas adicionales -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      
      <div *ngFor="let metrica of metricas" class="bg-white rounded-2xl p-6 shadow-lg border border-gray-100">
        <div class="flex items-center gap-2 mb-4">
          <div class="w-8 h-8 bg-{{metrica.color === 'success' ? 'green' : metrica.color === 'info' ? 'blue' : metrica.color === 'warning' ? 'orange' : 'purple'}}-500 rounded-lg flex items-center justify-center">
            <i class="pi {{metrica.icono}} text-white text-sm"></i>
          </div>
          <h4 class="font-bold text-gray-800">{{metrica.titulo}}</h4>
        </div>
        
        <div *ngIf="metrica.metricas" class="space-y-2">
          <div *ngFor="let submetrica of metrica.metricas" 
               class="flex justify-between items-center text-sm">
            <span class="text-gray-600 flex items-center gap-1">
              <i *ngIf="submetrica.icono" class="pi {{submetrica.icono}} text-xs"></i>
              {{submetrica.label}}
            </span>
            <span class="font-medium text-gray-800">{{submetrica.valor}}</span>
          </div>
        </div>
        
        <!-- Bot√≥n de acci√≥n -->
        <button *ngIf="metrica.accionPrincipal" 
                class="mt-4 w-full bg-blue-50 hover:bg-blue-100 text-blue-700 py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2"
                [disabled]="metrica.accionPrincipal.disabled"
                (click)="metrica.accionPrincipal.callback()">
          <i class="pi {{metrica.accionPrincipal.icono}}"></i>
          {{metrica.accionPrincipal.label}}
        </button>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="flex items-center gap-2 text-sm text-gray-500">
        <i class="pi pi-refresh animate-spin"></i>
        Actualizando cada 30 segundos
      </div>
      <div class="flex gap-2">
        <p-button label="Exportar Reporte" icon="pi pi-download" [outlined]="true" 
                  (click)="exportarReporte('reporte')"></p-button>
        <p-button label="Actualizar" icon="pi pi-refresh" severity="info" [outlined]="true"
                  (click)="actualizarTodasLasMetricas()"></p-button>
        <p-button label="Cerrar" icon="pi pi-times" (click)="showDashboard = false"></p-button>
      </div>
    </div>
  </ng-template>
</p-dialog>  

<!-- Men√∫ contextual para ventas -->
<p-menu #menuAcciones [popup]="true" [model]="itemsMenuAcciones"></p-menu>


</div> <!-- Fin del contenedor principal con centrado condicional -->

