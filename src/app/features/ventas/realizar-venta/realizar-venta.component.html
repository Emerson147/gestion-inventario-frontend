<!-- Toast y confirmaciones con animaciones mejoradas -->
<p-confirmDialog 
  [style]="{width: '500px'}"
  styleClass="custom-confirm-dialog"
  role="dialog"
  aria-modal="true">
</p-confirmDialog>

  <app-toast-notification 
    [toasts]="toastService.getCurrentToasts()"
    (toastDismissed)="onToastDismissed($event)"
  ></app-toast-notification>

<!-- Skeleton Loader para estados de carga -->
<app-skeleton-loader 
  *ngIf="isLoading"
  [showHeader]="true"
  [showCards]="true"
  [cardCount]="4">
</app-skeleton-loader>

<!-- Contenedor Principal con Centrado Condicional -->
<div [class]="!cajaAbierta ? 'min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 dark:from-gray-900 dark:via-blue-900 dark:to-indigo-900 p-4' : 'min-h-screen'">

  <!-- Header Componente Modular -->
  <app-header-ventas
    *ngIf="!isLoading"
    [cajaAbierta]="cajaAbierta"
    [totalVentasDelDia]="getTotalVentasDelDia()"
    [contarVentasDelDia]="contarVentasDelDia()"
    [promedioVenta]="getPromedioVenta()"
    [currentTime]="getCurrentTime()"
    (irAPOS)="irAPOS()"
    (imprimirReporteCaja)="imprimirReporteCaja()"
    (verTotalesDelDia)="verTotalesDelDia()"
    (cerrarCaja)="cerrarCaja()"
    (abrirCaja)="abrirCaja()">
  </app-header-ventas>

<!-- Navegación por pestañas - Solo cuando la caja está abierta -->
<div *ngIf="cajaAbierta" class="relative mb-6 h-full flex flex-col">
  <!-- Container Principal Moderno - Ocupar todo el espacio -->
  <div class="bg-white border border-gray-200 rounded-xl shadow-sm overflow-hidden flex-1 flex flex-col min-h-[calc(100vh-280px)]">
    
    <!-- Barra de Estado Simplificada -->
    <div class="bg-gray-50 px-4 py-3 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-6">
          <!-- Estado de Conexión -->
          <div class="flex items-center gap-2">
            <div class="w-2 h-2 bg-emerald-500 rounded-full"></div>
            <span class="text-sm font-medium text-gray-700">Sistema Activo</span>
          </div>
          
          <!-- Cliente Actual -->
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <i class="pi pi-user text-gray-400"></i>
            <span>{{clienteSeleccionado ? clienteSeleccionado.nombres + ' ' + clienteSeleccionado.apellidos : 'Sin cliente seleccionado'}}</span>
          </div>
          
          <!-- Carrito Info -->
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <i class="pi pi-shopping-bag text-gray-400"></i>
            <span>{{carrito.length}} artículo{{carrito.length !== 1 ? 's' : ''}}</span>
            <span *ngIf="totalVenta > 0" class="text-blue-600 font-medium">- {{formatearMoneda(totalVenta)}}</span>
          </div>
        </div>
        
        <!-- Información Temporal -->
        <div class="flex items-center gap-3 text-sm text-gray-500">
          <span>{{getCurrentTime() | date:'HH:mm'}}</span>
          <span class="text-gray-300">•</span>
          <span>{{getCurrentTime() | date:'dd/MM/yyyy'}}</span>
        </div>
      </div>
    </div>

    <!-- TabView Moderno con Diseño Mejorado - Ocupar todo el espacio -->
    <p-tabView 
      [(activeIndex)]="activeTabIndex" 
      styleClass="modern-tabs-enhanced full-height"
      (onChange)="onTabChange($event)"
      [scrollable]="true"
      class="bg-white flex-1 flex flex-col"
      >
    
      <!-- PESTAÑA 1: PUNTO DE VENTA -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <!-- Contenedor principal del tab -->
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- Ícono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 0">
                  <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-shopping-cart text-white text-lg font-bold"></i>
                  </div>
                  <!-- Badge dinámico de productos en carrito -->
                  <div *ngIf="carrito.length > 0" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-red-500 to-red-600 
                              text-white text-xs font-bold rounded-full flex items-center justify-center 
                              shadow-lg animate-pulse border-2 border-white">
                    {{carrito.length}}
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 0">
                  Punto de Venta
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 0">
                  {{totalVenta > 0 ? formatearMoneda(totalVenta) : 'Seleccionar productos'}}
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 0">
                <div class="w-3 h-3 bg-green-500 rounded-full animate-pulse"></div>
              </div>
              
              <!-- Línea de activación -->
              <div *ngIf="activeTabIndex === 0" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-blue-500 to-blue-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>

        <div class="tab-content-container-fullheight">
          <app-pos-ventas 
            (procesarPago)="onProcesarPagoDesdePOS($any($event))">
          </app-pos-ventas>
        </div>
      </p-tabPanel>

      <!-- PESTAÑA 2: HISTORIAL -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- Ícono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 1">
                  <div class="w-10 h-10 bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-history text-white text-lg font-bold"></i>
                  </div>
                  <!-- Badge de pendientes -->
                  <div *ngIf="ventasPendientesCount > 0" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-orange-500 to-orange-600 
                              text-white text-xs font-bold rounded-full flex items-center justify-center 
                              shadow-lg animate-bounce border-2 border-white">
                    {{ventasPendientesCount}}
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 1">
                  Historial de Ventas
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 1">
                  {{ventasFiltradas.length || 0}} transacciones registradas
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 1">
                <div class="w-3 h-3 bg-indigo-500 rounded-full" 
                     [class.animate-pulse]="ventasPendientesCount > 0"></div>
              </div>
              
              <!-- Línea de activación -->
              <div *ngIf="activeTabIndex === 1" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-indigo-500 to-indigo-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>
      
        <div class="tab-content-container-fullheight">
          <app-historial-ventas></app-historial-ventas>
        </div>
      </p-tabPanel>
      
      <!-- PESTAÑA 3: REPORTES -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- Ícono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 2">
                  <div class="w-10 h-10 bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-chart-line text-white text-lg font-bold"></i>
                  </div>
                  <!-- Indicador de carga -->
                  <div *ngIf="loadingReportes" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-blue-500 to-blue-600 
                              rounded-full flex items-center justify-center border-2 border-white">
                    <i class="pi pi-spin pi-spinner text-white text-xs"></i>
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 2">
                  Reportes y Analytics
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 2">
                  Análisis detallado y estadísticas
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 2">
                <div class="w-3 h-3 bg-emerald-500 rounded-full" 
                     [class.animate-pulse]="loadingReportes"></div>
              </div>
              
              <!-- Línea de activación -->
              <div *ngIf="activeTabIndex === 2" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-emerald-500 to-emerald-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>
      
        <div class="tab-content-container-fullheight">
          <app-reporte-ventas></app-reporte-ventas>
        </div>
      </p-tabPanel>
      
      <!-- PESTAÑA 4: CONFIGURACIÓN -->
      <p-tabPanel>
        <ng-template pTemplate="header">
          <div class="tab-header-modern">
            <div class="flex items-center gap-3 px-6 py-4 relative">
              <!-- Ícono con indicador -->
              <div class="relative z-10">
                <div class="tab-icon-container" 
                     [class.active]="activeTabIndex === 3">
                  <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl 
                              flex items-center justify-center shadow-lg transform transition-all duration-300 
                              hover:scale-110 group-hover:shadow-xl">
                    <i class="pi pi-cog text-white text-lg font-bold"></i>
                  </div>
                  <!-- Badge de configuraciones pendientes -->
                  <div *ngIf="configPendientes > 0" 
                       class="absolute -top-2 -right-2 w-6 h-6 bg-gradient-to-r from-yellow-500 to-yellow-600 
                              text-white text-xs font-bold rounded-full flex items-center justify-center 
                              shadow-lg animate-pulse border-2 border-white">
                    {{configPendientes}}
                  </div>
                </div>
              </div>
              
              <!-- Contenido textual -->
              <div class="flex-1">
                <div class="tab-title" [class.active]="activeTabIndex === 3">
                  Configuración
                </div>
                <div class="tab-subtitle" [class.active]="activeTabIndex === 3">
                  Ajustes y preferencias del sistema
                </div>
              </div>
              
              <!-- Indicador de estado -->
              <div class="status-indicator" [class.active]="activeTabIndex === 3">
                <div class="w-3 h-3 bg-purple-500 rounded-full" 
                     [class.animate-pulse]="configPendientes > 0"></div>
              </div>
              
              <!-- Línea de activación -->
              <div *ngIf="activeTabIndex === 3" 
                   class="absolute bottom-0 left-0 right-0 h-1 
                          bg-gradient-to-r from-purple-500 to-purple-600 
                          rounded-full animate-tab-slide">
              </div>
            </div>
          </div>
        </ng-template>
        
        <div class="tab-content-container-fullheight">
          <app-configuracion></app-configuracion>
        </div>
      </p-tabPanel>
    </p-tabView>
    
    <!-- Barra de Acciones Simplificada -->
    <div class="bg-gray-50 px-4 py-3 border-t border-gray-200">
      <div class="flex items-center justify-between">
        <!-- Estado actual -->
        <div class="flex items-center gap-2">
          <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
          <span class="text-sm font-medium text-gray-700">{{getTabStatus()}}</span>
        </div>
        
        <!-- Acciones principales -->
        <div class="flex items-center gap-2">
          <!-- Refrescar -->
          <button 
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
            pTooltip="Actualizar (F5)"
            (click)="refrescarPestanaActual()">
            <i class="pi pi-refresh text-sm"></i>
          </button>
          
          <!-- Ayuda -->
          <button 
            class="p-2 text-gray-500 hover:text-gray-700 hover:bg-gray-200 rounded-lg transition-colors"
            pTooltip="Ayuda"
            (click)="mostrarAyuda()">
            <i class="pi pi-question-circle text-sm"></i>
          </button>
          
          <!-- Cerrar sesión -->
          <button 
            class="px-3 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors text-sm font-medium"
            (click)="cerrarCaja()">
            Finalizar Sesión
          </button>
        </div>
      </div>
    </div>
  </div>
    
</div>


<!-- DIÁLOGO: DEVOLUCIONES - SECCIÓN CORREGIDA -->
<p-dialog 
  [(visible)]="devolucionDialog" 
  [header]="'Procesar Devolución'" 
  [modal]="true" 
  [style]="{width: '800px'}" 
  [draggable]="false" 
  [resizable]="false"
  styleClass="border-0 shadow-2xl"
>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <div class="bg-gradient-to-r from-orange-500 to-orange-600 p-2 rounded-lg">
        <i class="pi pi-refresh text-white text-xl"></i>
      </div>
      <span class="font-bold text-xl">Procesar Devolución</span>
    </div>
  </ng-template>
  
  <div *ngIf="ventaDevolucion" class="p-5">
    <!-- Información de la venta -->
    <div class="bg-blue-50 rounded-lg p-4 mb-4 border border-blue-200">
      <h4 class="font-bold text-blue-800 mb-2">Información de la Venta</h4>
      <div class="grid grid-cols-2 gap-2 text-sm">
        <div><strong>N° Venta:</strong> {{ventaDevolucion.numeroVenta}}</div>
        <div><strong>Fecha:</strong> {{ventaDevolucion.fechaCreacion | date:'dd/MM/yyyy'}}</div>
        <div><strong>Cliente:</strong> {{ventaDevolucion.cliente.nombres}} {{ventaDevolucion.cliente.apellidos}}</div>
        <div><strong>Total:</strong> {{formatearMoneda(ventaDevolucion.total)}}</div>
      </div>
    </div>
    
    <!-- Productos a devolver -->
    <div class="mb-4">
      <h4 class="font-bold text-neutral-800 mb-3">Seleccionar Productos a Devolver</h4>
      
      <div class="space-y-3">
        <div *ngFor="let item of itemsDevolucion" 
             class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <div class="flex items-center gap-4">
            <!-- Checkbox de selección -->
            <p-checkbox 
              [(ngModel)]="item.seleccionado" 
              [binary]="true"
            />
            
            <!-- Información del producto -->
            <div class="flex-1">
              <div class="font-semibold">{{item.producto.nombre}}</div>
              <div class="text-sm text-neutral-600">
                {{item.color.nombre}} - {{item.talla.numero}} - {{item.producto.codigo}}
              </div>
              <div class="text-sm">
                <span class="text-neutral-500">Cantidad vendida:</span> 
                <span class="font-mono font-semibold">{{item.cantidad}}</span>
              </div>
            </div>
            
            <!-- Cantidad a devolver -->
            <div class="w-32">
              <label for="cantidadDevolver" class="text-xs text-neutral-600 block mb-1">Cant. a devolver</label>
              <p-inputNumber 
                [(ngModel)]="item.cantidadDevolver" 
                [min]="0" 
                [max]="item.cantidad"
                [disabled]="!item.seleccionado"
                styleClass="w-full"
                [showButtons]="true"
                buttonLayout="horizontal"
              />
            </div>
            
            <!-- Precio -->
            <div class="w-24 text-right">
              <div class="text-sm text-neutral-500">Precio Unit.</div>
              <div class="font-semibold">{{formatearMoneda(item.precioUnitario)}}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Motivo de devolución -->
    <div class="mb-4">
      <label for="motivoDevolucion" class="flex text-sm font-medium text-neutral-700 mb-2">
        <i class="pi pi-comment text-orange-600 mr-2"></i>
        Motivo de la Devolución
      </label>
      <textarea 
        pInputTextarea 
        [(ngModel)]="motivoDevolucion" 
        placeholder="Explique el motivo de la devolución..."
        rows="3"
        class="w-full"
        required
      ></textarea>
    </div>
    
    <!-- Resumen de devolución -->
    <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
      <h5 class="font-semibold text-orange-800 mb-2">Resumen de Devolución</h5>
      <div class="text-sm space-y-1">
        <div class="flex justify-between">
          <span>Items seleccionados:</span>
          <span class="font-semibold">{{getItemsSeleccionados()}}</span>
        </div>
        <div class="flex justify-between">
          <span>Cantidad total a devolver:</span>
          <span class="font-semibold">{{getCantidadTotalDevolver()}}</span>
        </div>
        <div class="flex justify-between font-bold text-lg pt-2 border-t border-orange-300">
          <span>Monto a devolver:</span>
          <span class="text-orange-600">{{formatearMoneda(getMontoTotalDevolver())}}</span>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between gap-3 px-3">
      <p-button 
        label="Cancelar" 
        icon="pi pi-times" 
        severity="secondary"
        [outlined]="true"
        (click)="devolucionDialog = false"
      />
      
      <p-button 
        label="Procesar Devolución" 
        icon="pi pi-check" 
        severity="danger"
        [disabled]="!isDevolucionValid()"
        (click)="procesarDevolucion()"
      />
    </div>
  </ng-template>
</p-dialog>

 
<!-- Menú contextual para ventas -->
<p-menu #menuAcciones [popup]="true" [model]="itemsMenuAcciones"></p-menu>


</div> <!-- Fin del contenedor principal con centrado condicional -->

