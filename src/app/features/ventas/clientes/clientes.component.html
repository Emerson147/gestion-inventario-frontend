<!-- Zen Garden Sticky Header -->
<header
  class="sticky top-0 z-50 bg-surface-0/80 dark:bg-surface-900/80 backdrop-blur-xl border-b border-surface-200 dark:border-surface-800 transition-all duration-300 ease-out mb-6"
>
  <div class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 py-4">
    <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
      <!-- Branding & Title -->
      <div class="flex items-center gap-4 w-full sm:w-auto">
        <div class="relative group cursor-pointer">
          <div
            class="absolute inset-0 bg-blue-500/20 rounded-2xl blur-lg opacity-0 group-hover:opacity-100 transition-all duration-500 ease-out"
          ></div>
          <div
            class="relative w-12 h-12 rounded-2xl bg-gradient-to-br from-blue-500 to-indigo-600 text-white flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-300 hover:-translate-y-1"
          >
            <i
              class="pi pi-users text-xl transform group-hover:rotate-12 transition-transform duration-300"
            ></i>
          </div>
        </div>

        <div class="flex-1 min-w-0">
          <h1
            class="text-xl sm:text-2xl font-bold text-surface-900 dark:text-surface-0 tracking-tight leading-none mb-1"
          >
            Cartera de Clientes
          </h1>
          <div
            class="flex items-center gap-2 text-xs font-medium text-surface-600 dark:text-surface-400"
          >
            <span
              class="bg-surface-50 dark:bg-surface-800 px-2.5 py-1 rounded-lg text-[10px] font-bold uppercase tracking-wider border border-surface-200 dark:border-surface-700"
            >
              Ventas
            </span>
            <span
              class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"
            ></span>
            <span class="truncate"> Gestión & Fidelización </span>
          </div>
        </div>
      </div>

      <!-- Global Stats & System Info (Desktop) -->
      <div class="hidden md:flex items-center gap-4">
        <div
          class="flex gap-4 px-4 py-2 bg-surface-50 dark:bg-surface-800/50 rounded-2xl border border-surface-200 dark:border-surface-700/50"
        >
          <div class="flex flex-col items-center">
            <span
              class="text-[10px] font-bold text-surface-400 uppercase tracking-wider"
              >Total</span
            >
            <span
              class="text-lg font-bold text-surface-900 dark:text-surface-0"
              >{{ getMetricasZapateria().total }}</span
            >
          </div>
          <div class="w-px h-full bg-surface-200 dark:bg-surface-700"></div>
          <div class="flex flex-col items-center">
            <span
              class="text-[10px] font-bold text-emerald-500 uppercase tracking-wider"
              >Activos</span
            >
            <span
              class="text-lg font-bold text-emerald-600 dark:text-emerald-400"
              >{{ getMetricasZapateria().activos }}</span
            >
          </div>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- Toast & Confirm -->
<p-toast position="top-right" [life]="4000" styleClass="custom-toast" />
<p-confirmDialog
  [style]="{ width: '450px' }"
  styleClass="custom-confirm-dialog"
></p-confirmDialog>

<!-- KPI Scrollable Section -->
<section class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 mb-8">
  <div class="overflow-x-auto pb-4 pt-2 -mx-4 px-4 sm:mx-0 sm:px-0">
    <div class="flex gap-4 min-w-max">
      <!-- KPI Cards with Zen Design -->
      <div
        class="p-5 rounded-[2rem] bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 shadow-sm min-w-[200px] flex items-center gap-4 group hover:-translate-y-1 transition-transform duration-300"
      >
        <div
          class="w-12 h-12 rounded-2xl bg-emerald-50 dark:bg-emerald-900/20 flex items-center justify-center text-emerald-600 dark:text-emerald-400 group-hover:scale-110 transition-transform"
        >
          <i class="pi pi-check-circle text-xl"></i>
        </div>
        <div>
          <p
            class="text-xs text-surface-500 dark:text-surface-400 font-medium uppercase tracking-wide"
          >
            Fidelidad
          </p>
          <p class="text-2xl font-black text-surface-900 dark:text-surface-0">
            {{ getMetricasZapateria().porcentajeActivos }}%
          </p>
        </div>
      </div>

      <div
        class="p-5 rounded-[2rem] bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 shadow-sm min-w-[200px] flex items-center gap-4 group hover:-translate-y-1 transition-transform duration-300"
      >
        <div
          class="w-12 h-12 rounded-2xl bg-amber-50 dark:bg-amber-900/20 flex items-center justify-center text-amber-600 dark:text-amber-400 group-hover:scale-110 transition-transform"
        >
          <i class="pi pi-crown text-xl"></i>
        </div>
        <div>
          <p
            class="text-xs text-surface-500 dark:text-surface-400 font-medium uppercase tracking-wide"
          >
            Clientes VIP
          </p>
          <p class="text-2xl font-black text-surface-900 dark:text-surface-0">
            {{ getMetricasZapateria().clientesVIP }}
          </p>
        </div>
      </div>

      <div
        class="p-5 rounded-[2rem] bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 shadow-sm min-w-[220px] flex items-center gap-4 group hover:-translate-y-1 transition-transform duration-300"
      >
        <div
          class="w-12 h-12 rounded-2xl bg-purple-50 dark:bg-purple-900/20 flex items-center justify-center text-purple-600 dark:text-purple-400 group-hover:scale-110 transition-transform"
        >
          <i class="pi pi-money-bill text-xl"></i>
        </div>
        <div>
          <p
            class="text-xs text-surface-500 dark:text-surface-400 font-medium uppercase tracking-wide"
          >
            Valor Cartera
          </p>
          <p
            class="text-2xl font-black text-surface-900 dark:text-surface-0 font-mono tracking-tight"
          >
            {{
              getAnalisisValorCliente().totalVentas
                | currency: "S/. " : "symbol" : "1.0-0"
            }}
          </p>
        </div>
      </div>

      <div
        class="p-5 rounded-[2rem] bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 shadow-sm min-w-[200px] flex items-center gap-4 group hover:-translate-y-1 transition-transform duration-300"
      >
        <div
          class="w-12 h-12 rounded-2xl bg-orange-50 dark:bg-orange-900/20 flex items-center justify-center text-orange-600 dark:text-orange-400 group-hover:scale-110 transition-transform"
        >
          <i class="pi pi-chart-line text-xl"></i>
        </div>
        <div>
          <p
            class="text-xs text-surface-500 dark:text-surface-400 font-medium uppercase tracking-wide"
          >
            Ticket Prom.
          </p>
          <p class="text-2xl font-black text-surface-900 dark:text-surface-0">
            {{ getMetricasZapateria().promedioCompras | number: "1.1-1" }}
          </p>
        </div>
      </div>

      <div
        *ngIf="selectedClientes.length"
        class="p-5 rounded-[2rem] bg-indigo-50 dark:bg-indigo-900/10 border border-indigo-100 dark:border-indigo-800 shadow-sm min-w-[180px] flex items-center gap-4 animate-fade-in"
      >
        <div
          class="w-12 h-12 rounded-2xl bg-indigo-100 dark:bg-indigo-900/30 flex items-center justify-center text-indigo-600 dark:text-indigo-400"
        >
          <i class="pi pi-check-square text-xl"></i>
        </div>
        <div>
          <p class="text-xs text-indigo-500 font-bold uppercase tracking-wide">
            Selección
          </p>
          <p class="text-2xl font-black text-indigo-700 dark:text-indigo-300">
            {{ selectedClientes.length }}
          </p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Zen Toolbar -->
<section class="max-w-[1920px] mx-auto px-4 sm:px-6 lg:px-8 mb-8">
  <div
    class="bg-white dark:bg-surface-900 rounded-[2rem] p-4 shadow-sm border border-surface-200 dark:border-surface-800 flex flex-col xl:flex-row items-center justify-between gap-4 transition-all duration-300"
  >
    <!-- Actions Group -->
    <div
      class="flex items-center gap-3 w-full xl:w-auto overflow-x-auto no-scrollbar"
    >
      <button
        *appHasPermission="{
          module: 'clientes',
          permission: permissionTypes.CREATE,
        }"
        (click)="openNew()"
        class="h-12 px-6 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl font-bold uppercase tracking-widest hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 flex items-center gap-2 whitespace-nowrap"
      >
        <i class="pi pi-plus"></i>
        <span>Nuevo Cliente</span>
      </button>

      <div
        *ngIf="selectedClientes?.length"
        class="h-8 w-px bg-surface-200 dark:bg-surface-700 mx-1"
      ></div>

      <button
        *ngIf="selectedClientes?.length"
        (click)="eliminarSeleccionados()"
        class="h-12 px-6 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border border-red-100 dark:border-red-900/30 rounded-xl font-bold uppercase tracking-widest hover:bg-red-100 dark:hover:bg-red-900/40 transition-all duration-300 flex items-center gap-2 whitespace-nowrap animate-fade-in"
      >
        <i class="pi pi-trash"></i>
        <span>Eliminar ({{ selectedClientes.length }})</span>
      </button>
    </div>

    <!-- Filters & View Options -->
    <div
      class="flex items-center gap-3 w-full xl:w-auto justify-between xl:justify-end bg-surface-50 dark:bg-surface-800/50 p-1.5 rounded-2xl border border-surface-100 dark:border-surface-700"
    >
      <!-- View Switcher -->
      <div class="flex bg-white dark:bg-surface-900 rounded-xl p-1 shadow-sm">
        <button
          *ngFor="let option of viewOptions"
          (click)="currentView = option.value"
          class="px-4 h-9 flex items-center justify-center rounded-lg transition-all duration-300 gap-2 text-xs font-bold uppercase tracking-wider"
          [ngClass]="
            currentView === option.value
              ? 'bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 shadow-md'
              : 'text-surface-500 hover:bg-surface-50 dark:hover:bg-surface-800'
          "
          [pTooltip]="option.label"
          tooltipPosition="top"
        >
          <i [class]="option.icon"></i>
          <span class="hidden sm:inline">{{ option.label }}</span>
        </button>
      </div>

      <div class="w-px h-6 bg-surface-200 dark:bg-surface-700 mx-2"></div>

      <div class="flex gap-2">
        <button
          (click)="mostrarEstadisticas()"
          class="w-10 h-10 flex items-center justify-center rounded-xl bg-purple-50 dark:bg-purple-900/20 text-purple-600 dark:text-purple-400 hover:bg-purple-100 dark:hover:bg-purple-900/40 transition-all duration-300"
          pTooltip="Reportes y Métricas"
        >
          <i class="pi pi-chart-bar"></i>
        </button>
        <button
          (click)="exportarExcel()"
          [disabled]="uiState.isExporting"
          class="w-10 h-10 flex items-center justify-center rounded-xl bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 dark:text-emerald-400 hover:bg-emerald-100 dark:hover:bg-emerald-900/40 transition-all duration-300 disabled:opacity-50"
          pTooltip="Descargar Excel"
        >
          <i
            class="pi"
            [ngClass]="
              uiState.isExporting ? 'pi-spin pi-spinner' : 'pi-file-excel'
            "
          ></i>
        </button>
      </div>
    </div>
  </div>
</section>

<!-- Vista de Tabla Modernizada -->
<div
  *ngIf="currentView === 'table'"
  class="mb-8 hidden lg:block animate-fade-in"
>
  <div
    class="bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 rounded-[2rem] overflow-hidden shadow-sm transition-colors duration-300"
  >
    <p-table
      #dt
      [value]="clientesFiltrados"
      [rows]="DEFAULT_PAGE_SIZE"
      [paginator]="true"
      [rowsPerPageOptions]="PAGE_SIZE_OPTIONS"
      [totalRecords]="clientesFiltrados.length"
      [(selection)]="selectedClientes"
      dataKey="id"
      [loading]="uiState.isTableLoading"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} de {totalRecords}"
      [globalFilterFields]="[
        'nombres',
        'apellidos',
        'dni',
        'ruc',
        'email',
        'telefono',
      ]"
      [rowHover]="true"
      [rowTrackBy]="trackByClienteId"
      styleClass="p-datatable-lg zen-table-clean"
    >
      <ng-template pTemplate="caption">
        <div
          class="flex flex-col md:flex-row md:items-center justify-between gap-4 px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-100 dark:border-surface-800"
        >
          <div class="flex items-center gap-4">
            <div
              class="w-12 h-12 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-400 border border-surface-100 dark:border-surface-700"
            >
              <i class="pi pi-users text-xl"></i>
            </div>
            <div>
              <h3
                class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0"
              >
                Directorio de Clientes
              </h3>
              <p class="text-sm text-surface-500 dark:text-surface-400 mt-0.5">
                <span *ngIf="clientesFiltrados.length"
                  >{{ clientesFiltrados.length }} registros activos</span
                >
              </p>
            </div>
          </div>

          <div class="relative group w-full md:w-auto">
            <i
              class="pi pi-search absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 group-focus-within:text-primary-500 transition-colors text-lg z-10"
            ></i>
            <input
              pInputText
              type="text"
              (input)="onGlobalFilter($event)"
              placeholder="Buscar por nombre, DNI, RUC..."
              class="pl-12 pr-4 py-3 w-full md:w-80 bg-surface-50 dark:bg-surface-800 border-none rounded-2xl text-base focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900 transition-all shadow-inner text-surface-700 dark:text-surface-200 placeholder:text-surface-400"
            />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr
          class="bg-surface-50/50 dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800"
        >
          <th style="width: 3rem" class="text-center py-4">
            <p-tableHeaderCheckbox />
          </th>

          <th
            pSortableColumn="nombres"
            class="py-4 pl-6 text-xs font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors"
          >
            <div class="flex items-center gap-2">
              Cliente <p-sortIcon field="nombres" />
            </div>
          </th>

          <th
            pSortableColumn="dni"
            class="py-4 text-xs font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors"
          >
            Documentos
          </th>

          <th
            pSortableColumn="telefono"
            class="py-4 text-xs font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors"
          >
            Contacto
          </th>

          <th
            class="py-4 text-center text-xs font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider"
          >
            Estado
          </th>

          <th
            style="width: 10rem"
            class="py-4 text-center text-xs font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider"
          >
            Acciones
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-cliente>
        <tr
          class="group border-b border-surface-50 dark:border-surface-800/50 hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-all duration-200 last:border-0"
        >
          <td class="text-center py-4">
            <p-tableCheckbox [value]="cliente" />
          </td>

          <td class="py-4 pl-6">
            <div class="flex items-center gap-4">
              <div
                class="w-10 h-10 rounded-xl bg-gradient-to-br from-surface-100 to-surface-50 dark:from-surface-800 dark:to-surface-800 flex items-center justify-center text-surface-500 font-bold text-sm border border-surface-200 dark:border-surface-700 shadow-sm"
              >
                {{
                  (cliente.nombres.charAt(0) || "-") +
                    (cliente.apellidos.charAt(0) || "")
                }}
              </div>
              <div class="flex flex-col">
                <span
                  class="font-bold text-surface-900 dark:text-surface-0 text-sm leading-tight"
                >
                  {{ cliente.nombres }} {{ cliente.apellidos }}
                </span>
                <span
                  class="text-xs text-surface-500 flex items-center gap-1 mt-0.5"
                  *ngIf="cliente.direccion"
                >
                  <i class="pi pi-map-marker text-[10px]"></i>
                  {{ cliente.direccion }}
                </span>
                <span
                  class="text-[10px] text-surface-400 italic mt-0.5"
                  *ngIf="!cliente.direccion"
                  >Sin dirección</span
                >
              </div>
            </div>
          </td>

          <td class="py-4">
            <div class="flex flex-col gap-1.5">
              <div class="flex items-center gap-2" *ngIf="cliente.dni">
                <span
                  class="px-1.5 py-0.5 rounded-md bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-[10px] font-bold border border-blue-100 dark:border-blue-900/30 w-8 text-center uppercase"
                  >DNI</span
                >
                <span
                  class="text-sm font-mono text-surface-700 dark:text-surface-200 font-medium"
                  >{{ cliente.dni }}</span
                >
              </div>
              <div class="flex items-center gap-2" *ngIf="cliente.ruc">
                <span
                  class="px-1.5 py-0.5 rounded-md bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 text-[10px] font-bold border border-orange-100 dark:border-orange-900/30 w-8 text-center uppercase"
                  >RUC</span
                >
                <span
                  class="text-sm font-mono text-surface-700 dark:text-surface-200 font-medium"
                  >{{ cliente.ruc }}</span
                >
              </div>
              <span
                class="text-xs text-surface-400 italic"
                *ngIf="!cliente.dni && !cliente.ruc"
                >No registrado</span
              >
            </div>
          </td>

          <td class="py-4">
            <div class="flex flex-col gap-1">
              <div class="flex items-center gap-2" *ngIf="cliente.email">
                <div
                  class="w-5 h-5 rounded-full bg-surface-100 dark:bg-surface-800 flex items-center justify-center text-[10px] text-surface-500"
                >
                  <i class="pi pi-envelope"></i>
                </div>
                <span
                  class="text-sm text-surface-700 dark:text-surface-200 truncate max-w-[180px]"
                  [pTooltip]="cliente.email"
                  >{{ cliente.email }}</span
                >
              </div>
              <div class="flex items-center gap-2" *ngIf="cliente.telefono">
                <div
                  class="w-5 h-5 rounded-full bg-surface-100 dark:bg-surface-800 flex items-center justify-center text-[10px] text-surface-500"
                >
                  <i class="pi pi-phone"></i>
                </div>
                <span
                  class="text-sm text-surface-700 dark:text-surface-200 font-mono"
                  >{{ cliente.telefono }}</span
                >
              </div>
              <span
                class="text-xs text-surface-400 italic"
                *ngIf="!cliente.email && !cliente.telefono"
                >Sin contacto</span
              >
            </div>
          </td>

          <td class="py-4 text-center">
            <span
              class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-lg text-xs font-bold border"
              [ngClass]="
                cliente.estado
                  ? 'bg-emerald-50 text-emerald-700 border-emerald-100 dark:bg-emerald-900/20 dark:text-emerald-400 dark:border-emerald-900/30'
                  : 'bg-red-50 text-red-700 border-red-100 dark:bg-red-900/20 dark:text-red-400 dark:border-red-900/30'
              "
            >
              <span
                class="w-1.5 h-1.5 rounded-full"
                [ngClass]="cliente.estado ? 'bg-emerald-500' : 'bg-red-500'"
              ></span>
              {{ cliente.estado ? "Activo" : "Inactivo" }}
            </span>
          </td>

          <td class="py-4 text-center">
            <div
              class="flex gap-1 justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200"
            >
              <button
                (click)="verDetallesCliente(cliente)"
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 text-surface-400 hover:text-primary-600 transition-colors"
                pTooltip="Ver Perfil"
                tooltipPosition="top"
              >
                <i class="pi pi-eye"></i>
              </button>

              <button
                *appHasPermission="{
                  module: 'clientes',
                  permission: permissionTypes.EDIT,
                }"
                (click)="editCliente(cliente)"
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-200 transition-colors"
                pTooltip="Editar"
                tooltipPosition="top"
              >
                <i class="pi pi-pencil"></i>
              </button>

              <button
                *appHasPermission="{
                  module: 'clientes',
                  permission: permissionTypes.EDIT,
                }"
                (click)="
                  cliente.estado ? desactivar(cliente) : reactivar(cliente)
                "
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors"
                [ngClass]="
                  cliente.estado
                    ? 'text-surface-400 hover:text-red-600'
                    : 'text-surface-400 hover:text-emerald-600'
                "
                [pTooltip]="cliente.estado ? 'Desactivar' : 'Activar'"
                tooltipPosition="top"
              >
                <i
                  class="pi"
                  [ngClass]="cliente.estado ? 'pi-ban' : 'pi-check-circle'"
                ></i>
              </button>

              <button
                (click)="mostrarMenuAcciones($event, cliente)"
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-200 transition-colors"
                pTooltip="Más"
                tooltipPosition="top"
              >
                <i class="pi pi-ellipsis-v"></i>
              </button>
            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="6" class="text-center py-24">
            <div class="flex flex-col items-center justify-center">
              <div
                class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6 border border-surface-100 dark:border-surface-700 border-dashed"
              >
                <i
                  class="pi pi-users text-4xl text-surface-300 dark:text-surface-600"
                ></i>
              </div>
              <h4
                class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2"
              >
                Directorio Vacío
              </h4>
              <p class="text-surface-500 text-base max-w-sm mx-auto mb-8">
                No se encontraron clientes con los filtros actuales.
              </p>

              <button
                *appHasPermission="{
                  module: 'clientes',
                  permission: permissionTypes.CREATE,
                }"
                (click)="openNew()"
                class="px-6 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2"
              >
                <i class="pi pi-plus"></i> Nuevo Cliente
              </button>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Vista de Cards  para Clientes -->
<div *ngIf="currentView === 'cards'" class="mb-8 animate-fade-in">
  <div
    class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300"
  >
    <div
      class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 relative z-10"
    >
      <div class="flex items-center gap-5">
        <div
          class="w-14 h-14 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-200 dark:border-surface-700 shadow-inner"
        >
          <i class="pi pi-id-card text-2xl"></i>
        </div>
        <div class="flex flex-col">
          <h3
            class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none"
          >
            Galería de Perfiles
          </h3>
          <div
            class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400"
          >
            <span>Visualización por Ficha</span>
            <span
              class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"
            ></span>
            <span class="font-medium text-primary-600 dark:text-primary-400">
              {{ clientesFiltrados.length || 0 }} contactos
            </span>
          </div>
        </div>
      </div>
    </div>

    <div
      *ngIf="
        !uiState.isTableLoading && clientesFiltrados?.length;
        else emptyOrLoading
      "
    >
      <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
        <div
          *appHasPermission="{
            module: 'clientes',
            permission: permissionTypes.CREATE,
          }"
          (click)="openNew()"
          class="group relative bg-surface-50 dark:bg-surface-800/50 hover:bg-white dark:hover:bg-surface-800 rounded-[2rem] border-2 border-dashed border-surface-200 dark:border-surface-700 hover:border-primary-300 dark:hover:border-primary-700 flex flex-col items-center justify-center min-h-[320px] cursor-pointer transition-all duration-300 hover:-translate-y-1"
        >
          <div
            class="w-16 h-16 rounded-full bg-surface-100 dark:bg-surface-700 flex items-center justify-center text-surface-400 group-hover:bg-primary-50 group-hover:text-primary-600 transition-colors mb-4"
          >
            <i class="pi pi-plus text-2xl"></i>
          </div>
          <h4
            class="text-lg font-bold text-surface-600 dark:text-surface-300 group-hover:text-primary-700 dark:group-hover:text-primary-400"
          >
            Agregar Cliente
          </h4>
          <p class="text-sm text-surface-400 mt-1">Registrar nuevo perfil</p>
        </div>

        <div
          *ngFor="let cliente of clientesFiltrados; trackBy: trackByClienteId"
          class="group relative bg-white dark:bg-surface-900 rounded-[2rem] border border-surface-200 dark:border-surface-700 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden"
          [class.ring-2]="selectedClientes.includes(cliente)"
          [class.ring-primary-500]="selectedClientes.includes(cliente)"
        >
          <div
            class="absolute top-0 left-0 right-0 h-1.5"
            [ngClass]="cliente.estado ? 'bg-emerald-500' : 'bg-red-500'"
          ></div>

          <div
            class="absolute top-4 right-4 z-10 opacity-0 group-hover:opacity-100 transition-opacity"
            [class.opacity-100]="selectedClientes.includes(cliente)"
          >
            <p-checkbox
              [value]="cliente"
              [(ngModel)]="selectedClientes"
              [binary]="false"
            ></p-checkbox>
          </div>

          <div class="p-6 flex-1 flex flex-col">
            <div class="flex items-center gap-4 mb-6">
              <div class="relative">
                <div
                  class="w-16 h-16 rounded-2xl bg-surface-100 dark:bg-surface-800 flex items-center justify-center text-surface-500 text-xl font-bold border border-surface-200 dark:border-surface-700"
                >
                  {{
                    (cliente.nombres.charAt(0) || "-") +
                      (cliente.apellidos.charAt(0) || "")
                  }}
                </div>
                <div
                  *ngIf="cliente.compras && cliente.compras >= 10"
                  class="absolute -bottom-2 -right-2 w-6 h-6 bg-amber-400 rounded-full flex items-center justify-center text-white text-xs shadow-sm"
                  pTooltip="Cliente VIP"
                >
                  <i class="pi pi-crown text-[10px]"></i>
                </div>
              </div>

              <div class="flex-1 min-w-0">
                <h4
                  class="text-lg font-bold text-surface-900 dark:text-surface-0 truncate leading-tight mb-1"
                >
                  {{ cliente.nombres }} {{ cliente.apellidos }}
                </h4>
                <div class="flex items-center gap-2">
                  <span
                    class="px-2 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider border"
                    [ngClass]="
                      cliente.estado
                        ? 'bg-emerald-50 text-emerald-700 border-emerald-100'
                        : 'bg-red-50 text-red-700 border-red-100'
                    "
                  >
                    {{ cliente.estado ? "Activo" : "Inactivo" }}
                  </span>
                </div>
              </div>
            </div>

            <div class="space-y-3 mb-6">
              <div
                class="flex items-center gap-3 text-sm text-surface-600 dark:text-surface-300"
              >
                <div
                  class="w-8 h-8 rounded-lg bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-400"
                >
                  <i class="pi pi-envelope"></i>
                </div>
                <span class="truncate">{{
                  cliente.email || "Sin correo"
                }}</span>
              </div>
              <div
                class="flex items-center gap-3 text-sm text-surface-600 dark:text-surface-300"
              >
                <div
                  class="w-8 h-8 rounded-lg bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-400"
                >
                  <i class="pi pi-phone"></i>
                </div>
                <span class="truncate">{{
                  cliente.telefono || "Sin teléfono"
                }}</span>
              </div>
            </div>

            <div class="flex flex-wrap gap-2 mb-6">
              <span
                *ngIf="cliente.dni"
                class="px-2 py-1 rounded-lg bg-surface-50 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 text-xs text-surface-600 dark:text-surface-300 font-mono"
              >
                <strong class="text-surface-400 mr-1">DNI</strong
                >{{ cliente.dni }}
              </span>
              <span
                *ngIf="cliente.ruc"
                class="px-2 py-1 rounded-lg bg-surface-50 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 text-xs text-surface-600 dark:text-surface-300 font-mono"
              >
                <strong class="text-surface-400 mr-1">RUC</strong
                >{{ cliente.ruc }}
              </span>
            </div>

            <div
              class="mt-auto pt-4 border-t border-surface-100 dark:border-surface-800 flex justify-between items-center"
            >
              <div class="flex flex-col">
                <span class="text-[10px] font-bold text-surface-400 uppercase"
                  >Compras</span
                >
                <span
                  class="text-lg font-bold text-surface-900 dark:text-surface-0"
                  >{{ cliente.compras || 0 }}</span
                >
              </div>

              <div
                class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0 duration-200"
              >
                <button
                  (click)="verDetallesCliente(cliente)"
                  class="w-8 h-8 rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-900 transition-colors"
                  pTooltip="Ver"
                >
                  <i class="pi pi-eye"></i>
                </button>
                <button
                  *appHasPermission="{
                    module: 'clientes',
                    permission: permissionTypes.EDIT,
                  }"
                  (click)="editCliente(cliente)"
                  class="w-8 h-8 rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-900 transition-colors"
                  pTooltip="Editar"
                >
                  <i class="pi pi-pencil"></i>
                </button>
                <button
                  (click)="mostrarMenuAcciones($event, cliente)"
                  class="w-8 h-8 rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-900 transition-colors"
                  pTooltip="Más"
                >
                  <i class="pi pi-ellipsis-v"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #emptyOrLoading>
      <div
        *ngIf="uiState.isTableLoading"
        class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6"
      >
        <div
          *ngFor="let i of [1, 2, 3]"
          class="h-[320px] rounded-[2rem] bg-surface-50 animate-pulse"
        ></div>
      </div>

      <div
        *ngIf="!uiState.isTableLoading && clientesFiltrados.length === 0"
        class="flex flex-col items-center justify-center py-20 text-center"
      >
        <div
          class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6 text-surface-300 dark:text-surface-600 border border-surface-100 dark:border-surface-700"
        >
          <i class="pi pi-users text-4xl"></i>
        </div>
        <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">
          Directorio Vacío
        </h3>
        <p class="text-surface-500 text-base max-w-sm mb-8">
          No se encontraron clientes. Registra el primero para comenzar a
          construir tu base de datos.
        </p>
        <button
          (click)="openNew()"
          class="px-8 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2"
        >
          <i class="pi pi-plus"></i> Nuevo Cliente
        </button>
      </div>
    </ng-template>
  </div>
</div>

<!-- Vista de tabla móvil responsive -->
<div class="block lg:hidden mb-8 animate-fade-in">
  <div
    class="bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 rounded-[1.5rem] overflow-hidden shadow-sm transition-colors duration-300"
  >
    <div
      class="p-5 border-b border-surface-100 dark:border-surface-800 bg-white dark:bg-surface-900"
    >
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div
            class="w-10 h-10 rounded-xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-400 border border-surface-100 dark:border-surface-700"
          >
            <i class="pi pi-list text-lg"></i>
          </div>
          <div>
            <h3
              class="text-base font-bold text-surface-900 dark:text-surface-0 m-0"
            >
              Lista de Clientes
            </h3>
            <p
              class="text-xs text-surface-500 dark:text-surface-400 mt-0.5"
              *ngIf="clientesFiltrados?.length"
            >
              {{ clientesFiltrados.length }} registros
            </p>
          </div>
        </div>

        <button
          (click)="cargarClientes()"
          class="w-10 h-10 rounded-xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-500 hover:text-primary-600 transition-colors"
        >
          <i class="pi pi-refresh" [class.pi-spin]="loading"></i>
        </button>
      </div>

      <div class="relative group w-full">
        <i
          class="pi pi-search absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 text-lg"
        ></i>
        <input
          pInputText
          type="text"
          (input)="onGlobalFilter($event)"
          placeholder="Buscar cliente..."
          class="pl-12 pr-4 py-3 w-full bg-surface-50 dark:bg-surface-800 border-none rounded-xl text-sm focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900 transition-all shadow-inner text-surface-700 dark:text-surface-200"
        />
      </div>
    </div>

    <div class="overflow-x-auto">
      <p-table
        #dtMobile
        [value]="clientesFiltrados"
        [rows]="10"
        [paginator]="true"
        [totalRecords]="clientesFiltrados.length"
        [(selection)]="selectedClientes"
        dataKey="id"
        [loading]="uiState.isTableLoading"
        [showCurrentPageReport]="false"
        [globalFilterFields]="[
          'nombres',
          'apellidos',
          'dni',
          'ruc',
          'email',
          'telefono',
        ]"
        styleClass="p-datatable-sm"
        [rowHover]="true"
        [tableStyle]="{ 'min-width': '800px' }"
        [rowTrackBy]="trackByClienteId"
        [rowsPerPageOptions]="[5, 10, 15]"
      >
        <ng-template pTemplate="header">
          <tr
            class="bg-surface-50/50 dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800"
          >
            <th style="width: 3rem" class="text-center p-3">
              <p-tableHeaderCheckbox />
            </th>
            <th
              class="p-3 text-xs font-bold text-surface-500 uppercase tracking-wider pl-4"
            >
              Cliente
            </th>
            <th
              class="p-3 text-xs font-bold text-surface-500 uppercase tracking-wider"
            >
              Contacto
            </th>
            <th
              class="p-3 text-xs font-bold text-surface-500 uppercase tracking-wider"
            >
              Docs
            </th>
            <th
              class="p-3 text-center text-xs font-bold text-surface-500 uppercase tracking-wider"
            >
              Estado
            </th>
            <th
              class="p-3 text-center text-xs font-bold text-surface-500 uppercase tracking-wider"
            >
              Acción
            </th>
          </tr>
        </ng-template>

        <ng-template pTemplate="body" let-cliente>
          <tr
            class="group border-b border-surface-100 dark:border-surface-800 hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-all duration-200"
          >
            <td class="text-center p-3">
              <p-tableCheckbox [value]="cliente" />
            </td>

            <td class="p-3 pl-4">
              <div class="flex items-center gap-3">
                <div
                  class="w-8 h-8 rounded-lg bg-surface-100 dark:bg-surface-800 flex flex-shrink-0 items-center justify-center text-surface-500 font-bold text-xs"
                >
                  {{ cliente.nombres?.charAt(0) || "-" }}
                </div>
                <div class="flex flex-col min-w-0">
                  <span
                    class="font-bold text-surface-900 dark:text-surface-0 text-sm truncate max-w-[140px]"
                  >
                    {{ cliente.nombres }} {{ cliente.apellidos }}
                  </span>
                  <span
                    class="text-[10px] text-surface-500 truncate max-w-[140px]"
                    *ngIf="cliente.direccion"
                  >
                    {{ cliente.direccion }}
                  </span>
                </div>
              </div>
            </td>

            <td class="p-3">
              <div class="flex flex-col gap-1">
                <div class="flex items-center gap-1.5" *ngIf="cliente.telefono">
                  <i class="pi pi-phone text-[10px] text-surface-400"></i>
                  <span
                    class="text-xs font-medium text-surface-700 dark:text-surface-200"
                    >{{ cliente.telefono }}</span
                  >
                </div>
                <div class="flex items-center gap-1.5" *ngIf="cliente.email">
                  <i class="pi pi-envelope text-[10px] text-surface-400"></i>
                  <span
                    class="text-xs text-surface-500 truncate max-w-[120px]"
                    >{{ cliente.email }}</span
                  >
                </div>
              </div>
            </td>

            <td class="p-3">
              <div class="flex flex-col items-start gap-1">
                <span
                  *ngIf="cliente.dni"
                  class="px-1.5 py-0.5 rounded bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 text-[10px] font-mono text-surface-600 dark:text-surface-300"
                >
                  {{ cliente.dni }}
                </span>
                <span
                  *ngIf="cliente.ruc"
                  class="px-1.5 py-0.5 rounded bg-surface-100 dark:bg-surface-800 border border-surface-200 dark:border-surface-700 text-[10px] font-mono text-surface-600 dark:text-surface-300"
                >
                  {{ cliente.ruc }}
                </span>
              </div>
            </td>

            <td class="text-center p-3">
              <div class="flex justify-center">
                <span
                  class="w-2.5 h-2.5 rounded-full"
                  [ngClass]="
                    cliente.estado
                      ? 'bg-emerald-500 shadow-sm shadow-emerald-200'
                      : 'bg-red-500 shadow-sm shadow-red-200'
                  "
                ></span>
              </div>
            </td>

            <td class="text-center p-3">
              <div class="flex justify-center gap-1">
                <button
                  (click)="verDetallesCliente(cliente)"
                  class="w-8 h-8 rounded-lg bg-surface-50 dark:bg-surface-800 text-surface-500 active:bg-surface-200 flex items-center justify-center"
                >
                  <i class="pi pi-eye"></i>
                </button>
                <button
                  (click)="mostrarMenuAcciones($event, cliente)"
                  class="w-8 h-8 rounded-lg bg-surface-50 dark:bg-surface-800 text-surface-500 active:bg-surface-200 flex items-center justify-center"
                >
                  <i class="pi pi-ellipsis-v"></i>
                </button>
              </div>
            </td>
          </tr>
        </ng-template>

        <ng-template pTemplate="emptymessage">
          <tr>
            <td colspan="6" class="text-center py-12">
              <div class="flex flex-col items-center gap-3">
                <div
                  class="w-12 h-12 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center text-surface-400"
                >
                  <i class="pi pi-search text-xl"></i>
                </div>
                <p class="text-sm text-surface-500 font-medium">
                  No hay resultados
                </p>
                <button
                  (click)="openNew()"
                  class="text-xs font-bold text-primary-600 uppercase tracking-wide"
                >
                  + Nuevo Cliente
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </div>
</div>

<!-- Menú contextual -->
<p-menu #menuAcciones [popup]="true" [model]="itemsMenuAcciones"></p-menu>

<!-- Diálogo de formulario  optimizado -->
<p-dialog
  [(visible)]="visible"
  [style]="{
    width: '900px',
    'max-width': '95vw',
    height: 'auto',
    'max-height': '90vh',
  }"
  [modal]="true"
  (onHide)="hideDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{
    padding: '0',
    'border-radius': '1.5rem',
    overflow: 'hidden',
  }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-white dark:bg-surface-950">
    <div
      class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800 sticky top-0 z-50"
    >
      <div class="flex items-center gap-5">
        <div
          class="w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-lg"
          [ngClass]="
            editMode
              ? 'bg-primary-600'
              : 'bg-surface-900 dark:bg-surface-0 dark:text-surface-900'
          "
        >
          <i
            class="pi"
            [ngClass]="editMode ? 'pi-user-edit' : 'pi-user-plus'"
          ></i>
        </div>

        <div class="flex flex-col">
          <h2
            class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none"
          >
            {{ editMode ? "Editar Perfil" : "Nuevo Cliente" }}
          </h2>
          <div class="flex items-center gap-2 mt-1">
            <span class="text-sm text-surface-500 dark:text-surface-400">
              {{
                editMode
                  ? "Actualizando datos de contacto"
                  : "Registrar en la base de datos"
              }}
            </span>
            <span
              *ngIf="editMode"
              class="text-[10px] font-bold bg-primary-50 text-primary-700 px-2 py-0.5 rounded uppercase tracking-wider"
            >
              Edición
            </span>
          </div>
        </div>
      </div>

      <button
        (click)="hideDialog()"
        class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors"
      >
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
      <form
        [formGroup]="clienteForm"
        (ngSubmit)="guardarCliente()"
        class="space-y-8"
      >
        <div>
          <h4
            class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-4 flex items-center gap-2"
          >
            <i class="pi pi-id-card text-primary-500"></i> Identidad Personal
          </h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-1.5">
              <label
                for="nombres"
                class="text-sm font-bold text-surface-700 dark:text-surface-200"
                >Nombres <span class="text-red-500">*</span></label
              >
              <input
                pInputText
                id="nombres"
                formControlName="nombres"
                class="w-full h-12 bg-surface-50 dark:bg-surface-800 border-none rounded-xl px-4 text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-500 transition-all"
                placeholder="Ej. Juan Carlos"
                [ngClass]="{
                  'ring-2 ring-red-500/20 bg-red-50':
                    f['nombres'].invalid && (f['nombres'].dirty || submitted),
                }"
              />
              <small
                *ngIf="getFieldError('nombres')"
                class="text-red-500 text-xs font-medium pl-1"
              >
                {{ getFieldError("nombres") }}
              </small>
            </div>

            <div class="space-y-1.5">
              <label
                for="apellidos"
                class="text-sm font-bold text-surface-700 dark:text-surface-200"
                >Apellidos <span class="text-red-500">*</span></label
              >
              <input
                pInputText
                id="apellidos"
                formControlName="apellidos"
                class="w-full h-12 bg-surface-50 dark:bg-surface-800 border-none rounded-xl px-4 text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-500 transition-all"
                placeholder="Ej. Pérez Gómez"
                [ngClass]="{
                  'ring-2 ring-red-500/20 bg-red-50':
                    f['apellidos'].invalid &&
                    (f['apellidos'].dirty || submitted),
                }"
              />
              <small
                *ngIf="getFieldError('apellidos')"
                class="text-red-500 text-xs font-medium pl-1"
              >
                {{ getFieldError("apellidos") }}
              </small>
            </div>

            <div class="md:col-span-2 space-y-1.5">
              <label
                for="fechaNacimiento"
                class="text-sm font-bold text-surface-700 dark:text-surface-200"
                >Fecha de Nacimiento</label
              >
              <div class="relative">
                <i
                  class="pi pi-calendar absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 z-10"
                ></i>
                <p-datepicker
                  id="fechaNacimiento"
                  formControlName="fechaNacimiento"
                  dateFormat="dd/mm/yy"
                  placeholder="Seleccionar fecha"
                  styleClass="w-full"
                  inputStyleClass="w-full h-12 bg-surface-50 dark:bg-surface-800 border-none rounded-xl pl-10 text-surface-900 dark:text-surface-0"
                  [yearNavigator]="true"
                  [monthNavigator]="true"
                  yearRange="1940:2020"
                ></p-datepicker>
              </div>
            </div>
          </div>
        </div>

        <div
          class="bg-surface-50 dark:bg-surface-800/50 p-6 rounded-3xl border border-surface-200 dark:border-surface-700"
        >
          <h4
            class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-4 flex items-center gap-2"
          >
            <i class="pi pi-file text-indigo-500"></i> Datos Fiscales
          </h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-1.5">
              <label
                for="dni"
                class="text-xs font-bold text-surface-500 uppercase"
                >DNI</label
              >
              <div class="relative">
                <input
                  pInputText
                  id="dni"
                  formControlName="dni"
                  maxlength="8"
                  class="w-full h-11 bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-700 rounded-xl px-4 font-mono text-sm focus:border-primary-500 focus:ring-0"
                  placeholder="8 dígitos"
                />
                <div class="absolute right-3 top-1/2 -translate-y-1/2">
                  <i
                    class="pi pi-check-circle text-green-500"
                    *ngIf="f['dni'].valid && f['dni'].value"
                  ></i>
                </div>
              </div>
            </div>

            <div class="space-y-1.5">
              <label
                for="ruc"
                class="text-xs font-bold text-surface-500 uppercase"
                >RUC</label
              >
              <div class="relative">
                <input
                  pInputText
                  id="ruc"
                  formControlName="ruc"
                  maxlength="11"
                  class="w-full h-11 bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-700 rounded-xl px-4 font-mono text-sm focus:border-primary-500 focus:ring-0"
                  placeholder="11 dígitos"
                />
              </div>
            </div>
          </div>
        </div>

        <div>
          <h4
            class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-4 flex items-center gap-2"
          >
            <i class="pi pi-map-marker text-orange-500"></i> Contacto &
            Ubicación
          </h4>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="space-y-1.5">
              <label
                for="telefono"
                class="text-sm font-bold text-surface-700 dark:text-surface-200"
                >Teléfono</label
              >
              <div class="relative">
                <i
                  class="pi pi-phone absolute left-4 top-1/2 -translate-y-1/2 text-surface-400"
                ></i>
                <input
                  pInputText
                  id="telefono"
                  formControlName="telefono"
                  class="w-full h-12 bg-surface-50 dark:bg-surface-800 border-none rounded-xl pl-10"
                  placeholder="+51 999 999 999"
                />
              </div>
            </div>

            <div class="space-y-1.5">
              <label
                for="email"
                class="text-sm font-bold text-surface-700 dark:text-surface-200"
                >Email</label
              >
              <div class="relative">
                <i
                  class="pi pi-envelope absolute left-4 top-1/2 -translate-y-1/2 text-surface-400"
                ></i>
                <input
                  pInputText
                  id="email"
                  formControlName="email"
                  type="email"
                  class="w-full h-12 bg-surface-50 dark:bg-surface-800 border-none rounded-xl pl-10"
                  placeholder="cliente@email.com"
                />
              </div>
            </div>

            <div class="md:col-span-2 space-y-1.5">
              <label
                for="direccion"
                class="text-sm font-bold text-surface-700 dark:text-surface-200"
                >Dirección de Entrega</label
              >
              <input
                pInputText
                id="direccion"
                formControlName="direccion"
                class="w-full h-12 bg-surface-50 dark:bg-surface-800 border-none rounded-xl px-4"
                placeholder="Av. Principal 123, Distrito..."
              />
            </div>
          </div>
        </div>

        <div
          class="flex items-center justify-between p-4 bg-surface-50 dark:bg-surface-800/50 rounded-2xl border border-surface-200 dark:border-surface-700"
        >
          <div>
            <span
              class="block text-sm font-bold text-surface-900 dark:text-surface-0"
              >Estado de Cuenta</span
            >
            <span class="text-xs text-surface-500"
              >Habilitar operaciones para este cliente</span
            >
          </div>
          <div class="flex items-center gap-3">
            <span
              class="text-xs font-bold uppercase tracking-wider"
              [ngClass]="
                clienteForm.get('estado')?.value
                  ? 'text-emerald-600'
                  : 'text-surface-400'
              "
            >
              {{ clienteForm.get("estado")?.value ? "Activo" : "Inactivo" }}
            </span>
            <p-inputSwitch formControlName="estado"></p-inputSwitch>
          </div>
        </div>
      </form>
    </div>

    <div
      class="flex flex-col md:flex-row justify-between items-center gap-4 px-8 py-6 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-700 sticky bottom-0 z-50"
    >
      <div class="flex items-center gap-2" *ngIf="!editMode">
        <p-checkbox
          [(ngModel)]="crearYAgregar"
          [binary]="true"
          inputId="crearYAgregar"
        ></p-checkbox>
        <label
          for="crearYAgregar"
          class="text-sm font-medium text-surface-600 cursor-pointer select-none"
          >Crear y agregar otro</label
        >
      </div>
      <div *ngIf="editMode"></div>
      <div class="flex gap-3 w-full md:w-auto">
        <button
          pButton
          label="Cancelar"
          class="p-button-text text-surface-500 hover:text-surface-900 font-bold px-6 rounded-xl flex-1 md:flex-none"
          (click)="hideDialog()"
        ></button>
        <button
          pButton
          [label]="editMode ? 'Guardar Cambios' : 'Registrar Cliente'"
          icon="pi pi-check"
          class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-8 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex-1 md:flex-none"
          (click)="guardarCliente()"
          [loading]="uiState.isFormSaving"
          [disabled]="clienteForm.invalid"
        ></button>
      </div>
    </div>
  </div>
</p-dialog>

<!-- Diálogo de Detalles del Cliente optimizado -->
<p-dialog
  [(visible)]="detalleDialog"
  [style]="{ width: '1000px', maxWidth: '95vw', height: '90vh' }"
  [modal]="true"
  (onHide)="hideDetalleDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div
    class="flex flex-col h-full bg-white dark:bg-surface-950"
    *ngIf="clienteDetalle"
  >
    <div
      class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800 sticky top-0 z-50"
    >
      <div class="flex items-center gap-5">
        <div
          class="w-12 h-12 rounded-2xl bg-indigo-50 dark:bg-indigo-900/20 flex items-center justify-center text-indigo-600 dark:text-indigo-400 border border-indigo-100 dark:border-indigo-900/30 shadow-inner"
        >
          <i class="pi pi-user text-xl"></i>
        </div>

        <div class="flex flex-col">
          <h2
            class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none"
          >
            Perfil del Cliente
          </h2>
          <div
            class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400"
          >
            <span>Vista Detallada</span>
            <span
              class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"
            ></span>
            <span class="font-medium text-indigo-600 dark:text-indigo-400">
              ID: #{{ clienteDetalle.id }}
            </span>
          </div>
        </div>
      </div>

      <button
        (click)="hideDetalleDialog()"
        class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors"
      >
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="space-y-6">
          <div
            class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 flex flex-col items-center text-center"
          >
            <div class="relative mb-4">
              <div
                class="w-32 h-32 rounded-full bg-white dark:bg-surface-700 flex items-center justify-center text-4xl font-bold text-surface-400 dark:text-surface-200 shadow-sm border-4 border-white dark:border-surface-800"
              >
                {{
                  (clienteDetalle.nombres.charAt(0) || "-") +
                    (clienteDetalle.apellidos.charAt(0) || "")
                }}
              </div>
              <div
                class="absolute bottom-1 right-1 w-8 h-8 rounded-full border-4 border-surface-50 dark:border-surface-800 flex items-center justify-center"
                [ngClass]="
                  clienteDetalle.estado ? 'bg-emerald-500' : 'bg-red-500'
                "
              >
                <i
                  class="pi pi-check text-white text-xs"
                  *ngIf="clienteDetalle.estado"
                ></i>
                <i
                  class="pi pi-times text-white text-xs"
                  *ngIf="!clienteDetalle.estado"
                ></i>
              </div>
            </div>

            <h3
              class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-1"
            >
              {{ clienteDetalle.nombres }} {{ clienteDetalle.apellidos }}
            </h3>
            <span
              class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border mb-4"
              [ngClass]="
                clienteDetalle.estado
                  ? 'bg-emerald-50 text-emerald-700 border-emerald-100'
                  : 'bg-red-50 text-red-700 border-red-100'
              "
            >
              {{ clienteDetalle.estado ? "Cuenta Activa" : "Inactivo" }}
            </span>

            <div class="w-full mt-2">
              <div
                class="flex justify-between text-xs mb-1 font-medium text-surface-500"
              >
                <span>Perfil Completado</span>
                <span>{{ getCompletion(clienteDetalle) }}%</span>
              </div>
              <div
                class="w-full bg-surface-200 dark:bg-surface-700 rounded-full h-1.5"
              >
                <div
                  class="h-1.5 rounded-full bg-primary-600 transition-all duration-1000"
                  [style.width.%]="getCompletion(clienteDetalle)"
                ></div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div
              class="bg-white dark:bg-surface-900 p-4 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm"
            >
              <span
                class="text-[10px] font-bold text-surface-400 uppercase block mb-1"
                >Compras</span
              >
              <span
                class="text-2xl font-bold text-surface-900 dark:text-surface-0"
                >{{ clienteDetalle.compras || 0 }}</span
              >
            </div>
            <div
              class="bg-white dark:bg-surface-900 p-4 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm"
            >
              <span
                class="text-[10px] font-bold text-surface-400 uppercase block mb-1"
                >Total Gastado</span
              >
              <span class="text-lg font-bold text-purple-600">{{
                clienteDetalle.totalCompras
                  | currency: "S/. " : "symbol" : "1.0-0"
              }}</span>
            </div>
          </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
          <div
            class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm"
          >
            <h4
              class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2"
            >
              <i class="pi pi-phone text-emerald-500"></i> Información de
              Contacto
            </h4>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <span class="text-xs text-surface-500 block mb-1"
                  >Teléfono</span
                >
                <div class="flex items-center gap-2">
                  <i class="pi pi-mobile text-surface-400"></i>
                  <span
                    class="text-base font-medium text-surface-900 dark:text-surface-0"
                    >{{ clienteDetalle.telefono || "No registrado" }}</span
                  >
                </div>
              </div>
              <div>
                <span class="text-xs text-surface-500 block mb-1">Email</span>
                <div class="flex items-center gap-2">
                  <i class="pi pi-envelope text-surface-400"></i>
                  <span
                    class="text-base font-medium text-surface-900 dark:text-surface-0 truncate"
                    >{{ clienteDetalle.email || "No registrado" }}</span
                  >
                </div>
              </div>
              <div class="md:col-span-2">
                <span class="text-xs text-surface-500 block mb-1"
                  >Dirección</span
                >
                <div class="flex items-center gap-2">
                  <i class="pi pi-map-marker text-surface-400"></i>
                  <span
                    class="text-base font-medium text-surface-900 dark:text-surface-0"
                    >{{
                      clienteDetalle.direccion || "Sin dirección registrada"
                    }}</span
                  >
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div
              class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm"
            >
              <h4
                class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2"
              >
                <i class="pi pi-id-card text-blue-500"></i> Datos Fiscales
              </h4>
              <div class="space-y-4">
                <div
                  class="flex justify-between items-center p-3 rounded-xl bg-surface-50 dark:bg-surface-800"
                >
                  <span class="text-xs font-bold text-surface-500">DNI</span>
                  <span
                    class="font-mono font-bold text-surface-900 dark:text-surface-0"
                    >{{ clienteDetalle.dni || "---" }}</span
                  >
                </div>
                <div
                  class="flex justify-between items-center p-3 rounded-xl bg-surface-50 dark:bg-surface-800"
                >
                  <span class="text-xs font-bold text-surface-500">RUC</span>
                  <span
                    class="font-mono font-bold text-surface-900 dark:text-surface-0"
                    >{{ clienteDetalle.ruc || "---" }}</span
                  >
                </div>
              </div>
            </div>

            <div
              class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm"
            >
              <h4
                class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2"
              >
                <i class="pi pi-clock text-orange-500"></i> Registro
              </h4>
              <div class="space-y-4">
                <div>
                  <span class="text-xs text-surface-500 block mb-1"
                    >Fecha Nacimiento</span
                  >
                  <span
                    class="text-sm font-bold text-surface-900 dark:text-surface-0"
                  >
                    {{
                      clienteDetalle.fechaNacimiento
                        ? (clienteDetalle.fechaNacimiento
                          | date: "dd MMMM yyyy")
                        : "No registrada"
                    }}
                  </span>
                </div>
                <div
                  class="pt-4 border-t border-surface-100 dark:border-surface-800"
                >
                  <span class="text-xs text-surface-500 block mb-1"
                    >Miembro Desde</span
                  >
                  <span
                    class="text-sm font-mono text-surface-700 dark:text-surface-200"
                  >
                    {{ clienteDetalle.fechaCreacion | date: "dd/MM/yyyy" }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div
      class="flex justify-between items-center px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-800 sticky bottom-0 z-50"
    >
      <div class="text-xs text-surface-500 font-medium flex items-center gap-2">
        <i class="pi pi-check-circle text-emerald-500"></i>
        Datos sincronizados
      </div>
      <div class="flex gap-3">
        <button
          pButton
          label="Cerrar"
          class="p-button-text text-surface-500 hover:text-surface-900 font-bold"
          (click)="hideDetalleDialog()"
        ></button>
        <button
          pButton
          label="Exportar Ficha"
          icon="pi pi-file-pdf"
          class="p-button-outlined font-bold border-surface-300 text-surface-700 hover:bg-surface-50"
          (click)="exportarFichaCliente(clienteDetalle!)"
          [loading]="uiState.isExporting"
        ></button>
        <button
          pButton
          label="Editar Perfil"
          icon="pi pi-pencil"
          class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-6 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all"
          (click)="editCliente(clienteDetalle!); hideDetalleDialog()"
        ></button>
      </div>
    </div>
  </div>
</p-dialog>

<!-- Modal de Estadísticas Modernizado -->
<p-dialog
  [(visible)]="estadisticasDialog"
  [style]="{ width: '1200px', maxWidth: '95vw', height: '90vh' }"
  [modal]="true"
  (onHide)="hideEstadisticasDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-surface-50 dark:bg-surface-950">
    <div
      class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800 sticky top-0 z-50"
    >
      <div class="flex items-center gap-5">
        <div
          class="w-12 h-12 rounded-2xl bg-purple-50 dark:bg-purple-900/20 flex items-center justify-center text-purple-600 dark:text-purple-400 border border-purple-100 dark:border-purple-900/30 shadow-inner"
        >
          <i class="pi pi-chart-bar text-xl"></i>
        </div>

        <div class="flex flex-col">
          <h2
            class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none"
          >
            Analytics de Clientes
          </h2>
          <div
            class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400"
          >
            <span>Inteligencia de Negocio</span>
            <span
              class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"
            ></span>
            <span class="font-medium text-purple-600 dark:text-purple-400">
              {{ getCurrentDate() | date: "dd MMM yyyy" }}
            </span>
          </div>
        </div>
      </div>

      <button
        (click)="hideEstadisticasDialog()"
        class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors"
      >
        <i class="pi pi-times"></i>
      </button>
    </div>

    <div
      class="flex-1 overflow-y-auto custom-scrollbar p-8 space-y-8"
      *ngIf="clientes.length; else noStats"
    >
      <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
        <div
          class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center justify-center text-center hover:border-blue-200 transition-colors"
        >
          <div
            class="w-10 h-10 rounded-xl bg-blue-50 dark:bg-blue-900/20 text-blue-600 flex items-center justify-center mb-3"
          >
            <i class="pi pi-users"></i>
          </div>
          <span
            class="text-3xl font-bold text-surface-900 dark:text-surface-0 leading-none mb-1"
            >{{ getEstadisticas().total }}</span
          >
          <span
            class="text-xs font-bold text-surface-400 uppercase tracking-wider"
            >Total</span
          >
        </div>

        <div
          class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center justify-center text-center hover:border-emerald-200 transition-colors"
        >
          <div
            class="w-10 h-10 rounded-xl bg-emerald-50 dark:bg-emerald-900/20 text-emerald-600 flex items-center justify-center mb-3"
          >
            <i class="pi pi-check-circle"></i>
          </div>
          <span
            class="text-3xl font-bold text-surface-900 dark:text-surface-0 leading-none mb-1"
            >{{ getEstadisticas().activos }}</span
          >
          <span
            class="text-xs font-bold text-surface-400 uppercase tracking-wider"
            >Activos</span
          >
        </div>

        <div
          class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center justify-center text-center hover:border-purple-200 transition-colors"
        >
          <div
            class="w-10 h-10 rounded-xl bg-purple-50 dark:bg-purple-900/20 text-purple-600 flex items-center justify-center mb-3"
          >
            <i class="pi pi-percentage"></i>
          </div>
          <span
            class="text-3xl font-bold text-surface-900 dark:text-surface-0 leading-none mb-1"
            >{{ getEstadisticas().porcentajeActivos | number: "1.0-0" }}%</span
          >
          <span
            class="text-xs font-bold text-surface-400 uppercase tracking-wider"
            >Retención</span
          >
        </div>

        <div
          class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center justify-center text-center hover:border-amber-200 transition-colors"
        >
          <div
            class="w-10 h-10 rounded-xl bg-amber-50 dark:bg-amber-900/20 text-amber-600 flex items-center justify-center mb-3"
          >
            <i class="pi pi-crown"></i>
          </div>
          <span
            class="text-3xl font-bold text-surface-900 dark:text-surface-0 leading-none mb-1"
            >{{ getMetricasZapateria().clientesVIP }}</span
          >
          <span
            class="text-xs font-bold text-surface-400 uppercase tracking-wider"
            >Clientes VIP</span
          >
        </div>

        <div
          class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center justify-center text-center hover:border-indigo-200 transition-colors"
        >
          <div
            class="w-10 h-10 rounded-xl bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 flex items-center justify-center mb-3"
          >
            <i class="pi pi-money-bill"></i>
          </div>
          <span
            class="text-lg font-bold text-surface-900 dark:text-surface-0 leading-none mb-1"
            >{{
              getAnalisisValorCliente().totalVentas
                | currency: "S/. " : "symbol" : "1.0-0"
            }}</span
          >
          <span
            class="text-xs font-bold text-surface-400 uppercase tracking-wider"
            >Valor Total</span
          >
        </div>
      </div>

      <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
        <div
          class="bg-white dark:bg-surface-900 rounded-[2rem] p-8 border border-surface-200 dark:border-surface-700 shadow-sm"
        >
          <h4
            class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2"
          >
            <i class="pi pi-database text-purple-500"></i> Calidad de Datos
          </h4>

          <div class="space-y-6">
            <div>
              <div class="flex justify-between text-sm mb-2">
                <span
                  class="font-bold text-surface-700 dark:text-surface-200 flex items-center gap-2"
                  ><i class="pi pi-envelope text-surface-400"></i> Con
                  Email</span
                >
                <span class="font-bold text-purple-600">{{
                  getEstadisticas().clientesConEmail
                }}</span>
              </div>
              <div
                class="w-full bg-surface-100 dark:bg-surface-800 rounded-full h-2"
              >
                <div
                  class="bg-purple-500 h-2 rounded-full transition-all duration-1000"
                  [style.width.%]="
                    (getEstadisticas().clientesConEmail /
                      getEstadisticas().total) *
                    100
                  "
                ></div>
              </div>
            </div>

            <div>
              <div class="flex justify-between text-sm mb-2">
                <span
                  class="font-bold text-surface-700 dark:text-surface-200 flex items-center gap-2"
                  ><i class="pi pi-phone text-surface-400"></i> Con
                  Teléfono</span
                >
                <span class="font-bold text-emerald-600">{{
                  getEstadisticas().clientesConTelefono
                }}</span>
              </div>
              <div
                class="w-full bg-surface-100 dark:bg-surface-800 rounded-full h-2"
              >
                <div
                  class="bg-emerald-500 h-2 rounded-full transition-all duration-1000"
                  [style.width.%]="
                    (getEstadisticas().clientesConTelefono /
                      getEstadisticas().total) *
                    100
                  "
                ></div>
              </div>
            </div>

            <div>
              <div class="flex justify-between text-sm mb-2">
                <span
                  class="font-bold text-surface-700 dark:text-surface-200 flex items-center gap-2"
                  ><i class="pi pi-check-circle text-surface-400"></i> Perfil
                  100%</span
                >
                <span class="font-bold text-blue-600">{{
                  getEstadisticas().clientesCompletos
                }}</span>
              </div>
              <div
                class="w-full bg-surface-100 dark:bg-surface-800 rounded-full h-2"
              >
                <div
                  class="bg-blue-500 h-2 rounded-full transition-all duration-1000"
                  [style.width.%]="
                    (getEstadisticas().clientesCompletos /
                      getEstadisticas().total) *
                    100
                  "
                ></div>
              </div>
            </div>
          </div>
        </div>

        <div
          class="bg-white dark:bg-surface-900 rounded-[2rem] p-8 border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col"
        >
          <h4
            class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2"
          >
            <i class="pi pi-chart-pie text-emerald-500"></i> Segmentación
          </h4>

          <div class="flex-1 flex items-end justify-around pb-4">
            <div class="flex flex-col items-center group">
              <span
                class="text-xs font-bold text-emerald-600 mb-2 opacity-0 group-hover:opacity-100 transition-opacity"
                >{{ getEstadisticas().activos }}</span
              >
              <div
                class="w-16 bg-emerald-100 dark:bg-emerald-900/30 rounded-t-2xl relative overflow-hidden group-hover:bg-emerald-200 transition-colors"
                [style.height]="
                  (getEstadisticas().activos / getEstadisticas().total) * 150 +
                  20 +
                  'px'
                "
              >
                <div
                  class="absolute bottom-0 left-0 right-0 h-1 bg-emerald-500"
                ></div>
              </div>
              <span
                class="text-xs font-bold text-surface-500 mt-3 uppercase tracking-wide"
                >Activos</span
              >
            </div>

            <div class="flex flex-col items-center group">
              <span
                class="text-xs font-bold text-red-600 mb-2 opacity-0 group-hover:opacity-100 transition-opacity"
                >{{ getEstadisticas().inactivos }}</span
              >
              <div
                class="w-16 bg-red-100 dark:bg-red-900/30 rounded-t-2xl relative overflow-hidden group-hover:bg-red-200 transition-colors"
                [style.height]="
                  (getEstadisticas().inactivos / getEstadisticas().total) *
                    150 +
                  20 +
                  'px'
                "
              >
                <div
                  class="absolute bottom-0 left-0 right-0 h-1 bg-red-500"
                ></div>
              </div>
              <span
                class="text-xs font-bold text-surface-500 mt-3 uppercase tracking-wide"
                >Inactivos</span
              >
            </div>

            <div class="flex flex-col items-center group">
              <span
                class="text-xs font-bold text-amber-600 mb-2 opacity-0 group-hover:opacity-100 transition-opacity"
                >{{ getMetricasZapateria().clientesVIP }}</span
              >
              <div
                class="w-16 bg-amber-100 dark:bg-amber-900/30 rounded-t-2xl relative overflow-hidden group-hover:bg-amber-200 transition-colors"
                [style.height]="
                  (getMetricasZapateria().clientesVIP /
                    getEstadisticas().total) *
                    150 +
                  20 +
                  'px'
                "
              >
                <div
                  class="absolute bottom-0 left-0 right-0 h-1 bg-amber-500"
                ></div>
              </div>
              <span
                class="text-xs font-bold text-surface-500 mt-3 uppercase tracking-wide"
                >VIP</span
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <ng-template #noStats>
      <div class="flex flex-col items-center justify-center py-32 text-center">
        <div
          class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6 border border-surface-100 dark:border-surface-700"
        >
          <i
            class="pi pi-chart-line text-4xl text-surface-300 dark:text-surface-600"
          ></i>
        </div>
        <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">
          Sin Datos de Análisis
        </h3>
        <p class="text-surface-500 text-base max-w-sm mb-8">
          Registra tus primeros clientes para activar el panel de inteligencia
          de negocio.
        </p>
        <button
          (click)="openNew(); hideEstadisticasDialog()"
          class="px-6 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2"
        >
          <i class="pi pi-plus"></i> Nuevo Cliente
        </button>
      </div>
    </ng-template>

    <div
      class="flex justify-between items-center px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-800 sticky bottom-0 z-50"
    >
      <div class="text-xs text-surface-500 font-medium flex items-center gap-2">
        <i class="pi pi-clock"></i>
        Actualizado: {{ uiState.lastUpdate | date: "HH:mm" }}
      </div>
      <div class="flex gap-3">
        <button
          pButton
          label="Cerrar"
          class="p-button-text text-surface-500 hover:text-surface-900 font-bold"
          (click)="hideEstadisticasDialog()"
        ></button>
        <button
          pButton
          label="Descargar PDF"
          icon="pi pi-download"
          class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-6 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all"
          (click)="exportarPDF()"
          [loading]="uiState.isExporting"
        ></button>
      </div>
    </div>
  </div>
</p-dialog>
