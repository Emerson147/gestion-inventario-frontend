<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<p-toolbar class="mb-4">
  <ng-template pTemplate="start">
    <p-button *appHasPermission="{module: 'clientes', permission: permissionTypes.CREATE}" label="Nuevo Cliente" icon="pi pi-plus" (click)="openNew()" class="mr-2"/>
    <p-button *appHasPermission="{module: 'clientes', permission: permissionTypes.DELETE}" label="Eliminar" severity="danger" icon="pi pi-trash" outlined (click)="eliminarSeleccionados()" [disabled]="!selectedClientes.length"/>
  </ng-template>
</p-toolbar>

<div class="mb-3 flex items-center gap-2">
  <p-inputText [(ngModel)]="filtro" (input)="buscar()" placeholder="Buscar cliente por nombre, dni, ruc..." style="width: 300px"/>
  <p-button icon="pi pi-times" class="p-button-text p-button-sm" *ngIf="filtro" (click)="limpiarBusqueda()"></p-button>
</div>

<p-table 
  #dt
  [value]="clientes"
  [paginator]="true" 
  [rows]="10"
  [rowsPerPageOptions]="[5,10,20,50]"
  [(selection)]="selectedClientes"
  dataKey="id"
  [loading]="loading"
  [showCurrentPageReport]="true"
  currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} clientes"
  [globalFilterFields]="['nombres', 'apellidos', 'dni', 'ruc', 'email', 'telefono']"
>
  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem"><p-tableHeaderCheckbox /></th>
      <th pSortableColumn="nombres">Nombres <p-sortIcon field="nombres"/></th>
      <th pSortableColumn="apellidos">Apellidos <p-sortIcon field="apellidos"/></th>
      <th pSortableColumn="dni">DNI <p-sortIcon field="dni"/></th>
      <th pSortableColumn="ruc">RUC <p-sortIcon field="ruc"/></th>
      <th pSortableColumn="telefono">Teléfono <p-sortIcon field="telefono"/></th>
      <th pSortableColumn="email">Email <p-sortIcon field="email"/></th>
      <th pSortableColumn="estado">Estado <p-sortIcon field="estado"/></th>
      <th>Acciones</th>
    </tr>
  </ng-template>
  <ng-template pTemplate="body" let-cliente>
    <tr>
      <td><p-tableCheckbox [value]="cliente"/></td>
      <td>{{cliente.nombres}}</td>
      <td>{{cliente.apellidos}}</td>
      <td>{{cliente.dni}}</td>
      <td>{{cliente.ruc}}</td>
      <td>{{cliente.telefono}}</td>
      <td>{{cliente.email}}</td>
      <td>
        <p-tag 
          [value]="cliente.estado ? 'Activo' : 'Inactivo'"
          [severity]="cliente.estado ? 'success' : 'danger'">
        </p-tag>
      </td>
      <td class="flex gap-2">
        <ng-container *appHasPermission="{module: 'clientes', permission: permissionTypes.EDIT}">
          <p-button icon="pi pi-pencil" class="p-button-rounded p-button-info mr-1" (click)="editCliente(cliente)"></p-button>
        </ng-container>
        
        <ng-container *appHasPermission="{module: 'clientes', permission: permissionTypes.EDIT}">
          <ng-container *ngIf="cliente.estado">
            <p-button icon="pi pi-ban" class="p-button-rounded p-button-warning mr-1" (click)="desactivar(cliente)"></p-button>
          </ng-container>
          <ng-container *ngIf="!cliente.estado">
            <p-button icon="pi pi-check" class="p-button-rounded p-button-success mr-1" (click)="reactivar(cliente)"></p-button>
          </ng-container>
        </ng-container>
        
        <ng-container *appHasPermission="{module: 'clientes', permission: permissionTypes.DELETE}">
          <p-button icon="pi pi-trash" class="p-button-rounded p-button-danger" (click)="confirmarEliminacion(cliente)"></p-button>
        </ng-container>
      </td>
    </tr>
  </ng-template>
  <ng-template pTemplate="emptymessage">
    <tr><td colspan="9" class="text-center">No hay clientes para mostrar.</td></tr>
  </ng-template>
</p-table>

<!-- Diálogo formulario cliente -->
<p-dialog [(visible)]="visible" [header]="editMode ? 'Editar Cliente' : 'Nuevo Cliente'" [modal]="true" [style]="{width: '500px'}" (onHide)="hideDialog()">
  <ng-template pTemplate="content">
    <form (ngSubmit)="guardarCliente()">
      <div class="field">
        <label>Nombres*</label>
        <input pInputText [(ngModel)]="cliente.nombres" name="nombres" required/>
      </div>
      <div class="field">
        <label>Apellidos*</label>
        <input pInputText [(ngModel)]="cliente.apellidos" name="apellidos" required/>
      </div>
      <div class="field">
        <label>DNI</label>
        <input pInputText [(ngModel)]="cliente.dni" name="dni" maxlength="8" pattern="[0-9]{8}" />
      </div>
      <div class="field">
        <label>RUC</label>
        <input pInputText [(ngModel)]="cliente.ruc" name="ruc" maxlength="11" pattern="[0-9]{11}" />
      </div>
      <div class="field">
        <label>Teléfono</label>
        <input pInputText [(ngModel)]="cliente.telefono" name="telefono"/>
      </div>
      <div class="field">
        <label>Email</label>
        <input pInputText [(ngModel)]="cliente.email" name="email" type="email"/>
      </div>
      <div class="field">
        <label>Dirección</label>
        <input pInputText [(ngModel)]="cliente.direccion" name="direccion"/>
      </div>
      <div class="field">
        <label>Fecha de Nacimiento</label>
        <p-datepicker [(ngModel)]="cliente.fechaNacimiento" name="fechaNacimiento" dateFormat="yy-mm-dd" [showIcon]="true"/>
      </div>
    </form>
  </ng-template>
  <ng-template pTemplate="footer">
    <p-button label="Cancelar" icon="pi pi-times" text (click)="hideDialog()"></p-button>
    <p-button label="Guardar" icon="pi pi-check" (click)="guardarCliente()" [loading]="loading"></p-button>
  </ng-template>
</p-dialog>