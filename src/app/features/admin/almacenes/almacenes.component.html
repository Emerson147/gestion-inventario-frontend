<p-toast position="top-right" [life]="4000" />
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- Header premium con dashboard metrics -->
<div class="mb-6">
  <!-- Header principal con gradiente y métricas -->
  <div class="bg-gradient-to-r from-white via-blue-50 to-white rounded-xl p-6 shadow-sm border border-gray-100">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
      <!-- Título principal -->
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="bg-blue-600 p-3 rounded-lg shadow-lg">
            <i class="pi pi-building text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900 m-0">Gestión de Almacenes</h1>
            <p class="text-gray-600 mt-1 mb-0">Control inteligente de infraestructura y ubicaciones</p>
          </div>
        </div>
      </div>
      
      <!-- Dashboard metrics avanzado -->
      <div class="flex flex-wrap gap-4">
        <!-- Total almacenes -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] warehouse-entrance">
          <div class="flex items-center gap-3">
            <div class="bg-blue-100 p-2 rounded-lg">
              <i class="pi pi-building text-blue-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-blue-600">{{ calcularEstadisticas().totalAlmacenes }}</div>
              <div class="text-sm text-gray-600 font-medium">Total</div>
            </div>
          </div>
        </div>
        
        <!-- Almacenes activos -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] warehouse-entrance">
          <div class="flex items-center gap-3">
            <div class="bg-green-100 p-2 rounded-lg">
              <i class="pi pi-check-circle text-green-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-600">{{ calcularEstadisticas().almacenesActivos }}</div>
              <div class="text-sm text-gray-600 font-medium">Activos</div>
            </div>
          </div>
        </div>
        
        <!-- Capacidad total -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] warehouse-entrance" 
             *ngIf="calcularEstadisticas().capacidadTotal > 0">
          <div class="flex items-center gap-3">
            <div class="bg-purple-100 p-2 rounded-lg">
              <i class="pi pi-database text-purple-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-purple-600">{{ calcularEstadisticas().capacidadTotal | number:'1.0-0' }}</div>
              <div class="text-sm text-gray-600 font-medium">Capacidad</div>
            </div>
          </div>
        </div>
        
        <!-- Ocupación promedio -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] warehouse-entrance"
             *ngIf="calcularEstadisticas().porcentajeOcupacion > 0">
          <div class="flex items-center gap-3">
            <div class="bg-orange-100 p-2 rounded-lg">
              <i class="pi pi-chart-pie text-orange-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-orange-600">{{ calcularEstadisticas().porcentajeOcupacion | number:'1.0-0' }}%</div>
              <div class="text-sm text-gray-600 font-medium">Ocupación</div>
            </div>
          </div>
        </div>
        
        <!-- Zonas totales -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] warehouse-entrance"
             *ngIf="calcularEstadisticas().zonasTotal > 0">
          <div class="flex items-center gap-3">
            <div class="bg-indigo-100 p-2 rounded-lg">
              <i class="pi pi-sitemap text-indigo-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-indigo-600">{{ calcularEstadisticas().zonasTotal }}</div>
              <div class="text-sm text-gray-600 font-medium">Zonas</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toolbar moderno con controles avanzados -->
<div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-6">
  <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
    <!-- Acciones principales -->
    <div class="flex flex-wrap gap-3">
      <p-button 
        *appHasPermission="{module: 'almacenes', permission: permissionTypes.CREATE}" 
        label="Nuevo Almacén" 
        icon="pi pi-plus" 
        size="large"
        class="shadow-sm hover:shadow-md transition-all duration-300" 
        (click)="openNew()"
        (keyup.enter)="openNew()"
        (keyup.space)="openNew()"
        tabindex="0"
        role="button"
        aria-label="Abrir formulario de nuevo almacén"
        pTooltip="Crear nuevo almacén"
      />
      <p-button 
        *appHasPermission="{module: 'almacenes', permission: permissionTypes.DELETE}"
        [label]="'Eliminar (' + (selectedAlmacenes.length || 0) + ')'" 
        icon="pi pi-trash" 
        severity="danger"
        [outlined]="true"
        size="large"
        class="shadow-sm hover:shadow-md transition-all duration-300" 
        (click)="deleteSelectedAlmacenes()"
        (keyup.enter)="deleteSelectedAlmacenes()"
        (keyup.space)="deleteSelectedAlmacenes()"
        tabindex="0"
        role="button"
        [attr.aria-label]="'Eliminar ' + selectedAlmacenes.length + ' almacenes seleccionados'"
        [disabled]="!selectedAlmacenes.length"
        pTooltip="Eliminar almacenes seleccionados"
      />
      <p-button 
        label="Configurar Zonas" 
        icon="pi pi-sitemap" 
        severity="info"
        [outlined]="true"
        size="large"
        class="shadow-sm hover:shadow-md transition-all duration-300" 
        (click)="mostrarZonas()"
        (keyup.enter)="mostrarZonas()"
        (keyup.space)="mostrarZonas()"
        tabindex="0"
        role="button"
        aria-label="Mostrar zonas de almacenamiento"
        pTooltip="Gestionar zonas de almacenes"
      />
      <p-button 
        label="Mapa Global" 
        icon="pi pi-map" 
        severity="success"
        [outlined]="true"
        size="large"
        class="shadow-sm hover:shadow-md transition-all duration-300" 
        (click)="mostrarMapa()"
        (keyup.enter)="mostrarMapa()"
        (keyup.space)="mostrarMapa()"
        tabindex="0"
        role="button"
        aria-label="Mostrar mapa de almacenes"
        pTooltip="Vista de mapa de almacenes"
      />
    </div>

    <!-- Controles de vista y utilidades -->
    <div class="flex flex-wrap items-center gap-3">
      <!-- Selector de vista -->
      <div class="flex items-center gap-2">
        <span class="text-sm font-medium text-gray-700">Vista:</span>
        <p-selectButton 
          [(ngModel)]="currentView" 
          [options]="viewOptions" 
          optionLabel="label" 
          optionValue="value"
          size="small"
          class="shadow-sm"
        >
          <ng-template let-option pTemplate="option">
            <i [class]="option.icon" class="mr-2"></i>
            {{option.label}}
          </ng-template>
        </p-selectButton>
      </div>

      <!-- Utilidades -->
      <div class="flex gap-2">
        <p-button 
          icon="pi pi-chart-bar" 
          severity="info" 
          [outlined]="true"
          [rounded]="true"
          size="large"
          pTooltip="Ver estadísticas"
          class="shadow-sm hover:shadow-md transition-all duration-300"
          (click)="mostrarEstadisticas()"
          (keyup.enter)="mostrarEstadisticas()"
          (keyup.space)="mostrarEstadisticas()"
          tabindex="0"
          role="button"
          aria-label="Mostrar estadísticas"
        />
        <p-button 
          icon="pi pi-filter" 
          severity="secondary" 
          [outlined]="true"
          [rounded]="true"
          size="large"
          pTooltip="Filtros avanzados"
          class="shadow-sm hover:shadow-md transition-all duration-300"
          (click)="mostrarFiltros()"
          (keyup.enter)="mostrarFiltros()"
          (keyup.space)="mostrarFiltros()"
          tabindex="0"
          role="button"
          [attr.aria-expanded]="filtrosVisibles"
          [attr.aria-label]="filtrosVisibles ? 'Ocultar filtros' : 'Mostrar filtros'"
        />
        <p-button 
          icon="pi pi-download" 
          severity="success" 
          [outlined]="true"
          [rounded]="true"
          size="large"
          pTooltip="Exportar a Excel"
          class="shadow-sm hover:shadow-md transition-all duration-300"
          (click)="exportarExcel()"
          (keyup.enter)="exportarExcel()"
          (keyup.space)="exportarExcel()"
          tabindex="0"
          role="button"
          aria-label="Exportar a Excel"
          [disabled]="!almacenes.length"
        />
        <p-button 
          icon="pi pi-refresh" 
          severity="secondary" 
          [outlined]="true"
          [rounded]="true"
          size="large"
          pTooltip="Actualizar datos"
          class="shadow-sm hover:shadow-md transition-all duration-300"
          (click)="loadAlmacenes()"
          (keyup.enter)="loadAlmacenes()"
          (keyup.space)="loadAlmacenes()"
          tabindex="0"
          role="button"
          aria-label="Recargar almacenes"
        />
      </div>
    </div>
  </div>
</div>

<!-- Vista Grid Premium (Principal) -->
<div *ngIf="currentView === 'grid'" class="mb-6">
  <div *ngIf="almacenes.length; else emptyWarehouses">
    <div class="warehouse-grid">
      <div 
        *ngFor="let almacen of almacenes; trackBy: trackByAlmacen" 
        class="warehouse-card bg-white rounded-2xl overflow-hidden border border-gray-200 hover:shadow-xl transition-all duration-300 warehouse-entrance"
      >
        <!-- Header del almacén con gradiente -->
        <div 
          class="p-6 text-white relative"
          [ngClass]="{
            'bg-gradient-to-r from-green-500 to-blue-500': almacen.estado === 'ACTIVO',
            'bg-gradient-to-r from-gray-500 to-gray-600': almacen.estado === 'INACTIVO',
            'bg-gradient-to-r from-orange-500 to-red-500': almacen.estado === 'MANTENIMIENTO'
          }"
        >
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="bg-white bg-opacity-20 p-3 rounded-lg">
                <i class="pi pi-building text-white text-xl"></i>
              </div>
              <div>
                <h3 class="font-bold text-lg m-0">{{almacen?.nombre}}</h3>
                <p class="text-sm opacity-90 mt-1">{{almacen?.tipoAlmacen || 'SUCURSAL'}}</p>
              </div>
            </div>
            
            <!-- Estado del almacén -->
            <div class="text-right">
              <p-tag 
                [value]="almacen?.estado || 'ACTIVO'"
                [severity]="getEstadoColor(almacen?.estado || 'ACTIVO')"
                [icon]="getEstadoIcon(almacen?.estado || 'ACTIVO')"
                styleClass="text-xs font-medium"
              />
            </div>
          </div>
          
          <!-- Métricas del almacén -->
          <div class="grid grid-cols-3 gap-3 text-center">
            <div class="bg-white bg-opacity-10 rounded-lg p-3">
              <div class="text-2xl font-bold">{{almacen?.capacidadMaxima || 0 | number:'1.0-0'}}</div>
              <div class="text-xs opacity-80">Capacidad</div>
            </div>
            <div class="bg-white bg-opacity-10 rounded-lg p-3">
              <div class="text-2xl font-bold">{{almacen?.capacidadUtilizada || 0 | number:'1.0-0'}}</div>
              <div class="text-xs opacity-80">Utilizada</div>
            </div>
            <div class="bg-white bg-opacity-10 rounded-lg p-3">
              <div class="text-2xl font-bold">{{almacen?.porcentajeOcupacion || 0 | number:'1.0-0'}}%</div>
              <div class="text-xs opacity-80">Ocupación</div>
            </div>
          </div>
        </div>
        
        <!-- Contenido del almacén -->
        <div class="p-6">
          <!-- Información básica -->
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-3">
              <i class="pi pi-map-marker text-green-600"></i>
              <span class="font-medium text-gray-800">Ubicación</span>
            </div>
            <p class="text-gray-600 text-sm">{{almacen?.ubicacion}}</p>
            
            <div class="flex items-center gap-2 mt-3" *ngIf="almacen?.descripcion">
              <i class="pi pi-file-edit text-blue-600"></i>
              <span class="font-medium text-gray-800">Descripción</span>
            </div>
            <p class="text-gray-600 text-sm mt-1" *ngIf="almacen?.descripcion">
              {{(almacen?.descripcion?.length || 0) > 80 ? (almacen?.descripcion | slice:0:80) + '...' : almacen?.descripcion}}
            </p>
          </div>
          
          <!-- Información extendida -->
          <div class="mb-4" *ngIf="almacen?.responsable">
            <div class="flex items-center gap-2 mb-2">
              <i class="pi pi-user text-purple-600"></i>
              <span class="font-medium text-gray-800">Responsable</span>
            </div>
            <div class="text-sm text-gray-600">{{almacen?.responsable}}</div>
            <div class="text-xs text-gray-500" *ngIf="almacen?.telefono">Tel: {{almacen?.telefono}}</div>
          </div>
          
          <!-- Barra de capacidad visual -->
          <div class="mb-4" *ngIf="almacen?.capacidadMaxima">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
              <span>Capacidad Utilizada</span>
              <span>{{almacen?.porcentajeOcupacion || 0 | number:'1.0-0'}}%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3 overflow-hidden">
              <div 
                class="h-3 rounded-full transition-all duration-500"
                [ngClass]="{
                  'bg-gradient-to-r from-green-400 to-green-600': (almacen?.porcentajeOcupacion || 0) < 75,
                  'bg-gradient-to-r from-yellow-400 to-orange-500': (almacen?.porcentajeOcupacion || 0) >= 75 && (almacen?.porcentajeOcupacion || 0) < 90,
                  'bg-gradient-to-r from-red-400 to-red-600': (almacen?.porcentajeOcupacion || 0) >= 90
                }"
                [style.width.%]="almacen.porcentajeOcupacion || 0"
              ></div>
            </div>
          </div>
          
          <!-- KPIs del almacén -->
          <div class="mb-4" *ngIf="almacen?.kpis">
            <div class="text-sm font-medium text-gray-700 mb-2">Indicadores</div>
            <div class="grid grid-cols-2 gap-2">
              <div class="bg-blue-50 rounded-lg p-2 text-center">
                <div class="font-bold text-blue-600">{{almacen?.kpis?.eficienciaEspacio | number:'1.0-0'}}%</div>
                <div class="text-xs text-blue-700">Eficiencia</div>
              </div>
              <div class="bg-green-50 rounded-lg p-2 text-center">
                <div class="font-bold text-green-600">{{almacen?.kpis?.preciscionInventario | number:'1.0-0'}}%</div>
                <div class="text-xs text-green-700">Precisión</div>
              </div>
            </div>
          </div>
          
          <!-- Zonas del almacén -->
          <div class="mb-4" *ngIf="almacen.zonas && almacen.zonas.length > 0">
            <div class="text-sm font-medium text-gray-700 mb-2">Zonas ({{almacen.zonas.length}})</div>
            <div class="flex flex-wrap gap-1">
              <p-chip 
                *ngFor="let zona of almacen.zonas.slice(0, 3)" 
                [label]="zona?.codigo || 'Sin código'" 
                size="small"
                styleClass="bg-gray-100 text-gray-700 text-xs"
              />
              <p-chip 
                *ngIf="almacen.zonas.length > 3"
                [label]="'+' + (almacen.zonas.length - 3) + ' más'" 
                size="small"
                styleClass="bg-blue-100 text-blue-700 text-xs"
              />
            </div>
          </div>
          
          <!-- Fecha de creación -->
          <div class="text-xs text-gray-500 mb-4" *ngIf="almacen?.fechaCreacion">
            Creado: {{almacen?.fechaCreacion | date:'dd/MM/yyyy'}}
          </div>
          
          <!-- Acciones del almacén -->
          <div class="flex gap-2">
            <p-button 
              label="Detalle" 
              icon="pi pi-eye" 
              size="small"
              [outlined]="true"
              class="flex-1"
              (click)="mostrarDetalle(almacen)"
              (keyup.enter)="mostrarDetalle(almacen)"
              (keyup.space)="mostrarDetalle(almacen)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Ver detalles de ' + almacen.nombre"
            />
            <p-button 
              icon="pi pi-sitemap" 
              size="small"
              severity="info"
              [outlined]="true"
              pTooltip="Ver zonas"
              (click)="mostrarZonas(almacen)"
            />
            <p-button 
              *appHasPermission="{module: 'almacenes', permission: permissionTypes.EDIT}"
              icon="pi pi-pencil" 
              size="small"
              pTooltip="Editar"
              (click)="editAlmacen(almacen)"
              (keyup.enter)="editAlmacen(almacen)"
              (keyup.space)="editAlmacen(almacen)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Editar ' + almacen.nombre"
            />
            <p-button 
              *appHasPermission="{module: 'almacenes', permission: permissionTypes.DELETE}"
              icon="pi pi-trash" 
              severity="danger" 
              size="small"
              [outlined]="true"
              pTooltip="Eliminar"
              (click)="deleteAlmacen(almacen)"
              (keyup.enter)="deleteAlmacen(almacen)"
              (keyup.space)="deleteAlmacen(almacen)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Eliminar ' + almacen.nombre"
            />
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template #emptyWarehouses>
    <div class="text-center py-20">
      <div class="bg-blue-100 p-12 rounded-full inline-block mb-6 float-animation">
        <i class="pi pi-building text-6xl text-blue-600"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-700 mb-3">No hay almacenes configurados</h3>
      <p class="text-gray-500 mb-6 max-w-md mx-auto">
        Comienza creando tu primer almacén para gestionar eficientemente tu inventario y operaciones de almacenamiento.
      </p>
      <p-button 
        *appHasPermission="{module: 'almacenes', permission: permissionTypes.CREATE}"
        label="Crear Primer Almacén" 
        icon="pi pi-plus" 
        size="large"
        class="shadow-lg hover:shadow-xl transition-all duration-300" 
        (click)="openNew()"
        (keyup.enter)="openNew()"
        (keyup.space)="openNew()"
        tabindex="0"
        role="button"
        aria-label="Abrir formulario de nuevo almacén"
      />
    </div>
  </ng-template>
</div>

<!-- Vista de Mapa -->
<div *ngIf="currentView === 'map'" class="mb-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <!-- Header del mapa -->
    <div class="bg-gradient-to-r from-green-50 to-blue-50 p-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-green-600 p-2 rounded-lg">
            <i class="pi pi-map text-white"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold text-gray-800 m-0">Mapa Global de Almacenes</h3>
            <p class="text-sm text-gray-600 mt-1">{{almacenes.length}} ubicaciones registradas</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenido del mapa (simulado) -->
    <div class="p-6">
      <div class="bg-gradient-to-br from-blue-100 to-green-100 rounded-xl p-12 text-center">
        <div class="bg-blue-600 p-6 rounded-full inline-block mb-4">
          <i class="pi pi-map text-white text-4xl"></i>
        </div>
        <h4 class="text-xl font-bold text-gray-800 mb-2">Vista de Mapa Interactivo</h4>
        <p class="text-gray-600 mb-4">Integración con Google Maps / OpenStreetMap</p>
        <div class="text-sm text-blue-600">
          <i class="pi pi-info-circle mr-1"></i>
          Esta funcionalidad requiere configuración de API de mapas
        </div>
      </div>
      
      <!-- Lista de ubicaciones -->
      <div class="mt-6">
        <h4 class="font-bold text-gray-800 mb-4">Ubicaciones Registradas</h4>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <div 
            *ngFor="let almacen of almacenes" 
            class="bg-gray-50 rounded-lg p-4 hover:bg-gray-100 transition-colors duration-300"
          >
            <div class="flex items-center gap-3">
              <div class="bg-green-100 p-2 rounded-lg">
                <i class="pi pi-map-marker text-green-600"></i>
              </div>
              <div>
                <div class="font-medium text-gray-800">{{almacen?.nombre}}</div>
                <div class="text-sm text-gray-600">{{almacen?.ubicacion}}</div>
                <div class="text-xs text-gray-500" *ngIf="almacen?.ubicacionGeografica">
                  {{almacen?.ubicacionGeografica?.ciudad}}, {{almacen?.ubicacionGeografica?.pais}}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Vista de Lista (Tabla modernizada) -->
<div *ngIf="currentView === 'list'" class="mb-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <p-table
      #dt
      [value]="almacenes"
      [rows]="10"
      [paginator]="true"
      [globalFilterFields]="['nombre', 'ubicacion', 'descripcion', 'responsable']"
      [tableStyle]="{'min-width': '75rem'}"
      [(selection)]="selectedAlmacenes"
      [rowHover]="true"
      dataKey="id"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} almacenes"
      [rowsPerPageOptions]="[5, 10, 20, 30, 50]"
      [loading]="loading"
      [alwaysShowPaginator]="true"
      styleClass="p-datatable-gridlines p-datatable-striped"
    >
      <!-- Caption modernizado -->
      <ng-template pTemplate="caption">
        <div class="bg-gradient-to-r from-blue-50 to-green-50 p-4 border-b border-gray-200">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex items-center gap-3">
              <div class="bg-blue-600 p-2 rounded-lg">
                <i class="pi pi-list text-white"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold text-gray-800 m-0">Lista Detallada de Almacenes</h3>
                <p class="text-sm text-gray-600 mt-1" *ngIf="almacenes?.length">
                  {{almacenes.length}} almacenes registrados en el sistema
                </p>
              </div>
            </div>
            <div class="flex gap-3">
              <p-iconfield>
                <p-inputicon styleClass="pi pi-search" />
                <input 
                  pInputText 
                  type="text" 
                  (input)="onGlobalFilter(dt, $event)" 
                  placeholder="Búsqueda rápida..." 
                  class="w-80 h-10 rounded-lg"
                />
              </p-iconfield>
            </div>
          </div>
        </div>
      </ng-template>

      <!-- Header modernizado -->
      <ng-template pTemplate="header">
        <tr class="bg-gray-50">
          <th style="width: 3rem" class="text-center border-b-2 border-gray-200">
            <p-tableHeaderCheckbox />
          </th>
          <th pSortableColumn="nombre" style="min-width:15rem" class="border-b-2 border-gray-200">
            <div class="flex items-center gap-2 font-bold text-gray-700">
              <i class="pi pi-building text-blue-600"></i>
              Almacén
              <p-sortIcon field="nombre" />
            </div>
          </th>
          <th pSortableColumn="ubicacion" style="min-width:15rem" class="border-b-2 border-gray-200">
            <div class="flex items-center gap-2 font-bold text-gray-700">
              <i class="pi pi-map-marker text-green-600"></i>
              Ubicación
              <p-sortIcon field="ubicacion" />
            </div>
          </th>
          <th style="min-width:10rem" class="text-center border-b-2 border-gray-200">
            <div class="flex items-center justify-center gap-2 font-bold text-gray-700">
              <i class="pi pi-chart-pie text-purple-600"></i>
              Capacidad
            </div>
          </th>
          <th style="min-width:8rem" class="text-center border-b-2 border-gray-200">
            <div class="flex items-center justify-center gap-2 font-bold text-gray-700">
              <i class="pi pi-bookmark text-indigo-600"></i>
              Estado
            </div>
          </th>
          <th style="min-width:10rem" class="text-center border-b-2 border-gray-200">
            <div class="flex items-center justify-center gap-2 font-bold text-gray-700">
              <i class="pi pi-user text-orange-600"></i>
              Responsable
            </div>
          </th>
          <th pSortableColumn="fechaCreacion" style="min-width:10rem" class="text-center border-b-2 border-gray-200">
            <div class="flex items-center justify-center gap-2 font-bold text-gray-700">
              <i class="pi pi-calendar text-gray-600"></i>
              Creación
              <p-sortIcon field="fechaCreacion" />
            </div>
          </th>
          <th style="min-width:12rem" class="text-center border-b-2 border-gray-200">
            <div class="flex items-center justify-center gap-2 font-bold text-gray-700">
              <i class="pi pi-cog text-gray-600"></i>
              Acciones
            </div>
          </th>
        </tr>
      </ng-template>

      <!-- Body de la tabla modernizado -->
      <ng-template pTemplate="body" let-almacen let-rowIndex="rowIndex">
        <tr class="hover:bg-blue-50 transition-colors duration-200" [class.bg-gray-25]="rowIndex % 2 === 0">
          <td class="text-center">
            <p-tableCheckbox [value]="almacen" />
          </td>
          
          <!-- Almacén -->
          <td>
            <div class="flex items-center gap-3">
              <div class="bg-blue-100 p-2 rounded-lg">
                <i class="pi pi-building text-blue-600"></i>
              </div>
              <div>
                <div class="font-bold text-gray-900">{{almacen?.nombre}}</div>
                <div class="text-sm text-gray-500">{{almacen?.tipoAlmacen || 'SUCURSAL'}}</div>
                <div class="text-xs text-gray-400" *ngIf="almacen.id">ID: {{almacen.id}}</div>
              </div>
            </div>
          </td>
          
          <!-- Ubicación -->
          <td>
            <div class="flex items-center gap-2">
              <i class="pi pi-map-marker text-green-600"></i>
              <div>
                <div class="font-medium text-gray-800">{{almacen.ubicacion}}</div>
                <div class="text-sm text-gray-500" *ngIf="almacen.ubicacionGeografica">
                  {{almacen.ubicacionGeografica?.ciudad}}, {{almacen.ubicacionGeografica?.pais}}
                </div>
              </div>
            </div>
          </td>
          
          <!-- Capacidad -->
          <td class="text-center">
            <div class="flex flex-col items-center gap-1" *ngIf="almacen.capacidadMaxima">
              <div class="text-sm font-medium text-gray-700">
                {{almacen.capacidadUtilizada || 0 | number:'1.0-0'}} / {{almacen.capacidadMaxima | number:'1.0-0'}}
              </div>
              <div class="w-full max-w-20">
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    class="h-2 rounded-full transition-all duration-500"
                    [ngClass]="{
                      'bg-green-500': (almacen?.porcentajeOcupacion || 0) < 75,
                      'bg-yellow-500': (almacen?.porcentajeOcupacion || 0) >= 75 && (almacen?.porcentajeOcupacion || 0) < 90,
                      'bg-red-500': (almacen?.porcentajeOcupacion || 0) >= 90
                    }"
                    [style.width.%]="almacen?.porcentajeOcupacion || 0"
                  ></div>
                </div>
              </div>
              <div class="text-xs text-gray-500">{{almacen?.porcentajeOcupacion || 0 | number:'1.0-0'}}%</div>
            </div>
            <div *ngIf="!almacen.capacidadMaxima" class="text-gray-400 text-sm">Sin datos</div>
          </td>
          
          <!-- Estado -->
          <td class="text-center">
            <p-tag 
              [value]="almacen.estado || 'ACTIVO'"
              [severity]="getEstadoColor(almacen.estado || 'ACTIVO')"
              [icon]="getEstadoIcon(almacen.estado || 'ACTIVO')"
              class="shadow-sm font-medium"
            />
          </td>
          
          <!-- Responsable -->
          <td class="text-center">
            <div *ngIf="almacen.responsable; else sinResponsable">
              <div class="font-medium text-gray-800">{{almacen.responsable}}</div>
              <div class="text-xs text-gray-500" *ngIf="almacen.telefono">{{almacen.telefono}}</div>
            </div>
            <ng-template #sinResponsable>
              <span class="text-gray-400 italic">Sin asignar</span>
            </ng-template>
          </td>
          
          <!-- Fecha de creación -->
          <td class="text-center">
            <div *ngIf="almacen.fechaCreacion; else sinFecha" class="text-sm">
              <div class="font-medium text-gray-800">{{almacen.fechaCreacion | date:'dd/MM/yyyy'}}</div>
              <div class="text-xs text-gray-500">{{almacen.fechaCreacion | date:'HH:mm'}}</div>
            </div>
            <ng-template #sinFecha>
              <span class="text-gray-400">No disponible</span>
            </ng-template>
          </td>
          
          <!-- Acciones -->
          <td>
            <div class="flex gap-2 justify-center">
              <!-- Botón Ver Detalles -->
              <p-button 
                icon="pi pi-eye" 
                [rounded]="true" 
                [outlined]="true"
                severity="info"
                size="small"
                pTooltip="Ver detalles"
                class="hover:shadow-md transition-all duration-300"
                (click)="mostrarDetalle(almacen)"
              (keyup.enter)="mostrarDetalle(almacen)"
              (keyup.space)="mostrarDetalle(almacen)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Ver detalles de ' + almacen.nombre"
              />
              <!-- Botón Zonas -->
              <p-button 
                icon="pi pi-sitemap" 
                [rounded]="true" 
                [outlined]="true"
                severity="secondary"
                size="small"
                pTooltip="Gestionar zonas"
                class="hover:shadow-md transition-all duration-300"
                (click)="mostrarZonas(almacen)"
              />
              <!-- Botón Editar -->
              <p-button 
                *appHasPermission="{module: 'almacenes', permission: permissionTypes.EDIT}"
                icon="pi pi-pencil" 
                [rounded]="true" 
                [outlined]="true"
                size="small"
                pTooltip="Editar"
                class="hover:shadow-md transition-all duration-300"
                (click)="editAlmacen(almacen)"
              (keyup.enter)="editAlmacen(almacen)"
              (keyup.space)="editAlmacen(almacen)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Editar ' + almacen.nombre"
              />
              <!-- Botón Eliminar -->
              <p-button 
                *appHasPermission="{module: 'almacenes', permission: permissionTypes.DELETE}"
                icon="pi pi-trash" 
                severity="danger" 
                [rounded]="true" 
                [outlined]="true"
                size="small"
                pTooltip="Eliminar"
                class="hover:shadow-md transition-all duration-300"
                (click)="deleteAlmacen(almacen)"
              (keyup.enter)="deleteAlmacen(almacen)"
              (keyup.space)="deleteAlmacen(almacen)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Eliminar ' + almacen.nombre"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Empty message modernizado -->
      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-12">
            <div class="bg-blue-100 p-8 rounded-full inline-block mb-4">
              <i class="pi pi-building text-6xl text-blue-600"></i>
            </div>
            <div class="text-center">
              <div class="text-2xl font-bold text-gray-700 mb-2">No hay almacenes disponibles</div>
              <div class="text-gray-500 mb-6">No se encontraron almacenes en el sistema</div>
              <p-button 
                *appHasPermission="{module: 'almacenes', permission: permissionTypes.CREATE}"
                label="Crear Primer Almacén" 
                icon="pi pi-plus" 
                size="large"
                class="shadow-lg hover:shadow-xl transition-all duration-300" 
                (click)="openNew()"
        (keyup.enter)="openNew()"
        (keyup.space)="openNew()"
        tabindex="0"
        role="button"
        aria-label="Abrir formulario de nuevo almacén"
              />
            </div>
          </td>
        </tr>
      </ng-template>

      <!-- Loading template -->
      <ng-template pTemplate="loadingbody">
        <tr>
          <td colspan="8">
            <div class="flex items-center justify-center py-8">
              <div class="flex items-center gap-3">
                <i class="pi pi-spin pi-spinner text-blue-600 text-2xl"></i>
                <span class="text-lg font-medium text-gray-600">Cargando almacenes...</span>
              </div>
            </div>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </div>
</div>

<!-- Vista de Analytics -->
<div *ngIf="currentView === 'analytics'" class="mb-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <!-- Header de analytics -->
    <div class="bg-gradient-to-r from-purple-50 to-pink-50 p-4 border-b border-gray-200">
      <div class="flex items-center gap-3">
        <div class="bg-purple-600 p-2 rounded-lg">
          <i class="pi pi-chart-bar text-white"></i>
        </div>
        <div>
          <h3 class="text-xl font-bold text-gray-800 m-0">Analytics de Almacenes</h3>
          <p class="text-sm text-gray-600 mt-1">Análisis detallado de capacidad, eficiencia y rendimiento</p>
        </div>
      </div>
    </div>

    <div class="p-6" *ngIf="almacenes?.length; else noAnalyticsData">
      <div class="analytics-grid">
        <!-- KPIs principales -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 col-span-full">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-dashboard text-blue-600"></i>
            Indicadores Clave de Rendimiento
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <!-- Eficiencia promedio -->
            <div class="text-center">
              <p-knob 
                [value]="calcularEstadisticas().eficienciaPromedio || 0"
                [size]="80"
                [readonly]="true"
                valueTemplate="{value}%"
                [strokeWidth]="8"
                fill="#3b82f6"
                textColor="#374151"
              />
              <div class="mt-2 font-medium text-gray-700">Eficiencia Promedio</div>
              <div class="text-sm text-gray-500">Uso del espacio</div>
            </div>
            
            <!-- Ocupación global -->
            <div class="text-center">
              <p-knob 
                [value]="calcularEstadisticas().porcentajeOcupacion || 0"
                [size]="80"
                [readonly]="true"
                valueTemplate="{value}%"
                [strokeWidth]="8"
                fill="#10b981"
                textColor="#374151"
              />
              <div class="mt-2 font-medium text-gray-700">Ocupación Global</div>
              <div class="text-sm text-gray-500">Capacidad utilizada</div>
            </div>
            
            <!-- Disponibilidad -->
            <div class="text-center">
              <p-knob 
                [value]="getKnobValue()" 
                [size]="80"
                [readonly]="true"
                valueTemplate="{value}%"
                [strokeWidth]="8"
                [rangeColor]="'#f59e0b'"
                [valueColor]="'#374151'"
              />
              <div class="mt-2 font-medium text-gray-700">Disponibilidad</div>
              <div class="text-sm text-gray-500">Almacenes activos</div>
            </div>
            
            <!-- Performance -->
            <div class="text-center">
              <p-knob 
                [value]="getPerformanceValue()" 
                [size]="80"
                [readonly]="true"
                valueTemplate="{value}%"
                [strokeWidth]="8"
                [rangeColor]="'#8b5cf6'"
                [valueColor]="'#374151'"
              />
              <div class="mt-2 font-medium text-gray-700">Performance</div>
              <div class="text-sm text-gray-500">Rendimiento general</div>
            </div>
          </div>
        </div>
        
        <!-- Gráfico de distribución por estado -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-chart-pie text-purple-600"></i>
            Distribución por Estado
          </h4>
          <div class="chart-container">
            <p-chart 
              type="doughnut" 
              [data]="chartData" 
              [options]="chartOptions"
              [style.width]="'300px'"
              [style.height]="'300px'"
            />
          </div>
        </div>
        
        <!-- Capacidad por almacén -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-chart-bar text-green-600"></i>
            Capacidad por Almacén
          </h4>
          <div class="space-y-4">
            <div 
              *ngFor="let item of calcularEstadisticas().distribucionCapacidad.slice(0, 6)" 
              class="bg-gray-50 rounded-lg p-3"
            >
              <div class="flex justify-between items-center mb-2">
                <span class="font-medium text-gray-800 text-sm">{{item.almacen}}</span>
                <span class="font-bold text-blue-600 text-sm">{{item.porcentaje | number:'1.0-0'}}%</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div 
                  class="h-2 rounded-full transition-all duration-500"
                  [ngClass]="getCapacityClass(item.porcentaje)"
                  [style.width.%]="item.porcentaje"
                ></div>
              </div>
              <div class="text-xs text-gray-500 mt-1">
                {{item.utilizada | number:'1.0-0'}} / {{item.capacidad | number:'1.0-0'}} unidades
              </div>
            </div>
          </div>
        </div>
        
        <!-- Alertas de capacidad -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-exclamation-triangle text-orange-600"></i>
            Alertas de Capacidad
          </h4>
          <div class="space-y-3" *ngIf="calcularEstadisticas().alertasCapacidad.length; else noAlertas">
            <div 
              *ngFor="let alerta of calcularEstadisticas().alertasCapacidad" 
              class="rounded-lg p-3 border-l-4"
              [ngClass]="{
                'bg-red-50 border-red-500': alerta.severidad === 'high',
                'bg-orange-50 border-orange-500': alerta.severidad === 'medium',
                'bg-blue-50 border-blue-500': alerta.severidad === 'low'
              }"
            >
              <div class="flex items-start gap-2">
                <i 
                  [ngClass]="{
                    'pi pi-times-circle text-red-600': alerta.severidad === 'high',
                    'pi pi-exclamation-triangle text-orange-600': alerta.severidad === 'medium',
                    'pi pi-info-circle text-blue-600': alerta.severidad === 'low'
                  }"
                  class="mt-1"
                ></i>
                <div>
                  <div class="font-medium text-gray-800 text-sm">{{alerta.almacen}}</div>
                  <div class="text-sm text-gray-600">{{alerta.mensaje}}</div>
                </div>
              </div>
            </div>
          </div>
          <ng-template #noAlertas>
            <div class="text-center py-4 text-gray-500">
              <i class="pi pi-check-circle text-green-600 text-2xl mb-2"></i>
              <div class="text-sm">Sin alertas de capacidad</div>
            </div>
          </ng-template>
        </div>
        
        <!-- Estadísticas de zonas -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-sitemap text-indigo-600"></i>
            Distribución de Zonas
          </h4>
          <div class="space-y-3">
            <div 
              *ngFor="let tipo of tiposZona" 
              class="flex items-center justify-between p-2 rounded bg-gray-50"
            >
              <div class="flex items-center gap-2">
                <i [class]="tipo.icon" [style.color]="tipo.color"></i>
                <span class="text-sm font-medium">{{tipo.label}}</span>
              </div>
              <div class="text-sm font-bold text-gray-700">
                {{getZonasPorTipo(tipo.value)}}
              </div>
            </div>
          </div>
          
          <div class="mt-4 pt-3 border-t border-gray-200">
            <div class="text-center">
              <div class="text-2xl font-bold text-indigo-600">{{calcularEstadisticas().zonasTotal}}</div>
              <div class="text-sm text-gray-500">Total de zonas</div>
            </div>
          </div>
        </div>
        
        <!-- Métricas de rendimiento -->
        <div class="bg-white rounded-xl p-6 border border-gray-200">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-clock text-pink-600"></i>
            Métricas de Rendimiento
          </h4>
          <div class="space-y-4">
            <div class="bg-pink-50 rounded-lg p-3">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-gray-700">Tiempo Promedio Picking</span>
                <span class="font-bold text-pink-600">15.2 min</span>
              </div>
              <p-progressBar [value]="70" styleClass="h-2" />
            </div>
            
            <div class="bg-green-50 rounded-lg p-3">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-gray-700">Rotación de Inventario</span>
                <span class="font-bold text-green-600">82%</span>
              </div>
              <p-progressBar [value]="82" styleClass="h-2" />
            </div>
            
            <div class="bg-blue-50 rounded-lg p-3">
              <div class="flex justify-between items-center mb-1">
                <span class="text-sm font-medium text-gray-700">Precisión de Inventario</span>
                <span class="font-bold text-blue-600">94%</span>
              </div>
              <p-progressBar [value]="94" styleClass="h-2" />
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <ng-template #noAnalyticsData>
      <div class="text-center py-12">
        <div class="bg-purple-100 p-8 rounded-full inline-block mb-4">
          <i class="pi pi-chart-bar text-4xl text-purple-600"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-700 mb-2">No hay datos para analizar</h3>
        <p class="text-gray-500">Configure almacenes para ver análisis detallados</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Vista de Zonas -->
<div *ngIf="currentView === 'zones'" class="mb-6">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
    <!-- Header de zonas -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 p-4 border-b border-gray-200">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-indigo-600 p-2 rounded-lg">
            <i class="pi pi-sitemap text-white"></i>
          </div>
          <div>
            <h3 class="text-xl font-bold text-gray-800 m-0">Gestión de Zonas</h3>
            <p class="text-sm text-gray-600 mt-1">Organización interna de almacenes</p>
          </div>
        </div>
        <p-button 
          label="Configurar Zonas" 
          icon="pi pi-plus" 
          (click)="mostrarZonas()"
        (keyup.enter)="mostrarZonas()"
        (keyup.space)="mostrarZonas()"
        tabindex="0"
        role="button"
        aria-label="Mostrar zonas de almacenamiento"
        />
      </div>
    </div>

    <div class="p-6" *ngIf="almacenes?.length; else noZonesData">
      <!-- Lista de almacenes con sus zonas -->
      <p-accordion [multiple]="true">
        <p-accordionTab 
          *ngFor="let almacen of almacenes; trackBy: trackByAlmacen" 
          [header]="almacen.nombre || 'Almacén sin nombre'"
        >
          <ng-template pTemplate="header">
            <div class="flex items-center justify-between w-full">
              <div class="flex items-center gap-3">
                <div class="bg-indigo-100 p-2 rounded-lg">
                  <i class="pi pi-building text-indigo-600"></i>
                </div>
                <div>
                  <div class="font-medium text-gray-800">{{almacen.nombre}}</div>
                  <div class="text-sm text-gray-500">{{almacen.zonas?.length || 0}} zonas configuradas</div>
                </div>
              </div>
              <div class="flex items-center gap-2">
                <p-tag 
                  [value]="almacen.estado || 'ACTIVO'"
                  [severity]="getEstadoColor(almacen.estado || 'ACTIVO')"
                  size="small"
                />
                <span class="text-sm text-gray-500">{{almacen.ubicacion}}</span>
              </div>
            </div>
          </ng-template>
          
          <!-- Contenido del acordeón - Layout de zonas -->
          <div class="mt-4">
            <div *ngIf="almacen.zonas?.length; else noZonasEnAlmacen">
              <!-- Vista de layout de zonas -->
              <div class="mb-6">
                <h5 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                  <i class="pi pi-th-large text-indigo-600"></i>
                  Layout del Almacén
                </h5>
                <div class="zone-layout bg-gray-50 rounded-xl p-4 relative" style="height: 300px; overflow: hidden;">
                  <div 
                    *ngFor="let zona of almacen.zonas; trackBy: trackByZona" 
                    class="zone-block absolute rounded-lg shadow-sm border-2 border-white"
                    [style.left.px]="zona.coordenadas?.x || 0"
                    [style.top.px]="zona.coordenadas?.y || 0"
                    [style.width.px]="zona.coordenadas?.width || 80"
                    [style.height.px]="zona.coordenadas?.height || 40"
                    [style.background-color]="getTipoZonaColor(zona.tipo) + '20'"
                    [style.border-color]="getTipoZonaColor(zona.tipo)"
                    [title]="zona.nombre + ' - ' + zona.descripcion"
                  >
                    <div class="p-2 h-full flex flex-col justify-center text-center">
                      <div class="text-xs font-bold text-gray-800">{{zona.codigo}}</div>
                      <div class="text-xs text-gray-600">{{zona.ocupacion}}/{{zona.capacidad}}</div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Lista detallada de zonas -->
              <div class="zone-grid">
                <div 
                  *ngFor="let zona of almacen.zonas; trackBy: trackByZona" 
                  class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-md transition-shadow duration-300"
                >
                  <!-- Header de la zona -->
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div 
                        class="p-2 rounded-lg"
                        [style.background-color]="getTipoZonaColor(zona.tipo) + '20'"
                      >
                        <i 
                          [class]="getTipoZonaIcon(zona.tipo)" 
                          [style.color]="getTipoZonaColor(zona.tipo)"
                        ></i>
                      </div>
                      <div>
                        <div class="font-bold text-gray-800">{{zona.codigo}}</div>
                        <div class="text-sm text-gray-600">{{zona.nombre}}</div>
                      </div>
                    </div>
                    <p-tag 
                      [value]="zona.estado"
                      [severity]="getEstadoZonaColor(zona.estado)"
                      size="small"
                    />
                  </div>
                  
                  <!-- Descripción -->
                  <p class="text-sm text-gray-600 mb-3">{{zona.descripcion}}</p>
                  
                  <!-- Métricas de la zona -->
                  <div class="space-y-2">
                    <!-- Capacidad -->
                    <div>
                      <div class="flex justify-between text-sm text-gray-600 mb-1">
                        <span>Ocupación</span>
                        <span>{{zona.ocupacion}}/{{zona.capacidad}} ({{safeDivide(zona.ocupacion, zona.capacidad) | number:'1.0-0'}}%)</span>
                      </div>
                      <div class="w-full bg-gray-200 rounded-full h-2">
                        <div 
                          class="h-2 rounded-full transition-all duration-500"
                          [style.background-color]="getTipoZonaColor(zona.tipo)"
                          [style.width.%]="safeDivide(zona.ocupacion, zona.capacidad)"
                        ></div>
                      </div>
                    </div>
                    
                    <!-- Tipo de zona -->
                    <div class="flex items-center justify-between text-sm">
                      <span class="text-gray-600">Tipo:</span>
                      <span class="font-medium" [style.color]="getTipoZonaColor(zona.tipo)">{{getTipoZonaLabel(zona.tipo)}}</span>
                    </div>
                  </div>
                  
                  <!-- Acciones de la zona -->
                  <div class="mt-4 flex gap-2">
                    <p-button 
                      icon="pi pi-eye" 
                      size="small"
                      [outlined]="true"
                      severity="info"
                      pTooltip="Ver detalle"
                      class="flex-1"
                    />
                    <p-button 
                      icon="pi pi-pencil" 
                      size="small"
                      [outlined]="true"
                      pTooltip="Editar zona"
                    />
                  </div>
                </div>
              </div>
            </div>
            
            <ng-template #noZonasEnAlmacen>
              <div class="text-center py-8 bg-gray-50 rounded-xl">
                <div class="bg-indigo-100 p-6 rounded-full inline-block mb-3">
                  <i class="pi pi-sitemap text-3xl text-indigo-600"></i>
                </div>
                <h4 class="font-bold text-gray-700 mb-2">Sin zonas configuradas</h4>
                <p class="text-gray-500 mb-4">Este almacén no tiene zonas definidas</p>
                <p-button 
                  label="Configurar Zonas" 
                  icon="pi pi-plus" 
                  size="small"
                  (click)="mostrarZonas(almacen)"
                />
              </div>
            </ng-template>
          </div>
        </p-accordionTab>
      </p-accordion>
    </div>
    
    <ng-template #noZonesData>
      <div class="text-center py-12">
        <div class="bg-indigo-100 p-8 rounded-full inline-block mb-4">
          <i class="pi pi-sitemap text-4xl text-indigo-600"></i>
        </div>
        <h3 class="text-xl font-bold text-gray-700 mb-2">No hay almacenes para gestionar</h3>
        <p class="text-gray-500">Cree almacenes para configurar sus zonas</p>
      </div>
    </ng-template>
  </div>
</div>

<!-- Modal para crear/editar almacén simplificado -->
<p-dialog 
  [(visible)]="almacenDialog" 
  [style]="{'width': '800px', 'height': 'auto'}" 
  [header]="editMode ? 'Editar Almacén' : 'Nuevo Almacén'" 
  [modal]="true" 
  (onHide)="hideDialog()"
  [contentStyle]="{'padding':'20px'}"
  styleClass="warehouse-dialog"
>
  <div class="p-4">
    <!-- Debug info -->
    <div class="mb-4 p-3 bg-gray-100 rounded text-sm" *ngIf="!editMode">
      <strong>Debug:</strong> Almacén inicializado - Nombre: "{{almacen.nombre}}", Ubicación: "{{almacen.ubicacion}}"
          </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Columna izquierda -->
            <div>
        <!-- Nombre -->
        <div class="mb-4">
          <label for="nombre" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-building mr-2 text-blue-600"></i>
                  Nombre del Almacén*
                </label>
                <input 
                  type="text" 
                  pInputText 
                  id="nombre" 
                  [(ngModel)]="almacen.nombre" 
            class="w-full h-12 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Ej: Almacén Principal"
            [ngClass]="{'border-red-500': submitted && !almacen.nombre.trim()}" 
                />
                <small class="text-red-500 block mt-1" *ngIf="submitted && !almacen.nombre?.trim()">
            El nombre es obligatorio
                </small>
              </div>
              
        <!-- Ubicación -->
        <div class="mb-4">
          <label for="ubicacion" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-map-marker mr-2 text-green-600"></i>
                  Ubicación*
                </label>
                <input 
                  type="text" 
                  pInputText 
                  id="ubicacion" 
                  [(ngModel)]="almacen.ubicacion" 
            class="w-full h-12 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            placeholder="Ej: Sector A, Piso 2"
            [ngClass]="{'border-red-500': submitted && !almacen.ubicacion?.trim()}" 
                />
                <small class="text-red-500 block mt-1" *ngIf="submitted && !almacen.ubicacion?.trim()">
            La ubicación es obligatoria
                </small>
              </div>
              
              <!-- Tipo de almacén -->
        <div class="mb-4">
          <label for="tipoAlmacen" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-tag mr-2 text-purple-600"></i>
                  Tipo de Almacén
                </label>
                <p-select 
                  id="tipoAlmacen"
                  [options]="tiposAlmacen" 
                  [(ngModel)]="almacen.tipoAlmacen" 
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccionar tipo"
                  class="w-full"
                  styleClass="h-12"
          />
              </div>
              
              <!-- Estado -->
        <div class="mb-4">
          <label for="estadoAlmacen" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-bookmark mr-2 text-indigo-600"></i>
                  Estado
                </label>
          <p-select 
            id="estadoAlmacen" 
                  [options]="estadosAlmacen" 
                  [(ngModel)]="almacen.estado" 
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Seleccionar estado"
                  class="w-full"
                  styleClass="h-12"
          />
              </div>
            </div>
            
      <!-- Columna derecha -->
            <div>
              <!-- Capacidad máxima -->
        <div class="mb-4">
          <label for="capacidadMaxima" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-database mr-2 text-blue-600"></i>
                  Capacidad Máxima
                </label>
                <p-inputNumber
                  id="capacidadMaxima"
                  [(ngModel)]="almacen.capacidadMaxima"
                  [showButtons]="true"
                  [min]="0"
                  [max]="999999"
                  suffix=" unidades"
                  class="w-full"
            placeholder="1000"
          />
              </div>
              
              <!-- Responsable -->
        <div class="mb-4">
          <label for="responsable" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-user mr-2 text-orange-600"></i>
                  Responsable
                </label>
                <input 
                  type="text" 
                  pInputText 
                  id="responsable" 
                  [(ngModel)]="almacen.responsable" 
            class="w-full h-12 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="Nombre del responsable"
                />
              </div>
              
              <!-- Teléfono -->
        <div class="mb-4">
          <label for="telefono" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-phone mr-2 text-green-600"></i>
            Teléfono
                </label>
                <input 
                  type="tel" 
                  pInputText 
                  id="telefono" 
                  [(ngModel)]="almacen.telefono" 
            class="w-full h-12 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="+51 999 999 999"
                />
              </div>
              
              <!-- Email -->
        <div class="mb-4">
          <label for="email" class="block font-bold mb-2 text-gray-700">
                  <i class="pi pi-envelope mr-2 text-blue-600"></i>
            Email
                </label>
                <input 
                  type="email" 
                  pInputText 
                  id="email" 
                  [(ngModel)]="almacen.email" 
            class="w-full h-12 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  placeholder="almacen@empresa.com"
                />
              </div>
            </div>
          </div>
          
    <!-- Descripción (ancho completo) -->
    <div class="mb-4">
      <label for="descripcion" class="block font-bold mb-2 text-gray-700">
              <i class="pi pi-file-edit mr-2 text-gray-600"></i>
              Descripción (Opcional)
            </label>
            <textarea 
              id="descripcion" 
              pInputTextarea 
        class="w-full h-24 px-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" 
              [(ngModel)]="almacen.descripcion" 
        placeholder="Describe las características del almacén..."
              [maxlength]="500"
            ></textarea>
      <small class="text-gray-500 block mt-1">
        {{(almacen.descripcion?.length || 0)}}/500 caracteres
              </small>
            </div>
          </div>

  <!-- Footer con botones -->
  <ng-template pTemplate="footer">
    <div class="flex justify-end gap-3">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
        severity="secondary" 
          (click)="hideDialog()"
          [disabled]="loading"
        class="shadow-md"
        />
        <p-button 
        label="Guardar" 
          icon="pi pi-check" 
        severity="success" 
          (click)="saveAlmacen()"
          [loading]="loading"
        [disabled]="loading"
          class="shadow-lg"
        />
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Estadísticas Detalladas -->
<p-dialog 
  [(visible)]="estadisticasDialog" 
  [style]="{width: '1200px'}" 
  header="Estadísticas Avanzadas de Almacenes" 
  [modal]="true" 
  (onHide)="hideEstadisticasDialog()"
  [maximizable]="true"
>
  <div *ngIf="almacenes?.length; else noStatsData">
    <!-- Tabs para diferentes vistas de estadísticas -->
    <p-tabView [(activeIndex)]="activeTab">
      <!-- Tab: Dashboard Ejecutivo -->
      <p-tabPanel header="Dashboard Ejecutivo" leftIcon="pi pi-chart-pie">
        <div class="grid">
          <!-- Métricas principales en cards premium -->
          <div class="col-12">
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-6 mb-6">
              <h3 class="text-2xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-dashboard text-blue-600"></i>
                Dashboard Ejecutivo de Almacenes
              </h3>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <!-- Total Value -->
                <div class="text-center bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow duration-300 kpi-card">
                  <div class="bg-blue-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-dollar text-blue-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-blue-600 mb-1">${{calcularEstadisticas().valorInventarioTotal | number:'1.0-0'}}</div>
                  <div class="text-sm text-gray-600 font-medium">Valor Total</div>
                  <div class="text-xs text-gray-500 mt-1">Inventario valorizado</div>
                </div>
                
                <!-- Efficiency -->
                <div class="text-center bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow duration-300 kpi-card">
                  <div class="bg-green-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-chart-line text-green-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-green-600 mb-1">{{calcularEstadisticas().eficienciaPromedio | number:'1.0-0'}}%</div>
                  <div class="text-sm text-gray-600 font-medium">Eficiencia</div>
                  <div class="text-xs text-gray-500 mt-1">Promedio general</div>
                </div>
                
                <!-- Capacity -->
                <div class="text-center bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow duration-300 kpi-card">
                  <div class="bg-orange-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-database text-orange-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-orange-600 mb-1">{{calcularEstadisticas().porcentajeOcupacion | number:'1.0-0'}}%</div>
                  <div class="text-sm text-gray-600 font-medium">Ocupación</div>
                  <div class="text-xs text-gray-500 mt-1">Capacidad utilizada</div>
                </div>
                
                <!-- Performance Score -->
                <div class="text-center bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-shadow duration-300 kpi-card">
                  <div class="bg-purple-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-star text-purple-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-purple-600 mb-1">92</div>
                  <div class="text-sm text-gray-600 font-medium">Score Global</div>
                  <div class="text-xs text-gray-500 mt-1">Rendimiento general</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Gráficos y análisis -->
          <div class="col-12 md:col-6">
            <div class="bg-white rounded-xl p-6 border border-gray-200 h-full">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-chart-pie text-purple-600"></i>
                Distribución por Estado
              </h4>
              <div class="chart-container">
                <p-chart 
                  type="doughnut" 
                  [data]="chartData" 
                  [options]="chartOptions"
                  [style.width]="'300px'"
                  [style.height]="'300px'"
                />
              </div>
              <div class="mt-4 grid grid-cols-1 gap-2">
                <div 
                  *ngFor="let estado of estadosAlmacen" 
                  class="flex items-center justify-between p-2 rounded bg-gray-50"
                >
                  <div class="flex items-center gap-2">
                    <i [class]="estado.icon" [ngStyle]="{'color': estado.color === 'success' ? '#10b981' : estado.color === 'danger' ? '#ef4444' : '#f59e0b'}"></i>
                    <span class="text-sm font-medium">{{estado.label}}</span>
                  </div>
                  <span class="text-sm font-bold text-gray-700">
{{getAlmacenesCountByEstado(estado.value)}}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Ranking de almacenes -->
          <div class="col-12 md:col-6">
            <div class="bg-white rounded-xl p-6 border border-gray-200 h-full">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-trophy text-gold-600"></i>
                Ranking de Almacenes
              </h4>
              <div class="space-y-3">
                <div 
                  *ngFor="let almacen of almacenes.slice(0, 6); let i = index" 
                  class="flex items-center justify-between p-3 rounded-lg border border-gray-100 hover:bg-gray-50 transition-colors duration-300"
                >
                  <div class="flex items-center gap-3">
                    <div 
                      class="rounded-full w-8 h-8 flex items-center justify-center font-bold text-sm text-white"
                      [ngClass]="{
                        'bg-gold-500': i === 0,
                        'bg-gray-400': i === 1,
                        'bg-orange-600': i === 2,
                        'bg-blue-500': i > 2
                      }"
                    >
                      {{i + 1}}
                    </div>
                    <div>
                      <span class="font-medium text-gray-800 text-sm">{{almacen.nombre}}</span>
                      <div class="text-xs text-gray-500">{{almacen.ubicacion}}</div>
                    </div>
                  </div>
                  <div class="text-right">
                    <div class="font-bold text-green-600 text-sm">{{almacen.kpis?.eficienciaEspacio || 85 | number:'1.0-0'}}%</div>
                    <div class="text-xs text-gray-500">Eficiencia</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tendencias y proyecciones -->
          <div class="col-12">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-chart-line text-blue-600"></i>
                Tendencias y Proyecciones
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Crecimiento mensual -->
                <div class="bg-blue-50 rounded-xl p-4 text-center">
                  <div class="text-3xl font-bold text-blue-600 mb-2">+12%</div>
                  <div class="text-sm font-medium text-blue-800">Crecimiento Mensual</div>
                  <div class="text-xs text-blue-600 mt-1">vs. mes anterior</div>
                </div>
                
                <!-- Proyección trimestral -->
                <div class="bg-green-50 rounded-xl p-4 text-center">
                  <div class="text-3xl font-bold text-green-600 mb-2">+25%</div>
                  <div class="text-sm font-medium text-green-800">Proyección Trimestral</div>
                  <div class="text-xs text-green-600 mt-1">capacidad estimada</div>
                </div>
                
                <!-- ROI -->
                <div class="bg-purple-50 rounded-xl p-4 text-center">
                  <div class="text-3xl font-bold text-purple-600 mb-2">18.5%</div>
                  <div class="text-sm font-medium text-purple-800">ROI Anual</div>
                  <div class="text-xs text-purple-600 mt-1">retorno de inversión</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
      
      <!-- Tab: Análisis Operacional -->
      <p-tabPanel header="Análisis Operacional" leftIcon="pi pi-cog">
        <div class="grid">
          <!-- Métricas operacionales -->
          <div class="col-12">
            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-6 mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Indicadores Operacionales</h3>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="text-center">
                  <p-knob 
                    [value]="78"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="10"
                    fill="#3b82f6"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Utilización</div>
                  <div class="text-sm text-gray-500">Espacio aprovechado</div>
                </div>
                
                <div class="text-center">
                  <p-knob 
                    [value]="94"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="10"
                    fill="#10b981"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Precisión</div>
                  <div class="text-sm text-gray-500">Inventario exacto</div>
                </div>
                
                <div class="text-center">
                  <p-knob 
                    [value]="67"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="10"
                    fill="#f59e0b"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Velocidad</div>
                  <div class="text-sm text-gray-500">Tiempo de picking</div>
                </div>
                
                <div class="text-center">
                  <p-knob 
                    [value]="85"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="10"
                    fill="#8b5cf6"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Disponibilidad</div>
                  <div class="text-sm text-gray-500">Tiempo operativo</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Análisis por almacén individual -->
          <div class="col-12 md:col-8">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-building text-green-600"></i>
                Análisis por Almacén
              </h4>
              <div class="space-y-4">
                <div 
                  *ngFor="let almacen of almacenes" 
                  class="bg-gray-50 rounded-xl p-4"
                >
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="bg-green-100 p-2 rounded-lg">
                        <i class="pi pi-building text-green-600"></i>
                      </div>
                      <div>
                        <span class="font-bold text-gray-800">{{almacen.nombre}}</span>
                        <div class="text-sm text-gray-500">{{almacen.ubicacion}}</div>
                      </div>
                    </div>
                    <p-tag 
                      [value]="almacen.estado || 'ACTIVO'"
                      [severity]="getEstadoColor(almacen.estado || 'ACTIVO')"
                      size="small"
                    />
                  </div>
                  
                  <!-- Métricas del almacén -->
                  <div class="grid grid-cols-4 gap-4">
                    <div class="text-center bg-white rounded-lg p-3">
                      <div class="text-lg font-bold text-blue-600">{{almacen?.porcentajeOcupacion || 0 | number:'1.0-0'}}%</div>
                      <div class="text-xs text-gray-600">Ocupación</div>
                    </div>
                    <div class="text-center bg-white rounded-lg p-3">
                      <div class="text-lg font-bold text-green-600">{{almacen.kpis?.eficienciaEspacio || 85 | number:'1.0-0'}}%</div>
                      <div class="text-xs text-gray-600">Eficiencia</div>
                    </div>
                    <div class="text-center bg-white rounded-lg p-3">
                      <div class="text-lg font-bold text-orange-600">{{almacen.kpis?.preciscionInventario || 92 | number:'1.0-0'}}%</div>
                      <div class="text-xs text-gray-600">Precisión</div>
                    </div>
                    <div class="text-center bg-white rounded-lg p-3">
                      <div class="text-lg font-bold text-purple-600">{{almacen.zonas?.length || 0}}</div>
                      <div class="text-xs text-gray-600">Zonas</div>
                    </div>
                  </div>
                  
                  <!-- Barra de capacidad -->
                  <div class="mt-3" *ngIf="almacen.capacidadMaxima">
                    <div class="flex justify-between text-sm text-gray-600 mb-1">
                      <span>Capacidad</span>
                      <span>{{almacen.capacidadUtilizada || 0 | number:'1.0-0'}} / {{almacen.capacidadMaxima | number:'1.0-0'}}</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                      <div 
                        class="h-3 rounded-full transition-all duration-500"
                        [ngClass]="getCapacityClass(almacen?.porcentajeOcupacion || 0)"
                        [style.width.%]="almacen?.porcentajeOcupacion || 0"
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Alertas y recomendaciones -->
          <div class="col-12 md:col-4">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-lightbulb text-yellow-600"></i>
                Recomendaciones
              </h4>
              <div class="space-y-3">
                <div class="alert-card bg-green-50 border-green-200 rounded-lg p-3">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-check-circle text-green-600 mt-1"></i>
                    <div>
                      <div class="font-medium text-green-800 text-sm">Optimización de Espacio</div>
                      <div class="text-sm text-green-700">Reorganizar zonas en Almacén Principal para aumentar eficiencia 15%</div>
                    </div>
                  </div>
                </div>
                
                <div class="alert-card bg-blue-50 border-blue-200 rounded-lg p-3">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-info-circle text-blue-600 mt-1"></i>
                    <div>
                      <div class="font-medium text-blue-800 text-sm">Automatización</div>
                      <div class="text-sm text-blue-700">Implementar sistema WMS en 2 almacenes reduciría tiempo picking 30%</div>
                    </div>
                  </div>
                </div>
                
                <div class="alert-card bg-orange-50 border-orange-200 rounded-lg p-3">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-exclamation-triangle text-orange-600 mt-1"></i>
                    <div>
                      <div class="font-medium text-orange-800 text-sm">Mantenimiento</div>
                      <div class="text-sm text-orange-700">Programar mantenimiento preventivo en Bodega Norte</div>
                    </div>
                  </div>
                </div>
                
                <div class="alert-card bg-purple-50 border-purple-200 rounded-lg p-3">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-star text-purple-600 mt-1"></i>
                    <div>
                      <div class="font-medium text-purple-800 text-sm">Expansión</div>
                      <div class="text-sm text-purple-700">Considerar apertura de nuevo almacén en zona sur</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
      
      <!-- Tab: Análisis Financiero -->
      <p-tabPanel header="Análisis Financiero" leftIcon="pi pi-dollar">
        <div class="grid">
          <!-- Métricas financieras -->
          <div class="col-12">
            <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-xl p-6 mb-6">
              <h3 class="text-xl font-bold text-gray-800 mb-4">Análisis Financiero</h3>
              <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="text-center bg-white rounded-xl p-6 shadow-sm">
                  <div class="bg-emerald-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-dollar text-emerald-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-emerald-600 mb-1">${{calcularEstadisticas().valorInventarioTotal | number:'1.0-0'}}</div>
                  <div class="text-sm text-gray-600 font-medium">Valor Inventario</div>
                </div>
                
                <div class="text-center bg-white rounded-xl p-6 shadow-sm">
                  <div class="bg-blue-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-chart-line text-blue-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-blue-600 mb-1">$125,000</div>
                  <div class="text-sm text-gray-600 font-medium">Costo Operacional</div>
                </div>
                
                <div class="text-center bg-white rounded-xl p-6 shadow-sm">
                  <div class="bg-green-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-trending-up text-green-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-green-600 mb-1">18.5%</div>
                  <div class="text-sm text-gray-600 font-medium">ROI Anual</div>
                </div>
                
                <div class="text-center bg-white rounded-xl p-6 shadow-sm">
                  <div class="bg-purple-100 p-3 rounded-full inline-block mb-3">
                    <i class="pi pi-money-bill text-purple-600 text-2xl"></i>
                  </div>
                  <div class="text-3xl font-bold text-purple-600 mb-1">$45,000</div>
                  <div class="text-sm text-gray-600 font-medium">Ahorro Mensual</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Costos por almacén -->
          <div class="col-12 md:col-8">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-calculator text-blue-600"></i>
                Costos por Almacén
              </h4>
              <div class="space-y-4">
                <div 
                  *ngFor="let almacen of almacenes" 
                  class="bg-gray-50 rounded-xl p-4"
                >
                  <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center gap-3">
                      <div class="bg-blue-100 p-2 rounded-lg">
                        <i class="pi pi-building text-blue-600"></i>
                      </div>
                      <span class="font-bold text-gray-800">{{almacen.nombre}}</span>
                    </div>
                    <div class="text-right">
                      <div class="font-bold text-green-600">${{getValorInventarioAlmacen(almacen) | number:'1.0-0'}}</div>
                      <div class="text-sm text-gray-500">Valor inventario</div>
                    </div>
                  </div>
                  
                  <div class="grid grid-cols-4 gap-3">
                    <div class="text-center bg-white rounded-lg p-2">
                      <div class="font-bold text-blue-600">${{getValorOperacion(almacen) | number:'1.0-0'}}</div>
                      <div class="text-xs text-gray-600">Operación</div>
                    </div>
                    <div class="text-center bg-white rounded-lg p-2">
                      <div class="font-bold text-orange-600">${{getValorMantenimiento(almacen) | number:'1.0-0'}}</div>
                      <div class="text-xs text-gray-600">Mantenimiento</div>
                    </div>
                    <div class="text-center bg-white rounded-lg p-2">
                      <div class="font-bold text-purple-600">${{getValorPersonal(almacen) | number:'1.0-0'}}</div>
                      <div class="text-xs text-gray-600">Personal</div>
                    </div>
                    <div class="text-center bg-white rounded-lg p-2">
                      <div class="font-bold text-green-600">{{getROI(almacen) | number:'1.0-0'}}%</div>
                      <div class="text-xs text-gray-600">ROI</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Proyecciones financieras -->
          <div class="col-12 md:col-4">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-chart-line text-green-600"></i>
                Proyecciones
              </h4>
              <div class="space-y-4">
                <div class="bg-green-50 rounded-lg p-4">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-green-600 mb-1">+15%</div>
                    <div class="text-sm font-medium text-green-800">Crecimiento Q1</div>
                    <div class="text-xs text-green-600">vs. período anterior</div>
                  </div>
                </div>
                
                <div class="bg-blue-50 rounded-lg p-4">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600 mb-1">$380K</div>
                    <div class="text-sm font-medium text-blue-800">Proyección Q2</div>
                    <div class="text-xs text-blue-600">valor inventario</div>
                  </div>
                </div>
                
                <div class="bg-purple-50 rounded-lg p-4">
                  <div class="text-center">
                    <div class="text-2xl font-bold text-purple-600 mb-1">22%</div>
                    <div class="text-sm font-medium text-purple-800">ROI Proyectado</div>
                    <div class="text-xs text-purple-600">próximo año</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
    </p-tabView>
  </div>
  
  <ng-template #noStatsData>
    <div class="text-center py-12">
      <div class="bg-blue-100 p-8 rounded-full inline-block mb-4">
        <i class="pi pi-chart-bar text-4xl text-blue-600"></i>
      </div>
      <h3 class="text-xl font-bold text-gray-700 mb-2">No hay datos para analizar</h3>
      <p class="text-gray-500">Configure almacenes para ver estadísticas detalladas</p>
    </div>
  </ng-template>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="text-sm text-gray-600">
        <i class="pi pi-info-circle mr-1"></i>
        Datos actualizados: {{currentDate | date:'dd/MM/yyyy HH:mm'}}
      </div>
      <div class="flex gap-3">
        <p-button 
          label="Cerrar" 
          icon="pi pi-times" 
          class="p-button-text" 
          (click)="hideEstadisticasDialog()"
          (keyup.enter)="hideEstadisticasDialog()"
          (keyup.space)="hideEstadisticasDialog()"
          tabindex="0"
          role="button"
          aria-label="Cerrar estadísticas"
        />
        <p-button 
          label="Exportar Reporte" 
          icon="pi pi-download" 
          severity="info"
          (click)="exportarEstadisticas()"
          (keyup.enter)="exportarEstadisticas()"
          (keyup.space)="exportarEstadisticas()"
          tabindex="0"
          role="button"
          aria-label="Exportar estadísticas"
        />
        <p-button 
          label="Actualizar Datos" 
          icon="pi pi-refresh" 
          severity="secondary"
          (click)="loadAlmacenes(); updateChartData()" 
        />
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Detalle de Almacén -->
<p-dialog 
  [(visible)]="detalleAlmacenDialog" 
  [style]="{width: '1000px'}" 
  [header]="'Detalle de ' + (almacen.nombre || 'Almacén')" 
  [modal]="true" 
  (onHide)="hideDetalleDialog()"
  [maximizable]="true"
>
  <div *ngIf="almacen.id">
    <!-- Header con información clave -->
    <div class="bg-gradient-to-r from-blue-50 to-green-50 rounded-xl p-6 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-4">
          <div class="bg-blue-600 p-4 rounded-lg">
            <i class="pi pi-building text-white text-2xl"></i>
          </div>
          <div>
            <h2 class="text-2xl font-bold text-gray-800 m-0">{{almacen.nombre}}</h2>
            <p class="text-gray-600 mt-1">{{almacen.ubicacion}}</p>
            <div class="flex items-center gap-3 mt-2">
              <p-tag 
                [value]="almacen.tipoAlmacen || 'SUCURSAL'"
                severity="info"
                size="small"
              />
              <p-tag 
                [value]="almacen.estado || 'ACTIVO'"
                [severity]="getEstadoColor(almacen.estado || 'ACTIVO')"
                size="small"
              />
            </div>
          </div>
        </div>
        
        <!-- Rating del almacén -->
        <div class="text-center">
          <div class="text-3xl font-bold text-green-600 mb-1">{{almacen.kpis?.eficienciaEspacio || 85 | number:'1.0-0'}}%</div>
          <div class="text-sm text-gray-600 mb-2">Eficiencia General</div>
          <p-rating 
            [ngModel]="(almacen.kpis?.eficienciaEspacio || 85) / 20" 
            [readonly]="true" 
            [cancel]="false"
            class="text-yellow-500"
          />
        </div>
      </div>
    </div>

    <!-- Tabs de información detallada -->
    <p-tabView>
      <!-- Tab: Información General -->
      <p-tabPanel header="Información General" leftIcon="pi pi-info-circle">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Información básica -->
          <div class="bg-white rounded-xl p-6 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-info text-blue-600"></i>
              Información Básica
            </h4>
            <div class="space-y-4">
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">Nombre:</span>
                <span class="text-gray-900">{{almacen.nombre}}</span>
              </div>
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">Tipo:</span>
                <span class="text-gray-900">{{almacen.tipoAlmacen || 'SUCURSAL'}}</span>
              </div>
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">Estado:</span>
                <p-tag 
                  [value]="almacen.estado || 'ACTIVO'"
                  [severity]="getEstadoColor(almacen.estado || 'ACTIVO')"
                />
              </div>
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">Responsable:</span>
                <span class="text-gray-900">{{almacen.responsable || 'Sin asignar'}}</span>
              </div>
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">Teléfono:</span>
                <span class="text-gray-900">{{almacen.telefono || 'No disponible'}}</span>
              </div>
              <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                <span class="font-medium text-gray-700">Email:</span>
                <span class="text-gray-900">{{almacen.email || 'No disponible'}}</span>
              </div>
            </div>
          </div>
          
          <!-- Métricas de capacidad -->
          <div class="bg-white rounded-xl p-6 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-chart-pie text-green-600"></i>
              Capacidad y Ocupación
            </h4>
            <div class="text-center mb-6">
              <div class="relative inline-block">
                <div class="capacity-ring w-32 h-32 rounded-full border-8 border-gray-200 flex items-center justify-center mx-auto mb-4">
                     [style.--percentage]="(almacen.porcentajeOcupacion || 0) * 3.6 + 'deg'"
                  <div class="text-center">
                    <div class="text-2xl font-bold text-gray-800">{{almacen.porcentajeOcupacion || 0 | number:'1.0-0'}}%</div>
                    <div class="text-sm text-gray-600">Ocupado</div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Capacidad Total:</span>
                <span class="font-bold text-blue-600">{{almacen.capacidadMaxima || 0 | number:'1.0-0'}} unidades</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Capacidad Utilizada:</span>
                <span class="font-bold text-green-600">{{almacen.capacidadUtilizada || 0 | number:'1.0-0'}} unidades</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">Capacidad Disponible:</span>
                <span class="font-bold text-orange-600">{{(almacen.capacidadMaxima || 0) - (almacen.capacidadUtilizada || 0) | number:'1.0-0'}} unidades</span>
              </div>
            </div>
          </div>
          
          <!-- Ubicación geográfica -->
          <div class="bg-white rounded-xl p-6 border border-gray-200" *ngIf="almacen.ubicacionGeografica">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-map-marker text-red-600"></i>
              Ubicación Geográfica
            </h4>
            <div class="space-y-3">
              <div class="form-group">
                <label for="direccion" class="text-sm font-medium text-gray-600">Dirección Completa</label>
                <div id="direccion" class="text-gray-800">{{almacen.ubicacionGeografica.direccion || 'No especificada'}}</div>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <span class="text-sm font-medium text-gray-600">Ciudad</span>
                  <div class="text-gray-800">{{almacen.ubicacionGeografica.ciudad || 'No especificada'}}</div>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-600">Código Postal</span>
                  <div class="text-gray-800">{{almacen.ubicacionGeografica.codigoPostal || 'No especificado'}}</div>
                </div>
              </div>
              <div class="grid grid-cols-2 gap-3" *ngIf="almacen.ubicacionGeografica?.latitud && almacen.ubicacionGeografica?.longitud">
                <div>
                  <span class="text-sm font-medium text-gray-600">Latitud</span>
                  <div class="text-gray-800 font-mono text-sm">{{almacen.ubicacionGeografica.latitud | number:'1.6-6'}}</div>
                </div>
                <div>
                  <span class="text-sm font-medium text-gray-600">Longitud</span>
                  <div class="text-gray-800 font-mono text-sm">{{almacen.ubicacionGeografica.longitud | number:'1.6-6'}}</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Condiciones ambientales -->
          <div class="bg-white rounded-xl p-6 border border-gray-200" *ngIf="almacen.temperatura || almacen.humedad">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-sun text-orange-600"></i>
              Condiciones Ambientales
            </h4>
            <div class="space-y-4">
              <!-- Temperatura -->
              <div *ngIf="almacen.temperatura">
                <span class="text-sm font-medium text-gray-600 mb-2 block">Temperatura (°C)</span>
                <div class="grid grid-cols-3 gap-3 text-center">
                  <div class="bg-blue-50 rounded-lg p-3">
                    <div class="text-lg font-bold text-blue-600">{{almacen.temperatura.min}}°</div>
                    <div class="text-xs text-gray-600">Mínima</div>
                  </div>
                  <div class="bg-green-50 rounded-lg p-3">
                    <div class="text-lg font-bold text-green-600">{{almacen.temperatura.actual | number:'1.1-1'}}°</div>
                    <div class="text-xs text-gray-600">Actual</div>
                  </div>
                  <div class="bg-red-50 rounded-lg p-3">
                    <div class="text-lg font-bold text-red-600">{{almacen.temperatura.max}}°</div>
                    <div class="text-xs text-gray-600">Máxima</div>
                  </div>
                </div>
              </div>
              
              <!-- Humedad -->
              <div *ngIf="almacen.humedad">
                <span class="text-sm font-medium text-gray-600 mb-2 block">Humedad (%)</span>
                <div class="grid grid-cols-3 gap-3 text-center">
                  <div class="bg-cyan-50 rounded-lg p-3">
                    <div class="text-lg font-bold text-cyan-600">{{almacen.humedad.min}}%</div>
                    <div class="text-xs text-gray-600">Mínima</div>
                  </div>
                  <div class="bg-teal-50 rounded-lg p-3">
                    <div class="text-lg font-bold text-teal-600">{{almacen.humedad.actual | number:'1.1-1'}}%</div>
                    <div class="text-xs text-gray-600">Actual</div>
                  </div>
                  <div class="bg-indigo-50 rounded-lg p-3">
                    <div class="text-lg font-bold text-indigo-600">{{almacen.humedad.max}}%</div>
                    <div class="text-xs text-gray-600">Máxima</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
      
      <!-- Tab: Zonas y Layout -->
      <p-tabPanel header="Zonas y Layout" leftIcon="pi pi-sitemap">
        <div *ngIf="almacen.zonas?.length; else noZonasDetail">
          <!-- Layout visual -->
          <div class="mb-6">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-th-large text-indigo-600"></i>
              Layout Visual del Almacén
            </h4>
            <div class="zone-layout bg-gray-50 rounded-xl p-6 relative" style="height: 400px; overflow: hidden;">
              <div 
                *ngFor="let zona of almacen.zonas; trackBy: trackByZona" 
                class="zone-block absolute rounded-lg shadow-sm border-2 border-white cursor-pointer"
                [style.left.px]="zona.coordenadas?.x || 0"
                [style.top.px]="zona.coordenadas?.y || 0"
                [style.width.px]="zona.coordenadas?.width || 80"
                [style.height.px]="zona.coordenadas?.height || 40"
                [style.background-color]="getTipoZonaColor(zona.tipo) + '30'"
                [style.border-color]="getTipoZonaColor(zona.tipo)"
                [title]="zona.nombre + ' - ' + zona.descripcion"
              >
                <div class="p-2 h-full flex flex-col justify-center text-center">
                  <div class="text-sm font-bold text-gray-800">{{zona.codigo}}</div>
                  <div class="text-xs text-gray-600">{{zona.ocupacion}}/{{zona.capacidad}}</div>
                  <div class="text-xs" [style.color]="getTipoZonaColor(zona.tipo)">
                    {{safeDivide(zona.ocupacion, zona.capacidad) | number:'1.0-0'}}%
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Lista detallada de zonas -->
          <div class="zone-grid">
            <div 
              *ngFor="let zona of almacen.zonas; trackBy: trackByZona" 
              class="bg-white rounded-xl p-4 border border-gray-200 hover:shadow-md transition-shadow duration-300"
            >
              <!-- Header de la zona -->
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  <div 
                    class="p-3 rounded-lg"
                    [style.background-color]="getTipoZonaColor(zona.tipo) + '20'"
                  >
                    <i 
                      [class]="getTipoZonaIcon(zona.tipo)" 
                      [style.color]="getTipoZonaColor(zona.tipo)"
                      class="text-lg"
                    ></i>
                  </div>
                  <div>
                    <div class="font-bold text-gray-800">{{zona.codigo}}</div>
                    <div class="text-sm text-gray-600">{{zona.nombre}}</div>
                  </div>
                </div>
                <p-tag 
                  [value]="zona.estado"
                  [severity]="getEstadoZonaColor(zona.estado)"
                  size="small"
                />
              </div>
              
              <!-- Descripción -->
              <p class="text-sm text-gray-600 mb-4">{{zona.descripcion}}</p>
              
              <!-- Métricas de la zona -->
              <div class="space-y-3">
                <!-- Capacidad -->
                <div>
                  <div class="flex justify-between text-sm text-gray-600 mb-1">
                    <span>Ocupación</span>
                    <span>{{zona.ocupacion}}/{{zona.capacidad}} ({{(zona.ocupacion/zona.capacidad)*100 | number:'1.0-0'}}%)</span>
                  </div>
                  <div class="w-full bg-gray-200 rounded-full h-3">
                    <div 
                      class="h-3 rounded-full transition-all duration-500"
                      [style.background-color]="getTipoZonaColor(zona.tipo)"
                      [style.width.%]="(zona.ocupacion/zona.capacidad)*100"
                    ></div>
                  </div>
                </div>
                
                <!-- Información adicional -->
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <div class="flex justify-between">
                    <span class="text-gray-600">Tipo:</span>
                    <span class="font-medium" [style.color]="getTipoZonaColor(zona.tipo)">{{getTipoZonaLabel(zona.tipo)}}</span>
                  </div>
                  <div class="flex justify-between">
                    <span class="text-gray-600">Estado:</span>
                    <span class="font-medium">{{zona.estado}}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <ng-template #noZonasDetail>
          <div class="text-center py-12">
            <div class="bg-indigo-100 p-8 rounded-full inline-block mb-4">
              <i class="pi pi-sitemap text-4xl text-indigo-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-700 mb-2">Sin zonas configuradas</h3>
            <p class="text-gray-500 mb-4">Este almacén no tiene zonas definidas</p>
            <p-button 
              label="Configurar Zonas" 
              icon="pi pi-plus" 
              (click)="mostrarZonas(almacen)"
            />
          </div>
        </ng-template>
      </p-tabPanel>
      
      <!-- Tab: KPIs y Rendimiento -->
      <p-tabPanel header="KPIs y Rendimiento" leftIcon="pi pi-chart-line">
        <div class="grid">
          <!-- KPIs principales -->
          <div class="col-12">
            <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-6 mb-6">
              <h4 class="text-xl font-bold text-gray-800 mb-4">Indicadores de Rendimiento</h4>
              <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
                <div class="text-center">
                  <p-knob 
                    [value]="almacen.kpis?.eficienciaEspacio || 85"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="8"
                    fill="#3b82f6"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Eficiencia Espacio</div>
                </div>
                
                <div class="text-center">
                  <p-knob 
                    [value]="almacen.kpis?.preciscionInventario || 92"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="8"
                    fill="#10b981"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Precisión Inventario</div>
                </div>
                
                <div class="text-center">
                  <p-knob 
                    [value]="almacen.kpis?.rotacionInventario || 75"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="8"
                    fill="#f59e0b"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Rotación Inventario</div>
                </div>
                
                <div class="text-center">
                  <p-knob 
                    [value]="100 - (almacen.kpis?.tiempoPromedioPicking || 15) * 3"
                    [size]="80"
                    [readonly]="true"
                    valueTemplate="{value}%"
                    [strokeWidth]="8"
                    fill="#8b5cf6"
                    textColor="#374151"
                  />
                  <div class="mt-2 font-medium text-gray-700">Velocidad Picking</div>
                  <div class="text-xs text-gray-500">{{almacen.kpis?.tiempoPromedioPicking || 15}} min promedio</div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tendencias y comparativas -->
          <div class="col-12">
            <div class="bg-white rounded-xl p-6 border border-gray-200">
              <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="pi pi-chart-line text-blue-600"></i>
                Tendencias de Rendimiento
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-blue-50 rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-blue-600 mb-2">+8%</div>
                  <div class="text-sm font-medium text-blue-800">Mejora Mensual</div>
                  <div class="text-xs text-blue-600">vs. mes anterior</div>
                </div>
                
                <div class="bg-green-50 rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-green-600 mb-2">94%</div>
                  <div class="text-sm font-medium text-green-800">Disponibilidad</div>
                  <div class="text-xs text-green-600">tiempo operativo</div>
                </div>
                
                <div class="bg-purple-50 rounded-xl p-4 text-center">
                  <div class="text-2xl font-bold text-purple-600 mb-2">1.2x</div>
                  <div class="text-sm font-medium text-purple-800">vs. Promedio</div>
                  <div class="text-xs text-purple-600">rendimiento relativo</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
      
      <!-- Tab: Seguridad y Sistemas -->
      <p-tabPanel header="Seguridad" leftIcon="pi pi-shield" *ngIf="almacen.seguridad">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Sistemas de seguridad -->
          <div class="bg-white rounded-xl p-6 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-shield text-red-600"></i>
              Sistemas de Seguridad
            </h4>
            <div class="space-y-4">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-2">
                  <i class="pi pi-video text-blue-600"></i>
                  <span class="font-medium text-gray-700">Cámaras de Seguridad</span>
                </div>
                <span class="font-bold text-blue-600">{{almacen.seguridad.camaras}} unidades</span>
              </div>
              
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-2">
                  <i class="pi pi-lock text-green-600"></i>
                  <span class="font-medium text-gray-700">Accesos Controlados</span>
                </div>
                <span class="font-bold text-green-600">{{almacen.seguridad.accesosControlados}} puntos</span>
              </div>
              
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-2">
                  <i class="pi pi-exclamation-triangle text-orange-600"></i>
                  <span class="font-medium text-gray-700">Sistema Contra Incendios</span>
                </div>
                <p-tag 
                  [value]="almacen.seguridad.sistemasIncendio ? 'Activo' : 'Inactivo'"
                  [severity]="almacen.seguridad.sistemasIncendio ? 'success' : 'danger'"
                  size="small"
                />
              </div>
              
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div class="flex items-center gap-2">
                  <i class="pi pi-bell text-purple-600"></i>
                  <span class="font-medium text-gray-700">Sistema de Alarmas</span>
                </div>
                <p-tag 
                  [value]="almacen.seguridad.alarmas ? 'Activo' : 'Inactivo'"
                  [severity]="almacen.seguridad.alarmas ? 'success' : 'danger'"
                  size="small"
                />
              </div>
            </div>
          </div>
          
          <!-- Estado de seguridad -->
          <div class="bg-white rounded-xl p-6 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
              <i class="pi pi-check-circle text-green-600"></i>
              Estado de Seguridad
            </h4>
            <div class="text-center mb-6">
              <div class="text-4xl font-bold text-green-600 mb-2">95%</div>
              <div class="text-lg font-medium text-gray-700">Nivel de Seguridad</div>
              <div class="text-sm text-gray-500">Evaluación general</div>
            </div>
            
            <div class="space-y-3">
              <div class="bg-green-50 rounded-lg p-3">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-700">Acceso Físico</span>
                  <span class="font-bold text-green-600">98%</span>
                </div>
                <p-progressBar [value]="98" styleClass="h-2" />
              </div>
              
              <div class="bg-blue-50 rounded-lg p-3">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-700">Videovigilancia</span>
                  <span class="font-bold text-blue-600">95%</span>
                </div>
                <p-progressBar [value]="95" styleClass="h-2" />
              </div>
              
              <div class="bg-orange-50 rounded-lg p-3">
                <div class="flex justify-between items-center mb-1">
                  <span class="text-sm font-medium text-gray-700">Protección Incendios</span>
                  <span class="font-bold text-orange-600">92%</span>
                </div>
                <p-progressBar [value]="92" styleClass="h-2" />
              </div>
            </div>
          </div>
        </div>
      </p-tabPanel>
    </p-tabView>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="text-sm text-gray-600" *ngIf="almacen.fechaActualizacion">
        <i class="pi pi-clock mr-1"></i>
        Última actualización: {{almacen.fechaActualizacion | date:'dd/MM/yyyy HH:mm'}}
      </div>
      <div class="flex gap-3">
        <p-button 
          label="Cerrar" 
          icon="pi pi-times" 
          class="p-button-text" 
          (click)="hideDetalleDialog()"
          (keyup.enter)="hideDetalleDialog()"
          (keyup.space)="hideDetalleDialog()"
          tabindex="0"
          role="button"
          aria-label="Cerrar detalles"
        />
        <p-button 
          label="Gestionar Zonas" 
          icon="pi pi-sitemap" 
          severity="info"
          [outlined]="true"
          (click)="mostrarZonas(almacen)" 
        />
        <p-button 
          label="Editar Almacén" 
          icon="pi pi-pencil" 
          (click)="editAlmacen(almacen); hideDetalleDialog()" 
        />
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Gestión de Zonas -->
<p-dialog 
  [(visible)]="zonasDialog" 
  [style]="{width: '1100px'}" 
  [header]="'Gestión de Zonas - ' + (almacen.nombre || 'Almacén')" 
  [modal]="true" 
  (onHide)="hideZonasDialog()"
  [maximizable]="true"
>
  <div>
    <!-- Header con acciones -->
    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-4 mb-6">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-indigo-600 p-2 rounded-lg">
            <i class="pi pi-sitemap text-white"></i>
          </div>
          <div>
            <h3 class="text-lg font-bold text-gray-800 m-0">Configuración de Zonas</h3>
            <p class="text-sm text-gray-600 mt-1">{{almacen.zonas?.length || 0}} zonas configuradas</p>
          </div>
        </div>
        <div class="flex gap-2">
          <p-button 
            label="Nueva Zona" 
            icon="pi pi-plus" 
            size="small"
            (click)="crearNuevaZona()"
            (keyup.enter)="crearNuevaZona()"
            (keyup.space)="crearNuevaZona()"
            tabindex="0"
            role="button"
            aria-label="Crear nueva zona"
          />
          <p-button 
            label="Layout Automático" 
            icon="pi pi-refresh" 
            severity="secondary"
            [outlined]="true"
            size="small"
            (click)="generarLayoutAutomatico()"
            (keyup.enter)="generarLayoutAutomatico()"
            (keyup.space)="generarLayoutAutomatico()"
            tabindex="0"
            role="button"
            aria-label="Generar diseño automático"
          />
        </div>
      </div>
    </div>

    <!-- Splitter para vista dividida -->
    <p-splitter [style]="{'height': '600px'}" [panelSizes]="[60, 40]">
      <!-- Panel izquierdo: Layout visual -->
      <ng-template pTemplate="panel">
        <div class="p-4">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-th-large text-indigo-600"></i>
            Layout Visual del Almacén
          </h4>
          
          <!-- Toolbar del editor -->
          <div class="bg-white rounded-lg border border-gray-200 p-3 mb-4">
            <div class="flex items-center gap-3">
              <span class="text-sm font-medium text-gray-700">Herramientas:</span>
              <p-button 
                icon="pi pi-plus-circle" 
                severity="info"
                [outlined]="true"
                size="small"
                pTooltip="Agregar zona"
              />
              <p-button 
                icon="pi pi-pencil" 
                severity="secondary"
                [outlined]="true"
                size="small"
                pTooltip="Editar zona"
              />
              <p-button 
                icon="pi pi-trash" 
                severity="danger"
                [outlined]="true"
                size="small"
                pTooltip="Eliminar zona"
              />
              <div class="border-l border-gray-300 h-6 mx-2"></div>
              <span class="text-sm text-gray-600">Zoom:</span>
              <p-button 
                icon="pi pi-search-plus" 
                [outlined]="true"
                size="small"
                pTooltip="Zoom in"
              />
              <p-button 
                icon="pi pi-search-minus" 
                [outlined]="true"
                size="small"
                pTooltip="Zoom out"
              />
            </div>
          </div>
          
          <!-- Canvas del layout -->
          <div class="zone-layout bg-gray-50 rounded-xl border-2 border-dashed border-gray-300 relative overflow-hidden" 
               style="height: 450px; cursor: crosshair;">
            <!-- Grid de fondo -->
            <div class="absolute inset-0 opacity-30"
                 style="background-image: 
                        repeating-linear-gradient(0deg, transparent, transparent 19px, #e5e7eb 19px, #e5e7eb 21px),
                        repeating-linear-gradient(90deg, transparent, transparent 19px, #e5e7eb 19px, #e5e7eb 21px);">
            </div>
            
            <!-- Zonas existentes -->
            <div 
              *ngFor="let zona of almacen.zonas; trackBy: trackByZona; let i = index" 
              class="zone-block absolute rounded-lg shadow-md border-2 border-white cursor-move select-none"
              [style.left.px]="zona.coordenadas?.x || (50 + i * 100)"
              [style.top.px]="zona.coordenadas?.y || (50 + (i % 3) * 80)"
              [style.width.px]="zona.coordenadas?.width || 100"
              [style.height.px]="zona.coordenadas?.height || 60"
              [style.background-color]="getTipoZonaColor(zona.tipo) + '40'"
              [style.border-color]="getTipoZonaColor(zona.tipo)"
              [title]="zona.nombre + ' - ' + zona.descripcion"
              (click)="seleccionarZona(zona)"
              (keyup.enter)="seleccionarZona(zona)"
              (keyup.space)="seleccionarZona(zona)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Seleccionar zona ' + zona.nombre"
            >
              <!-- Contenido de la zona -->
              <div class="p-2 h-full flex flex-col justify-center text-center relative">
                <!-- Indicador de estado -->
                <div class="absolute top-1 right-1">
                  <div 
                    class="w-2 h-2 rounded-full"
                    [ngClass]="{
                      'bg-green-500': zona.estado === 'ACTIVA',
                      'bg-orange-500': zona.estado === 'MANTENIMIENTO',
                      'bg-red-500': zona.estado === 'FUERA_SERVICIO'
                    }"
                  ></div>
                </div>
                
                <!-- Icono del tipo de zona -->
                <div class="mb-1">
                  <i 
                    [class]="getTipoZonaIcon(zona.tipo)" 
                    [style.color]="getTipoZonaColor(zona.tipo)"
                    class="text-lg"
                  ></i>
                </div>
                
                <!-- Información de la zona -->
                <div class="text-xs font-bold text-gray-800">{{zona.codigo}}</div>
                <div class="text-xs text-gray-600">{{zona.ocupacion}}/{{zona.capacidad}}</div>
                
                <!-- Barra de ocupación mini -->
                <div class="w-full bg-white bg-opacity-50 rounded-full h-1 mt-1">
                  <div 
                    class="h-1 rounded-full"
                    [style.background-color]="getTipoZonaColor(zona.tipo)"
                    [style.width.%]="(zona.ocupacion/zona.capacidad)*100"
                  ></div>
                </div>
              </div>
              
              <!-- Handles de redimensionamiento -->
              <div 
                class="absolute -bottom-1 -right-1 w-3 h-3 bg-white border border-gray-400 rounded cursor-se-resize"
                tabindex="0"
                role="button"
                aria-label="Redimensionar zona"
                (keydown.enter)="iniciarRedimension($event, zona)"
                (keydown.space)="iniciarRedimension($event, zona)">
              </div>
            </div>
            
            <!-- Indicadores de coordenadas -->
            <div class="absolute bottom-2 left-2 bg-white bg-opacity-90 rounded px-2 py-1 text-xs text-gray-600">
              <i class="pi pi-map-marker mr-1"></i>
              {{almacen.ubicacion}}
            </div>
            
            <!-- Leyenda -->
            <div class="absolute top-2 right-2 bg-white bg-opacity-90 rounded-lg p-2">
              <div class="text-xs font-bold text-gray-800 mb-2">Leyenda</div>
              <div class="space-y-1">
                <div *ngFor="let tipo of tiposZona.slice(0, 5)" class="flex items-center gap-2 text-xs">
                  <div 
                    class="w-3 h-3 rounded"
                    [style.background-color]="tipo.color + '60'"
                  ></div>
                  <span class="text-gray-700">{{tipo.label}}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>
      
      <!-- Panel derecho: Lista y configuración -->
      <ng-template pTemplate="panel">
        <div class="p-4">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
            <i class="pi pi-list text-purple-600"></i>
            Lista de Zonas
          </h4>
          
          <!-- Lista de zonas -->
          <div class="space-y-3 max-h-96 overflow-y-auto" *ngIf="almacen.zonas?.length; else noZonesInWarehouse">
            <div 
              *ngFor="let zona of almacen.zonas; trackBy: trackByZona" 
              class="bg-white rounded-lg p-3 border border-gray-200 hover:shadow-md transition-shadow duration-300 cursor-pointer"
              [class.ring-2]="zonaSeleccionada?.id === zona.id"
              [class.ring-indigo-500]="zonaSeleccionada?.id === zona.id"
              (click)="seleccionarZona(zona)"
              (keyup.enter)="seleccionarZona(zona)"
              (keyup.space)="seleccionarZona(zona)"
              tabindex="0"
              role="button"
              [attr.aria-label]="'Seleccionar zona ' + zona.nombre"
            >
              <!-- Header de la zona -->
              <div class="flex items-center justify-between mb-2">
                <div class="flex items-center gap-3">
                  <div 
                    class="p-2 rounded-lg"
                    [style.background-color]="getTipoZonaColor(zona.tipo) + '20'"
                  >
                    <i 
                      [class]="getTipoZonaIcon(zona.tipo)" 
                      [style.color]="getTipoZonaColor(zona.tipo)"
                    ></i>
                  </div>
                  <div>
                    <div class="font-bold text-gray-800 text-sm">{{zona.codigo}}</div>
                    <div class="text-xs text-gray-600">{{zona.nombre}}</div>
                  </div>
                </div>
                <div class="flex gap-1">
                  <p-button 
                    icon="pi pi-pencil" 
                    size="small"
                    [outlined]="true"
                    severity="info"
                    pTooltip="Editar"
                    (click)="editarZona(zona); $event.stopPropagation()"
                    (keyup.enter)="editarZona(zona); $event.stopPropagation()"
                    (keyup.space)="editarZona(zona); $event.stopPropagation()"
                    tabindex="0"
                    role="button"
                    [attr.aria-label]="'Editar zona ' + zona.nombre"
                  />
                  <p-button 
                    icon="pi pi-trash" 
                    size="small"
                    [outlined]="true"
                    severity="danger"
                    pTooltip="Eliminar"
                    (click)="eliminarZona(zona); $event.stopPropagation()"
                    (keyup.enter)="eliminarZona(zona); $event.stopPropagation()"
                    (keyup.space)="eliminarZona(zona); $event.stopPropagation()"
                    tabindex="0"
                    role="button"
                    [attr.aria-label]="'Eliminar zona ' + zona.nombre"
                  />
                </div>
              </div>
              
              <!-- Estado y tipo -->
              <div class="flex items-center justify-between mb-2">
                <p-tag 
                  [value]="getTipoZonaLabel(zona.tipo)"
                  size="small"
                  styleClass="text-xs"
                  [style.background-color]="getTipoZonaColor(zona.tipo) + '20'"
                  [style.color]="getTipoZonaColor(zona.tipo)"
                />
                <p-tag 
                  [value]="zona.estado"
                  [severity]="getEstadoZonaColor(zona.estado)"
                  size="small"
                />
              </div>
              
              <!-- Capacidad -->
              <div class="space-y-1">
                <div class="flex justify-between text-xs text-gray-600">
                  <span>Ocupación</span>
                  <span>{{zona.ocupacion}}/{{zona.capacidad}} ({{(zona.ocupacion/zona.capacidad)*100 | number:'1.0-0'}}%)</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                  <div 
                    class="h-2 rounded-full transition-all duration-500"
                    [style.background-color]="getTipoZonaColor(zona.tipo)"
                    [style.width.%]="(zona.ocupacion/zona.capacidad)*100"
                  ></div>
                </div>
              </div>
              
              <!-- Coordenadas (si están disponibles) -->
              <div class="text-xs text-gray-500 mt-2" *ngIf="zona.coordenadas">
                Pos: {{zona.coordenadas.x}}, {{zona.coordenadas.y}} | 
                Tamaño: {{zona.coordenadas.width}} x {{zona.coordenadas.height}}
              </div>
            </div>
          </div>
          
          <ng-template #noZonesInWarehouse>
            <div class="text-center py-8 bg-gray-50 rounded-xl">
              <div class="bg-indigo-100 p-4 rounded-full inline-block mb-3">
                <i class="pi pi-sitemap text-2xl text-indigo-600"></i>
              </div>
              <h4 class="font-bold text-gray-700 mb-2">Sin zonas configuradas</h4>
              <p class="text-gray-500 text-sm mb-4">Comience agregando zonas al almacén</p>
              <p-button 
                label="Crear Primera Zona" 
                icon="pi pi-plus" 
                size="small"
                (click)="crearNuevaZona()"
            (keyup.enter)="crearNuevaZona()"
            (keyup.space)="crearNuevaZona()"
            tabindex="0"
            role="button"
            aria-label="Crear nueva zona"
              />
            </div>
          </ng-template>
          
          <!-- Panel de propiedades de zona seleccionada -->
          <div class="mt-6" *ngIf="zonaSeleccionada">
            <h5 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <i class="pi pi-cog text-gray-600"></i>
              Propiedades de Zona
            </h5>
            <div class="bg-gray-50 rounded-lg p-4 space-y-3">
              <div>
                <label for="codigoZona" class="text-sm font-medium text-gray-700">Código</label>
                <input 
                  id="codigoZona"
                  type="text" 
                  pInputText 
                  [(ngModel)]="zonaSeleccionada.codigo" 
                  class="w-full mt-1"
                  size="small"
                />
              </div>
              <div>
                <label for="nombreZona" class="text-sm font-medium text-gray-700">Nombre</label>
                <input 
                  id="nombreZona"
                  type="text" 
                  pInputText 
                  [(ngModel)]="zonaSeleccionada.nombre" 
                  class="w-full mt-1"
                  size="small"
                />
              </div>
              <div>
                <label for="tipoZona" class="text-sm font-medium text-gray-700">Tipo</label>
                <p-select 
                  inputId="tipoZona"
                  [options]="tiposZona" 
                  [(ngModel)]="zonaSeleccionada.tipo" 
                  optionLabel="label"
                  optionValue="value"
                  class="w-full mt-1"
                  styleClass="h-10"
                />
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div>
                  <label for="capacidadZona" class="text-sm font-medium text-gray-700">Capacidad</label>
                  <p-inputNumber
                    inputId="capacidadZona"
                    [(ngModel)]="zonaSeleccionada.capacidad"
                    [min]="1"
                    [showButtons]="true"
                    class="w-full mt-1"
                  />
                </div>
                <div>
                  <label for="ocupacionZona" class="text-sm font-medium text-gray-700">Ocupación</label>
                  <p-inputNumber
                    inputId="ocupacionZona"
                    [(ngModel)]="zonaSeleccionada.ocupacion"
                    [min]="0"
                    [max]="zonaSeleccionada.capacidad"
                    [showButtons]="true"
                    class="w-full mt-1"
                  />
                </div>
              </div>
              <div>
                <label for="estadoZona" class="text-sm font-medium text-gray-700">Estado</label>
                <p-select 
                  inputId="estadoZona"
                  [options]="estadosZona" 
                  [(ngModel)]="zonaSeleccionada.estado" 
                  optionLabel="label"
                  optionValue="value"
                  class="w-full mt-1"
                  styleClass="h-10"
                />
              </div>
              <div class="flex gap-2">
                <p-button 
                  label="Guardar" 
                  icon="pi pi-check" 
                  size="small"
                  class="flex-1"
                  (click)="guardarZona()"
                  (keyup.enter)="guardarZona()"
                  (keyup.space)="guardarZona()"
                  tabindex="0"
                  role="button"
                  aria-label="Guardar zona"
                />
                <p-button 
                  label="Cancelar" 
                  icon="pi pi-times" 
                  severity="secondary"
                  [outlined]="true"
                  size="small"
                  (click)="cancelarEdicionZona()"
                  (keyup.enter)="cancelarEdicionZona()"
                  (keyup.space)="cancelarEdicionZona()"
                  tabindex="0"
                  role="button"
                  aria-label="Cancelar edición"
                />
              </div>
            </div>
          </div>
        </div>
      </ng-template>
    </p-splitter>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="text-sm text-gray-600">
        <i class="pi pi-info-circle mr-1"></i>
        {{almacen.zonas?.length || 0}} zonas configuradas
      </div>
      <div class="flex gap-3">
        <p-button 
          label="Cerrar" 
          icon="pi pi-times" 
          class="p-button-text" 
          (click)="hideZonasDialog()" 
        />
        <p-button 
          label="Guardar Layout" 
          icon="pi pi-save" 
          severity="info"
          (click)="guardarLayoutZonas()"
          (keyup.enter)="guardarLayoutZonas()"
          (keyup.space)="guardarLayoutZonas()"
          tabindex="0"
          role="button"
          aria-label="Guardar diseño de zonas"
        />
        <p-button 
          label="Aplicar Cambios" 
          icon="pi pi-check" 
          (click)="aplicarCambiosZonas()"
          (keyup.enter)="aplicarCambiosZonas()"
          (keyup.space)="aplicarCambiosZonas()"
          tabindex="0"
          role="button"
          aria-label="Aplicar cambios"
        />
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Mapa Global -->
<p-dialog 
  [(visible)]="mapaDialog" 
  [style]="{width: '1200px', height: '800px'}" 
  header="Mapa Global de Almacenes" 
  [modal]="true" 
  (onHide)="hideMapaDialog()"
  [maximizable]="true"
>
  <div class="h-full">
    <!-- Toolbar del mapa -->
    <div class="bg-white rounded-lg border border-gray-200 p-3 mb-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <span class="text-sm font-medium text-gray-700">Vista:</span>
          <p-selectButton 
            [(ngModel)]="tipoVistaMapa" 
            [options]="[
              {label: 'Satelite', value: 'satellite'},
              {label: 'Mapa', value: 'roadmap'},
              {label: 'Terreno', value: 'terrain'}
            ]" 
            optionLabel="label" 
            optionValue="value"
            size="small"
          />
        </div>
        
        <div class="flex items-center gap-3">
          <p-button 
            icon="pi pi-search-plus" 
            [outlined]="true"
            size="small"
            pTooltip="Zoom in"
            (click)="zoomIn()"
            (keyup.enter)="zoomIn()"
            (keyup.space)="zoomIn()"
            tabindex="0"
            role="button"
            aria-label="Acercar mapa"
          />
          <p-button 
            icon="pi pi-search-minus" 
            [outlined]="true"
            size="small"
            pTooltip="Zoom out"
            (click)="zoomOut()"
            (keyup.enter)="zoomOut()"
            (keyup.space)="zoomOut()"
            tabindex="0"
            role="button"
            aria-label="Alejar mapa"
          />
          <p-button 
            icon="pi pi-compass" 
            [outlined]="true"
            size="small"
            pTooltip="Centrar mapa"
            (click)="centrarMapa()"
            (keyup.enter)="centrarMapa()"
            (keyup.space)="centrarMapa()"
            tabindex="0"
            role="button"
            aria-label="Centrar mapa"
          />
          <p-button 
            icon="pi pi-map-marker" 
            severity="info"
            [outlined]="true"
            size="small"
            pTooltip="Mostrar todos"
            (click)="mostrarTodosAlmacenes()"
            (keyup.enter)="mostrarTodosAlmacenes()"
            (keyup.space)="mostrarTodosAlmacenes()"
            tabindex="0"
            role="button"
            aria-label="Mostrar todos los almacenes"
          />
        </div>
      </div>
    </div>

    <!-- Contenedor del mapa -->
    <div class="grid grid-cols-4 gap-4 h-full">
      <!-- Mapa principal -->
      <div class="col-span-3">
        <div class="bg-gradient-to-br from-green-100 to-blue-100 rounded-xl h-full flex items-center justify-center border border-gray-200">
          <!-- Simulación de mapa -->
          <div class="text-center">
            <div class="bg-green-600 p-8 rounded-full inline-block mb-4">
              <i class="pi pi-map text-white text-4xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-gray-800 mb-3">Mapa Interactivo</h3>
            <p class="text-gray-600 mb-4 max-w-md">
              Visualización geográfica de todos los almacenes con información en tiempo real
            </p>
            
            <!-- Simulación de marcadores -->
            <div class="grid grid-cols-2 gap-4 mt-8 max-w-lg mx-auto">
              <div 
                *ngFor="let almacen of almacenes.slice(0, 4)" 
                class="bg-white rounded-lg p-3 shadow-sm hover:shadow-md transition-shadow duration-300 cursor-pointer"
                (click)="centrarEnAlmacen(almacen)"
                (keyup.enter)="centrarEnAlmacen(almacen)"
                (keyup.space)="centrarEnAlmacen(almacen)"
                tabindex="0"
                role="button"
                [attr.aria-label]="'Centrar en ' + almacen.nombre"
              >
                <div class="flex items-center gap-2 mb-2">
                  <div class="map-marker w-3 h-3 rounded-full"
                       [ngClass]="{
                         'bg-green-500': almacen.estado === 'ACTIVO',
                         'bg-red-500': almacen.estado === 'INACTIVO',
                         'bg-orange-500': almacen.estado === 'MANTENIMIENTO'
                       }">
                  </div>
                  <span class="font-medium text-gray-800 text-sm">{{almacen.nombre}}</span>
                </div>
                <div class="text-xs text-gray-600">{{almacen.ubicacion}}</div>
                <div class="text-xs text-gray-500" *ngIf="almacen.ubicacionGeografica">
                  {{almacen.ubicacionGeografica.ciudad}}, {{almacen.ubicacionGeografica.pais}}
                </div>
              </div>
            </div>
            
            <div class="text-sm text-blue-600 mt-6">
              <i class="pi pi-info-circle mr-1"></i>
              Esta funcionalidad requiere integración con servicios de mapas (Google Maps, OpenStreetMap)
            </div>
          </div>
        </div>
      </div>
      
      <!-- Panel lateral con información -->
      <div class="col-span-1">
        <div class="space-y-4">
          <!-- Filtros del mapa -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <i class="pi pi-filter text-blue-600"></i>
              Filtros
            </h4>
            <div class="space-y-3">
              <div>
                <label for="filtroEstado" class="text-sm font-medium text-gray-700 mb-1 block">Estado</label>
                <p-multiSelect
                  inputId="filtroEstado" 
                  [options]="estadosAlmacenConTodos" 
                  [(ngModel)]="filtroEstadoMapa" 
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Filtrar por estado"
                  class="w-full"
                  [showClear]="true"  
                  styleClass="h-10"
              />
              </div>
              <div>
                <label for="filtroTipo" class="text-sm font-medium text-gray-700 mb-1 block">Tipo</label>
                <p-multiSelect 
                  inputId="filtroTipo"
                  [options]="tiposAlmacenConTodos" 
                  [(ngModel)]="filtroTipoMapa" 
                  optionLabel="label"
                  optionValue="value"
                  placeholder="Filtrar por tipo"
                  class="w-full"
                  [showClear]="true"
                  styleClass="h-10"
              />
              </div>
              <div class="flex items-center gap-2">
                <p-checkbox 
                  [(ngModel)]="mostrarRutas" 
                  [binary]="true"
                  inputId="mostrarRutas"
                />
                <label for="mostrarRutas" class="text-sm text-gray-700">Mostrar rutas</label>
              </div>
              <div class="flex items-center gap-2">
                <p-checkbox 
                  [(ngModel)]="mostrarRadioCobertura" 
                  [binary]="true"
                  inputId="mostrarRadio"
                />
                <label for="mostrarRadio" class="text-sm text-gray-700">Radio de cobertura</label>
              </div>
            </div>
          </div>
          
          <!-- Lista de almacenes en el mapa -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <i class="pi pi-list text-green-600"></i>
              Almacenes ({{almacenes.length}})
            </h4>
            <div class="space-y-2 max-h-60 overflow-y-auto">
              <div 
                *ngFor="let almacen of almacenes" 
                class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-50 cursor-pointer transition-colors duration-300"
                (click)="centrarEnAlmacen(almacen)"
                (keyup.enter)="centrarEnAlmacen(almacen)"
                (keyup.space)="centrarEnAlmacen(almacen)"
                tabindex="0"
                role="button"
                [attr.aria-label]="'Centrar en ' + almacen.nombre"
              >
                <div class="map-marker w-3 h-3 rounded-full"
                     [ngClass]="{
                       'bg-green-500': almacen.estado === 'ACTIVO',
                       'bg-red-500': almacen.estado === 'INACTIVO',
                       'bg-orange-500': almacen.estado === 'MANTENIMIENTO'
                     }">
                </div>
                <div class="flex-1">
                  <div class="font-medium text-gray-800 text-sm">{{almacen.nombre}}</div>
                  <div class="text-xs text-gray-600">{{almacen.ubicacion}}</div>
                </div>
                <p-tag 
                  [value]="almacen.estado || 'ACTIVO'"
                  [severity]="getEstadoColor(almacen.estado || 'ACTIVO')"
                  size="small"
                />
              </div>
            </div>
          </div>
          
          <!-- Estadísticas del mapa -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <i class="pi pi-chart-bar text-purple-600"></i>
              Estadísticas
            </h4>
            <div class="space-y-2">
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600">Total Almacenes:</span>
                <span class="font-bold text-blue-600">{{calcularEstadisticas().totalAlmacenes}}</span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600">Activos:</span>
                <span class="font-bold text-green-600">{{getAlmacenesActivosCount()}}</span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600">En Mantenimiento:</span>
                <span class="font-bold text-orange-600">{{getAlmacenesMantenimientoCount()}}</span>
              </div>
              <div class="flex justify-between items-center text-sm">
                <span class="text-gray-600">Capacidad Total:</span>
                <span class="font-bold text-purple-600">{{calcularEstadisticas().capacidadTotal | number:'1.0-0'}}</span>
              </div>
            </div>
          </div>
          
          <!-- Leyenda -->
          <div class="bg-white rounded-xl p-4 border border-gray-200">
            <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
              <i class="pi pi-info-circle text-gray-600"></i>
              Leyenda
            </h4>
            <div class="space-y-2">
              <div class="flex items-center gap-2 text-sm">
                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                <span class="text-gray-700">Almacén Activo</span>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <div class="w-3 h-3 rounded-full bg-orange-500"></div>
                <span class="text-gray-700">En Mantenimiento</span>
              </div>
              <div class="flex items-center gap-2 text-sm">
                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                <span class="text-gray-700">Inactivo</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="text-sm text-gray-600">
        <i class="pi pi-map mr-1"></i>
        {{almacenes.length}} ubicaciones en el mapa
      </div>
      <div class="flex gap-3">
        <p-button 
          label="Cerrar" 
          icon="pi pi-times" 
          class="p-button-text" 
          (click)="hideMapaDialog()"
          (keyup.enter)="hideMapaDialog()"
          (keyup.space)="hideMapaDialog()"
          tabindex="0"
          role="button"
          aria-label="Cerrar mapa"
        />
        <p-button 
          label="Exportar Mapa" 
          icon="pi pi-download" 
          severity="info"
          [outlined]="true"
          (click)="exportarMapa()"
          (keyup.enter)="exportarMapa()"
          (keyup.space)="exportarMapa()"
          tabindex="0"
          role="button"
          aria-label="Exportar mapa"
        />
        <p-button 
          label="Configurar GPS" 
          icon="pi pi-cog" 
          severity="secondary"
          (click)="configurarGPS()"
          (keyup.enter)="configurarGPS()"
          (keyup.space)="configurarGPS()"
          tabindex="0"
          role="button"
          aria-label="Configurar GPS"
        />
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Filtros Avanzados -->
<p-dialog 
  [(visible)]="filtrosDialog" 
  [style]="{width: '900px'}" 
  header="Filtros Avanzados de Almacenes" 
  [modal]="true" 
  (onHide)="hideFiltrosDialog()"
>
  <div class="p-4">
    <!-- Resumen de filtros activos -->
    <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-xl p-4 mb-6" *ngIf="getTotalFiltrosActivosAlmacenes() > 0">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="bg-blue-600 p-2 rounded-lg">
            <i class="pi pi-filter text-white"></i>
          </div>
          <div>
            <h4 class="font-bold text-gray-800 m-0">Filtros Activos</h4>
            <p class="text-sm text-gray-600 mt-1">{{getTotalFiltrosActivosAlmacenes()}} filtro{{getTotalFiltrosActivosAlmacenes() > 1 ? 's' : ''}} aplicado{{getTotalFiltrosActivosAlmacenes() > 1 ? 's' : ''}}</p>
          </div>
        </div>
        <p-button 
          label="Limpiar Todo" 
          icon="pi pi-times" 
          severity="secondary"
          [outlined]="true"
          size="small"
          (click)="limpiarFiltrosAlmacenes()"
        />
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Filtros por características -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
        <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="pi pi-tags text-blue-600"></i>
          Filtros por Características
        </h4>
        
        <!-- Filtro por nombre -->
        <div class="mb-4">
          <label for="filtroNombre" class="block font-semibold mb-2 text-gray-700">
            <i class="pi pi-building mr-1 text-blue-600"></i>
            <span>Nombre del Almacén</span>
          </label>
          <input 
            id="filtroNombre"
            type="text" 
            pInputText 
            [(ngModel)]="filtrosAlmacenes.nombre" 
            placeholder="Buscar por nombre..."
            class="w-full"
          />
        </div>
        
        <!-- Filtro por ubicación -->
        <div class="mb-4">
          <label for="filtroUbicacion" class="block font-semibold mb-2 text-gray-700">
            <i class="pi pi-map-marker mr-1 text-green-600"></i>
            Ubicación
          </label>
          <input 
            id="filtroUbicacion"
            type="text" 
            pInputText 
            [(ngModel)]="filtrosAlmacenes.ubicacion" 
            placeholder="Buscar por ubicación..."
            class="w-full"
          />
        </div>
        
        <!-- Filtro por estado -->
        <div class="mb-4">
          <label for="filtroEstado" class="block font-semibold mb-2 text-gray-700">
            <i class="pi pi-bookmark mr-1 text-indigo-600"></i>
            Estado
          </label>
          <p-select 
            inputId="filtroEstado"
            [options]="estadosAlmacen" 
            [(ngModel)]="filtrosAlmacenes.estado" 
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar estado"
            [showClear]="true"
            class="w-full"
          />
        </div>
        
        <!-- Filtro por tipo -->
        <div class="mb-4">
          <label for="filtroTipoAlmacen" class="block font-semibold mb-2 text-gray-700">
            <i class="pi pi-tag mr-1 text-purple-600"></i>
            Tipo de Almacén
          </label>
          <p-select 
            inputId="filtroTipoAlmacen"
            [options]="tiposAlmacen" 
            [(ngModel)]="filtrosAlmacenes.tipoAlmacen" 
            optionLabel="label"
            optionValue="value"
            placeholder="Seleccionar tipo"
            [showClear]="true"
            class="w-full"
          />
        </div>
        
        <!-- Filtro por responsable -->
        <div class="mb-4">
          <label for="filtroResponsable" class="block font-semibold mb-2 text-gray-700">
            <i class="pi pi-user mr-1 text-orange-600"></i>
            Responsable
          </label>
          <input 
            id="filtroResponsable"
            type="text" 
            pInputText 
            [(ngModel)]="filtrosAlmacenes.responsable" 
            placeholder="Buscar por responsable..."
            class="w-full"
          />
        </div>
      </div>
      
      <!-- Filtros numéricos y de rango -->
      <div class="bg-white rounded-xl border border-gray-200 p-6">
        <h4 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
          <i class="pi pi-sliders-h text-purple-600"></i>
          Filtros Numéricos y Rangos
        </h4>
        
        <!-- Rango de capacidad -->
        <div class="mb-6">
          <div class="block font-semibold mb-3 text-gray-700">
            <i class="pi pi-database mr-1 text-blue-600"></i>
            Rango de Capacidad
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="capacidadMin" class="text-sm text-gray-600 mb-1 block">Capacidad Mínima</label>
              <p-inputNumber
                inputId="capacidadMin"
                [(ngModel)]="filtrosAlmacenes.capacidadMin"
                [showButtons]="true"
                [min]="0"
                placeholder="Min"
                class="w-full"
              />
            </div>
            <div>
              <label for="capacidadMax" class="text-sm text-gray-600 mb-1 block">Capacidad Máxima</label>
              <p-inputNumber
                inputId="capacidadMax"
                [(ngModel)]="filtrosAlmacenes.capacidadMax"
                [showButtons]="true"
                [min]="0"
                placeholder="Max"
                class="w-full"
              />
            </div>
          </div>
        </div>
        
        <!-- Rango de ocupación -->
        <div class="mb-6">
          <div class="block font-semibold mb-3 text-gray-700">
            <i class="pi pi-chart-pie mr-1 text-green-600"></i>
            Rango de Ocupación (%)
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div>
              <label for="ocupacionMin" class="text-sm text-gray-600 mb-1 block">Ocupación Mínima</label>
              <p-inputNumber
                inputId="ocupacionMin"
                [(ngModel)]="filtrosAlmacenes.ocupacionMin"
                [showButtons]="true"
                [min]="0"
                [max]="100"
                suffix="%"
                placeholder="Min %"
                class="w-full"
              />
            </div>
            <div>
              <label for="ocupacionMax" class="text-sm text-gray-600 mb-1 block">Ocupación Máxima</label>
              <p-inputNumber
                inputId="ocupacionMax"
                [(ngModel)]="filtrosAlmacenes.ocupacionMax"
                [showButtons]="true"
                [min]="0"
                [max]="100"
                suffix="%"
                placeholder="Max %"
                class="w-full"
              />
            </div>
          </div>
          
          <!-- Visualización del rango -->
          <div class="mt-4" *ngIf="filtrosAlmacenes.ocupacionMin !== null || filtrosAlmacenes.ocupacionMax !== null">
            <div class="bg-green-50 rounded-lg p-3">
              <div class="text-sm text-gray-600 mb-2">Rango de ocupación seleccionado:</div>
              <div class="font-medium text-green-600">
                {{filtrosAlmacenes.ocupacionMin || 0}}% - {{filtrosAlmacenes.ocupacionMax || 100}}%
              </div>
            </div>
          </div>
        </div>
        
        <!-- Filtro por ciudad -->
        <div class="mb-4">
          <label for="filtroCiudad" class="block font-semibold mb-2 text-gray-700">
            <i class="pi pi-building mr-1 text-indigo-600"></i>
            Ciudad
          </label>
          <input 
            id="filtroCiudad"
            type="text" 
            pInputText 
            [(ngModel)]="filtrosAlmacenes.ciudad" 
            placeholder="Buscar por ciudad..."
            class="w-full"
          />
        </div>
        
        <!-- Filtros rápidos predefinidos -->
        <div class="mb-4">
          <div class="block font-semibold mb-3 text-gray-700">
            <i class="pi pi-bolt mr-1 text-yellow-600"></i>
            Filtros Rápidos
          </div>
          <div class="grid grid-cols-2 gap-2">
            <p-button 
              label="Alta Capacidad" 
              icon="pi pi-arrow-up"
              severity="success"
              [outlined]="true"
              size="small"
              class="w-full"
              (click)="aplicarFiltroRapidoAlmacenes('alta-capacidad')"
              pTooltip="Almacenes con capacidad > 5000"
            />
            <p-button 
              label="Baja Ocupación" 
              icon="pi pi-arrow-down"
              severity="warn"
              [outlined]="true"
              size="small"
              class="w-full"
              (click)="aplicarFiltroRapidoAlmacenes('baja-ocupacion')"
              pTooltip="Almacenes con ocupación < 50%"
            />
            <p-button 
              label="Solo Activos" 
              icon="pi pi-check"
              severity="success"
              [outlined]="true"
              size="small"
              class="w-full"
              (click)="aplicarFiltroRapidoAlmacenes('solo-activos')"
              pTooltip="Solo almacenes activos"
            />
            <p-button 
              label="Mantenimiento" 
              icon="pi pi-wrench"
              severity="secondary"
              [outlined]="true"
              size="small"
              class="w-full"
              (click)="aplicarFiltroRapidoAlmacenes('mantenimiento')"
              pTooltip="Almacenes en mantenimiento"
            />
          </div>
        </div>
      </div>
      
      <!-- Resumen de resultados esperados -->
      <div class="col-span-full" *ngIf="getTotalFiltrosActivosAlmacenes() > 0">
        <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-xl p-4">
          <h4 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
            <i class="pi pi-info-circle text-blue-600"></i>
            Resumen de Filtros Aplicados
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <div class="text-center" *ngIf="filtrosAlmacenes.nombre">
              <div class="text-sm text-gray-600">Nombre</div>
              <div class="font-medium text-blue-600">{{filtrosAlmacenes.nombre}}</div>
            </div>
            <div class="text-center" *ngIf="filtrosAlmacenes.estado">
              <div class="text-sm text-gray-600">Estado</div>
              <div class="font-medium text-green-600">{{getEstadoLabel(filtrosAlmacenes.estado)}}</div>
            </div>
            <div class="text-center" *ngIf="filtrosAlmacenes.tipoAlmacen">
              <div class="text-sm text-gray-600">Tipo</div>
              <div class="font-medium text-purple-600">{{getTipoAlmacenLabel(filtrosAlmacenes.tipoAlmacen)}}</div>
            </div>
            <div class="text-center" *ngIf="filtrosAlmacenes.capacidadMin !== null || filtrosAlmacenes.capacidadMax !== null">
              <div class="text-sm text-gray-600">Capacidad</div>
              <div class="font-medium text-blue-600">
                {{filtrosAlmacenes.capacidadMin || 0}} - {{filtrosAlmacenes.capacidadMax || '∞'}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <div class="text-sm text-gray-600">
        <i class="pi pi-info-circle mr-1"></i>
        Los filtros se aplicarán sobre {{almacenes.length}} almacenes totales
      </div>
      <div class="flex gap-3">
        <p-button 
          label="Cancelar" 
          icon="pi pi-times" 
          class="p-button-text" 
          (click)="hideFiltrosDialog()" 
        />
        <p-button 
          label="Limpiar Filtros" 
          icon="pi pi-refresh" 
          severity="secondary"
          [outlined]="true"
          (click)="limpiarFiltrosAlmacenes()" 
        />
        <p-button 
          label="Aplicar Filtros" 
          icon="pi pi-check" 
          (click)="aplicarFiltrosAlmacenes(); hideFiltrosDialog()" 
        />
      </div>
    </div>
  </ng-template>
</p-dialog>