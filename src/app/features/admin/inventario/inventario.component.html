<p-toast position="top-right" [life]="4000" />
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<!-- Header -->
<div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 mb-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden group transition-all duration-300 hover:shadow-md">
  
  <div class="absolute top-0 right-0 w-96 h-96 bg-emerald-50 dark:bg-emerald-900/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/3 opacity-60 pointer-events-none transition-transform duration-1000 group-hover:scale-110"></div>

  <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8 relative z-10">
    
    <div class="flex items-center gap-5">
      <div class="w-20 h-20 rounded-3xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-emerald-600 dark:text-emerald-400 border border-surface-100 dark:border-surface-700 shadow-inner">
        <i class="pi pi-box text-3xl"></i>
      </div>
      
      <div>
        <h1 class="text-3xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-tight">
          Control de Inventario
        </h1>
        <p class="text-surface-500 dark:text-surface-400 mt-1 mb-0 text-base flex items-center gap-2">
          <span>Logística</span>
          <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
          <span class="font-medium text-emerald-600 dark:text-emerald-400">Stock & Valorización</span>
        </p>
      </div>
    </div>

    <div class="w-full xl:w-auto bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-1 border border-surface-100 dark:border-surface-700/50 overflow-x-auto no-scrollbar">
      <div class="flex flex-row items-center divide-x divide-surface-200 dark:divide-surface-700 min-w-max">
        
        <div class="px-6 py-3 flex flex-col items-center sm:items-start min-w-[140px]">
           <span class="text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-1 flex items-center gap-1.5">
              <i class="pi pi-money-bill text-emerald-600"></i> Valor Total
           </span>
           <span class="text-2xl font-bold text-surface-900 dark:text-surface-0 leading-none">
              S/. {{ calcularEstadisticas().valorTotalInventario | number: "1.2-2" }}
           </span>
        </div>

        <div class="px-6 py-3 flex flex-col items-center sm:items-start min-w-[120px]">
           <span class="text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-1 flex items-center gap-1.5">
              <i class="pi pi-box text-blue-500"></i> SKUs
           </span>
           <span class="text-2xl font-bold text-surface-900 dark:text-surface-0 leading-none">
              {{ calcularEstadisticas().totalProductos | number }}
           </span>
        </div>

        <div class="px-6 py-3 flex flex-col items-center sm:items-start min-w-[120px]">
           <span class="text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-1 flex items-center gap-1.5">
              <i class="pi pi-exclamation-triangle" [ngClass]="calcularEstadisticas().stockCritico > 0 ? 'text-orange-500' : 'text-surface-400'"></i> Crítico
           </span>
           <span class="text-2xl font-bold leading-none transition-colors"
                 [ngClass]="calcularEstadisticas().stockCritico > 0 ? 'text-orange-600 dark:text-orange-400' : 'text-surface-900 dark:text-surface-0'">
              {{ calcularEstadisticas().stockCritico }}
           </span>
        </div>

        <div class="px-6 py-3 flex flex-col items-center sm:items-start min-w-[120px]">
           <span class="text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-1 flex items-center gap-1.5">
              <i class="pi pi-times-circle" [ngClass]="calcularEstadisticas().productosAgotados > 0 ? 'text-red-500' : 'text-surface-400'"></i> Agotados
           </span>
           <span class="text-2xl font-bold leading-none transition-colors"
                 [ngClass]="calcularEstadisticas().productosAgotados > 0 ? 'text-red-600 dark:text-red-400' : 'text-surface-900 dark:text-surface-0'">
              {{ calcularEstadisticas().productosAgotados }}
           </span>
        </div>

        <div class="px-6 py-3 flex flex-col items-center sm:items-start min-w-[140px]">
           <span class="text-[10px] font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-1 flex items-center gap-1.5">
              <i class="pi pi-chart-line text-purple-500"></i> Eficiencia
           </span>
           <div class="flex items-center gap-2">
               <span class="text-2xl font-bold text-surface-900 dark:text-surface-0 leading-none">
                  {{ calcularEstadisticas().eficienciaStock | number: "1.0-0" }}%
               </span>
               <div class="w-8 h-8 relative flex items-center justify-center">
                   <svg class="w-full h-full transform -rotate-90">
                       <circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="3" fill="transparent" class="text-surface-200 dark:text-surface-700" />
                       <circle cx="16" cy="16" r="12" stroke="currentColor" stroke-width="3" fill="transparent" class="text-purple-500 transition-all duration-1000" [attr.stroke-dasharray]="75" [attr.stroke-dashoffset]="75 - (75 * (calcularEstadisticas().eficienciaStock / 100))" stroke-linecap="round" />
                   </svg>
               </div>
           </div>
        </div>

      </div>
    </div>

  </div>
</div>

<!-- Toolbar -->
<div class="sticky top-4 z-40 mb-8 px-2">
  <div class="bg-white dark:bg-surface-900 rounded-2xl p-3 shadow-lg border border-surface-200 dark:border-surface-700 flex flex-col xl:flex-row items-center justify-between gap-4 transition-all duration-300">
    
    <div class="flex flex-wrap items-center gap-2 w-full xl:w-auto">
      
      <button
        *appHasPermission="{ module: 'inventario', permission: permissionTypes.CREATE }"
        (click)="openNew()"
        class="group relative px-5 py-2.5 bg-surface-900 hover:bg-black dark:bg-surface-0 dark:hover:bg-surface-200 text-white dark:text-surface-900 rounded-xl font-bold transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5 active:scale-95 flex items-center gap-2 shadow-md min-w-max"
      >
        <i class="pi pi-plus text-xs"></i>
        <span>Nuevo Movimiento</span>
      </button>

      <button
        (click)="mostrarAnalisisAbc()"
        class="px-4 py-2.5 bg-purple-50 dark:bg-purple-900/20 hover:bg-purple-100 dark:hover:bg-purple-900/30 text-purple-600 dark:text-purple-400 rounded-xl font-bold border border-purple-100 dark:border-purple-900/50 transition-all flex items-center gap-2 min-w-max"
        pTooltip="Matriz Estratégica"
      >
        <i class="pi pi-sort-amount-down"></i>
        <span class="hidden sm:inline">Análisis ABC</span>
      </button>

      <button
        (click)="mostrarAlertas()"
        class="relative px-4 py-2.5 rounded-xl font-bold transition-all flex items-center gap-2 min-w-max border"
        [ngClass]="calcularEstadisticas().alertasCriticas.length > 0 
            ? 'bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 border-red-100 dark:border-red-900/50 hover:bg-red-100' 
            : 'bg-surface-50 dark:bg-surface-800 text-surface-600 dark:text-surface-300 border-surface-200 dark:border-surface-700 hover:bg-surface-100'"
        pTooltip="Centro de Alertas"
      >
        <i class="pi pi-bell" [class.animate-swing]="calcularEstadisticas().alertasCriticas.length > 0"></i>
        <span class="hidden sm:inline">Alertas</span>
        
        <span *ngIf="calcularEstadisticas().alertasCriticas.length > 0" 
              class="absolute -top-1 -right-1 flex h-4 w-4">
          <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
          <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500 text-white text-[9px] items-center justify-center font-bold">
            {{ calcularEstadisticas().alertasCriticas.length }}
          </span>
        </span>
      </button>

      <div *ngIf="selectedInventarios?.length" class="animate-fade-in border-l border-surface-200 dark:border-surface-700 pl-2 ml-1">
          <button
            *appHasPermission="{ module: 'inventario', permission: permissionTypes.DELETE }"
            (click)="deleteSelectedInventarios()"
            [disabled]="!productoSeleccionadoFiltro"
            class="px-4 py-2.5 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold transition-all flex items-center gap-2 border border-red-100 dark:border-red-900/50 min-w-max disabled:opacity-50 disabled:cursor-not-allowed"
            pTooltip="Eliminar selección"
          >
            <i class="pi pi-trash"></i>
            <span>({{ selectedInventarios.length }})</span>
          </button>
      </div>
    </div>

    <div class="flex items-center gap-2 bg-surface-50 dark:bg-surface-800 p-1.5 rounded-xl border border-surface-100 dark:border-surface-700 w-full xl:w-auto justify-between xl:justify-end">
      
      <div class="flex bg-white dark:bg-surface-900 rounded-lg p-1 shadow-sm border border-surface-100 dark:border-surface-700 overflow-x-auto no-scrollbar max-w-[200px] sm:max-w-none">
        <button 
            *ngFor="let option of viewOptions"
            (click)="currentView = option.value"
            class="w-9 h-9 flex-shrink-0 flex items-center justify-center rounded-md transition-all duration-200 relative"
            [ngClass]="currentView === option.value 
                ? 'bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 shadow-md scale-105 z-10' 
                : 'text-surface-400 hover:text-surface-600 dark:hover:text-surface-300 hover:bg-surface-50 dark:hover:bg-surface-800'"
            [pTooltip]="option.label"
            tooltipPosition="top">
            <i [class]="option.icon"></i>
        </button>
      </div>

      <div class="w-px h-6 bg-surface-200 dark:bg-surface-700 mx-1 flex-shrink-0"></div>

      <div class="flex gap-1 items-center">
          <button
            (click)="mostrarEstadisticas()"
            class="w-10 h-10 flex items-center justify-center rounded-lg text-purple-500 hover:text-purple-700 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all active:scale-90"
            pTooltip="Dashboard Analytics">
            <i class="pi pi-chart-bar"></i>
          </button>

          <button
            (click)="mostrarFiltros()"
            class="w-10 h-10 flex items-center justify-center rounded-lg text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 hover:bg-white dark:hover:bg-surface-700 transition-all active:scale-90"
            pTooltip="Filtros Avanzados">
            <i class="pi pi-filter"></i>
          </button>

          <div class="zen-split-button">
              <p-splitButton 
                  icon="pi pi-download" 
                  [model]="exportOptions"
                  (onClick)="exportarTodo()"
                  styleClass="p-button-text p-button-secondary"
                  pTooltip="Exportar Data"
              ></p-splitButton>
          </div>

          <button
            (click)="filtrarInventarioPorProducto()"
            class="w-10 h-10 flex items-center justify-center rounded-lg text-surface-500 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all active:scale-90"
            pTooltip="Refrescar Datos">
            <i class="pi pi-refresh"></i>
          </button>
      </div>

    </div>
  </div>
</div>

<!-- Vista Dashboard (Principal) -->
<div *ngIf="currentView === 'dashboard'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
    
    <div class="mb-10 max-w-4xl mx-auto">
        <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0">Explorador de Inventario</h2>
            <p class="text-surface-500 mt-2 text-sm">Busca por código, nombre o SKU para gestionar existencias</p>
        </div>

        <div class="relative group z-20">
            <div class="absolute -inset-1 bg-gradient-to-r from-primary-200 to-primary-100 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
            
            <div class="relative bg-white dark:bg-surface-900 rounded-2xl shadow-xl">
                <p-select
                    [options]="productos"
                    [(ngModel)]="productoSeleccionadoFiltro"
                    optionLabel="codigo"
                    placeholder="Escribe para buscar un producto..."
                    [filter]="true"
                    filterBy="nombre,codigo"
                    [style]="{ width: '100%' }"
                    (onChange)="filtrarInventarioPorProducto()"
                    (onClear)="limpiarFiltros()"
                    [showClear]="true"
                    [resetFilterOnHide]="true"
                    [filterMatchMode]="'contains'"
                    appendTo="body"
                    styleClass="w-full h-16 border-0 bg-transparent text-lg pl-4"
                    panelStyleClass="zen-dropdown-panel mt-2 rounded-2xl shadow-2xl border border-surface-100"
                    [panelStyle]="{ 'min-width': '100%', 'max-height': '400px' }"
                    [virtualScroll]="true"
                    [virtualScrollItemSize]="70"
                    scrollHeight="350px"
                    [loading]="isLoadingProductos"
                    [disabled]="productos.length === 0"
                >
                    <ng-template pTemplate="loader">
                        <i class="pi pi-spin pi-spinner text-primary-500"></i>
                    </ng-template>

                    <ng-template pTemplate="selectedItem">
                        <div *ngIf="productoSeleccionadoFiltro" class="flex items-center gap-3 h-full">
                            <div class="w-8 h-8 rounded-lg bg-primary-50 text-primary-600 flex items-center justify-center font-bold text-xs border border-primary-100">
                                {{ productoSeleccionadoFiltro.nombre.charAt(0) }}
                            </div>
                            <div class="flex flex-col justify-center">
                                <span class="text-sm font-bold text-surface-900 dark:text-surface-0 leading-none">{{ productoSeleccionadoFiltro.nombre }}</span>
                                <span class="text-xs text-surface-500 leading-none mt-1">{{ productoSeleccionadoFiltro.codigo }}</span>
                            </div>
                        </div>
                    </ng-template>

                    <ng-template let-item pTemplate="item">
                        <div class="flex items-center gap-4 p-2 hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors rounded-xl mx-2">
                            <div class="w-10 h-10 rounded-xl bg-surface-100 dark:bg-surface-800 flex items-center justify-center text-surface-500">
                                <i class="pi pi-box"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="font-bold text-surface-800 dark:text-surface-100 truncate">{{ item.nombre }}</div>
                                <div class="flex items-center gap-2 text-xs text-surface-500">
                                    <span class="font-mono bg-surface-100 dark:bg-surface-800 px-1.5 rounded">{{ item.codigo }}</span>
                                    <span>•</span>
                                    <span class="text-emerald-600 font-bold">S/. {{ item.precioVenta | number:'1.2-2' }}</span>
                                </div>
                            </div>
                            <div *ngIf="item.stock !== undefined" class="text-right">
                                <span class="block text-xs font-bold" [ngClass]="item.stock > 0 ? 'text-surface-900' : 'text-red-500'">
                                    {{ item.stock }}
                                </span>
                                <span class="text-[10px] uppercase text-surface-400">Stock</span>
                            </div>
                        </div>
                    </ng-template>
                </p-select>
            </div>
        </div>
    </div>

    <div *ngIf="inventariosFiltrados?.length; else noDashboardData" class="animate-fade-in-up">
        
        <div class="flex items-center justify-between mb-6 pb-6 border-b border-surface-100 dark:border-surface-800">
            <h3 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0 flex items-center gap-2">
                <i class="pi pi-th-large text-primary-500"></i>
                <span *ngIf="productoSeleccionadoFiltro">Resultados para: {{ productoSeleccionadoFiltro.nombre }}</span>
                <span *ngIf="!productoSeleccionadoFiltro">Vista General</span>
            </h3>
            <span class="text-xs font-bold text-surface-500 bg-surface-100 dark:bg-surface-800 px-3 py-1.5 rounded-lg">
                {{ inventariosFiltrados.length }} variantes encontradas
            </span>
        </div>

        <div *ngIf="productoSeleccionadoFiltro" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-2xl p-4 border border-surface-200 dark:border-surface-700 text-center">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest block mb-1">Total Unidades</span>
                <span class="text-2xl font-bold text-blue-600">{{ totalUnidades | number }}</span>
            </div>
            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-2xl p-4 border border-surface-200 dark:border-surface-700 text-center">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest block mb-1">Variantes</span>
                <span class="text-2xl font-bold text-surface-900 dark:text-surface-0">{{ totalVariantes | number }}</span>
            </div>
            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-2xl p-4 border border-surface-200 dark:border-surface-700 text-center">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest block mb-1">Stock Bajo</span>
                <span class="text-2xl font-bold text-amber-600">{{ stockBajoCount | number }}</span>
            </div>
            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-2xl p-4 border border-surface-200 dark:border-surface-700 text-center">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest block mb-1">Agotados</span>
                <span class="text-2xl font-bold text-red-600">{{ agotadosCount | number }}</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            <div *ngFor="let inventario of inventariosDashboardPaginados; trackBy: trackByInventario"
                 class="group bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-700 hover:border-primary-300 dark:hover:border-primary-700 shadow-sm hover:shadow-lg transition-all duration-300 cursor-pointer overflow-hidden relative"
                 (click)="mostrarDetalle(inventario)">
                
                <div class="absolute top-0 left-0 bottom-0 w-1" 
                     [ngClass]="{
                        'bg-emerald-500': getStockLevel(inventario) === 'good',
                        'bg-amber-500': getStockLevel(inventario) === 'low',
                        'bg-red-500': getStockLevel(inventario) === 'critical'
                     }"></div>

                <div class="p-5 pl-7">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="text-xs font-mono text-surface-400 block mb-0.5">{{ inventario.serie }}</span>
                            <div class="flex items-center gap-2">
                                <span class="text-lg font-bold text-surface-900 dark:text-surface-0">{{ inventario.color?.nombre }}</span>
                                <span class="w-1 h-1 rounded-full bg-surface-300"></span>
                                <span class="text-sm text-surface-600">Talla {{ inventario.talla?.numero }}</span>
                            </div>
                        </div>
                        <div class="w-3 h-3 rounded-full border shadow-sm" [style.background-color]="inventario.color?.codigoHex || '#ccc'"></div>
                    </div>

                    <div class="flex justify-between items-end mt-4">
                        <div>
                            <div class="flex items-center gap-1.5 text-xs text-surface-500 mb-1">
                                <i class="pi pi-building"></i>
                                <span class="truncate max-w-[120px]">{{ inventario.almacen?.nombre }}</span>
                            </div>
                            <div class="flex items-center gap-1.5 text-xs text-surface-400">
                                <i class="pi pi-map-marker"></i>
                                <span>{{ inventario.ubicacionAlmacen || 'General' }}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="block text-2xl font-bold leading-none" 
                                  [ngClass]="{
                                    'text-emerald-600': getStockLevel(inventario) === 'good',
                                    'text-amber-600': getStockLevel(inventario) === 'low',
                                    'text-red-600': getStockLevel(inventario) === 'critical'
                                  }">
                                {{ inventario.cantidad }}
                            </span>
                            <span class="text-[10px] font-bold text-surface-400 uppercase tracking-wider">Unidades</span>
                        </div>
                    </div>
                </div>

                <div class="absolute top-3 right-3 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button pButton icon="pi pi-pencil" class="p-button-rounded p-button-text p-button-sm text-surface-400 hover:text-primary-600 w-8 h-8" (click)="editInventario(inventario); $event.stopPropagation()"></button>
                </div>
            </div>
        </div>

        <div *ngIf="dashboardTotalRecords > dashboardRows" class="mt-8 flex justify-center">
            <p-paginator [rows]="dashboardRows" [totalRecords]="dashboardTotalRecords" [first]="dashboardPage * dashboardRows" (onPageChange)="onDashboardPageChange($event)" styleClass="border-none bg-transparent"></p-paginator>
        </div>

    </div>

    <ng-template #noDashboardData>
        <div class="flex flex-col items-center justify-center py-20 text-center">
            
            <div *ngIf="!productoSeleccionadoFiltro; else sinResultados">
                <div class="w-64 h-48 bg-surface-50 dark:bg-surface-800 rounded-3xl border-2 border-dashed border-surface-200 dark:border-surface-700 flex flex-col items-center justify-center mb-6 mx-auto">
                    <i class="pi pi-search text-4xl text-surface-300 dark:text-surface-600 mb-3"></i>
                    <span class="text-sm font-bold text-surface-400">Esperando búsqueda...</span>
                </div>
                <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Comienza a explorar</h3>
                <p class="text-surface-500 text-base max-w-md mx-auto">
                    Utiliza la barra de búsqueda superior para encontrar productos y ver su disponibilidad en tiempo real en todos los almacenes.
                </p>
                
                <div class="mt-6 flex flex-wrap justify-center gap-2">
                    <span class="text-xs text-surface-400 mr-2">Prueba buscar:</span>
                    <button class="px-3 py-1 rounded-full bg-surface-100 hover:bg-surface-200 text-xs font-medium text-surface-600 transition-colors">Casacas</button>
                    <button class="px-3 py-1 rounded-full bg-surface-100 hover:bg-surface-200 text-xs font-medium text-surface-600 transition-colors">Pantalones</button>
                    <button class="px-3 py-1 rounded-full bg-surface-100 hover:bg-surface-200 text-xs font-medium text-surface-600 transition-colors">Stock Bajo</button>
                </div>
            </div>

            <ng-template #sinResultados>
                <div class="w-20 h-20 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-4 text-surface-400 mx-auto">
                    <i class="pi pi-inbox text-3xl"></i>
                </div>
                <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Inventario Vacío</h3>
                <p class="text-surface-500 text-base max-w-md mx-auto mb-6">
                    El producto seleccionado no tiene existencias registradas actualmente.
                </p>
                <button 
                    *appHasPermission="{ module: 'inventario', permission: permissionTypes.CREATE }"
                    (click)="openNew()"
                    class="px-6 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2 mx-auto">
                    <i class="pi pi-plus"></i> Registrar Ingreso
                </button>
            </ng-template>

        </div>
    </ng-template>

  </div>
</div>

<!-- Vista Cards (Alternativa al dashboard) -->
<div *ngIf="currentView === 'cards'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 relative z-10">
        <div class="flex items-center gap-5">
            <div class="w-14 h-14 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi pi-th-large text-2xl"></i>
            </div>
            <div class="flex flex-col">
                <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Galería de Stock
                </h3>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Visualización por Ficha</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-medium text-primary-600 dark:text-primary-400">
                        {{ inventariosFiltrados.length || 0 }} items
                    </span>
                </div>
            </div>
        </div>
        
        <div *ngIf="cardsTotalRecords > cardsRows" class="hidden md:block">
            <span class="text-xs font-bold text-surface-400 uppercase tracking-widest mr-2">Página {{cardsPage + 1}}</span>
        </div>
    </div>

    <div *ngIf="inventariosFiltrados.length; else noCardsData">
        
        <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
            
            <div *ngFor="let inventario of inventariosCardsPaginados; trackBy: trackByInventario"
                 class="group relative bg-surface-50 dark:bg-surface-800/50 hover:bg-white dark:hover:bg-surface-800 rounded-[2rem] border border-surface-200 dark:border-surface-700 hover:border-primary-200 dark:hover:border-primary-800 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden">
                
                <div class="absolute top-0 left-0 right-0 h-1"
                     [ngClass]="{
                        'bg-emerald-500': getStockLevel(inventario) === 'good',
                        'bg-amber-500': getStockLevel(inventario) === 'low',
                        'bg-red-500': getStockLevel(inventario) === 'critical'
                     }"></div>

                <div class="p-6 flex-1 flex flex-col">
                    
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest block mb-1">Serie</span>
                            <span class="font-mono text-lg font-bold text-surface-900 dark:text-surface-0">{{ inventario.serie }}</span>
                        </div>
                        <span class="px-2 py-1 rounded-lg text-[10px] font-bold border"
                              [ngClass]="{
                                'bg-emerald-50 text-emerald-700 border-emerald-100': inventario.estado === 'DISPONIBLE',
                                'bg-red-50 text-red-700 border-red-100': inventario.estado !== 'DISPONIBLE'
                              }">
                            {{ inventario.estado | uppercase }}
                        </span>
                    </div>

                    <div class="mb-6">
                        <h4 class="text-sm font-bold text-surface-800 dark:text-surface-100 line-clamp-2 mb-2 min-h-[2.5em]">
                            {{ inventario.producto?.nombre }}
                        </h4>
                        
                        <div class="flex flex-wrap gap-2">
                            <div class="flex items-center gap-2 px-2 py-1 bg-white dark:bg-surface-900 rounded-md border border-surface-200 dark:border-surface-700 shadow-sm">
                                <div class="w-3 h-3 rounded-full border border-surface-300" [style.background-color]="inventario.color?.codigoHex || '#ccc'"></div>
                                <span class="text-xs font-medium text-surface-600 dark:text-surface-300">{{ inventario.color?.nombre }}</span>
                            </div>
                            <div class="px-2 py-1 bg-white dark:bg-surface-900 rounded-md border border-surface-200 dark:border-surface-700 shadow-sm">
                                <span class="text-xs font-medium text-surface-600 dark:text-surface-300">Talla <span class="font-bold">{{ inventario.talla?.numero }}</span></span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-auto bg-white dark:bg-surface-900 rounded-xl p-4 border border-surface-100 dark:border-surface-700 shadow-sm">
                        <div class="flex justify-between items-end mb-2">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-surface-400 uppercase font-bold">Stock Físico</span>
                                <span class="text-2xl font-bold leading-none"
                                      [ngClass]="{
                                        'text-emerald-600': getStockLevel(inventario) === 'good',
                                        'text-amber-600': getStockLevel(inventario) === 'low',
                                        'text-red-600': getStockLevel(inventario) === 'critical'
                                      }">
                                    {{ inventario.cantidad }}
                                </span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-surface-400 block">Almacén</span>
                                <span class="text-xs font-bold text-surface-700 dark:text-surface-200 truncate max-w-[100px] block" title="{{inventario.almacen?.nombre}}">
                                    {{ inventario.almacen?.nombre }}
                                </span>
                            </div>
                        </div>
                        <div class="w-full h-1.5 bg-surface-100 dark:bg-surface-800 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000"
                                 [style.width.%]="calculateWidthPercentage(inventario.cantidad, inventario.stockMaximo || 100)"
                                 [ngClass]="{
                                    'bg-emerald-500': getStockLevel(inventario) === 'good',
                                    'bg-amber-500': getStockLevel(inventario) === 'low',
                                    'bg-red-500': getStockLevel(inventario) === 'critical'
                                 }"></div>
                        </div>
                    </div>

                </div>

                <div class="px-6 py-3 border-t border-surface-200 dark:border-surface-700 flex justify-between items-center bg-white/50 dark:bg-surface-900/50 backdrop-blur-sm group-hover:bg-primary-50/20 transition-colors">
                    <span class="text-[10px] font-mono text-surface-400">{{ inventario.producto?.codigo }}</span>
                    
                    <div class="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity translate-y-2 group-hover:translate-y-0 duration-200">
                        <button (click)="mostrarDetalle(inventario)" class="w-8 h-8 rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-900 transition-colors" pTooltip="Ver">
                            <i class="pi pi-eye"></i>
                        </button>
                        <button (click)="editInventario(inventario)" class="w-8 h-8 rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-900 transition-colors" pTooltip="Editar">
                            <i class="pi pi-pencil"></i>
                        </button>
                        <button (click)="eliminarInventario(inventario)" class="w-8 h-8 rounded-lg hover:bg-red-50 text-surface-400 hover:text-red-600 transition-colors" pTooltip="Eliminar">
                            <i class="pi pi-trash"></i>
                        </button>
                    </div>
                </div>

            </div>
        </div>

        <div *ngIf="cardsTotalRecords > cardsRows" class="mt-8 flex justify-center">
            <p-paginator
                [rows]="cardsRows"
                [totalRecords]="cardsTotalRecords"
                [first]="cardsPage * cardsRows"
                (onPageChange)="onCardsPageChange($event)"
                [rowsPerPageOptions]="[5, 10, 15, 20]"
                styleClass="border-none bg-transparent"
            ></p-paginator>
        </div>

    </div>

    <ng-template #noCardsData>
        <div class="flex flex-col items-center justify-center py-20">
            <div class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6 text-surface-300 dark:text-surface-600 border border-surface-100 dark:border-surface-700">
                <i class="pi pi-th-large text-4xl"></i>
            </div>
            <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Galería Vacía</h3>
            <p class="text-surface-500 text-base max-w-sm text-center mb-8">
                No hay registros que coincidan con tu búsqueda. Selecciona un producto para ver sus existencias.
            </p>
            <button 
                (click)="openNew()"
                class="px-8 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2">
                <i class="pi pi-plus"></i> Nuevo Ingreso
            </button>
        </div>
    </ng-template>

  </div>
</div>

<!-- Vista de Tabla -->
<div *ngIf="currentView === 'table'" class="mb-8 animate-fade-in">
  
  <div class="block lg:hidden mb-4 p-4 bg-amber-50 dark:bg-amber-900/10 rounded-2xl border border-amber-100 dark:border-amber-800/30 flex items-center gap-3">
    <i class="pi pi-info-circle text-amber-500 text-xl"></i>
    <span class="text-sm text-amber-700 dark:text-amber-400 font-medium">
      Desliza horizontalmente para ver todos los datos.
    </span>
  </div>

  <div class="bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 rounded-[2rem] overflow-hidden shadow-sm transition-colors duration-300">
    
    <p-table
      #dt
      [value]="inventariosFiltrados"
      [rows]="10"
      [paginator]="true"
      [totalRecords]="inventariosFiltrados.length"
      [globalFilterFields]="['serie', 'color.nombre', 'talla.numero', 'almacen.nombre', 'estado']"
      [(selection)]="selectedInventarios"
      [rowHover]="true"
      dataKey="id"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} de {totalRecords}"
      [rowsPerPageOptions]="[10, 20, 50]"
      [loading]="loading"
      [tableStyle]="{ 'min-width': '85rem' }"
      styleClass="p-datatable-lg"
    >
      
      <ng-template pTemplate="caption">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-100 dark:border-surface-800">
          
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-400">
              <i class="pi pi-list text-xl"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0">Inventario Detallado</h3>
              <p class="text-sm text-surface-500 dark:text-surface-400 mt-0.5">
                <span *ngIf="inventariosFiltrados.length">{{ inventariosFiltrados.length }} registros</span>
                <span *ngIf="productoSeleccionadoFiltro" class="text-primary-600 font-medium"> • {{ productoSeleccionadoFiltro.nombre }}</span>
              </p>
            </div>
          </div>

          <div class="relative group w-full md:w-auto">
            <i class="pi pi-search absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 group-focus-within:text-primary-500 transition-colors text-lg"></i>
            <input
              pInputText
              type="text"
              (input)="onGlobalFilter(dt, $event)"
              placeholder="Buscar serie, lote, color..."
              class="pl-12 pr-4 py-3 w-full md:w-80 bg-surface-50 dark:bg-surface-800 border-none rounded-2xl text-base focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900 transition-all shadow-inner text-surface-700 dark:text-surface-200"
            />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr class="bg-surface-50/50 dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800">
          <th style="width: 3rem" class="text-center py-5">
            <p-tableHeaderCheckbox />
          </th>
          
          <th pSortableColumn="serie" class="py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
            <div class="flex items-center gap-2">Serie <p-sortIcon field="serie" /></div>
          </th>
          
          <th class="py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Variante
          </th>
          
          <th pSortableColumn="almacen.nombre" class="py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
            <div class="flex items-center gap-2">Ubicación <p-sortIcon field="almacen.nombre" /></div>
          </th>
          
          <th pSortableColumn="cantidad" class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
            <div class="flex justify-center items-center gap-2">Stock <p-sortIcon field="cantidad" /></div>
          </th>
          
          <th class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Estado
          </th>
          
          <th class="py-5 text-right text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Valor Total
          </th>
          
          <th style="width: 10rem" class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Acciones
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-inventario>
        <tr class="group border-b border-surface-100 dark:border-surface-800 hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-all duration-200">
          
          <td class="text-center py-6">
            <p-tableCheckbox [value]="inventario" />
          </td>
          
          <td class="py-6">
             <div class="flex flex-col">
                <span class="font-bold text-surface-900 dark:text-surface-0 font-mono text-sm">
                    {{ inventario.serie }}
                </span>
                <span class="text-xs text-surface-500 mt-0.5">
                    {{ inventario.producto?.codigo }}
                </span>
             </div>
          </td>

          <td class="py-6">
             <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full border shadow-sm flex items-center justify-center text-[10px] font-bold text-white relative group/tooltip"
                     [style.background-color]="inventario.color?.codigoHex || '#ccc'"
                     [title]="inventario.color?.nombre">
                     <span class="absolute -bottom-1 -right-1 bg-surface-900 text-white text-[9px] w-4 h-4 rounded-full flex items-center justify-center border border-white">
                        {{ inventario.talla?.numero }}
                     </span>
                </div>
                <div class="flex flex-col">
                    <span class="text-sm font-medium text-surface-700 dark:text-surface-200">{{ inventario.color?.nombre }}</span>
                    <span class="text-xs text-surface-500">Talla {{ inventario.talla?.numero }}</span>
                </div>
             </div>
          </td>

          <td class="py-6">
             <div class="flex flex-col">
                <span class="font-medium text-surface-900 dark:text-surface-0 text-sm">
                    {{ inventario.almacen?.nombre }}
                </span>
                <span class="text-xs text-surface-500 mt-0.5 flex items-center gap-1">
                    <i class="pi pi-map-marker text-[10px]"></i>
                    {{ inventario.almacen?.ubicacion }}
                </span>
             </div>
          </td>

          <td class="py-6 text-center">
             <div class="w-full max-w-[120px] mx-auto">
                <span class="block font-bold text-base mb-1" 
                      [ngClass]="{
                        'text-emerald-600': inventario.cantidad > 10,
                        'text-amber-600': inventario.cantidad <= 10 && inventario.cantidad > 0,
                        'text-red-600': inventario.cantidad === 0
                      }">
                    {{ inventario.cantidad }} <span class="text-[10px] text-surface-400 font-normal uppercase">und</span>
                </span>
                <div class="w-full bg-surface-200 dark:bg-surface-700 rounded-full h-1.5 overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500"
                         [ngClass]="{
                            'bg-emerald-500': inventario.cantidad > 10,
                            'bg-amber-500': inventario.cantidad <= 10 && inventario.cantidad > 0,
                            'bg-red-500': inventario.cantidad === 0
                         }"
                         [style.width.%]="calculateWidthPercentage(inventario.cantidad, inventario.stockMaximo || 100)">
                    </div>
                </div>
             </div>
          </td>

          <td class="py-6 text-center">
             <span class="px-2.5 py-1 rounded-full text-xs font-bold border"
                   [ngClass]="{
                      'bg-emerald-50 text-emerald-700 border-emerald-100': inventario.estado === 'DISPONIBLE',
                      'bg-red-50 text-red-700 border-red-100': inventario.estado === 'AGOTADO' || inventario.estado === 'DANIADO',
                      'bg-amber-50 text-amber-700 border-amber-100': inventario.estado === 'RESERVADO'
                   }">
                {{ inventario.estado | titlecase }}
             </span>
          </td>

          <td class="py-6 text-right">
             <div class="flex flex-col items-end">
                <span class="font-bold text-surface-900 dark:text-surface-0 font-mono">
                    S/. {{ inventario.valorTotal | number:'1.0-0' }}
                </span>
                <span class="text-[10px] text-surface-400">
                    unit: S/. {{ inventario.valorUnitario | number:'1.0-0' }}
                </span>
             </div>
          </td>

          <td class="py-6 text-center">
            <div class="flex gap-1 justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              
              <button 
                (click)="mostrarDetalle(inventario)" 
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 text-surface-400 hover:text-primary-600 transition-colors" 
                pTooltip="Ver Detalle" tooltipPosition="top"
              >
                <i class="pi pi-eye"></i>
              </button>
              
              <button 
                (click)="mostrarMovimientos(inventario)" 
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 text-surface-400 hover:text-purple-600 transition-colors" 
                pTooltip="Historial" tooltipPosition="top"
              >
                <i class="pi pi-history"></i>
              </button>
              
              <button 
                *appHasPermission="{ module: 'inventario', permission: permissionTypes.EDIT }" 
                (click)="editInventario(inventario)" 
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 dark:hover:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 transition-colors" 
                pTooltip="Editar" tooltipPosition="top"
              >
                <i class="pi pi-pencil"></i>
              </button>
              
              <button 
                *appHasPermission="{ module: 'inventario', permission: permissionTypes.DELETE }" 
                (click)="eliminarInventario(inventario)" 
                class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-surface-400 hover:text-red-600 transition-colors" 
                pTooltip="Eliminar" tooltipPosition="top"
              >
                <i class="pi pi-trash"></i>
              </button>

            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="8" class="text-center py-32">
            <div class="flex flex-col items-center justify-center">
                <div class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6">
                    <i class="pi pi-filter text-4xl text-surface-300 dark:text-surface-600"></i>
                </div>
                <h4 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">
                    {{ productoSeleccionadoFiltro ? 'Sin Stock Registrado' : 'Selecciona un Producto' }}
                </h4>
                <p class="text-surface-500 text-base max-w-sm mx-auto mb-8">
                    {{ productoSeleccionadoFiltro ? 'No se encontraron registros de inventario para este producto.' : 'Utiliza los filtros o selecciona un producto para ver su inventario.' }}
                </p>
                
                <button 
                    *ngIf="productoSeleccionadoFiltro"
                    (click)="openNew()"
                    class="px-6 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all">
                    Agregar Inventario
                </button>
            </div>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>
</div>

<!-- Vista de Analytics -->
<div *ngIf="currentView === 'analytics'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4 relative z-10">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 rounded-3xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-purple-600 dark:text-purple-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi pi-chart-bar text-3xl"></i>
            </div>
            
            <div class="flex flex-col">
                <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Analytics
                </h3>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Inteligencia de Negocio</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-medium text-purple-600 dark:text-purple-400">
                        Rendimiento & Valorización
                    </span>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button 
                (click)="generarDatosSimulados(); updateChartData()" 
                class="px-5 py-2.5 rounded-xl border border-surface-200 dark:border-surface-700 text-surface-600 dark:text-surface-300 hover:bg-surface-50 dark:hover:bg-surface-800 text-sm font-bold flex items-center gap-2 transition-all">
                <i class="pi pi-refresh"></i>
                <span>Actualizar</span>
            </button>
            <button 
                (click)="exportarExcel()" 
                class="px-5 py-2.5 rounded-xl bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 text-sm font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2">
                <i class="pi pi-download"></i>
                <span>Reporte</span>
            </button>
        </div>
    </div>

    <div *ngIf="inventariosFiltrados?.length; else noAnalyticsData">
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            
            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 relative overflow-hidden group">
                <div class="absolute left-0 top-6 bottom-6 w-1 rounded-r-full bg-emerald-500"></div>
                
                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2 pl-3">
                    <i class="pi pi-wallet text-emerald-500"></i> Valorización
                </h4>
                
                <div class="pl-3 grid grid-cols-2 gap-4">
                    <div>
                        <span class="text-3xl font-bold text-surface-900 dark:text-surface-0 block mb-1">
                            S/. {{ calcularEstadisticas().valorTotalInventario | number:'1.0-0' }}
                        </span>
                        <span class="text-xs text-surface-500 font-medium">Valor Total Activo</span>
                    </div>
                    <div>
                        <span class="text-xl font-bold text-blue-600 block mb-1">
                            S/. {{ calcularEstadisticas().valorEnRiesgo | number:'1.0-0' }}
                        </span>
                        <span class="text-xs text-surface-500 font-medium">Capital en Riesgo</span>
                    </div>
                </div>

                <div class="mt-6 pl-3">
                    <div class="w-full h-1.5 bg-surface-200 dark:bg-surface-700 rounded-full overflow-hidden">
                        <div class="h-full bg-emerald-500 rounded-full" style="width: 85%"></div>
                    </div>
                    <div class="flex justify-between mt-2 text-[10px] font-bold text-surface-400 uppercase tracking-wider">
                        <span>Eficiencia Financiera</span>
                        <span class="text-emerald-600">85%</span>
                    </div>
                </div>
            </div>

            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 flex flex-col items-center justify-center relative">
                <h4 class="absolute top-6 left-6 text-xs font-bold text-surface-400 uppercase tracking-widest">
                    <i class="pi pi-sync text-blue-500 mr-2"></i> Rotación
                </h4>
                
                <div class="relative mt-2">
                    <p-knob 
                        [(ngModel)]="calcularEstadisticas().rotacionPromedio" 
                        [size]="110" 
                        [readonly]="true" 
                        valueTemplate="{value}x" 
                        [strokeWidth]="8"
                        textColor="var(--text-color)"
                        valueColor="#3b82f6" 
                        rangeColor="var(--surface-200)"
                    ></p-knob>
                </div>
                
                <div class="mt-4 flex items-center gap-2 px-3 py-1 bg-white dark:bg-surface-800 rounded-lg border border-surface-100 dark:border-surface-700 shadow-sm">
                    <i class="pi pi-arrow-up text-emerald-500 text-xs"></i>
                    <span class="text-xs font-bold text-emerald-600">+15% vs año anterior</span>
                </div>
            </div>

            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-6 border border-surface-200 dark:border-surface-700">
                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                    <i class="pi pi-heart text-rose-500"></i> Salud de Stock
                </h4>
                
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-3 bg-white dark:bg-surface-800 rounded-xl border border-surface-100 dark:border-surface-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-emerald-50 dark:bg-emerald-900/30 flex items-center justify-center text-emerald-600">
                                <i class="pi pi-check text-sm"></i>
                            </div>
                            <span class="text-sm font-bold text-surface-700 dark:text-surface-200">Disponibles</span>
                        </div>
                        <span class="text-lg font-bold text-emerald-600">{{ getDisponiblesCount() }}</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-white dark:bg-surface-800 rounded-xl border border-surface-100 dark:border-surface-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-orange-50 dark:bg-orange-900/30 flex items-center justify-center text-orange-600">
                                <i class="pi pi-exclamation-triangle text-sm"></i>
                            </div>
                            <span class="text-sm font-bold text-surface-700 dark:text-surface-200">Críticos</span>
                        </div>
                        <span class="text-lg font-bold text-orange-600">{{ calcularEstadisticas().stockCritico }}</span>
                    </div>

                    <div class="flex items-center justify-between p-3 bg-white dark:bg-surface-800 rounded-xl border border-surface-100 dark:border-surface-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-lg bg-red-50 dark:bg-red-900/30 flex items-center justify-center text-red-600">
                                <i class="pi pi-times text-sm"></i>
                            </div>
                            <span class="text-sm font-bold text-surface-700 dark:text-surface-200">Agotados</span>
                        </div>
                        <span class="text-lg font-bold text-red-600">{{ calcularEstadisticas().productosAgotados }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <div class="lg:col-span-2 space-y-8">
                
                <div class="bg-white dark:bg-surface-900 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 shadow-sm">
                    <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Tendencia de Movimientos</h4>
                    <div class="chart-container h-[300px]">
                        <p-chart type="line" [data]="trendData" [options]="chartOptions" height="300px"></p-chart>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center">
                        <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Distribución</h4>
                        <div class="h-[200px] w-full flex justify-center">
                            <p-chart type="doughnut" [data]="chartData" [options]="chartOptions" width="200px" height="200px"></p-chart>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm">
                        <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Demanda por Zona</h4>
                        <div class="space-y-4">
                            <div *ngFor="let zona of calcularEstadisticas().zonasDemanda" class="group">
                                <div class="flex justify-between text-sm mb-1">
                                    <span class="font-bold text-surface-700 dark:text-surface-200">{{ zona.zona }}</span>
                                    <span class="font-bold" [style.color]="zona.color">{{ zona.demanda }}%</span>
                                </div>
                                <div class="w-full h-1.5 bg-surface-100 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-1000"
                                         [style.background-color]="zona.color"
                                         [style.width.%]="zona.demanda"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="space-y-8">
                
                <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm">
                    <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex justify-between items-center">
                        <span>Top Valor</span>
                        <i class="pi pi-star text-yellow-500"></i>
                    </h4>
                    <div class="space-y-3">
                        <div *ngFor="let inventario of inventariosFiltrados.slice(0, 5); let i = index" 
                             class="flex items-center justify-between p-3 rounded-2xl bg-surface-50 dark:bg-surface-800 border border-transparent hover:border-surface-200 transition-colors">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold text-white shadow-sm"
                                     [ngClass]="{
                                        'bg-yellow-500': i === 0,
                                        'bg-surface-400': i > 0
                                     }">
                                    {{ i + 1 }}
                                </div>
                                <div>
                                    <span class="block text-sm font-bold text-surface-900 dark:text-surface-0 line-clamp-1">{{ inventario.producto?.nombre }}</span>
                                    <span class="text-[10px] text-surface-500">{{ inventario.color?.nombre }}</span>
                                </div>
                            </div>
                            <span class="text-xs font-bold text-emerald-600">S/. {{ inventario.valorTotal | number:'1.0-0' }}</span>
                        </div>
                    </div>
                </div>

                <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm">
                    <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                        <i class="pi pi-bolt text-purple-500"></i> Insights IA
                    </h4>
                    <div class="space-y-3">
                        <div class="p-4 rounded-2xl bg-blue-50/50 dark:bg-blue-900/10 border border-blue-100 dark:border-blue-900/30">
                            <h5 class="text-sm font-bold text-blue-800 dark:text-blue-300 m-0 mb-1">Optimización Stock</h5>
                            <p class="text-xs text-blue-600 dark:text-blue-400 m-0 leading-relaxed">Reducir inventario categoría C en un 15% liberaría capital.</p>
                        </div>
                        <div class="p-4 rounded-2xl bg-orange-50/50 dark:bg-orange-900/10 border border-orange-100 dark:border-orange-900/30">
                            <h5 class="text-sm font-bold text-orange-800 dark:text-orange-300 m-0 mb-1">Riesgo Obsolescencia</h5>
                            <p class="text-xs text-orange-600 dark:text-orange-400 m-0 leading-relaxed">3 productos sin movimiento en 90+ días.</p>
                        </div>
                    </div>
                </div>

                <div class="bg-surface-900 dark:bg-surface-0 rounded-3xl p-6 text-white dark:text-surface-900 shadow-xl flex items-center justify-between">
                    <div>
                        <span class="block text-3xl font-black">A+</span>
                        <span class="text-xs opacity-70 uppercase tracking-widest">Score Operativo</span>
                    </div>
                    <div class="text-right">
                        <span class="block text-lg font-bold">94%</span>
                        <span class="text-xs opacity-70">Precisión</span>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <ng-template #noAnalyticsData>
        <div class="flex flex-col items-center justify-center py-24 text-center">
            <div class="w-24 h-24 bg-purple-50 dark:bg-purple-900/20 rounded-full flex items-center justify-center mb-6 border border-purple-100 dark:border-purple-900/30">
                <i class="pi pi-chart-pie text-4xl text-purple-500"></i>
            </div>
            <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Sin Datos Suficientes</h3>
            <p class="text-surface-500 text-base max-w-sm mb-8">
                Registra productos y movimientos para generar el análisis inteligente de tu inventario.
            </p>
            <button (click)="currentView = 'dashboard'" class="px-6 py-3 rounded-xl border border-surface-300 text-surface-600 font-bold hover:bg-surface-50 transition-all">
                Ir al Dashboard
            </button>
        </div>
    </ng-template>

  </div>
</div>

<!-- Vista de Análisis ABC -->
<div *ngIf="currentView === 'abc'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4 relative z-10">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 rounded-3xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-purple-600 dark:text-purple-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi pi-sort-amount-down text-3xl"></i>
            </div>
            
            <div class="flex flex-col">
                <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Matriz ABC
                </h3>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Segmentación de Valor</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-medium text-purple-600 dark:text-purple-400">
                        Pareto 80/20
                    </span>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button pButton label="Recalcular" icon="pi pi-refresh" class="p-button-outlined rounded-xl font-bold text-surface-600 border-surface-300 hover:bg-surface-50"></button>
            <button pButton label="Descargar" icon="pi pi-download" class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-6 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all"></button>
        </div>
    </div>

    <div *ngIf="inventariosFiltrados?.length; else noAbcData">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div *ngFor="let categoria of categoriasABC" 
                 class="relative overflow-hidden rounded-3xl p-6 border transition-all duration-300 group"
                 [ngClass]="{
                    'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/20 dark:border-emerald-800': categoria.categoria === 'A',
                    'bg-amber-50 border-amber-200 dark:bg-amber-900/20 dark:border-amber-800': categoria.categoria === 'B',
                    'bg-red-50 border-red-200 dark:bg-red-900/20 dark:border-red-800': categoria.categoria === 'C'
                 }">
                
                <div class="absolute -right-4 -top-4 w-24 h-24 rounded-full flex items-center justify-center text-4xl font-black opacity-10 pointer-events-none"
                     [ngClass]="{
                        'bg-emerald-500 text-emerald-900': categoria.categoria === 'A',
                        'bg-amber-500 text-amber-900': categoria.categoria === 'B',
                        'bg-red-500 text-red-900': categoria.categoria === 'C'
                     }">
                    {{ categoria.categoria }}
                </div>

                <div class="relative z-10">
                    <h4 class="text-xs font-bold text-surface-500 uppercase tracking-widest mb-1">{{ categoria.label }}</h4>
                    <span class="text-3xl font-bold text-surface-900 dark:text-surface-0 block mb-4">{{ getDatosCategoria(categoria).productos }} <span class="text-sm font-medium text-surface-500">SKUs</span></span>
                    
                    <div class="space-y-2">
                        <div class="flex justify-between text-sm">
                            <span class="text-surface-600 dark:text-surface-400">Valor</span>
                            <span class="font-bold text-surface-900 dark:text-surface-0">S/. {{ getDatosCategoria(categoria).valor | number:'1.0-0' }}</span>
                        </div>
                        <div class="w-full h-1.5 bg-surface-200 dark:bg-surface-700 rounded-full overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000"
                                 [style.width.%]="getDatosCategoria(categoria).porcentaje"
                                 [ngClass]="{
                                    'bg-emerald-500': categoria.categoria === 'A',
                                    'bg-amber-500': categoria.categoria === 'B',
                                    'bg-red-500': categoria.categoria === 'C'
                                 }"></div>
                        </div>
                        <div class="text-right text-xs font-bold" 
                             [ngClass]="{
                                'text-emerald-600': categoria.categoria === 'A',
                                'text-amber-600': categoria.categoria === 'B',
                                'text-red-600': categoria.categoria === 'C'
                             }">
                            {{ getDatosCategoria(categoria).porcentaje | number:'1.0-0' }}% del Total
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            
            <div class="bg-white dark:bg-surface-900 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center">
                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-8 w-full text-left">Distribución de Valor</h4>
                <div class="chart-container relative h-[300px] w-full flex justify-center">
                    <p-chart type="pie" [data]="abcData" [options]="chartOptions" height="300px"></p-chart>
                </div>
            </div>

            <div class="bg-white dark:bg-surface-900 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 shadow-sm">
                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Desglose Estratégico</h4>
                <div class="space-y-4">
                    <div *ngFor="let analisis of calcularEstadisticas().analisisABC" class="bg-surface-50 dark:bg-surface-800 rounded-xl p-4 border border-surface-100 dark:border-surface-700">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-lg flex items-center justify-center text-sm font-bold text-white shadow-sm"
                                     [ngClass]="'bg-' + (analisis.categoria === 'A' ? 'emerald' : (analisis.categoria === 'B' ? 'amber' : 'red')) + '-500'">
                                    {{ analisis.categoria }}
                                </div>
                                <span class="font-bold text-surface-900 dark:text-surface-0">Categoría {{ analisis.categoria }}</span>
                            </div>
                            <span class="text-lg font-bold" [ngClass]="'text-' + (analisis.categoria === 'A' ? 'emerald' : (analisis.categoria === 'B' ? 'amber' : 'red')) + '-600'">
                                {{ analisis.porcentaje | number:'1.0-0' }}%
                            </span>
                        </div>
                        <div class="flex justify-between text-xs text-surface-500 mt-2">
                            <span>{{ analisis.productos }} productos</span>
                            <span class="font-mono">S/. {{ analisis.valor | number:'1.0-0' }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-8">
            <div *ngFor="let categoria of categoriasABC">
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-3 h-8 rounded-full" [style.background-color]="categoria.color"></div>
                    <h4 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0">Productos Clase {{ categoria.categoria }}</h4>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                    <div *ngFor="let inventario of getInventariosPorCategoria(categoria).slice(0, 4)" 
                         class="bg-white dark:bg-surface-900 p-4 rounded-2xl border border-surface-200 dark:border-surface-700 hover:shadow-md hover:border-primary-300 transition-all duration-300 group cursor-pointer"
                         (click)="mostrarDetalle(inventario)">
                        
                        <div class="flex justify-between items-start mb-2">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm" [style.background-color]="categoria.color">
                                {{ categoria.categoria }}
                            </div>
                            <button class="text-surface-400 hover:text-primary-600 transition-colors opacity-0 group-hover:opacity-100">
                                <i class="pi pi-eye"></i>
                            </button>
                        </div>

                        <h5 class="text-sm font-bold text-surface-900 dark:text-surface-0 mb-1 truncate">{{ inventario.producto?.nombre }}</h5>
                        <div class="flex justify-between items-end mt-3">
                            <div class="flex flex-col">
                                <span class="text-[10px] text-surface-400 uppercase">Valor</span>
                                <span class="text-sm font-bold text-emerald-600">S/. {{ inventario.valorTotal | number:'1.0-0' }}</span>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="text-[10px] text-surface-400 uppercase">Stock</span>
                                <span class="text-sm font-bold text-surface-700 dark:text-surface-300">{{ inventario.cantidad }}</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-surface-50 dark:bg-surface-800/50 p-4 rounded-2xl border border-surface-200 dark:border-surface-700 flex flex-col items-center justify-center text-center cursor-pointer hover:bg-surface-100 dark:hover:bg-surface-800 transition-colors">
                        <span class="text-xs font-bold text-surface-500 uppercase tracking-widest">Ver Todos</span>
                        <i class="pi pi-arrow-right text-surface-400 mt-2"></i>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <ng-template #noAbcData>
        <div class="flex flex-col items-center justify-center py-24 text-center">
            <div class="w-24 h-24 bg-purple-50 dark:bg-purple-900/20 rounded-full flex items-center justify-center mb-6 border border-purple-100 dark:border-purple-900/30">
                <i class="pi pi-sort-amount-down text-4xl text-purple-500"></i>
            </div>
            <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Análisis Pendiente</h3>
            <p class="text-surface-500 text-base max-w-sm mb-8">
                No hay datos suficientes para generar la matriz ABC. Registra más productos y movimientos.
            </p>
            <button (click)="currentView = 'dashboard'" class="px-6 py-3 rounded-xl bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 font-bold shadow-lg transition-transform hover:-translate-y-0.5">
                Volver al Dashboard
            </button>
        </div>
    </ng-template>

  </div>
</div>

<!-- Vista de Alertas -->
<div *ngIf="currentView === 'alerts'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 rounded-3xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-rose-600 dark:text-rose-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi pi-exclamation-triangle text-3xl"></i>
            </div>
            
            <div class="flex flex-col">
                <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Centro de Alertas
                </h3>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Diagnóstico de Stock</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-medium text-rose-600 dark:text-rose-400">
                        {{ calcularEstadisticas().alertasCriticas.length }} incidencias
                    </span>
                </div>
            </div>
        </div>

        <div class="flex gap-3">
            <button pButton label="Configurar" icon="pi pi-cog" class="p-button-text text-surface-500 hover:text-surface-900 font-bold rounded-xl"></button>
            <button pButton label="Marcar Todo Leído" icon="pi pi-check-circle" class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-5 rounded-xl font-bold shadow-lg hover:shadow-xl transition-all"></button>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        
        <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-5 border border-surface-200 dark:border-surface-700 flex items-center gap-4 relative overflow-hidden group">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-red-500"></div>
            <div class="w-12 h-12 rounded-2xl bg-white dark:bg-surface-700 flex items-center justify-center text-red-600 shadow-sm">
                <i class="pi pi-times-circle text-xl"></i>
            </div>
            <div>
                <span class="block text-2xl font-bold text-surface-900 dark:text-surface-0">{{ getAlertasBySeverity("high") }}</span>
                <span class="text-xs font-bold text-surface-500 uppercase tracking-wider">Críticas</span>
            </div>
        </div>

        <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-5 border border-surface-200 dark:border-surface-700 flex items-center gap-4 relative overflow-hidden group">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-orange-500"></div>
            <div class="w-12 h-12 rounded-2xl bg-white dark:bg-surface-700 flex items-center justify-center text-orange-600 shadow-sm">
                <i class="pi pi-exclamation-triangle text-xl"></i>
            </div>
            <div>
                <span class="block text-2xl font-bold text-surface-900 dark:text-surface-0">{{ getAlertasBySeverity("medium") }}</span>
                <span class="text-xs font-bold text-surface-500 uppercase tracking-wider">Medias</span>
            </div>
        </div>

        <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-5 border border-surface-200 dark:border-surface-700 flex items-center gap-4 relative overflow-hidden group">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-500"></div>
            <div class="w-12 h-12 rounded-2xl bg-white dark:bg-surface-700 flex items-center justify-center text-blue-600 shadow-sm">
                <i class="pi pi-info-circle text-xl"></i>
            </div>
            <div>
                <span class="block text-2xl font-bold text-surface-900 dark:text-surface-0">{{ getAlertasBySeverity("low") }}</span>
                <span class="text-xs font-bold text-surface-500 uppercase tracking-wider">Info</span>
            </div>
        </div>

        <div class="bg-surface-50 dark:bg-surface-800/50 rounded-3xl p-5 border border-surface-200 dark:border-surface-700 flex items-center gap-4 relative overflow-hidden group">
            <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-emerald-500"></div>
            <div class="w-12 h-12 rounded-2xl bg-white dark:bg-surface-700 flex items-center justify-center text-emerald-600 shadow-sm">
                <i class="pi pi-check-circle text-xl"></i>
            </div>
            <div>
                <span class="block text-2xl font-bold text-surface-900 dark:text-surface-0">
                    {{ (inventariosFiltrados.length - calcularEstadisticas().alertasCriticas.length) > 0 ? (inventariosFiltrados.length - calcularEstadisticas().alertasCriticas.length) : 0 }}
                </span>
                <span class="text-xs font-bold text-surface-500 uppercase tracking-wider">Sanos</span>
            </div>
        </div>
    </div>

    <div *ngIf="calcularEstadisticas().alertasCriticas.length; else noAlertas">
        <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 px-1">Incidencias Activas</h4>
        
        <div class="grid grid-cols-1 gap-4">
            <div *ngFor="let alerta of calcularEstadisticas().alertasCriticas; trackBy: trackByAlerta"
                 class="group bg-white dark:bg-surface-900 rounded-2xl p-5 border transition-all duration-300 hover:shadow-lg hover:border-surface-300 dark:hover:border-surface-600 flex flex-col md:flex-row gap-5 items-start md:items-center relative"
                 [ngClass]="{
                    'border-red-100 dark:border-red-900/30': alerta.severidad === 'high',
                    'border-orange-100 dark:border-orange-900/30': alerta.severidad === 'medium',
                    'border-blue-100 dark:border-blue-900/30': alerta.severidad === 'low'
                 }">
                
                <div class="w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0"
                     [ngClass]="{
                        'bg-red-50 text-red-600': alerta.severidad === 'high',
                        'bg-orange-50 text-orange-600': alerta.severidad === 'medium',
                        'bg-blue-50 text-blue-600': alerta.severidad === 'low'
                     }">
                    <i class="pi text-xl" [ngClass]="{
                        'pi-times-circle': alerta.severidad === 'high',
                        'pi-exclamation-triangle': alerta.severidad === 'medium',
                        'pi-info-circle': alerta.severidad === 'low'
                    }"></i>
                </div>

                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-3 mb-1">
                        <h4 class="text-base font-bold text-surface-900 dark:text-surface-0 m-0 truncate">
                            {{ alerta.producto }}
                        </h4>
                        <span class="text-[10px] px-2 py-0.5 rounded border uppercase font-bold tracking-wider"
                              [ngClass]="{
                                'bg-red-50 border-red-100 text-red-700': alerta.severidad === 'high',
                                'bg-orange-50 border-orange-100 text-orange-700': alerta.severidad === 'medium',
                                'bg-blue-50 border-blue-100 text-blue-700': alerta.severidad === 'low'
                              }">
                            {{ alerta.tipo.replace('_', ' ') }}
                        </span>
                        <span *ngIf="alerta.urgente" class="text-[10px] px-2 py-0.5 rounded bg-red-600 text-white font-bold animate-pulse">URGENTE</span>
                    </div>
                    <p class="text-sm text-surface-600 dark:text-surface-300 m-0 line-clamp-1">
                        {{ alerta.mensaje }}
                    </p>
                    <div class="flex items-center gap-4 mt-2 text-xs text-surface-400">
                        <span class="flex items-center gap-1"><i class="pi pi-clock"></i> {{ alerta.fechaAlerta | date:'dd/MM HH:mm' }}</span>
                        <span class="flex items-center gap-1"><i class="pi pi-bolt"></i> {{ alerta.accionRecomendada }}</span>
                    </div>
                </div>

                <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                    <button pButton icon="pi pi-eye" class="p-button-rounded p-button-text p-button-secondary w-10 h-10" pTooltip="Ver Detalle"></button>
                    <button pButton icon="pi pi-check" class="p-button-rounded p-button-text p-button-success w-10 h-10" pTooltip="Resolver"></button>
                    <button pButton icon="pi pi-times" class="p-button-rounded p-button-text p-button-danger w-10 h-10" pTooltip="Descartar"></button>
                </div>

            </div>
        </div>
    </div>

    <ng-template #noAlertas>
        <div class="flex flex-col items-center justify-center py-24 text-center">
            <div class="w-24 h-24 bg-emerald-50 dark:bg-emerald-900/20 rounded-full flex items-center justify-center mb-6 border border-emerald-100 dark:border-emerald-900/30">
                <i class="pi pi-check-circle text-4xl text-emerald-500"></i>
            </div>
            <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Todo en Orden</h3>
            <p class="text-surface-500 text-base max-w-sm">
                No hay alertas activas en este momento. El sistema de inventario opera con normalidad.
            </p>
            <button 
                (click)="currentView = 'dashboard'"
                class="mt-6 px-6 py-2.5 rounded-xl border border-surface-300 text-surface-600 font-bold hover:bg-surface-50 transition-all flex items-center gap-2">
                <i class="pi pi-chart-pie"></i> Ir al Dashboard
            </button>
        </div>
    </ng-template>

  </div>
</div>

<!-- Modal de Crear/Editar Inventario (Modernizado) -->
<p-dialog
  [(visible)]="inventarioDialog"
  [style]="{ width: '900px', maxWidth: '95vw', height: 'auto', maxHeight: '90vh' }"
  [modal]="true"
  (onHide)="hideDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-white dark:bg-surface-900">
    
    <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700 sticky top-0 z-50">
        <div class="flex items-center gap-5">
            <div class="w-12 h-12 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi" [ngClass]="editMode ? 'pi-pencil' : 'pi-plus'"></i>
            </div>
            
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    {{ editMode ? 'Editar Inventario' : 'Nuevo Ingreso' }}
                </h2>
                <div class="text-sm text-surface-500 dark:text-surface-400 mt-1">
                    {{ editMode ? 'Modificar registro existente' : 'Registrar stock físico' }}
                </div>
            </div>
        </div>

        <button (click)="hideDialog()" class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-50 dark:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors">
            <i class="pi pi-times"></i>
        </button>
    </div>

    <div class="flex-1 overflow-hidden bg-surface-50/30 dark:bg-surface-950">
        <p-tabView [(activeIndex)]="activeTab" styleClass="h-full flex flex-col zen-tabs">
            
            <p-tabPanel header="Datos Principales" leftIcon="pi pi-box">
                <div class="p-8 overflow-y-auto custom-scrollbar h-[calc(80vh-180px)] space-y-8">
                    
                    <div class="bg-white dark:bg-surface-900 p-6 rounded-3xl border border-surface-200 dark:border-surface-700 shadow-sm">
                        <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                            <i class="pi pi-tag text-primary-500"></i> Identificación del Producto
                        </h4>

                        <div *ngIf="!editMode">
                            <label class="text-sm font-bold text-surface-700 dark:text-surface-200 block mb-2">Seleccionar Producto <span class="text-red-500">*</span></label>
                            <p-select
                                [options]="productos"
                                [(ngModel)]="productoSeleccionado"
                                optionLabel="nombre"
                                placeholder="Buscar por nombre o código..."
                                [filter]="true"
                                filterBy="nombre,codigo"
                                [showClear]="true"
                                styleClass="w-full h-14 rounded-xl border-surface-200"
                                [ngClass]="{ 'ng-invalid ng-dirty': submitted && !productoSeleccionado }"
                                (onChange)="loadColoresPorProducto(productoSeleccionado?.id || 0)"
                            >
                                <ng-template let-item pTemplate="item">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-lg bg-surface-100 flex items-center justify-center text-surface-500 font-bold text-xs">
                                            {{ item.codigo | slice:0:3 }}
                                        </div>
                                        <div>
                                            <div class="font-bold text-surface-900">{{ item.nombre }}</div>
                                            <div class="text-xs text-surface-500 font-mono">{{ item.codigo }}</div>
                                        </div>
                                        <div class="ml-auto font-bold text-emerald-600">S/. {{ item.precioVenta }}</div>
                                    </div>
                                </ng-template>
                            </p-select>
                            <small class="text-red-500 text-xs mt-1 block" *ngIf="submitted && !productoSeleccionado">Selección requerida</small>
                        </div>

                        <div *ngIf="editMode && productoSeleccionado" class="flex items-center gap-4 p-4 bg-surface-50 dark:bg-surface-800 rounded-2xl border border-surface-200 dark:border-surface-700">
                            <div class="w-12 h-12 rounded-xl bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600 font-bold text-xl">
                                {{ productoSeleccionado.nombre.charAt(0) }}
                            </div>
                            <div>
                                <span class="block text-lg font-bold text-surface-900 dark:text-surface-0">{{ productoSeleccionado.nombre }}</span>
                                <span class="text-sm text-surface-500 font-mono bg-white dark:bg-surface-900 px-2 py-0.5 rounded border border-surface-200 dark:border-surface-700">{{ productoSeleccionado.codigo }}</span>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="bg-white dark:bg-surface-900 p-6 rounded-3xl border border-surface-200 dark:border-surface-700 shadow-sm space-y-5">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest">Variante</h4>
                            
                            <div>
                                <label class="text-xs font-bold text-surface-500 mb-1.5 block">Color</label>
                                <div *ngIf="!editMode">
                                    <p-select
                                        [options]="colores"
                                        [(ngModel)]="colorSeleccionado"
                                        optionLabel="nombre"
                                        placeholder="Seleccionar Color"
                                        [disabled]="!productoSeleccionado"
                                        styleClass="w-full rounded-xl"
                                        (onChange)="loadTallasPorColor(colorSeleccionado?.id || 0)"
                                    >
                                        <ng-template pTemplate="selectedItem">
                                            <div class="flex items-center gap-2" *ngIf="colorSeleccionado">
                                                <div class="w-4 h-4 rounded-full border shadow-sm" [style.background-color]="colorSeleccionado.codigoHex"></div>
                                                <span>{{ colorSeleccionado.nombre }}</span>
                                            </div>
                                        </ng-template>
                                        <ng-template let-item pTemplate="item">
                                            <div class="flex items-center gap-2">
                                                <div class="w-4 h-4 rounded-full border shadow-sm" [style.background-color]="item.codigoHex"></div>
                                                <span>{{ item.nombre }}</span>
                                            </div>
                                        </ng-template>
                                    </p-select>
                                </div>
                                <div *ngIf="editMode && colorSeleccionado" class="flex items-center gap-2 p-3 bg-surface-50 rounded-xl border border-surface-200">
                                    <div class="w-6 h-6 rounded-full border shadow-sm" [style.background-color]="colorSeleccionado.codigoHex"></div>
                                    <span class="font-bold text-surface-700">{{ colorSeleccionado.nombre }}</span>
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-surface-500 mb-1.5 block">Talla</label>
                                <div *ngIf="!editMode">
                                    <p-select
                                        [options]="tallas"
                                        [(ngModel)]="tallaSeleccionada"
                                        optionLabel="numero"
                                        placeholder="Seleccionar Talla"
                                        [disabled]="!colorSeleccionado"
                                        styleClass="w-full rounded-xl"
                                    ></p-select>
                                </div>
                                <div *ngIf="editMode && tallaSeleccionada" class="p-3 bg-surface-50 rounded-xl border border-surface-200 font-bold text-surface-700 text-center">
                                    Talla {{ tallaSeleccionada.numero }}
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-surface-900 p-6 rounded-3xl border border-surface-200 dark:border-surface-700 shadow-sm space-y-5">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest">Almacén & Stock</h4>
                            
                            <div>
                                <label class="text-xs font-bold text-surface-500 mb-1.5 block">Ubicación</label>
                                <div *ngIf="!editMode">
                                    <p-select
                                        [options]="almacenes"
                                        [(ngModel)]="almacenSeleccionado"
                                        optionLabel="nombre"
                                        placeholder="Seleccionar Almacén"
                                        [disabled]="!productoSeleccionado"
                                        styleClass="w-full rounded-xl"
                                    ></p-select>
                                </div>
                                <div *ngIf="editMode && almacenSeleccionado" class="p-3 bg-surface-50 rounded-xl border border-surface-200 font-bold text-surface-700 flex items-center gap-2">
                                    <i class="pi pi-building text-surface-400"></i>
                                    {{ almacenSeleccionado.nombre }}
                                </div>
                            </div>

                            <div>
                                <label class="text-xs font-bold text-surface-500 mb-1.5 block">Cantidad Física <span class="text-red-500">*</span></label>
                                <p-inputNumber
                                    [(ngModel)]="inventario.cantidad"
                                    [showButtons]="true"
                                    buttonLayout="horizontal"
                                    [min]="0"
                                    incrementButtonIcon="pi pi-plus"
                                    decrementButtonIcon="pi pi-minus"
                                    styleClass="w-full font-bold text-lg"
                                    inputStyleClass="w-full text-center bg-surface-50 dark:bg-surface-800 border-surface-200 dark:border-surface-700 rounded-lg text-surface-900 dark:text-surface-0 h-12"
                                    [ngClass]="{'ng-invalid ng-dirty': submitted && inventario.cantidad < 0}"
                                ></p-inputNumber>
                            </div>
                        </div>

                    </div>

                    <div class="bg-surface-50 dark:bg-surface-800/50 p-4 rounded-2xl border border-surface-200 dark:border-surface-700 flex items-center justify-between">
                        <label class="text-sm font-bold text-surface-700 dark:text-surface-200">Estado del Inventario</label>
                        <p-select
                            [options]="estadosInventario"
                            [(ngModel)]="inventario.estado"
                            optionLabel="label"
                            optionValue="value"
                            styleClass="w-48 rounded-xl"
                        >
                            <ng-template pTemplate="selectedItem">
                                <div class="flex items-center gap-2" *ngIf="inventario.estado">
                                    <div class="w-2 h-2 rounded-full" [ngClass]="'bg-' + getEstadoColor(inventario.estado) + '-500'"></div>
                                    <span class="text-sm font-bold">{{ getEstadoLabel(inventario.estado) }}</span>
                                </div>
                            </ng-template>
                        </p-select>
                    </div>

                </div>
            </p-tabPanel>

            <p-tabPanel header="Finanzas & Control" leftIcon="pi pi-sliders-h">
                <div class="p-8 overflow-y-auto custom-scrollbar h-[calc(80vh-180px)]">
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <div class="bg-white dark:bg-surface-900 p-6 rounded-3xl border border-surface-200 dark:border-surface-700">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <i class="pi pi-wallet text-emerald-500"></i> Estructura de Costos
                            </h4>
                            <div class="space-y-4">
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Costo Unitario</label>
                                    <p-inputNumber [(ngModel)]="inventario.costo" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full" inputStyleClass="w-full rounded-xl bg-surface-50 border-surface-200"></p-inputNumber>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Valor Venta</label>
                                    <p-inputNumber [(ngModel)]="inventario.valorUnitario" mode="currency" currency="PEN" locale="es-PE" styleClass="w-full" inputStyleClass="w-full rounded-xl bg-surface-50 border-surface-200"></p-inputNumber>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Margen Objetivo</label>
                                    <p-inputNumber [(ngModel)]="inventario.margen" suffix="%" [min]="0" [max]="100" styleClass="w-full" inputStyleClass="w-full rounded-xl bg-surface-50 border-surface-200"></p-inputNumber>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-surface-900 p-6 rounded-3xl border border-surface-200 dark:border-surface-700">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <i class="pi pi-shield text-blue-500"></i> Control de Stock
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Mínimo</label>
                                    <p-inputNumber [(ngModel)]="inventario.stockMinimo" [showButtons]="true" [min]="0" styleClass="w-full" inputStyleClass="w-full rounded-xl bg-surface-50 border-surface-200 text-center"></p-inputNumber>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Máximo</label>
                                    <p-inputNumber [(ngModel)]="inventario.stockMaximo" [showButtons]="true" [min]="0" styleClass="w-full" inputStyleClass="w-full rounded-xl bg-surface-50 border-surface-200 text-center"></p-inputNumber>
                                </div>
                                <div class="col-span-2">
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Punto de Reorden</label>
                                    <p-inputNumber [(ngModel)]="inventario.puntoReorden" [showButtons]="true" [min]="0" styleClass="w-full" inputStyleClass="w-full rounded-xl bg-surface-50 border-surface-200 text-center"></p-inputNumber>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-white dark:bg-surface-900 p-6 rounded-3xl border border-surface-200 dark:border-surface-700">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <i class="pi pi-compass text-purple-500"></i> Trazabilidad
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Ubicación Exacta</label>
                                    <input type="text" pInputText [(ngModel)]="inventario.ubicacionAlmacen" placeholder="Pasillo/Estante" class="w-full rounded-xl bg-surface-50 border-surface-200 h-10 px-3 text-sm">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Lote</label>
                                    <input type="text" pInputText [(ngModel)]="inventario.lote" placeholder="LT-XXXX" class="w-full rounded-xl bg-surface-50 border-surface-200 h-10 px-3 text-sm font-mono">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-surface-500 block mb-1">Vencimiento</label>
                                    <p-calendar [(ngModel)]="inventario.fechaVencimiento" [showIcon]="true" styleClass="w-full rounded-xl" inputStyleClass="bg-surface-50 border-surface-200 rounded-l-xl"></p-calendar>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </p-tabPanel>

        </p-tabView>
    </div>

    <div class="px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-700 flex justify-between items-center sticky bottom-0 z-50">
        <div class="flex items-center gap-2 text-xs text-surface-400">
            <i class="pi pi-info-circle"></i> Campos marcados con <span class="text-red-500">*</span> son obligatorios
        </div>
        
        <div class="flex gap-3">
            <button pButton label="Cancelar" class="p-button-text text-surface-500 hover:text-surface-900 font-bold px-6 rounded-xl" (click)="hideDialog()"></button>
            <button *ngIf="!editMode" pButton label="Borrador" icon="pi pi-save" class="p-button-outlined border-surface-300 text-surface-600 font-bold px-6 rounded-xl hover:bg-surface-50" (click)="guardarInventario()"></button>
            <button pButton [label]="editMode ? 'Actualizar' : 'Registrar'" icon="pi pi-check" class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-8 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all" (click)="guardarInventario()" [loading]="loading"></button>
        </div>
    </div>

  </div>
</p-dialog>

<!-- Modal de Detalle de Inventario -->
<p-dialog
  [(visible)]="detalleInventarioDialog"
  [style]="{ width: '1100px', maxWidth: '95vw', height: '90vh' }"
  [modal]="true"
  (onHide)="hideDetalleDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-white dark:bg-surface-900" *ngIf="inventario.id">
    
    <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700 sticky top-0 z-50">
        <div class="flex items-center gap-5">
            <div class="w-16 h-16 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi pi-box text-3xl"></i>
            </div>
            
            <div class="flex flex-col gap-1">
                <h2 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    {{ inventario.producto?.nombre }}
                </h2>
                <div class="flex items-center gap-3">
                    <span class="text-xs font-mono font-bold text-surface-500 bg-surface-100 dark:bg-surface-800 px-2 py-1 rounded border border-surface-200 dark:border-surface-700">
                        {{ inventario.producto?.codigo }}
                    </span>
                    <span class="text-sm text-surface-500 dark:text-surface-400 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-surface-300"></span>
                        Serie: <span class="font-mono text-surface-700 dark:text-surface-300">{{ inventario.serie }}</span>
                    </span>
                </div>
            </div>
        </div>

        <div class="flex flex-col items-end border-l border-surface-100 dark:border-surface-800 pl-6">
            <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-1">Disponible</span>
            <div class="flex items-center gap-3">
                <span class="text-4xl font-bold text-surface-900 dark:text-surface-0 leading-none tracking-tight">
                    {{ inventario.cantidad }}
                </span>
                <div class="px-3 py-1 rounded-lg text-xs font-bold border flex items-center gap-2"
                      [ngClass]="{
                        'bg-emerald-50 text-emerald-700 border-emerald-100': getStockLevel(inventario) === 'good',
                        'bg-amber-50 text-amber-700 border-amber-100': getStockLevel(inventario) === 'low',
                        'bg-red-50 text-red-700 border-red-100': getStockLevel(inventario) === 'critical'
                      }">
                    <i class="pi" [ngClass]="{
                        'pi-check-circle': getStockLevel(inventario) === 'good',
                        'pi-exclamation-circle': getStockLevel(inventario) === 'low',
                        'pi-times-circle': getStockLevel(inventario) === 'critical'
                    }"></i>
                    {{ getStockLevel(inventario) | uppercase }}
                </div>
            </div>
        </div>

        <button (click)="hideDetalleDialog()" class="absolute top-6 right-6 md:static md:ml-4 w-10 h-10 flex items-center justify-center rounded-full bg-surface-50 dark:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors hover:shadow-sm">
            <i class="pi pi-times"></i>
        </button>
    </div>

    <div class="flex-1 overflow-hidden bg-surface-50/50 dark:bg-surface-950">
        <p-tabView styleClass="h-full flex flex-col zen-tabs">
            
            <p-tabPanel header="General" leftIcon="pi pi-info-circle">
                <div class="p-8 overflow-y-auto custom-scrollbar h-[calc(90vh-180px)]">
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        
                        <div class="space-y-6">
                            <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm">
                                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                                    <i class="pi pi-map-marker text-lg text-primary-500"></i> Localización
                                </h4>
                                
                                <div class="space-y-4">
                                    <div class="flex flex-col">
                                        <span class="text-xs text-surface-500 font-medium mb-1">Almacén</span>
                                        <span class="text-base font-bold text-surface-900 dark:text-surface-0">{{ inventario.almacen?.nombre }}</span>
                                    </div>
                                    <div class="w-full h-px bg-surface-100 dark:bg-surface-800"></div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-surface-500 font-medium mb-1">Ubicación Exacta</span>
                                        <span class="text-sm font-medium text-surface-700 dark:text-surface-200">{{ inventario.ubicacionAlmacen || 'General' }}</span>
                                    </div>
                                    <div class="w-full h-px bg-surface-100 dark:bg-surface-800"></div>
                                    <div class="flex flex-col">
                                        <span class="text-xs text-surface-500 font-medium mb-1">Lote de Compra</span>
                                        <span class="font-mono text-sm font-bold text-surface-600 dark:text-surface-300 bg-surface-50 dark:bg-surface-800 px-2 py-1 rounded w-fit">
                                            {{ inventario.lote || 'N/A' }}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm">
                                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-4">Especificaciones</h4>
                                <div class="flex items-center justify-between p-3 rounded-xl bg-surface-50 dark:bg-surface-800 border border-surface-100 dark:border-surface-700">
                                    <div class="flex items-center gap-3">
                                        <div class="w-6 h-6 rounded-full border shadow-sm" [style.background-color]="inventario.color?.codigoHex || '#ccc'"></div>
                                        <span class="text-sm font-bold text-surface-700 dark:text-surface-200">{{ inventario.color?.nombre }}</span>
                                    </div>
                                    <span class="text-xs font-bold text-surface-500 border-l border-surface-200 pl-3">
                                        Talla {{ inventario.talla?.numero }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-surface-900 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col items-center justify-center relative overflow-hidden">
                            <div class="absolute top-0 w-full h-2 bg-gradient-to-r"
                                 [ngClass]="{
                                    'from-emerald-400 to-emerald-600': getStockLevel(inventario) === 'good',
                                    'from-amber-400 to-amber-600': getStockLevel(inventario) === 'low',
                                    'from-red-400 to-red-600': getStockLevel(inventario) === 'critical'
                                 }"></div>

                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-8">Nivel de Inventario</h4>
                            
                            <div class="relative mb-8 scale-110">
                                <p-knob 
                                    [ngModel]="getStockPercentage(inventario)" 
                                    [size]="160" 
                                    [readonly]="true" 
                                    valueTemplate="{value}%" 
                                    [strokeWidth]="6"
                                    [rangeColor]="'var(--surface-100)'"
                                    [valueColor]="getStockColorHex(inventario)"
                                    textColor="var(--text-color)"
                                ></p-knob>
                                <i class="pi pi-database absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-surface-300 -z-10 text-6xl opacity-20"></i>
                            </div>

                            <div class="w-full grid grid-cols-2 gap-4">
                                <div class="p-3 rounded-2xl bg-surface-50 dark:bg-surface-800 text-center border border-surface-100 dark:border-surface-700">
                                    <span class="block text-[10px] text-surface-400 uppercase font-bold mb-1">Mínimo</span>
                                    <span class="text-lg font-bold text-surface-700 dark:text-surface-200">{{ inventario.stockMinimo || 0 }}</span>
                                </div>
                                <div class="p-3 rounded-2xl bg-surface-50 dark:bg-surface-800 text-center border border-surface-100 dark:border-surface-700">
                                    <span class="block text-[10px] text-surface-400 uppercase font-bold mb-1">Máximo</span>
                                    <span class="text-lg font-bold text-surface-700 dark:text-surface-200">{{ inventario.stockMaximo || '∞' }}</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6 flex items-center gap-2">
                                <i class="pi pi-wallet text-lg text-emerald-500"></i> Valorización
                            </h4>
                            
                            <div class="flex-1 flex flex-col justify-center space-y-0 divide-y divide-surface-100 dark:divide-surface-800">
                                <div class="py-4 flex justify-between items-center">
                                    <span class="text-sm text-surface-500">Costo Unitario</span>
                                    <span class="font-bold text-surface-900 dark:text-surface-0">S/. {{ inventario.costo || 0 | number:'1.2-2' }}</span>
                                </div>
                                <div class="py-4 flex justify-between items-center">
                                    <span class="text-sm text-surface-500">Precio Venta</span>
                                    <span class="font-bold text-blue-600">S/. {{ inventario.valorUnitario | number:'1.2-2' }}</span>
                                </div>
                                <div class="py-6 flex justify-between items-center bg-surface-50/50 dark:bg-surface-800/30 -mx-6 px-6 my-2">
                                    <span class="text-sm font-bold text-surface-600 dark:text-surface-300">Valor Total Stock</span>
                                    <span class="text-2xl font-bold text-emerald-600">S/. {{ inventario.valorTotal | number:'1.2-2' }}</span>
                                </div>
                                <div class="py-4 flex justify-between items-center">
                                    <span class="text-sm text-surface-500">Margen</span>
                                    <span class="px-2 py-1 rounded bg-purple-50 text-purple-700 text-xs font-bold border border-purple-100">
                                        {{ inventario.margen | number:'1.1-1' }}%
                                    </span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </p-tabPanel>

            <p-tabPanel header="Historial" leftIcon="pi pi-history">
                <div class="p-8 overflow-y-auto custom-scrollbar h-[calc(90vh-180px)]">
                    
                    <div *ngIf="inventario.movimientos?.length; else noMovimientos" class="max-w-4xl mx-auto">
                        <div class="relative pl-8 border-l border-surface-200 dark:border-surface-700 space-y-8">
                            
                            <div *ngFor="let mov of inventario.movimientos" class="relative group">
                                <div class="absolute -left-[37px] top-1.5 h-4 w-4 rounded-full border-2 bg-white dark:bg-surface-900 z-10 transition-colors duration-300"
                                     [ngClass]="{
                                        'border-emerald-500 group-hover:bg-emerald-500': mov.tipo === 'ENTRADA',
                                        'border-red-500 group-hover:bg-red-500': mov.tipo === 'SALIDA',
                                        'border-amber-500 group-hover:bg-amber-500': mov.tipo === 'AJUSTE'
                                     }"></div>

                                <div class="bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-700 p-4 hover:shadow-md transition-all duration-300 group-hover:border-surface-300">
                                    <div class="flex justify-between items-start">
                                        <div class="flex flex-col">
                                            <div class="flex items-center gap-3 mb-1">
                                                <span class="text-xs font-bold uppercase tracking-wider" 
                                                      [ngClass]="{
                                                        'text-emerald-600': mov.tipo === 'ENTRADA',
                                                        'text-red-600': mov.tipo === 'SALIDA',
                                                        'text-amber-600': mov.tipo === 'AJUSTE'
                                                      }">
                                                    {{ mov.tipo }}
                                                </span>
                                                <span class="text-xs text-surface-400 font-mono">{{ mov.fechaMovimiento | date:'dd/MM/yyyy HH:mm' }}</span>
                                            </div>
                                            <p class="text-sm text-surface-700 dark:text-surface-200 font-medium m-0">
                                                {{ mov.descripcion || 'Movimiento de inventario registrado' }}
                                            </p>
                                            <span class="text-xs text-surface-400 mt-2 flex items-center gap-1">
                                                <i class="pi pi-user text-[10px]"></i> {{ mov.usuario }}
                                            </span>
                                        </div>

                                        <div class="flex flex-col items-end">
                                            <span class="text-lg font-bold font-mono"
                                                  [ngClass]="mov.tipo === 'ENTRADA' ? 'text-emerald-600' : (mov.tipo === 'SALIDA' ? 'text-red-600' : 'text-surface-600')">
                                                {{ mov.tipo === 'ENTRADA' ? '+' : (mov.tipo === 'SALIDA' ? '-' : '') }}{{ mov.cantidad }}
                                            </span>
                                            <span class="text-[10px] text-surface-400 uppercase">Unidades</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>

                    <ng-template #noMovimientos>
                        <div class="flex flex-col items-center justify-center h-64 text-center">
                            <div class="w-20 h-20 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-4 text-surface-300 border border-surface-100">
                                <i class="pi pi-history text-3xl"></i>
                            </div>
                            <h4 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0">Sin historial</h4>
                            <span class="text-surface-500 text-sm">No se han registrado movimientos aún.</span>
                        </div>
                    </ng-template>

                </div>
            </p-tabPanel>

        </p-tabView>
    </div>

    <div class="flex justify-between items-center px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-700 sticky bottom-0 z-50">
        <div class="text-xs text-surface-500 font-medium flex items-center gap-2">
            <i class="pi pi-shield-check text-emerald-500"></i> Registro Auditado
        </div>
        <div class="flex gap-3">
            <button pButton label="Cerrar" class="p-button-text text-surface-600 dark:text-surface-300 font-bold" (click)="hideDetalleDialog()"></button>
            <button *appHasPermission="{ module: 'inventario', permission: permissionTypes.EDIT }" 
                    pButton 
                    label="Ajustar Stock" 
                    icon="pi pi-sliders-h" 
                    class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-6 rounded-xl font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all" 
                    (click)="editInventario(inventario); hideDetalleDialog()">
            </button>
        </div>
    </div>

  </div>
</p-dialog>

<!-- Modal de Estadísticas Avanzadas -->
<p-dialog
  [(visible)]="estadisticasDialog"
  [style]="{ width: '1300px', maxWidth: '98vw', height: '90vh' }"
  [modal]="true"
  (onHide)="hideEstadisticasDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-surface-50 dark:bg-surface-950">
    
    <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700 sticky top-0 z-50">
        <div class="flex items-center gap-5">
            <div class="w-14 h-14 rounded-2xl bg-surface-100 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-200 dark:border-surface-700 shadow-inner">
                <i class="pi pi-chart-line text-2xl"></i>
            </div>
            
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Inteligencia de Inventario
                </h2>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Análisis Financiero & Operativo</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-mono text-xs bg-surface-100 dark:bg-surface-800 px-2 py-0.5 rounded text-surface-600 dark:text-surface-300">
                        Updated: {{ currentDate | date:'HH:mm' }}
                    </span>
                </div>
            </div>
        </div>

        <button (click)="hideEstadisticasDialog()" class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors">
            <i class="pi pi-times"></i>
        </button>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col">
        
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 px-8 pt-8 pb-6 bg-surface-50 dark:bg-surface-950 z-30">
            <div class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-2">Valor Total</span>
                <span class="text-2xl font-bold text-surface-900 dark:text-surface-0">S/. {{ calcularEstadisticas().valorTotalInventario | number:'1.0-0' }}</span>
                <div class="mt-auto pt-2 flex items-center gap-1 text-xs font-bold text-emerald-600">
                    <i class="pi pi-arrow-up text-[10px]"></i> +12% vs mes anterior
                </div>
            </div>
            <div class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-2">Productos Únicos</span>
                <span class="text-2xl font-bold text-surface-900 dark:text-surface-0">{{ calcularEstadisticas().totalProductos }}</span>
                <div class="mt-auto pt-2 flex items-center gap-1 text-xs font-bold text-blue-600">
                    <i class="pi pi-arrow-up text-[10px]"></i> +5% crecimiento
                </div>
            </div>
            <div class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-2">Rotación Prom.</span>
                <span class="text-2xl font-bold text-surface-900 dark:text-surface-0">{{ calcularEstadisticas().rotacionPromedio | number:'1.1-1' }}x</span>
                <div class="mt-auto pt-2 flex items-center gap-1 text-xs font-bold text-purple-600">
                    <i class="pi pi-bolt text-[10px]"></i> Alta velocidad
                </div>
            </div>
            <div class="bg-white dark:bg-surface-900 p-5 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col">
                <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-2">Eficiencia Stock</span>
                <span class="text-2xl font-bold text-surface-900 dark:text-surface-0">{{ calcularEstadisticas().eficienciaStock | number:'1.0-0' }}%</span>
                <div class="w-full h-1.5 bg-surface-100 rounded-full mt-auto">
                    <div class="bg-orange-500 h-1.5 rounded-full" [style.width.%]="calcularEstadisticas().eficienciaStock"></div>
                </div>
            </div>
        </div>

        <p-tabView styleClass="flex-1 flex flex-col h-full zen-tabs">
            
            <p-tabPanel header="Operaciones" leftIcon="pi pi-chart-pie">
                <div class="p-8 overflow-y-auto custom-scrollbar h-[calc(65vh)]">
                    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                        
                        <div class="lg:col-span-8 grid grid-cols-1 md:grid-cols-2 gap-8 h-fit">
                            <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700">
                                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Distribución por Estado</h4>
                                <div class="flex justify-center h-[250px]">
                                    <p-chart type="doughnut" [data]="chartData" [options]="chartOptions" width="220" height="220"></p-chart>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700">
                                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Tendencia de Stock</h4>
                                <div class="h-[250px]">
                                    <p-chart type="line" [data]="trendData" [options]="chartOptions" height="250"></p-chart>
                                </div>
                            </div>
                            <div class="md:col-span-2 bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700">
                                <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Top 10 Productos por Valor</h4>
                                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    <div *ngFor="let inventario of inventariosFiltrados.slice(0, 8); let i = index" 
                                         class="flex items-center justify-between p-3 rounded-xl bg-surface-50 dark:bg-surface-800 border border-surface-100 dark:border-surface-700">
                                        <div class="flex items-center gap-3">
                                            <div class="w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold text-surface-600 bg-surface-200">
                                                {{ i + 1 }}
                                            </div>
                                            <div>
                                                <span class="block text-sm font-bold text-surface-900 dark:text-surface-0">{{ inventario.producto?.nombre }}</span>
                                                <span class="text-[10px] text-surface-500">Talla {{ inventario.talla?.numero }}</span>
                                            </div>
                                        </div>
                                        <span class="text-sm font-bold text-emerald-600">S/. {{ inventario.valorTotal | number:'1.0-0' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-4 space-y-6 h-fit">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest px-1">Atención Requerida</h4>
                            
                            <div class="bg-red-50 dark:bg-red-900/10 rounded-3xl p-6 border border-red-100 dark:border-red-900/30">
                                <div class="flex items-center gap-3 mb-4 text-red-700 dark:text-red-400">
                                    <i class="pi pi-times-circle text-xl"></i>
                                    <span class="font-bold">Agotados</span>
                                </div>
                                <span class="text-4xl font-bold text-red-600 dark:text-red-500 block mb-1">{{ calcularEstadisticas().productosAgotados }}</span>
                                <span class="text-xs text-red-600/70 font-medium">Requieren reposición inmediata</span>
                            </div>

                            <div class="bg-orange-50 dark:bg-orange-900/10 rounded-3xl p-6 border border-orange-100 dark:border-orange-900/30">
                                <div class="flex items-center gap-3 mb-4 text-orange-700 dark:text-orange-400">
                                    <i class="pi pi-exclamation-triangle text-xl"></i>
                                    <span class="font-bold">Stock Crítico</span>
                                </div>
                                <span class="text-4xl font-bold text-orange-600 dark:text-orange-500 block mb-1">{{ calcularEstadisticas().stockCritico }}</span>
                                <span class="text-xs text-orange-600/70 font-medium">Por debajo del mínimo</span>
                            </div>

                            <div class="bg-blue-50 dark:bg-blue-900/10 rounded-3xl p-6 border border-blue-100 dark:border-blue-900/30">
                                <div class="flex items-center gap-3 mb-4 text-blue-700 dark:text-blue-400">
                                    <i class="pi pi-info-circle text-xl"></i>
                                    <span class="font-bold">Valor en Riesgo</span>
                                </div>
                                <span class="text-3xl font-bold text-blue-600 dark:text-blue-500 block mb-1">S/. {{ calcularEstadisticas().valorEnRiesgo | number:'1.0-0' }}</span>
                                <span class="text-xs text-blue-600/70 font-medium">Productos sin movimiento > 90 días</span>
                            </div>
                        </div>

                    </div>
                </div>
            </p-tabPanel>

            <p-tabPanel header="Finanzas" leftIcon="pi pi-wallet">
                <div class="p-8 overflow-y-auto custom-scrollbar h-[calc(65vh)]">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <div class="bg-white dark:bg-surface-900 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 text-center">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Valor Total Inventario</h4>
                            <div class="text-5xl font-bold text-emerald-600 mb-2">S/. {{ calcularEstadisticas().valorTotalInventario | number:'1.0-0' }}</div>
                            
                            <div class="grid grid-cols-2 gap-4 mt-8 pt-8 border-t border-surface-100 dark:border-surface-800">
                                <div>
                                    <span class="block text-2xl font-bold text-surface-900 dark:text-surface-0">S/. {{ calcularEstadisticas().valorTotalInventario * 0.7 | number:'1.0-0' }}</span>
                                    <span class="text-xs font-bold text-surface-400 uppercase">Costo Total</span>
                                </div>
                                <div>
                                    <span class="block text-2xl font-bold text-purple-600">S/. {{ calcularEstadisticas().valorTotalInventario * 0.3 | number:'1.0-0' }}</span>
                                    <span class="text-xs font-bold text-surface-400 uppercase">Margen Potencial</span>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white dark:bg-surface-900 rounded-3xl p-6 border border-surface-200 dark:border-surface-700">
                            <h4 class="text-xs font-bold text-surface-400 uppercase tracking-widest mb-6">Top Rentabilidad</h4>
                            <div class="space-y-4">
                                <div *ngFor="let inventario of inventariosFiltrados.slice(0, 5)" class="bg-surface-50 dark:bg-surface-800 rounded-xl p-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold text-sm text-surface-900 dark:text-surface-0">{{ inventario.producto?.nombre }}</span>
                                        <span class="font-bold text-emerald-600 text-sm">S/. {{ inventario.valorTotal | number:'1.0-0' }}</span>
                                    </div>
                                    <div class="w-full bg-surface-200 dark:bg-surface-700 rounded-full h-1.5">
                                        <div class="h-full bg-emerald-500 rounded-full" [style.width.%]="calculateWidthPercentage(inventario.margen || 25, 100)"></div>
                                    </div>
                                    <div class="flex justify-between mt-1.5">
                                        <span class="text-[10px] text-surface-500">Margen: {{ inventario.margen || 25 }}%</span>
                                        <span class="text-[10px] text-surface-500">Stock: {{ inventario.cantidad }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="lg:col-span-2 bg-indigo-50 dark:bg-indigo-900/10 rounded-3xl p-8 border border-indigo-100 dark:border-indigo-900/30 flex flex-col md:flex-row items-center justify-between gap-8">
                            <div class="text-center md:text-left">
                                <h4 class="text-lg font-bold text-indigo-900 dark:text-indigo-300 m-0">Proyección de Crecimiento</h4>
                                <p class="text-sm text-indigo-700 dark:text-indigo-400 mt-1 opacity-80">Estimación basada en histórico anual</p>
                            </div>
                            <div class="flex gap-12">
                                <div class="text-center">
                                    <span class="block text-3xl font-bold text-indigo-600 dark:text-indigo-400">+3.2%</span>
                                    <span class="text-[10px] font-bold uppercase tracking-widest text-indigo-400 dark:text-indigo-300/60">Q3</span>
                                </div>
                                <div class="text-center">
                                    <span class="block text-3xl font-bold text-indigo-600 dark:text-indigo-400">+6.8%</span>
                                    <span class="text-[10px] font-bold uppercase tracking-widest text-indigo-400 dark:text-indigo-300/60">Semestre</span>
                                </div>
                                <div class="text-center">
                                    <span class="block text-3xl font-bold text-indigo-600 dark:text-indigo-400">+12.5%</span>
                                    <span class="text-[10px] font-bold uppercase tracking-widest text-indigo-400 dark:text-indigo-300/60">Anual</span>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </p-tabPanel>

            <p-tabPanel header="Reportes" leftIcon="pi pi-file">
                <div class="p-8 h-[calc(65vh)] flex items-center justify-center">
                    <div class="max-w-2xl w-full bg-white dark:bg-surface-900 rounded-3xl p-8 border border-surface-200 dark:border-surface-700 shadow-sm text-center">
                        <div class="w-16 h-16 bg-surface-100 dark:bg-surface-800 rounded-2xl flex items-center justify-center mx-auto mb-6 text-surface-400">
                            <i class="pi pi-file-pdf text-3xl"></i>
                        </div>
                        <h4 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Generador de Reportes</h4>
                        <p class="text-surface-500 mb-8">Selecciona el tipo de informe y el formato de salida.</p>
                        
                        <div class="grid grid-cols-2 gap-4 mb-8 text-left">
                            <div>
                                <label class="text-xs font-bold text-surface-500 uppercase block mb-2">Tipo</label>
                                <p-dropdown [options]="[{label:'Resumen Ejecutivo', value:'exec'}]" styleClass="w-full rounded-xl"></p-dropdown>
                            </div>
                            <div>
                                <label class="text-xs font-bold text-surface-500 uppercase block mb-2">Formato</label>
                                <div class="flex gap-2">
                                    <button class="flex-1 py-2.5 rounded-xl border border-surface-300 text-sm font-bold hover:bg-surface-50">PDF</button>
                                    <button class="flex-1 py-2.5 rounded-xl border border-surface-300 text-sm font-bold hover:bg-surface-50">Excel</button>
                                </div>
                            </div>
                        </div>

                        <button pButton label="Generar Descarga" icon="pi pi-download" class="w-full rounded-xl font-bold"></button>
                    </div>
                </div>
            </p-tabPanel>

        </p-tabView>
    </div>

    <div class="flex justify-between items-center px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-700 sticky bottom-0 z-50">
        <div class="text-xs text-surface-500 font-medium">
            <i class="pi pi-database mr-1"></i> Data Warehouse v2.4
        </div>
        <div class="flex gap-3">
            <button pButton label="Cerrar" class="p-button-text text-surface-600 dark:text-surface-300 font-bold" (click)="hideEstadisticasDialog()"></button>
            <button pButton label="Actualizar" icon="pi pi-refresh" class="p-button-outlined rounded-xl font-bold text-surface-600 border-surface-300" (click)="updateChartData()"></button>
        </div>
    </div>

  </div>
</p-dialog>

<!-- Modal de Alertas del Sistema -->
<p-dialog
  [(visible)]="alertasDialog"
  [style]="{ width: '900px', maxWidth: '95vw', height: '90vh' }"
  [modal]="true"
  (onHide)="hideAlertasDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-white dark:bg-surface-900">
    
    <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700 sticky top-0 z-50">
        <div class="flex items-center gap-5">
            <div class="w-14 h-14 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-red-600 dark:text-red-400 border border-surface-200 dark:border-surface-700 shadow-inner relative">
                <i class="pi pi-bell text-2xl" [class.animate-swing]="calcularEstadisticas().alertasCriticas.length > 0"></i>
                <span *ngIf="calcularEstadisticas().alertasCriticas.length > 0" class="absolute -top-1 -right-1 flex h-4 w-4">
                  <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                  <span class="relative inline-flex rounded-full h-4 w-4 bg-red-500"></span>
                </span>
            </div>
            
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Centro de Alertas
                </h2>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Monitoreo en Tiempo Real</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-medium" [ngClass]="calcularEstadisticas().alertasCriticas.length > 0 ? 'text-red-600' : 'text-emerald-600'">
                        {{ calcularEstadisticas().alertasCriticas.length }} Activas
                    </span>
                </div>
            </div>
        </div>

        <button (click)="hideAlertasDialog()" class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors hover:shadow-sm">
            <i class="pi pi-times"></i>
        </button>
    </div>

    <div class="flex-1 overflow-hidden flex flex-col bg-surface-50/30 dark:bg-surface-950">
        
        <div class="px-8 py-4 border-b border-surface-100 dark:border-surface-800 bg-white/80 dark:bg-surface-900/80 backdrop-blur-md flex flex-wrap items-center gap-4 sticky top-0 z-40">
            
            <div class="flex items-center gap-2 bg-surface-50 dark:bg-surface-800 p-1 rounded-xl border border-surface-200 dark:border-surface-700">
                <span class="text-xs font-bold text-surface-500 px-2 uppercase tracking-wide">Severidad</span>
                <p-selectButton
                    [options]="[
                      { label: 'Todas', value: 'all' },
                      { label: 'Críticas', value: 'high' },
                      { label: 'Medias', value: 'medium' }
                    ]"
                    optionLabel="label"
                    optionValue="value"
                    [(ngModel)]="selectedFilter"
                    styleClass="compact-select-button"
                ></p-selectButton>
            </div>

            <p-dropdown 
                [options]="[
                  { label: 'Todos los tipos', value: 'all' },
                  { label: 'Stock Crítico', value: 'STOCK_CRITICO' },
                  { label: 'Agotado', value: 'AGOTADO' }
                ]" 
                optionLabel="label" 
                optionValue="value"
                placeholder="Tipo de incidente"
                styleClass="text-sm rounded-xl h-10 border-surface-200"
            ></p-dropdown>

            <div class="ml-auto">
                <button pButton label="Marcar todo leído" icon="pi pi-check-circle" class="p-button-text p-button-sm text-surface-500 hover:text-emerald-600 font-bold"></button>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
            
            <div *ngIf="calcularEstadisticas().alertasCriticas.length; else noAlertas" class="space-y-4">
                
                <div *ngFor="let alerta of calcularEstadisticas().alertasCriticas; trackBy: trackByAlerta"
                     class="group relative bg-white dark:bg-surface-900 rounded-2xl p-5 border transition-all duration-300 hover:shadow-lg flex gap-5 overflow-hidden"
                     [ngClass]="{
                        'border-red-200 bg-red-50/10 dark:border-red-900/50': alerta.severidad === 'high',
                        'border-orange-200 bg-orange-50/10 dark:border-orange-900/50': alerta.severidad === 'medium',
                        'border-blue-200 bg-blue-50/10 dark:border-blue-900/50': alerta.severidad === 'low'
                     }">
                    
                    <div class="absolute left-0 top-0 bottom-0 w-1.5" 
                         [ngClass]="{
                            'bg-red-500': alerta.severidad === 'high',
                            'bg-orange-500': alerta.severidad === 'medium',
                            'bg-blue-500': alerta.severidad === 'low'
                         }"></div>

                    <div class="flex-shrink-0 mt-1">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center border shadow-sm"
                             [ngClass]="{
                                'bg-red-50 text-red-600 border-red-100': alerta.severidad === 'high',
                                'bg-orange-50 text-orange-600 border-orange-100': alerta.severidad === 'medium',
                                'bg-blue-50 text-blue-600 border-blue-100': alerta.severidad === 'low'
                             }">
                            <i [ngClass]="{
                                'pi-times-circle': alerta.severidad === 'high',
                                'pi-exclamation-triangle': alerta.severidad === 'medium',
                                'pi-info-circle': alerta.severidad === 'low'
                            }" class="pi text-lg"></i>
                        </div>
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1">
                            <div class="flex items-center gap-2">
                                <h4 class="text-base font-bold text-surface-900 dark:text-surface-0 m-0">{{ alerta.producto }}</h4>
                                <span class="text-[10px] px-2 py-0.5 rounded border uppercase font-bold tracking-wider"
                                      [ngClass]="{
                                        'bg-red-100 text-red-700 border-red-200': alerta.severidad === 'high',
                                        'bg-orange-100 text-orange-700 border-orange-200': alerta.severidad === 'medium',
                                        'bg-blue-100 text-blue-700 border-blue-200': alerta.severidad === 'low'
                                      }">
                                    {{ alerta.tipo.replace('_', ' ') }}
                                </span>
                            </div>
                            <span class="text-xs text-surface-400 font-mono">{{ alerta.fechaAlerta | date:'HH:mm' }}</span>
                        </div>
                        
                        <p class="text-sm text-surface-600 dark:text-surface-300 leading-relaxed mb-3">
                            {{ alerta.mensaje }}
                        </p>

                        <div class="bg-surface-50 dark:bg-surface-800 rounded-lg p-3 border border-surface-100 dark:border-surface-700 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <i class="pi pi-bolt text-amber-500 text-xs"></i>
                                <span class="text-xs font-medium text-surface-700 dark:text-surface-200">Recomendación: <span class="font-normal text-surface-500">{{ alerta.accionRecomendada }}</span></span>
                            </div>
                            <button class="text-xs font-bold text-primary-600 hover:text-primary-800 transition-colors">Ejecutar</button>
                        </div>
                    </div>

                    <div class="flex flex-col gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-2 group-hover:translate-x-0">
                        <button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-surface-100 text-surface-400 hover:text-surface-900 transition-colors" pTooltip="Ver Detalle">
                            <i class="pi pi-eye"></i>
                        </button>
                        <button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-emerald-50 text-surface-400 hover:text-emerald-600 transition-colors" pTooltip="Resolver">
                            <i class="pi pi-check"></i>
                        </button>
                        <button class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-50 text-surface-400 hover:text-red-600 transition-colors" pTooltip="Descartar">
                            <i class="pi pi-trash"></i>
                        </button>
                    </div>

                </div>

            </div>

            <ng-template #noAlertas>
                <div class="flex flex-col items-center justify-center h-full text-center py-20">
                    <div class="w-24 h-24 bg-emerald-50 dark:bg-emerald-900/20 rounded-full flex items-center justify-center mb-6 border border-emerald-100 dark:border-emerald-900/30">
                        <i class="pi pi-check-circle text-4xl text-emerald-500"></i>
                    </div>
                    <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Todo en Orden</h3>
                    <p class="text-surface-500 text-base max-w-sm">
                        No hay alertas activas en este momento. El sistema opera con normalidad.
                    </p>
                    <button pButton label="Ver Historial" icon="pi pi-history" class="p-button-outlined rounded-xl mt-6 font-bold text-surface-600 border-surface-300"></button>
                </div>
            </ng-template>

        </div>
    </div>

    <div class="flex justify-between items-center px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-700 sticky bottom-0 z-50">
        <div class="text-xs text-surface-500 font-medium">
            <i class="pi pi-sync mr-1 animate-spin"></i> Monitoreo Activo
        </div>
        <div class="flex gap-3">
            <button pButton label="Configuración" icon="pi pi-cog" class="p-button-text text-surface-600 font-bold" (click)="configurarAlertas()"></button>
            <button pButton label="Cerrar" class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-6 rounded-xl font-bold shadow-sm" (click)="hideAlertasDialog()"></button>
        </div>
    </div>

  </div>
</p-dialog>


<!-- Modal de Análisis ABC Detallado -->
<p-dialog
  [(visible)]="analisisAbcDialog"
  [style]="{ width: '1300px', maxWidth: '98vw', height: '90vh' }"
  [modal]="true"
  (onHide)="hideAnalisisAbcDialog()"
  [maximizable]="true"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [contentStyle]="{ padding: '0', borderRadius: '1.5rem', overflow: 'hidden' }"
  styleClass="app-dialog-zen"
>
  <div class="flex flex-col h-full bg-surface-50 dark:bg-surface-950">
    
    <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700 sticky top-0 z-50">
        <div class="flex items-center gap-5">
            <div class="w-14 h-14 rounded-2xl bg-surface-100 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-200 dark:border-surface-700">
                <i class="pi pi-sort-amount-down text-2xl"></i>
            </div>
            
            <div class="flex flex-col">
                <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight leading-none">
                    Clasificación ABC
                </h2>
                <div class="flex items-center gap-2 mt-1.5 text-sm text-surface-500 dark:text-surface-400">
                    <span>Análisis de Pareto</span>
                    <span class="w-1 h-1 rounded-full bg-surface-400"></span>
                    <span class="font-medium text-surface-900 dark:text-surface-0">
                        {{ inventariosFiltrados.length }} SKUs
                    </span>
                </div>
            </div>
        </div>

        <button (click)="hideAnalisisAbcDialog()" class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 border border-surface-200 dark:border-surface-700 transition-colors">
            <i class="pi pi-times"></i>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto custom-scrollbar p-8">
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            
            <div *ngFor="let categoria of categoriasABC" 
                 class="rounded-3xl p-6 border transition-colors group"
                 [ngClass]="{
                    'bg-emerald-50 border-emerald-200 dark:bg-emerald-900/30 dark:border-emerald-800': categoria.categoria === 'A',
                    'bg-amber-50 border-amber-200 dark:bg-amber-900/30 dark:border-amber-800': categoria.categoria === 'B',
                    'bg-red-50 border-red-200 dark:bg-red-900/30 dark:border-red-800': categoria.categoria === 'C'
                 }">
                
                <div class="flex justify-between items-start mb-6">
                    <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold border"
                         [ngClass]="{
                            'bg-white text-emerald-700 border-emerald-100': categoria.categoria === 'A',
                            'bg-white text-amber-700 border-amber-100': categoria.categoria === 'B',
                            'bg-white text-red-700 border-red-100': categoria.categoria === 'C'
                         }">
                        {{ categoria.categoria }}
                    </div>
                    <div class="text-right">
                        <span class="block text-3xl font-bold text-surface-900 dark:text-surface-0 tracking-tight">
                            {{ getPorcentajePorCategoria(categoria) | number:'1.0-0' }}%
                        </span>
                        <span class="text-[10px] font-bold text-surface-500 uppercase tracking-widest">Del Valor Total</span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="flex justify-between items-center text-sm border-b border-black/5 pb-2">
                        <span class="text-surface-600 dark:text-surface-300 font-medium">Productos</span>
                        <span class="font-bold text-surface-900 dark:text-surface-0">{{ getProductosPorCategoria(categoria) }}</span>
                    </div>
                    <div class="flex justify-between items-center text-sm border-b border-black/5 pb-2">
                        <span class="text-surface-600 dark:text-surface-300 font-medium">Valorización</span>
                        <span class="font-bold text-surface-900 dark:text-surface-0">S/. {{ getValorPorCategoria(categoria) | number:'1.0-0' }}</span>
                    </div>
                    
                    <div class="w-full h-2 bg-surface-200 dark:bg-surface-700 rounded-full overflow-hidden mt-4">
                        <div class="h-full rounded-full"
                             [style.width.%]="getPorcentajePorCategoria(categoria)"
                             [ngClass]="{
                                'bg-emerald-600': categoria.categoria === 'A',
                                'bg-amber-500': categoria.categoria === 'B',
                                'bg-red-500': categoria.categoria === 'C'
                             }"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="space-y-4">
            <p-accordion [multiple]="true" [activeIndex]="[0]" styleClass="zen-accordion-flat">
                <p-accordionTab *ngFor="let categoria of categoriasABC">
                    
                    <ng-template pTemplate="header">
                        <div class="flex items-center gap-4 w-full pr-4 py-2">
                            <div class="w-10 h-10 rounded-lg flex items-center justify-center text-base font-bold text-white shadow-sm"
                                 [style.background-color]="categoria.color">
                                {{ categoria.categoria }}
                            </div>
                            
                            <div class="flex flex-col">
                                <span class="font-bold text-surface-900 dark:text-surface-0 text-sm">Categoría {{ categoria.categoria }}</span>
                                <span class="text-xs text-surface-500 mt-0.5">{{ categoria.descripcion }}</span>
                            </div>
                            
                            <div class="ml-auto flex items-center gap-3">
                                <span class="px-3 py-1 rounded-md bg-white dark:bg-surface-800 text-surface-700 dark:text-surface-200 text-xs font-bold border border-surface-200 dark:border-surface-700">
                                    {{ getProductosPorCategoria(categoria) }} SKUs
                                </span>
                                <span class="px-3 py-1 rounded-md text-white text-xs font-bold shadow-sm" [style.background-color]="categoria.color">
                                    S/. {{ getValorPorCategoria(categoria) | number:'1.0-0' }}
                                </span>
                            </div>
                        </div>
                    </ng-template>

                    <div class="pt-4">
                        
                        <div class="bg-white dark:bg-surface-900 rounded-xl border border-surface-200 dark:border-surface-700 overflow-hidden mb-6">
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-left">
                                    <thead class="text-xs font-bold text-surface-500 uppercase bg-surface-50 dark:bg-surface-800 border-b border-surface-200 dark:border-surface-700">
                                        <tr>
                                            <th class="px-6 py-4">Producto</th>
                                            <th class="px-6 py-4 text-center">Stock</th>
                                            <th class="px-6 py-4 text-right">Valor Total</th>
                                            <th class="px-6 py-4 text-center">Rotación</th>
                                            <th class="px-6 py-4 text-center">Ver</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-surface-100 dark:divide-surface-800">
                                        <tr *ngFor="let inventario of getInventariosPorCategoria(categoria); let i = index" 
                                            class="hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-colors">
                                            
                                            <td class="px-6 py-4">
                                                <div class="flex items-center gap-3">
                                                    <div class="w-6 h-6 rounded flex items-center justify-center text-[10px] font-bold text-white" [style.background-color]="categoria.color">
                                                        {{ i + 1 }}
                                                    </div>
                                                    <div class="flex flex-col">
                                                        <span class="font-bold text-surface-900 dark:text-surface-0">{{ inventario.producto?.nombre }}</span>
                                                        <span class="text-[10px] text-surface-500">
                                                            {{ inventario.color?.nombre }} • {{ inventario.talla?.numero }}
                                                        </span>
                                                    </div>
                                                </div>
                                            </td>
                                            
                                            <td class="px-6 py-4 text-center font-mono font-medium text-surface-600 dark:text-surface-300">
                                                {{ inventario.cantidad }}
                                            </td>
                                            
                                            <td class="px-6 py-4 text-right font-bold text-surface-900 dark:text-surface-0">
                                                S/. {{ inventario.valorTotal | number:'1.0-0' }}
                                            </td>
                                            
                                            <td class="px-6 py-4 text-center">
                                                <span class="px-2 py-1 rounded-md bg-surface-100 dark:bg-surface-800 text-surface-600 dark:text-surface-300 text-xs font-bold">
                                                    {{ inventario.rotacion | number:'1.1-1' }}x
                                                </span>
                                            </td>
                                            
                                            <td class="px-6 py-4 text-center">
                                                <button (click)="mostrarDetalle(inventario)" class="text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 transition-colors">
                                                    <i class="pi pi-eye"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="p-5 rounded-xl border bg-surface-50 dark:bg-surface-800/30"
                             [ngClass]="{
                                'border-emerald-200 bg-emerald-50/50': categoria.categoria === 'A',
                                'border-amber-200 bg-amber-50/50': categoria.categoria === 'B',
                                'border-red-200 bg-red-50/50': categoria.categoria === 'C'
                             }">
                            <h6 class="font-bold text-surface-900 dark:text-surface-0 mb-3 flex items-center gap-2 text-sm">
                                <i class="pi pi-lightbulb" [style.color]="categoria.color"></i>
                                Estrategia Recomendada
                            </h6>
                            <ul class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-2 list-disc list-inside text-xs font-medium text-surface-600 dark:text-surface-300 marker:text-surface-400">
                                <ng-container *ngIf="categoria.categoria === 'A'">
                                    <li>Control de inventario estricto y frecuente (Diario).</li>
                                    <li>Relación estrecha con proveedores para entregas rápidas.</li>
                                    <li>Márgenes de seguridad ajustados para reducir costos.</li>
                                    <li>Ubicación prioritaria en almacén para picking rápido.</li>
                                </ng-container>
                                <ng-container *ngIf="categoria.categoria === 'B'">
                                    <li>Control moderado con revisiones periódicas (Mensual).</li>
                                    <li>Mantener stock de seguridad balanceado.</li>
                                    <li>Monitoreo de tendencias para evitar saltos a categoría A.</li>
                                    <li>Gestión por lotes económicos de compra.</li>
                                </ng-container>
                                <ng-container *ngIf="categoria.categoria === 'C'">
                                    <li>Control básico visual o revisiones trimestrales.</li>
                                    <li>Compras por volumen para reducir costos logísticos.</li>
                                    <li>Stock de seguridad alto para evitar desabastecimiento.</li>
                                    <li>Considerar automatización total de reabastecimiento.</li>
                                </ng-container>
                            </ul>
                        </div>

                    </div>
                </p-accordionTab>
            </p-accordion>
        </div>

    </div>

    <div class="flex justify-between items-center px-8 py-5 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-700 sticky bottom-0 z-50">
        <div class="text-xs text-surface-500 font-medium">
            <i class="pi pi-info-circle mr-1"></i> Análisis basado en valorización actual
        </div>
        <div class="flex gap-3">
            <button pButton label="Cerrar" class="p-button-text text-surface-600 dark:text-surface-300 font-bold" (click)="hideAnalisisAbcDialog()"></button>
            <button pButton label="Recalcular" icon="pi pi-refresh" class="p-button-outlined border-surface-300 text-surface-700 font-bold rounded-xl hover:bg-surface-50" (click)="recalcularABC()"></button>
            <button pButton label="Exportar Reporte" icon="pi pi-download" class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 border-none px-6 rounded-xl font-bold shadow-sm hover:bg-black transition-colors" (click)="exportarAnalisisABC()"></button>
        </div>
    </div>

  </div>
</p-dialog>

