<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>

<!-- Header premium con dashboard metrics -->
<div class="mb-6">
  <!-- Header principal con gradiente y m칠tricas -->
  <div class="bg-gradient-to-r from-white via-green-50 to-white rounded-xl p-6 shadow-sm border border-gray-100">
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
      <!-- T칤tulo principal -->
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="bg-green-600 p-3 rounded-lg shadow-lg">
            <i class="pi pi-arrows-alt text-white text-xl"></i>
          </div>
          <div>
            <h1 class="text-3xl font-bold text-gray-900 m-0">Gesti칩n de Movimientos</h1>
            <p class="text-gray-600 mt-1 mb-0">Control inteligente de movimientos de inventario</p>
          </div>
        </div>
      </div>
      
      <!-- Dashboard metrics avanzado -->
      <div class="flex flex-wrap gap-4">
        <!-- Total movimientos -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[140px] inventory-entrance">
          <div class="flex items-center gap-3">
            <div class="bg-blue-100 p-2 rounded-lg">
              <i class="pi pi-list text-blue-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-blue-600">
                {{inventarioSeleccionadoFiltro ? movimientosFiltrados.length : movimientos.length || 0}}
              </div>
              <div class="text-sm text-gray-600 font-medium">
                {{inventarioSeleccionadoFiltro ? 'Movimientos del Producto' : 'Total Movimientos'}}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Entradas del d칤a -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] inventory-entrance">
          <div class="flex items-center gap-3">
            <div class="bg-green-100 p-2 rounded-lg">
              <i class="pi pi-arrow-down text-green-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-600">{{getEntradasHoy()}}</div>
              <div class="text-sm text-gray-600 font-medium">
                {{inventarioSeleccionadoFiltro ? 'Entradas (Producto)' : 'Entradas Hoy'}}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Salidas del d칤a -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] inventory-entrance">
          <div class="flex items-center gap-3">
            <div class="bg-orange-100 p-2 rounded-lg">
              <i class="pi pi-arrow-up text-orange-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-orange-600">{{getSalidasHoy()}}</div>
              <div class="text-sm text-gray-600 font-medium">
                {{inventarioSeleccionadoFiltro ? 'Salidas (Producto)' : 'Salidas Hoy'}}
              </div>
            </div>
          </div>
        </div>
                
        <!-- Stock cr칤tico afectado -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] inventory-entrance"
             [class.pulse-value]="getProductosStockCritico() > 0">
          <div class="flex items-center gap-3">
            <div class="bg-red-100 p-2 rounded-lg">
              <i class="pi pi-exclamation-triangle text-red-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-red-600">{{getProductosStockCritico()}}</div>
              <div class="text-sm text-gray-600 font-medium">
                {{inventarioSeleccionadoFiltro ? 'Stock Actual' : 'Stock Cr칤tico'}}
              </div>
            </div>
          </div>
        </div>
        
        <!-- Eficiencia del d칤a -->
        <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100 hover:shadow-md transition-all duration-300 min-w-[120px] inventory-entrance">
          <div class="flex items-center gap-3">
            <div class="bg-teal-100 p-2 rounded-lg">
              <i class="pi pi-chart-line text-teal-600"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-teal-600">{{getEficienciaMovimientos() | number:'1.0-0'}}%</div>
              <div class="text-sm text-gray-600 font-medium">
                {{inventarioSeleccionadoFiltro ? 'Eficiencia (Producto)' : 'Eficiencia Hoy'}}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toolbar premium con acciones inteligentes -->
<div class="mb-6">
  <div class="bg-gradient-to-r from-white via-blue-50 to-white rounded-xl p-5 shadow-sm border border-gray-100">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      
      <!-- Secci칩n izquierda - Acciones principales -->
      <div class="flex flex-wrap items-center gap-3">
        <!-- Nuevo movimiento (principal) -->
        <button 
          *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.CREATE}"
          class="action-btn primary-btn"
          (click)="openNew()">
          <div class="btn-icon bg-blue-600">
            <i class="pi pi-plus text-white"></i>
          </div>
          <div class="btn-content">
            <div class="btn-title">Nuevo</div>
            <div class="btn-subtitle">Movimiento</div>
          </div>
        </button>
        
        <!-- Acciones r치pidas -->
        <div class="flex items-center gap-2 ml-2">
          <!-- Entrada r치pida -->
          <button 
            class="quick-action-btn success-btn"
            (click)="entradaRapida()"
            title="Nueva Entrada">
            <div class="quick-icon bg-green-100">
              <i class="pi pi-arrow-down text-green-600"></i>
            </div>
            <span class="quick-label">Entrada</span>
          </button>
          
          <!-- Salida r치pida -->
          <button 
            class="quick-action-btn warning-btn"
            (click)="salidaRapida()"
            title="Nueva Salida">
            <div class="quick-icon bg-orange-100">
              <i class="pi pi-arrow-up text-orange-600"></i>
            </div>
            <span class="quick-label">Salida</span>
          </button>
          
          <!-- Ajuste -->
          <button 
            class="quick-action-btn secondary-btn"
            (click)="ajusteInventario()"
            title="Ajuste de Inventario">
            <div class="quick-icon bg-purple-100">
              <i class="pi pi-sliders-h text-purple-600"></i>
            </div>
            <span class="quick-label">Ajuste</span>
          </button>
        </div>
        
        <!-- Separador visual -->
        <div class="separator"></div>
        
        <!-- Eliminar seleccionados -->
        <button 
          *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.DELETE}"
          class="action-btn danger-btn"
          (click)="deleteSelectedMovimientos()"
          [disabled]="!selectedMovimientos.length || !inventarioSeleccionadoFiltro"
          [class.disabled]="!selectedMovimientos.length || !inventarioSeleccionadoFiltro">
          <div class="btn-icon bg-red-600" [class.bg-gray-400]="!selectedMovimientos.length || !inventarioSeleccionadoFiltro">
            <i class="pi pi-trash text-white"></i>
          </div>
          <span class="btn-text">
            Eliminar ({{selectedMovimientos.length || 0}})
          </span>
        </button>
      </div>
      
      <!-- Secci칩n derecha - Filtros y exportaci칩n -->
      <div class="flex flex-wrap items-center gap-3">
        <!-- Info de filtros activos -->
        <div class="filter-info" *ngIf="inventarioSeleccionadoFiltro">
          <div class="info-badge active">
            <i class="pi pi-filter"></i>
            <span>Filtros aplicados</span>
            <div class="badge-count">{{getActiveFiltrosCount()}}</div>
          </div>
        </div>
        
        <!-- Contador de resultados -->
        <div class="results-counter">
          <div class="counter-badge">
            <i class="pi pi-list"></i>
            <span>{{movimientosFiltrados.length}} resultados</span>
          </div>
        </div>
        
        <!-- Acciones secundarias -->
        <div class="flex items-center gap-2">
          <!-- Limpiar filtros -->
          <button 
            class="secondary-action-btn"
            (click)="limpiarFiltros()"
            [disabled]="!inventarioSeleccionadoFiltro"
            [class.disabled]="!inventarioSeleccionadoFiltro"
            title="Limpiar todos los filtros">
            <div class="secondary-icon">
              <i class="pi pi-filter-slash"></i>
            </div>
          </button>
          
          <!-- Actualizar -->
          <button 
            class="secondary-action-btn"
            (click)="refresh()"
            title="Actualizar datos">
            <div class="secondary-icon">
              <i class="pi pi-refresh"></i>
            </div>
          </button>
          
          <!-- Exportar con opciones (Excel y PDF) -->
          <p-splitButton 
            label="Exportar" 
            icon="pi pi-download" 
            (onClick)="exportarExcelMejorado()"
            [model]="opcionesExportacion"
            [disabled]="movimientosFiltrados.length === 0"
            severity="success"
            [outlined]="false"
            styleClass="export-split-btn"
            appendTo="body">
            <ng-template pTemplate="content">
              <span class="font-semibold">Exportar</span>
            </ng-template>
          </p-splitButton>
        </div>
      </div>
    </div>
    
    <!-- Barra de progreso/estado (opcional) -->
    <div class="status-bar" *ngIf="loading || hasActiveFilters()">
      <div class="status-content">
        <!-- Loading -->
        <div class="flex items-center gap-2" *ngIf="loading">
          <i class="pi pi-spin pi-spinner text-blue-600"></i>
          <span class="text-sm text-gray-600">Cargando movimientos...</span>
        </div>
        
        <!-- Filtros activos -->
        <div class="flex items-center gap-2" *ngIf="loading && hasActiveFilters()">
          <i class="pi pi-info-circle text-blue-600"></i>
          <span class="text-sm text-gray-700">
            Mostrando {{movimientosFiltrados.length}} de {{movimientos.length}} movimientos
          </span>
        </div>
      </div>
    </div>
  </div>
</div>


<!-- Filtro por inventario origen -->
<div class="mb-4">
  <h5 class="mb-2">Filtrar por Inventario de Origen</h5>
  <p-select 
    [options]="inventarios" 
    [(ngModel)]="inventarioSeleccionadoFiltro" 
    optionLabel="serie"
    placeholder="Seleccione un inventario para filtrar movimientos"
    [filter]="true"
    filterBy="serie"
    [style]="{'width':'100%', 'max-width': '400px'}"
    (onChange)="filtrarMovimientosPorInventario()"
    [showClear]="true">
    <ng-template pTemplate="selectedItem">
      <div *ngIf="inventarioSeleccionadoFiltro">
        <div>{{inventarioSeleccionadoFiltro.serie}} - {{inventarioSeleccionadoFiltro.producto?.nombre}}</div>
      </div>
    </ng-template>
    <ng-template let-item pTemplate="item">
      <div>
        <div>{{item.serie}} - {{item.producto?.nombre}}</div>
        <small class="text-gray-500">{{item.color?.nombre}} - Talla {{item.talla?.numero}} - {{item.almacen?.nombre}}</small>
      </div>
    </ng-template>
  </p-select>
  <small *ngIf="inventarioSeleccionadoFiltro" class="block mt-2">
    Mostrando movimientos para: <strong>{{inventarioSeleccionadoFiltro.serie}} - {{inventarioSeleccionadoFiltro.producto?.nombre}}</strong>
  </small>
  <small *ngIf="!inventarioSeleccionadoFiltro" class="block mt-2">
    Seleccione un inventario para filtrar movimientos
  </small>
</div>

<!-- NUEVO: Panel de filtros avanzados -->
<div class="mb-6" *ngIf="inventarioSeleccionadoFiltro">
  <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-5">
    <div class="flex items-center gap-3 mb-4">
      <div class="bg-blue-100 p-2 rounded-lg">
        <i class="pi pi-filter text-blue-600"></i>
      </div>
      <h5 class="m-0 font-bold text-gray-800">Filtros Avanzados</h5>
    </div>
    
    <div class="grid gap-4">
      <!-- Filtro por rango de fechas -->
      <div class="col-12 md:col-6 lg:col-4">
        <label class="block font-semibold text-gray-700 mb-2">
          <i class="pi pi-calendar mr-2 text-purple-600"></i>
          Fecha Desde
        </label>
        <p-calendar 
          [(ngModel)]="fechaDesde" 
          [showIcon]="true" 
          dateFormat="dd/mm/yy"
          placeholder="Fecha inicial"
          [showButtonBar]="true"
          (onSelect)="aplicarFiltrosPorFecha()"
          class="w-full"
        ></p-calendar>
      </div>
      
      <div class="col-12 md:col-6 lg:col-4">
        <label class="block font-semibold text-gray-700 mb-2">
          <i class="pi pi-calendar mr-2 text-purple-600"></i>
          Fecha Hasta
        </label>
        <p-calendar 
          [(ngModel)]="fechaHasta" 
          [showIcon]="true" 
          dateFormat="dd/mm/yy"
          placeholder="Fecha final"
          [showButtonBar]="true"
          (onSelect)="aplicarFiltrosPorFecha()"
          class="w-full"
        ></p-calendar>
      </div>
      
      <!-- Filtro por estado -->
      <div class="col-12 md:col-6 lg:col-4">
        <label class="block font-semibold text-gray-700 mb-2">
          <i class="pi pi-tag mr-2 text-green-600"></i>
          Estado
        </label>
        <p-select 
          [(ngModel)]="estadoFiltro" 
          [options]="estadosMovimiento"
          optionLabel="label"
          optionValue="value"
          placeholder="Todos los estados"
          [showClear]="true"
          (onChange)="aplicarFiltrosPorFecha()"
          class="w-full"
        >
          <ng-template let-option pTemplate="item">
            <div class="flex items-center gap-2">
              <i [class]="option.icon"></i>
              <span>{{option.label}}</span>
            </div>
          </ng-template>
        </p-select>
      </div>
      
      <!-- Presets de rango de fechas -->
      <div class="col-12">
        <label class="block font-semibold text-gray-700 mb-2">
          <i class="pi pi-clock mr-2 text-orange-600"></i>
          Rangos R치pidos
        </label>
        <div class="flex flex-wrap gap-2">
          <button 
            pButton 
            label="Hoy" 
            icon="pi pi-calendar-plus"
            size="small"
            [outlined]="rangoFechaPreset !== 'hoy'"
            (click)="aplicarRangoFechaPreset('hoy')"
            class="flex-shrink-0"
          ></button>
          <button 
            pButton 
            label="Esta Semana" 
            icon="pi pi-calendar"
            size="small"
            [outlined]="rangoFechaPreset !== 'semana'"
            (click)="aplicarRangoFechaPreset('semana')"
            class="flex-shrink-0"
          ></button>
          <button 
            pButton 
            label="Este Mes" 
            icon="pi pi-calendar"
            size="small"
            [outlined]="rangoFechaPreset !== 'mes'"
            (click)="aplicarRangoFechaPreset('mes')"
            class="flex-shrink-0"
          ></button>
          <button 
            pButton 
            label="칔ltimo Mes" 
            icon="pi pi-calendar-minus"
            size="small"
            [outlined]="rangoFechaPreset !== 'ultimoMes'"
            (click)="aplicarRangoFechaPreset('ultimoMes')"
            class="flex-shrink-0"
          ></button>
          <button 
            pButton 
            label="Limpiar" 
            icon="pi pi-times"
            severity="secondary"
            size="small"
            [outlined]="true"
            (click)="aplicarRangoFechaPreset('limpiar')"
            class="flex-shrink-0"
          ></button>
          <button 
            pButton 
            label="Ver Gr치ficos" 
            icon="pi pi-chart-line"
            severity="info"
            size="small"
            (click)="mostrarGraficos()"
            class="flex-shrink-0"
          ></button>
        </div>
      </div>
    </div>
  </div>
</div>

<p-table
  #dt
  [value]="movimientosFiltrados"
  [rows]="10"
  [paginator]="true"
  [totalRecords]="movimientosFiltrados.length"
  [globalFilterFields]="['id', 'tipo', 'descripcion', 'referencia', 'cantidad', 'usuario']"
  [tableStyle]="{'min-width': '75rem'}"
  [(selection)]="selectedMovimientos"
  [rowHover]="true"
  dataKey="id"
  [showCurrentPageReport]="true"
  currentPageReportTemplate="Mostrando {first} a {last} de {totalRecords} movimientos"
  [rowsPerPageOptions]="[5, 10, 20, 30, 50]"
  [loading]="loading"
  [alwaysShowPaginator]="true"
>
  <ng-template pTemplate="caption">
    <div class="flex items-center justify-between">
      <h5 class="m-0">Movimientos de Inventario</h5>
      <p-iconfield>
        <p-inputicon styleClass="pi pi-search" />
        <input pInputText type="text" (input)="onGlobalFilter(dt, $event)" placeholder="Buscar..." />
      </p-iconfield>
    </div>
  </ng-template>

  <ng-template pTemplate="header">
    <tr>
      <th style="width: 3rem">
        <p-tableHeaderCheckbox />
      </th>
      <th pSortableColumn="tipo" style="min-width:10rem">
        Tipo
        <p-sortIcon field="tipo" />
      </th>
      <th pSortableColumn="producto" style="min-width:18rem">
        Producto / Detalles
        <p-sortIcon field="producto" />
      </th>
      <th pSortableColumn="cantidad" style="min-width:8rem">
        Cantidad
        <p-sortIcon field="cantidad" />
      </th>
      <th pSortableColumn="descripcion" style="min-width:15rem">
        Descripci칩n
        <p-sortIcon field="descripcion" />
      </th>
      <th pSortableColumn="referencia" style="min-width:10rem">
        Referencia
        <p-sortIcon field="referencia" />
      </th>
      <th pSortableColumn="fechaMovimiento" style="min-width:10rem">
        Fecha
        <p-sortIcon field="fechaMovimiento" />
      </th>
      <th pSortableColumn="usuario" style="min-width:8rem">
        Usuario
        <p-sortIcon field="usuario" />
      </th>
      <th style="min-width:8rem">Acciones</th>
    </tr>
  </ng-template>

  <ng-template pTemplate="body" let-movimiento>
    <tr>
      <td>
        <p-tableCheckbox [value]="movimiento" />
      </td>
      
      <!-- Tipo de movimiento con badge mejorado -->
      <td>
        <p-tag 
          [value]="movimiento.tipo" 
          [severity]="getTipoSeverity(movimiento.tipo)"
          [icon]="getTipoIcon(movimiento.tipo)"
          [style]="{'font-size': '0.875rem', 'padding': '0.5rem 0.75rem'}">
        </p-tag>
      </td>
      
      <!-- Producto con detalles visuales -->
      <td>
        <div class="space-y-2">
          <!-- Nombre del producto -->
          <div class="flex items-center gap-2" *ngIf="movimiento.producto">
            <div class="bg-blue-100 p-1.5 rounded-lg">
              <i class="pi pi-box text-blue-600 text-sm"></i>
            </div>
            <span class="font-semibold text-gray-900">{{movimiento.producto?.nombre}}</span>
          </div>
          
          <!-- Color y Talla en badges -->
          <div class="flex items-center gap-2 flex-wrap">
            <!-- Badge de Color con c칤rculo de color real -->
            <div class="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs font-medium bg-purple-50 text-purple-700 border border-purple-200"
                 *ngIf="movimiento.color">
              <div class="w-3 h-3 rounded-full border border-white shadow-sm"
                   [style.background-color]="movimiento.color?.codigoHex || '#cccccc'">
              </div>
              {{movimiento.color?.nombre}}
            </div>
            
            <!-- Badge de Talla -->
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs font-medium bg-blue-50 text-blue-700 border border-blue-200"
                  *ngIf="movimiento.talla">
              <i class="pi pi-tag text-xs"></i>
              Talla {{movimiento.talla?.numero}}
            </span>
          </div>
          
          <!-- Serie e Inventario destino si aplica -->
          <div class="flex items-center gap-2 text-xs text-gray-500">
            <span>Serie: {{movimiento.inventarioId}}</span>
            <span *ngIf="movimiento.inventarioDestinoId" class="flex items-center gap-1">
              <i class="pi pi-arrow-right"></i>
              Destino: {{movimiento.inventarioDestinoId}}
            </span>
          </div>
        </div>
      </td>
      
      <!-- Cantidad con formato destacado -->
      <td>
        <div class="flex items-center gap-2">
          <div class="bg-gradient-to-r from-green-50 to-emerald-50 px-3 py-1.5 rounded-lg border border-green-200">
            <span class="font-bold text-green-700 text-lg">{{movimiento.cantidad}}</span>
          </div>
        </div>
      </td>
      
      <!-- Descripci칩n con tooltip -->
      <td>
        <span class="text-gray-700" [title]="movimiento.descripcion">
          {{movimiento.descripcion.length > 45 ? (movimiento.descripcion | slice:0:45) + '...' : movimiento.descripcion}}
        </span>
      </td>
      
      <!-- Referencia -->
      <td>
        <div class="flex items-center gap-2">
          <i class="pi pi-tag text-gray-400 text-xs"></i>
          <span class="font-mono text-sm text-gray-600">{{movimiento.referencia}}</span>
        </div>
      </td>
      
      <!-- Fecha -->
      <td>
        <div class="space-y-1">
          <div class="font-medium text-gray-900">{{movimiento.fechaMovimiento | date:'dd/MM/yyyy'}}</div>
          <div class="text-xs text-gray-500">{{movimiento.fechaMovimiento | date:'HH:mm'}}</div>
        </div>
      </td>
      
      <!-- Usuario -->
      <td>
        <div class="flex items-center gap-2">
          <div class="bg-gray-100 p-1.5 rounded-full">
            <i class="pi pi-user text-gray-600 text-xs"></i>
          </div>
          <span class="text-sm text-gray-700">{{movimiento.usuario}}</span>
        </div>
      </td>
      
      <!-- Acciones -->
      <td>
        <div class="flex gap-1 flex-wrap">
          <!-- Ver detalles -->
          <button 
            pButton 
            icon="pi pi-eye" 
            class="p-button-rounded p-button-text p-button-sm hover:bg-blue-50"
            (click)="verDetallesMovimiento(movimiento)"
            pTooltip="Ver detalles completos"
            tooltipPosition="top"
            severity="info">
          </button>
          
          <!-- Editar -->
          <button 
            *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.EDIT}"
            pButton 
            icon="pi pi-pencil" 
            class="p-button-rounded p-button-text p-button-sm hover:bg-blue-50"
            (click)="editMovimiento(movimiento)"
            pTooltip="Editar movimiento"
            tooltipPosition="top">
          </button>
          
          <!-- Duplicar -->
          <button 
            *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.CREATE}"
            pButton 
            icon="pi pi-copy" 
            severity="success"
            class="p-button-rounded p-button-text p-button-sm hover:bg-green-50"
            (click)="duplicarMovimiento(movimiento)"
            pTooltip="Duplicar movimiento"
            tooltipPosition="top">
          </button>
          
          <!-- Revertir -->
          <button 
            *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.CREATE}"
            pButton 
            icon="pi pi-replay" 
            severity="danger"
            class="p-button-rounded p-button-text p-button-sm hover:bg-orange-50"
            (click)="revertirMovimiento(movimiento)"
            pTooltip="Revertir movimiento"
            tooltipPosition="top">
          </button>
          
          <!-- Imprimir ticket -->
          <button 
            pButton 
            icon="pi pi-print" 
            severity="secondary"
            class="p-button-rounded p-button-text p-button-sm hover:bg-gray-50"
            (click)="imprimirTicket(movimiento)"
            pTooltip="Imprimir ticket"
            tooltipPosition="top">
          </button>
          
          <!-- Eliminar -->
          <button 
            *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.DELETE}"
            pButton 
            icon="pi pi-trash" 
            severity="danger" 
            class="p-button-rounded p-button-text p-button-sm hover:bg-red-50"
            (click)="deleteMovimiento(movimiento)"
            pTooltip="Eliminar movimiento"
            tooltipPosition="top">
          </button>
        </div>
      </td>
    </tr>
  </ng-template>

  <ng-template pTemplate="emptymessage">
    <tr>
      <td colspan="10" class="text-center py-8">
        <div *ngIf="inventarioSeleccionadoFiltro; else sinInventarioSeleccionado">
          <i class="pi pi-inbox text-4xl text-gray-400 mb-3"></i>
          <div class="text-lg font-medium text-gray-600 mb-2">No hay movimientos disponibles</div>
          <div class="text-gray-500 mb-4">No se encontraron movimientos para este inventario.</div>
          <button 
            *appHasPermission="{module: 'movimientosInventario', permission: permissionTypes.CREATE}" 
            pButton 
            class="p-button-sm p-button-outlined" 
            (click)="openNew()">
            <i class="pi pi-plus mr-2"></i>
            <span>A침adir Primer Movimiento</span>
          </button>
        </div>
        <ng-template #sinInventarioSeleccionado>
          <i class="pi pi-filter text-4xl text-gray-400 mb-3"></i>
          <div class="text-lg font-medium text-gray-600 mb-2">Seleccione un inventario</div>
          <div class="text-gray-500">Elija un inventario de origen para ver sus movimientos</div>
        </ng-template>
      </td>
    </tr>
  </ng-template>
</p-table>

<!-- Di치logo para crear/editar movimiento - Versi칩n Mejorada -->
<p-dialog 
  [(visible)]="movimientoDialog" 
  [style]="{'width': '900px', 'max-width': '95vw', 'max-height': '90vh'}" 
  [modal]="true" 
  (onHide)="hideDialog()"
  [contentStyle]="{'padding':'0', 'overflow-y': 'auto', 'max-height': 'calc(90vh - 200px)'}"
  [closable]="!loading"
  [dismissableMask]="!loading"
>
  <!-- Header personalizado -->
  <ng-template pTemplate="header">
    <div class="w-full">
      <div class="bg-gradient-to-r from-blue-600 via-indigo-600 to-purple-600 -m-6 mb-0 p-6">
        <div class="flex items-center gap-4">
          <div class="bg-white/20 backdrop-blur p-3 rounded-xl">
            <i [class]="editMode ? 'pi pi-pencil text-white text-2xl' : 'pi pi-plus-circle text-white text-2xl'"></i>
          </div>
          <div class="text-white">
            <h2 class="text-2xl font-bold m-0">
              {{ editMode ? 'Editar Movimiento' : 'Nuevo Movimiento de Inventario' }}
            </h2>
            <p class="text-sm text-white/80 m-0 mt-1">
              {{ editMode ? 'Modifica los datos del movimiento seleccionado' : 'Registra una entrada, salida, ajuste o traslado de inventario' }}
            </p>
          </div>
        </div>
      </div>
    </div>
  </ng-template>
  
  <ng-template pTemplate="content">
    <div class="bg-gradient-to-br from-gray-50 to-blue-50 p-6 space-y-6 pb-8">
      
      <!-- Secci칩n 1: Tipo de Movimiento -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <div class="flex items-center gap-3 mb-4">
          <div class="bg-purple-100 p-2 rounded-lg">
            <i class="pi pi-tags text-purple-600"></i>
          </div>
          <div>
            <label class="block text-lg font-bold text-gray-900 m-0">Tipo de Movimiento*</label>
            <p class="text-sm text-gray-600 m-0">Selecciona la naturaleza del movimiento</p>
          </div>
        </div>
        
        <p-selectButton 
          [options]="tiposMovimiento" 
          [(ngModel)]="movimiento.tipo" 
          optionLabel="label"
          optionValue="value"
          [disabled]="editMode"
          [ngClass]="{'ng-invalid': submitted && !movimiento.tipo}"
          class="w-full"
        >
          <ng-template let-item>
            <div class="flex flex-col items-center gap-2 py-2 px-3">
              <i [class]="item.icon + ' text-xl'"></i>
              <span class="font-semibold text-sm">{{item.label}}</span>
            </div>
          </ng-template>
        </p-selectButton>
        
        <small class="text-red-600 flex items-center gap-1 mt-2" *ngIf="submitted && !movimiento.tipo">
          <i class="pi pi-exclamation-circle"></i>
          El tipo de movimiento es obligatorio.
        </small>
      </div>
      
      <!-- Secci칩n 2: Selecci칩n de Inventario Origen -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <div class="flex items-center gap-3 mb-4">
          <div class="bg-blue-100 p-2 rounded-lg">
            <i class="pi pi-box text-blue-600"></i>
          </div>
          <div>
            <label for="inventario" class="block text-lg font-bold text-gray-900 m-0">Inventario Origen*</label>
            <p class="text-sm text-gray-600 m-0">Producto desde donde se realiza el movimiento</p>
          </div>
        </div>
        
        <p-select 
          id="inventario" 
          [options]="inventarios" 
          [(ngModel)]="inventarioSeleccionado"
          optionLabel="serie"
          placeholder="游댌 Buscar y seleccionar inventario..."
          [filter]="true"
          filterBy="serie,producto.nombre"
          [showClear]="true"
          [disabled]="editMode"
          [ngClass]="{'ng-invalid': submitted && !inventarioSeleccionado}"
          [style]="{'width':'100%'}"
          class="w-full"
        >
          <ng-template pTemplate="selectedItem">
            <div *ngIf="inventarioSeleccionado" class="flex items-center gap-3 py-1">
              <div class="bg-blue-100 p-2 rounded-lg">
                <i class="pi pi-shopping-bag text-blue-600"></i>
              </div>
              <div class="flex-1">
                <div class="font-semibold text-gray-900">{{inventarioSeleccionado.serie}} - {{inventarioSeleccionado.producto?.nombre}}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">
                    {{inventarioSeleccionado.color?.nombre}}
                  </span>
                  <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
                    Talla {{inventarioSeleccionado.talla?.numero}}
                  </span>
                </div>
              </div>
            </div>
          </ng-template>
          <ng-template let-item pTemplate="item">
            <div class="py-2 hover:bg-gray-50 rounded-lg transition-colors">
              <div class="flex items-start gap-3">
                <div class="bg-gradient-to-br from-blue-100 to-indigo-100 p-2 rounded-lg">
                  <i class="pi pi-box text-blue-600"></i>
                </div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">{{item.serie}}</div>
                  <div class="text-sm text-gray-700 mt-0.5">{{item.producto?.nombre}}</div>
                  <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                    <span class="text-xs bg-purple-50 text-purple-700 px-2 py-0.5 rounded-full border border-purple-200">
                      <i class="pi pi-palette text-xs mr-1"></i>{{item.color?.nombre}}
                    </span>
                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full border border-blue-200">
                      <i class="pi pi-tag text-xs mr-1"></i>Talla {{item.talla?.numero}}
                    </span>
                    <span class="text-xs bg-green-50 text-green-700 px-2 py-0.5 rounded-full border border-green-200 font-semibold">
                      <i class="pi pi-database text-xs mr-1"></i>Stock: {{item.cantidad}}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </p-select>
        
        <small class="text-red-600 flex items-center gap-1 mt-2" *ngIf="submitted && !inventarioSeleccionado">
          <i class="pi pi-exclamation-circle"></i>
          El inventario de origen es obligatorio.
        </small>
      </div>
      
      <!-- Secci칩n 3: Informaci칩n del Producto Seleccionado (Mejorada) -->
      <div *ngIf="inventarioSeleccionado" class="animate-fadein">
        <div class="bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-600 rounded-2xl p-1 shadow-xl">
          <div class="bg-white rounded-xl p-6">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-indigo-100 to-purple-100 p-2.5 rounded-xl">
                  <i class="pi pi-info-circle text-indigo-600 text-lg"></i>
                </div>
                <h6 class="text-base font-bold text-gray-900 m-0">Producto Seleccionado</h6>
              </div>
              <span class="text-xs bg-green-100 text-green-700 px-3 py-1 rounded-full font-semibold">
                <i class="pi pi-check-circle mr-1"></i>Seleccionado
              </span>
            </div>
            
            <!-- Nombre del producto destacado -->
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-xl p-4 mb-4 border border-gray-200">
              <div class="flex items-center gap-3">
                <div class="bg-gradient-to-br from-blue-600 to-indigo-600 p-3 rounded-xl shadow-lg">
                  <i class="pi pi-shopping-bag text-white text-xl"></i>
                </div>
                <div>
                  <div class="text-xs text-gray-600 font-medium mb-1">Producto</div>
                  <div class="text-xl font-bold text-gray-900">{{inventarioSeleccionado.producto?.nombre}}</div>
                </div>
              </div>
            </div>
            
            <!-- Grid de caracter칤sticas -->
            <div class="grid grid-cols-2 gap-3">
              <!-- Color con c칤rculo real -->
              <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200 hover:shadow-md transition-shadow">
                <div class="flex items-center gap-3">
                  <div class="relative">
                    <div class="w-10 h-10 rounded-full border-3 border-white shadow-lg"
                         [style.background-color]="inventarioSeleccionado.color?.codigoHex || '#ccc'">
                    </div>
                    <div class="absolute -bottom-1 -right-1 bg-white rounded-full p-1 shadow-sm">
                      <i class="pi pi-palette text-purple-600 text-xs"></i>
                    </div>
                  </div>
                  <div class="flex-1">
                    <div class="text-xs text-gray-600 font-medium mb-0.5">Color</div>
                    <div class="font-bold text-sm text-gray-900">{{inventarioSeleccionado.color?.nombre}}</div>
                  </div>
                </div>
              </div>
              
              <!-- Talla -->
              <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-xl p-4 border border-blue-200 hover:shadow-md transition-shadow">
                <div class="flex items-center gap-3">
                  <div class="bg-blue-600 p-2.5 rounded-xl shadow-md">
                    <i class="pi pi-tag text-white text-lg"></i>
                  </div>
                  <div class="flex-1">
                    <div class="text-xs text-gray-600 font-medium mb-0.5">Talla</div>
                    <div class="font-bold text-lg text-gray-900">{{inventarioSeleccionado.talla?.numero}}</div>
                  </div>
                </div>
              </div>
              
              <!-- Almac칠n -->
              <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-4 border border-indigo-200 hover:shadow-md transition-shadow">
                <div class="flex items-center gap-3">
                  <div class="bg-indigo-600 p-2.5 rounded-xl shadow-md">
                    <i class="pi pi-warehouse text-white text-lg"></i>
                  </div>
                  <div class="flex-1">
                    <div class="text-xs text-gray-600 font-medium mb-0.5">Almac칠n</div>
                    <div class="font-bold text-sm text-gray-900">{{inventarioSeleccionado.almacen?.nombre || 'N/A'}}</div>
                  </div>
                </div>
              </div>
              
              <!-- Stock disponible destacado -->
              <div class="bg-gradient-to-br from-green-500 via-emerald-500 to-teal-500 rounded-xl p-4 shadow-lg hover:shadow-xl transition-shadow relative overflow-hidden">
                <!-- Efecto de brillo -->
                <div class="absolute inset-0 bg-white/10"></div>
                <div class="relative flex items-center gap-3">
                  <div class="bg-white/25 backdrop-blur p-2.5 rounded-xl shadow-md">
                    <i class="pi pi-database text-white text-lg"></i>
                  </div>
                  <div class="flex-1">
                    <div class="text-xs text-white/90 font-semibold mb-0.5">Stock Disponible</div>
                    <div class="font-bold text-2xl text-white flex items-baseline gap-1">
                      {{inventarioSeleccionado.cantidad}}
                      <span class="text-sm font-medium text-white/90">unidades</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Serie -->
            <div class="mt-3 bg-gray-50 rounded-lg p-3 border border-gray-200">
              <div class="flex items-center justify-between">
                <span class="text-xs text-gray-600 font-medium">Serie del Inventario:</span>
                <span class="font-mono text-sm font-bold text-gray-900 bg-white px-3 py-1 rounded-lg border border-gray-200">
                  {{inventarioSeleccionado.serie}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Secci칩n 4: Inventario Destino (solo para traslados) -->
      <div *ngIf="movimiento.tipo === 'TRASLADO'" class="bg-white rounded-xl shadow-sm border-2 border-orange-200 p-5 animate-fadein">
        <div class="flex items-center gap-3 mb-4">
          <div class="bg-orange-100 p-2 rounded-lg">
            <i class="pi pi-arrow-right-arrow-left text-orange-600"></i>
          </div>
          <div>
            <label for="inventarioDestino" class="block text-lg font-bold text-gray-900 m-0">Inventario Destino*</label>
            <p class="text-sm text-gray-600 m-0">Producto hacia donde se trasladar치 el inventario</p>
          </div>
        </div>
        
        <div class="bg-orange-50 rounded-lg p-3 mb-4 border border-orange-200">
          <div class="flex items-center gap-2 text-sm text-orange-800">
            <i class="pi pi-info-circle"></i>
            <span class="font-medium">Traslado: Las unidades se mover치n del inventario origen al destino</span>
          </div>
        </div>
        
        <p-select 
          id="inventarioDestino" 
          [options]="inventarios" 
          [(ngModel)]="inventarioDestinoSeleccionado"
          optionLabel="serie"
          placeholder="游꿢 Seleccionar inventario de destino..."
          [filter]="true"
          filterBy="serie,producto.nombre"
          [showClear]="true"
          [ngClass]="{'ng-invalid': submitted && movimiento.tipo === 'TRASLADO' && !inventarioDestinoSeleccionado}"
          [style]="{'width':'100%'}"
          class="w-full"
        >
          <ng-template pTemplate="selectedItem">
            <div *ngIf="inventarioDestinoSeleccionado" class="flex items-center gap-3 py-1">
              <div class="bg-orange-100 p-2 rounded-lg">
                <i class="pi pi-send text-orange-600"></i>
              </div>
              <div class="flex-1">
                <div class="font-semibold text-gray-900">{{inventarioDestinoSeleccionado.serie}} - {{inventarioDestinoSeleccionado.producto?.nombre}}</div>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-xs bg-purple-100 text-purple-700 px-2 py-0.5 rounded-full">
                    {{inventarioDestinoSeleccionado.color?.nombre}}
                  </span>
                  <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded-full">
                    Talla {{inventarioDestinoSeleccionado.talla?.numero}}
                  </span>
                </div>
              </div>
            </div>
          </ng-template>
          <ng-template let-item pTemplate="item">
            <div class="py-2 hover:bg-gray-50 rounded-lg transition-colors">
              <div class="flex items-start gap-3">
                <div class="bg-gradient-to-br from-orange-100 to-amber-100 p-2 rounded-lg">
                  <i class="pi pi-box text-orange-600"></i>
                </div>
                <div class="flex-1">
                  <div class="font-semibold text-gray-900">{{item.serie}}</div>
                  <div class="text-sm text-gray-700 mt-0.5">{{item.producto?.nombre}}</div>
                  <div class="flex items-center gap-2 mt-1.5 flex-wrap">
                    <span class="text-xs bg-purple-50 text-purple-700 px-2 py-0.5 rounded-full border border-purple-200">
                      {{item.color?.nombre}}
                    </span>
                    <span class="text-xs bg-blue-50 text-blue-700 px-2 py-0.5 rounded-full border border-blue-200">
                      Talla {{item.talla?.numero}}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          </ng-template>
        </p-select>
        
        <small class="text-red-600 flex items-center gap-1 mt-2" *ngIf="submitted && movimiento.tipo === 'TRASLADO' && !inventarioDestinoSeleccionado">
          <i class="pi pi-exclamation-circle"></i>
          El inventario de destino es obligatorio para traslados.
        </small>
      </div>
      
      <!-- Secci칩n 5: Cantidad y Detalles del Movimiento -->
      <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-5">
        <div class="flex items-center gap-3 mb-5">
          <div class="bg-green-100 p-2 rounded-lg">
            <i class="pi pi-calculator text-green-600"></i>
          </div>
          <div>
            <label class="block text-lg font-bold text-gray-900 m-0">Detalles del Movimiento</label>
            <p class="text-sm text-gray-600 m-0">Cantidad y descripci칩n del movimiento</p>
          </div>
        </div>
        
        <!-- Campo de Cantidad Mejorado -->
        <div class="mb-5">
          <label for="cantidad" class="flex items-center gap-2 font-semibold text-gray-700 mb-2">
            <i class="pi pi-hashtag text-green-600"></i>
            Cantidad de Unidades*
          </label>
          
          <div class="flex items-center gap-4">
            <p-inputNumber 
              id="cantidad" 
              [(ngModel)]="movimiento.cantidad"
              [showButtons]="true"
              buttonLayout="horizontal"
              [min]="1"
              [max]="inventarioSeleccionado?.cantidad || 9999"
              [step]="1"
              decrementButtonClass="p-button-danger"
              incrementButtonClass="p-button-success"
              incrementButtonIcon="pi pi-plus"
              decrementButtonIcon="pi pi-minus"
              [ngClass]="{'ng-invalid': submitted && (!movimiento.cantidad || movimiento.cantidad <= 0)}"
              [style]="{'width':'250px'}"
              class="flex-shrink-0"
            />
            
            <div *ngIf="inventarioSeleccionado" class="flex-1">
              <div class="bg-blue-50 rounded-lg p-3 border border-blue-200">
                <div class="flex items-center gap-2 text-sm">
                  <i class="pi pi-info-circle text-blue-600"></i>
                  <span class="text-blue-900">
                    <span class="font-semibold">Stock disponible:</span> {{inventarioSeleccionado.cantidad}} unidades
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <small class="text-red-600 flex items-center gap-1 mt-2" *ngIf="submitted && (!movimiento.cantidad || movimiento.cantidad <= 0)">
            <i class="pi pi-exclamation-circle"></i>
            La cantidad debe ser mayor a 0.
          </small>
          
          <div class="bg-orange-50 rounded-lg p-3 mt-2 border-l-4 border-orange-500" 
               *ngIf="movimiento.tipo === 'SALIDA' && inventarioSeleccionado && movimiento.cantidad > inventarioSeleccionado.cantidad">
            <div class="flex items-start gap-2">
              <i class="pi pi-exclamation-triangle text-orange-600 mt-0.5"></i>
              <div class="flex-1">
                <div class="font-semibold text-orange-900">丘멆잺 Advertencia de Stock</div>
                <div class="text-sm text-orange-800 mt-1">
                  La cantidad ingresada ({{movimiento.cantidad}}) excede el stock disponible ({{inventarioSeleccionado.cantidad}}). 
                  El sistema permitir치 el registro, pero se recomienda verificar la disponibilidad real.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Campo de Descripci칩n Mejorado -->
        <div class="mb-5">
          <label for="descripcion" class="flex items-center gap-2 font-semibold text-gray-700 mb-2">
            <i class="pi pi-align-left text-indigo-600"></i>
            Descripci칩n del Movimiento*
          </label>
          <textarea 
            id="descripcion" 
            pInputTextarea 
            class="w-full" 
            [(ngModel)]="movimiento.descripcion"
            rows="3" 
            placeholder="游닇 Describe el motivo y contexto del movimiento (ej: Venta a cliente, devoluci칩n de proveedor, ajuste por inventario f칤sico...)"
            [ngClass]="{'ng-invalid': submitted && !movimiento.descripcion.trim()}"
          ></textarea>
          <div class="flex justify-between items-center mt-1">
            <small class="text-red-600 flex items-center gap-1" *ngIf="submitted && !movimiento.descripcion?.trim()">
              <i class="pi pi-exclamation-circle"></i>
              La descripci칩n es obligatoria.
            </small>
            <small class="text-gray-500" *ngIf="!submitted || movimiento.descripcion?.trim()">
              {{movimiento.descripcion.length || 0}} caracteres
            </small>
          </div>
        </div>

        <!-- Campo de Referencia Mejorado -->
        <div>
          <label for="referencia" class="flex items-center gap-2 font-semibold text-gray-700 mb-2">
            <i class="pi pi-tag text-purple-600"></i>
            Referencia / Documento*
          </label>
          <div class="relative">
            <i class="pi pi-hashtag absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input 
              type="text" 
              pInputText 
              id="referencia" 
              [(ngModel)]="movimiento.referencia"
              class="w-full pl-10"
              placeholder="Ej: FAC-2024-001, OC-123456, AJUSTE-INV-001..."
              [ngClass]="{'ng-invalid': submitted && !movimiento.referencia.trim()}" 
            />
          </div>
          <small class="text-red-600 flex items-center gap-1 mt-2" *ngIf="submitted && !movimiento.referencia?.trim()">
            <i class="pi pi-exclamation-circle"></i>
            La referencia es obligatoria.
          </small>
          <small class="text-gray-500 flex items-center gap-1 mt-1" *ngIf="!submitted || movimiento.referencia?.trim()">
            <i class="pi pi-info-circle text-xs"></i>
            Ingresa el n칰mero de factura, orden de compra o documento relacionado
          </small>
        </div>
      </div>
    </div>
  </ng-template>
  
  <!-- Footer personalizado mejorado -->
  <ng-template pTemplate="footer">
    <div class="bg-gradient-to-r from-gray-50 to-blue-50 -m-6 mt-0 p-5 border-t-2 border-gray-200">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        
        <!-- Informaci칩n de ayuda -->
        <div class="flex items-center gap-2 text-sm text-gray-600">
          <i class="pi pi-info-circle text-blue-600"></i>
          <span class="hidden sm:inline">Completa todos los campos obligatorios (*)</span>
          <span class="sm:hidden">Campos obligatorios (*)</span>
        </div>
        
        <!-- Botones de acci칩n -->
        <div class="flex items-center gap-3 w-full sm:w-auto">
          <button 
            pButton 
            pRipple 
            label="Cancelar" 
            icon="pi pi-times" 
            severity="secondary"
            [outlined]="true"
            size="large"
            class="flex-1 sm:flex-none"
            (click)="hideDialog()"
            [disabled]="loading">
          </button>
          
          <button 
            pButton 
            pRipple 
            [label]="editMode ? 'Actualizar Movimiento' : 'Crear Movimiento'" 
            [icon]="editMode ? 'pi pi-save' : 'pi pi-check-circle'" 
            severity="success"
            size="large"
            class="flex-1 sm:flex-none font-bold shadow-lg"
            (click)="guardarMovimiento()"
            [loading]="loading">
          </button>
        </div>
      </div>
      
      <!-- Barra de progreso cuando est치 guardando -->
      <div *ngIf="loading" class="mt-3">
        <div class="bg-blue-100 rounded-full h-1.5 overflow-hidden">
          <div class="bg-gradient-to-r from-blue-600 to-indigo-600 h-full animate-pulse"></div>
        </div>
        <p class="text-center text-sm text-gray-600 mt-2 flex items-center justify-center gap-2">
          <i class="pi pi-spin pi-spinner"></i>
          {{ editMode ? 'Actualizando movimiento...' : 'Creando movimiento...' }}
        </p>
      </div>
    </div>
  </ng-template>
</p-dialog>

<!-- NUEVO: Sidebar de detalles del movimiento -->
<p-sidebar 
  [(visible)]="detallesSidebarVisible" 
  position="right" 
  [style]="{width: '500px'}"
  (onHide)="cerrarDetalles()"
>
  <ng-template pTemplate="header">
    <div class="flex items-center gap-3">
      <div class="bg-gradient-to-br from-blue-600 to-indigo-600 p-2 rounded-lg">
        <i class="pi pi-info-circle text-white text-xl"></i>
      </div>
      <div>
        <h3 class="m-0 font-bold text-gray-900">Detalles del Movimiento</h3>
        <p class="m-0 text-sm text-gray-600" *ngIf="movimientoDetalle">ID: {{movimientoDetalle.id}}</p>
      </div>
    </div>
  </ng-template>
  
  <div *ngIf="movimientoDetalle" class="space-y-4">
    <!-- Estado del movimiento -->
    <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 border border-blue-200">
      <div class="flex items-center justify-between mb-3">
        <span class="font-semibold text-gray-700">Estado</span>
        <p-tag 
          [value]="getEstadoMovimiento(movimientoDetalle)" 
          [severity]="getEstadoSeverity(getEstadoMovimiento(movimientoDetalle))"
          [style]="{'font-size': '0.875rem', 'padding': '0.5rem 0.75rem'}"
        ></p-tag>
      </div>
    </div>
    
    <!-- Tipo de movimiento -->
    <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm">
      <div class="flex items-center gap-3 mb-3">
        <div class="bg-purple-100 p-2 rounded-lg">
          <i [class]="getTipoIcon(movimientoDetalle.tipo) + ' text-purple-600'"></i>
        </div>
        <div>
          <div class="text-sm text-gray-600">Tipo de Movimiento</div>
          <div class="font-bold text-lg text-gray-900">{{movimientoDetalle.tipo}}</div>
        </div>
      </div>
    </div>
    
    <!-- Informaci칩n del producto -->
    <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-4 border border-purple-200">
      <h4 class="font-bold text-gray-900 mb-3 flex items-center gap-2">
        <i class="pi pi-box text-purple-600"></i>
        Informaci칩n del Producto
      </h4>
      
      <div class="space-y-3">
        <div class="flex justify-between items-center">
          <span class="text-gray-600">Producto:</span>
          <span class="font-semibold text-gray-900">{{movimientoDetalle.producto?.nombre || 'N/A'}}</span>
        </div>
        
        <div class="flex justify-between items-center">
          <span class="text-gray-600">Color:</span>
          <div class="flex items-center gap-2">
            <div class="w-4 h-4 rounded-full border-2 border-white shadow-sm"
                 [style.background-color]="movimientoDetalle.color?.codigoHex || '#ccc'">
            </div>
            <span class="font-semibold text-gray-900">{{movimientoDetalle.color?.nombre || 'N/A'}}</span>
          </div>
        </div>
        
        <div class="flex justify-between items-center">
          <span class="text-gray-600">Talla:</span>
          <span class="font-semibold text-gray-900">{{movimientoDetalle.talla?.numero || 'N/A'}}</span>
        </div>
        
        <div class="flex justify-between items-center">
          <span class="text-gray-600">Serie:</span>
          <span class="font-mono text-sm font-semibold text-gray-900">{{movimientoDetalle.inventarioId}}</span>
        </div>
      </div>
    </div>
    
    <!-- Cantidad destacada -->
    <div class="bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl p-5 text-white shadow-lg">
      <div class="text-center">
        <div class="text-sm font-medium opacity-90 mb-2">Cantidad Movida</div>
        <div class="text-5xl font-bold">{{movimientoDetalle.cantidad}}</div>
        <div class="text-sm font-medium opacity-90 mt-2">unidades</div>
      </div>
    </div>
    
    <!-- Informaci칩n adicional -->
    <div class="bg-white rounded-xl p-4 border border-gray-200 shadow-sm space-y-3">
      <div>
        <div class="text-sm font-semibold text-gray-600 mb-1">Descripci칩n</div>
        <div class="text-gray-900">{{movimientoDetalle.descripcion}}</div>
      </div>
      
      <div>
        <div class="text-sm font-semibold text-gray-600 mb-1">Referencia</div>
        <div class="font-mono text-sm text-gray-900">{{movimientoDetalle.referencia}}</div>
      </div>
      
      <div class="flex justify-between items-center pt-3 border-t border-gray-200">
        <span class="text-gray-600">Usuario:</span>
        <div class="flex items-center gap-2">
          <div class="bg-gray-100 p-1.5 rounded-full">
            <i class="pi pi-user text-gray-600 text-xs"></i>
          </div>
          <span class="font-semibold text-gray-900">{{movimientoDetalle.usuario}}</span>
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <span class="text-gray-600">Fecha:</span>
        <div class="text-right">
          <div class="font-semibold text-gray-900">{{movimientoDetalle.fechaMovimiento | date:'dd/MM/yyyy'}}</div>
          <div class="text-sm text-gray-600">{{movimientoDetalle.fechaMovimiento | date:'HH:mm:ss'}}</div>
        </div>
      </div>
    </div>
    
    <!-- Acciones r치pidas -->
    <div class="flex gap-2 pt-4">
      <button 
        pButton 
        label="Duplicar" 
        icon="pi pi-copy" 
        severity="success"
        [outlined]="true"
        size="small"
        class="flex-1"
        (click)="duplicarMovimiento(movimientoDetalle); cerrarDetalles()"
      ></button>
      <button 
        pButton 
        label="Revertir" 
        icon="pi pi-replay" 
        severity="danger"
        [outlined]="true"
        size="small"
        class="flex-1"
        (click)="revertirMovimiento(movimientoDetalle); cerrarDetalles()"
      ></button>
    </div>
    
    <button 
      pButton 
      label="Imprimir Ticket" 
      icon="pi pi-print" 
      severity="secondary"
      [outlined]="true"
      size="small"
      class="w-full"
      (click)="imprimirTicket(movimientoDetalle)"
    ></button>
  </div>
</p-sidebar>

<!-- NUEVO: Di치logo de gr치ficos -->
<p-dialog 
  [(visible)]="graficosDialogVisible" 
  [style]="{width: '90vw', maxWidth: '1200px'}" 
  header="Evoluci칩n de Movimientos de Inventario" 
  [modal]="true"
  [contentStyle]="{'padding': '1.5rem'}"
>
  <div *ngIf="chartData" class="bg-white rounded-xl p-4">
    <div class="mb-4">
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border border-blue-200">
        <div class="flex items-center gap-3">
          <div class="bg-blue-600 p-2 rounded-lg">
            <i class="pi pi-chart-line text-white"></i>
          </div>
          <div>
            <h4 class="m-0 font-bold text-gray-900">An치lisis Temporal</h4>
            <p class="m-0 text-sm text-gray-600 mt-1">
              Visualizaci칩n de movimientos en el per칤odo seleccionado
            </p>
          </div>
        </div>
      </div>
    </div>
    
    <div style="height: 400px;">
      <p-chart type="line" [data]="chartData" [options]="chartOptions" [style]="{'height': '100%'}"></p-chart>
    </div>
    
    <!-- Estad칤sticas resumidas -->
    <div class="grid mt-6 gap-4">
      <div class="col-12 md:col-3">
        <div class="bg-green-50 rounded-lg p-4 border border-green-200">
          <div class="flex items-center gap-3">
            <div class="bg-green-500 p-2 rounded-lg">
              <i class="pi pi-arrow-down text-white"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-green-700">{{getEntradasHoy()}}</div>
              <div class="text-sm text-gray-600">Entradas</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 md:col-3">
        <div class="bg-orange-50 rounded-lg p-4 border border-orange-200">
          <div class="flex items-center gap-3">
            <div class="bg-orange-500 p-2 rounded-lg">
              <i class="pi pi-arrow-up text-white"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-orange-700">{{getSalidasHoy()}}</div>
              <div class="text-sm text-gray-600">Salidas</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 md:col-3">
        <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
          <div class="flex items-center gap-3">
            <div class="bg-blue-500 p-2 rounded-lg">
              <i class="pi pi-list text-white"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-blue-700">{{movimientosFiltrados.length}}</div>
              <div class="text-sm text-gray-600">Total Movimientos</div>
            </div>
          </div>
        </div>
      </div>
      
      <div class="col-12 md:col-3">
        <div class="bg-purple-50 rounded-lg p-4 border border-purple-200">
          <div class="flex items-center gap-3">
            <div class="bg-purple-500 p-2 rounded-lg">
              <i class="pi pi-dollar text-white"></i>
            </div>
            <div>
              <div class="text-2xl font-bold text-purple-700">S/{{getValorTotalMovimientos() | number:'1.0-0'}}</div>
              <div class="text-sm text-gray-600">Valor Total</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center">
      <button 
        pButton 
        label="Exportar Gr치fico" 
        icon="pi pi-download" 
        severity="secondary"
        [outlined]="true"
        size="small"
        (click)="exportarExcelMejorado()"
      ></button>
      <button 
        pButton 
        label="Cerrar" 
        icon="pi pi-times" 
        class="p-button-text"
        (click)="graficosDialogVisible = false"
      ></button>
    </div>
  </ng-template>
</p-dialog>