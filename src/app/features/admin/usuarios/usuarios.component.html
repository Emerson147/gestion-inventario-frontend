<app-toast-notification
  [toasts]="toastService.getCurrentToasts()"
  (toastDismissed)="onToastDismissed($event)"
></app-toast-notification>

<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<!-- Header con dashboard metrics mejorado -->
<div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 mb-6 shadow-sm border border-surface-200 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
  
  <div class="absolute top-0 right-0 w-64 h-64 bg-surface-50 dark:bg-surface-800 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 opacity-60 pointer-events-none"></div>

  <div class="flex flex-col xl:flex-row justify-between items-start xl:items-center gap-8 relative z-10">
    
    <div class="flex items-center gap-5">
      <div class="w-16 h-16 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-100 dark:border-surface-700 shadow-sm">
        <i class="pi pi-users text-3xl"></i>
      </div>
      <div>
        <h1 class="text-3xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight">
          Gestión de Usuarios
        </h1>
        <p class="text-sm text-surface-500 dark:text-surface-400 mt-1 mb-0 flex items-center gap-2">
          <span>Administración de accesos</span>
          <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
          <span class="font-medium text-primary-600 dark:text-primary-400">Directorio del Sistema</span>
        </p>
      </div>
    </div>

    <div class="flex flex-wrap items-center gap-8 bg-surface-50 dark:bg-surface-800/50 px-8 py-4 rounded-2xl border border-surface-100 dark:border-surface-700/50" *ngIf="users && users.length > 0">
      
      <div class="flex flex-col items-center">
         <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-1">Total</span>
         <span class="text-2xl font-bold text-surface-900 dark:text-surface-0 leading-none">
            {{ calcularMetricasUsuarios().total | number }}
         </span>
      </div>

      <div class="hidden sm:block w-px h-8 bg-surface-200 dark:bg-surface-700"></div>

      <div class="flex flex-col items-center">
         <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-1 text-emerald-600 dark:text-emerald-400">Activos</span>
         <span class="text-2xl font-bold text-emerald-600 dark:text-emerald-400 leading-none">
            {{ calcularMetricasUsuarios().activos | number }}
         </span>
      </div>

      <div class="hidden sm:block w-px h-8 bg-surface-200 dark:bg-surface-700"></div>

      <div class="flex flex-col items-center">
         <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-1 text-rose-600 dark:text-rose-400">Admins</span>
         <span class="text-2xl font-bold text-rose-600 dark:text-rose-400 leading-none">
            {{ calcularMetricasUsuarios().admins | number }}
         </span>
      </div>

      <div class="hidden sm:block w-px h-8 bg-surface-200 dark:bg-surface-700"></div>

      <div class="flex flex-col items-center">
         <span class="text-[10px] font-bold text-surface-400 uppercase tracking-widest mb-1 text-purple-600 dark:text-purple-400">Nuevos</span>
         <span class="text-2xl font-bold text-purple-600 dark:text-purple-400 leading-none">
            {{ calcularMetricasUsuarios().nuevosUsuarios | number }}
         </span>
      </div>

    </div>
  </div>
</div>


<!-- Toolbar estilo dashboard limpio -->
<div class="sticky top-4 z-40 mb-8 px-2">
  <div class="bg-white dark:bg-surface-900 rounded-2xl p-3 shadow-lg border border-surface-200 dark:border-surface-700 flex flex-col sm:flex-row items-center justify-between gap-4 transition-all duration-300">
    
    <div class="flex items-center gap-2 w-full sm:w-auto">
      
      <button
        *appHasPermission="{ module: 'usuarios', permission: permissionTypes.CREATE }"
        (click)="openNew()"
        class="group relative px-6 py-3 bg-primary-600 hover:bg-primary-700 dark:bg-primary-500 dark:hover:bg-primary-400 text-white rounded-xl font-bold transition-all duration-300 hover:shadow-lg hover:-translate-y-0.5 active:scale-95 flex items-center gap-3 overflow-hidden flex-1 sm:flex-none justify-center shadow-md"
      >
        <i class="pi pi-user-plus text-sm"></i>
        <span>Nuevo Usuario</span>
      </button>

      <div *ngIf="selectedUsers?.length" class="animate-fade-in flex items-center ml-1 flex-1 sm:flex-none">
          <button
            *appHasPermission="{ module: 'usuarios', permission: permissionTypes.DELETE }"
            (click)="deleteSelectedUsers()"
            class="w-full sm:w-auto px-5 py-3 bg-red-50 dark:bg-red-900/20 hover:bg-red-100 dark:hover:bg-red-900/30 text-red-600 dark:text-red-400 rounded-xl font-bold transition-all duration-200 flex items-center justify-center gap-2 border border-red-100 dark:border-red-900/50 hover:shadow-md active:scale-95"
          >
            <i class="pi pi-trash text-sm"></i>
            <span>Eliminar ({{ selectedUsers.length }})</span>
          </button>
      </div>
    </div>

    <div class="flex items-center gap-2 bg-surface-50 dark:bg-surface-800 p-1.5 rounded-xl border border-surface-100 dark:border-surface-700 w-full sm:w-auto justify-between sm:justify-end">
      
      <div class="flex bg-white dark:bg-surface-900 rounded-lg p-1 shadow-sm border border-surface-100 dark:border-surface-700">
        <button 
            *ngFor="let option of viewOptions"
            (click)="currentView = option.value"
            class="w-9 h-9 flex items-center justify-center rounded-md transition-all duration-200 relative"
            [ngClass]="currentView === option.value 
                ? 'bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 shadow-md scale-105 z-10' 
                : 'text-surface-400 hover:text-surface-600 dark:hover:text-surface-300 hover:bg-surface-50 dark:hover:bg-surface-800'"
            pTooltip="{{ option.icon.includes('table') ? 'Vista Tabla' : 'Vista Tarjetas' }}"
            tooltipPosition="top">
            <i [class]="option.icon"></i>
        </button>
      </div>

      <div class="w-px h-6 bg-surface-200 dark:bg-surface-700 mx-1"></div>

      <div class="flex gap-1">
          <button
            (click)="loadUsers()"
            class="w-10 h-10 flex items-center justify-center rounded-lg text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 hover:bg-white dark:hover:bg-surface-700 transition-all active:scale-90"
            pTooltip="Actualizar Lista">
            <i class="pi pi-refresh" [class.animate-spin]="loading"></i>
          </button>

          <button
            (click)="mostrarEstadisticas()"
            class="w-10 h-10 flex items-center justify-center rounded-lg text-surface-500 hover:text-purple-600 hover:bg-purple-50 dark:hover:bg-purple-900/20 transition-all active:scale-90"
            pTooltip="Analíticas">
            <i class="pi pi-chart-pie"></i>
          </button>

          <button
            (click)="exportarExcel()"
            [disabled]="!usersFiltrados.length"
            class="w-10 h-10 flex items-center justify-center rounded-lg text-surface-500 hover:text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 transition-all active:scale-90 disabled:opacity-30 disabled:hover:bg-transparent"
            pTooltip="Exportar Excel">
            <i class="pi pi-download"></i>
          </button>
      </div>

    </div>
  </div>
</div>

<!-- Vista de Tabla (mejor en pantallas grandes) -->
<div *ngIf="currentView === 'table'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 border border-surface-200 dark:border-surface-800 rounded-[2rem] overflow-hidden shadow-sm transition-colors duration-300">
    
    <p-table
      #dt
      [value]="usersFiltrados"
      [rows]="10"
      [paginator]="true"
      [totalRecords]="usersFiltrados.length"
      [globalFilterFields]="['nombres', 'apellidos', 'username', 'email']"
      [(selection)]="selectedUsers"
      [rowHover]="true"
      dataKey="id"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} de {totalRecords}"
      [rowsPerPageOptions]="[5, 10, 20]"
      [loading]="loading"
      [tableStyle]="{ 'min-width': '80rem' }"
      styleClass="p-datatable-lg" 
    >
      <ng-template pTemplate="caption">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-100 dark:border-surface-800">
          
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-surface-400">
              <i class="pi pi-list text-xl"></i>
            </div>
            <div>
              <h3 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0">Directorio de Usuarios</h3>
              <p class="text-sm text-surface-500 dark:text-surface-400 mt-0.5">
                <span *ngIf="usersFiltrados.length">{{ usersFiltrados.length }} registros activos</span>
                <span *ngIf="!usersFiltrados.length">Listado maestro</span>
              </p>
            </div>
          </div>

          <div class="relative group w-full md:w-auto">
            <i class="pi pi-search absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 group-focus-within:text-primary-500 transition-colors text-lg"></i>
            <input
              pInputText
              type="text"
              (input)="onGlobalFilter(dt, $event)"
              placeholder="Buscar..."
              class="pl-12 pr-4 py-3 w-full md:w-80 bg-surface-50 dark:bg-surface-800 border-none rounded-2xl text-base focus:ring-2 focus:ring-primary-100 dark:focus:ring-primary-900 transition-all shadow-inner text-surface-700 dark:text-surface-200"
            />
          </div>
        </div>
      </ng-template>

      <ng-template pTemplate="header">
        <tr class="bg-surface-50/50 dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800">
          <th style="width: 3rem" class="text-center py-5">
            <p-tableHeaderCheckbox />
          </th>
          
          <th style="width: 6rem" class="text-center py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Perfil
          </th>
          
          <th pSortableColumn="username" class="py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
            <div class="flex items-center gap-2">Usuario <p-sortIcon field="username" /></div>
          </th>
          
          <th pSortableColumn="nombres" class="py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
            <div class="flex items-center gap-2">Identidad <p-sortIcon field="nombres" /></div>
          </th>
          
          <th pSortableColumn="email" class="py-5 text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
            <div class="flex items-center gap-2">Contacto <p-sortIcon field="email" /></div>
          </th>
          
          <th class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Roles
          </th>
          
          <th class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Estado
          </th>
          
          <th pSortableColumn="fechaCreacion" class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider cursor-pointer hover:text-primary-600 transition-colors">
             Registro <p-sortIcon field="fechaCreacion" />
          </th>
          
          <th style="width: 10rem" class="py-5 text-center text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">
            Acciones
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-usuario>
        <tr class="group border-b border-surface-100 dark:border-surface-800 hover:bg-surface-50 dark:hover:bg-surface-800/50 transition-all duration-200">
          
          <td class="text-center py-6">
            <p-tableCheckbox [value]="usuario" />
          </td>
          
          <td class="text-center py-6">
            <div class="relative inline-block cursor-pointer" (click)="verDetallesUsuario(usuario)">
              <p-avatar 
                [image]="getAvatarUrl(usuario)" 
                [label]="getInitials(usuario)" 
                size="large" 
                shape="circle" 
                styleClass="shadow-sm border border-surface-200 dark:border-surface-700 bg-surface-100 text-surface-700 dark:bg-surface-800 dark:text-surface-200 font-bold transition-transform group-hover:scale-110"
              ></p-avatar>
              
              <div 
                class="absolute bottom-0 right-0 w-3.5 h-3.5 rounded-full border-2 border-white dark:border-surface-900"
                [ngClass]="usuario.activo ? 'bg-emerald-500' : 'bg-surface-400'"
              ></div>
            </div>
          </td>

          <td class="py-6">
             <span class="font-bold text-surface-900 dark:text-surface-0 text-base block cursor-pointer hover:text-primary-600 transition-colors" (click)="verDetallesUsuario(usuario)">
                {{ usuario.username }}
             </span>
             <span class="text-xs text-surface-400 font-mono mt-1 block">ID: {{ usuario.id }}</span>
          </td>

          <td class="py-6">
             <div class="text-base font-medium text-surface-700 dark:text-surface-200">
               {{ usuario.nombres }} {{ usuario.apellidos }}
             </div>
          </td>

          <td class="py-6">
             <div class="text-base text-surface-600 dark:text-surface-300">
                {{ usuario.email }}
             </div>
          </td>

          <td class="py-6 text-center">
             <div class="flex justify-center flex-wrap gap-2">
                <span 
                  *ngFor="let rol of usuario.roles.slice(0,2)" 
                  class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold border"
                  [ngClass]="{
                    'bg-indigo-50 text-indigo-700 border-indigo-200 dark:bg-indigo-900/30 dark:text-indigo-200 dark:border-indigo-700': rol === 'ADMIN',
                    'bg-white text-surface-600 border-surface-200 dark:bg-surface-800 dark:text-surface-300 dark:border-surface-700': rol !== 'ADMIN'
                  }"
                >
                   {{ getRoleLabel([rol]) }}
                </span>
                <span *ngIf="usuario.roles.length > 2" class="text-xs font-bold text-surface-400 py-1 px-1">
                   +{{usuario.roles.length - 2}}
                </span>
             </div>
          </td>

          <td class="py-6 text-center">
             <div class="inline-flex items-center gap-2">
                <span class="w-2 h-2 rounded-full" [ngClass]="usuario.activo ? 'bg-emerald-500' : 'bg-surface-400'"></span>
                <span class="text-sm font-medium" [ngClass]="usuario.activo ? 'text-surface-700 dark:text-surface-200' : 'text-surface-500'">
                    {{ usuario.activo ? 'Activo' : 'Inactivo' }}
                </span>
             </div>
          </td>

          <td class="py-6 text-center">
             <div class="flex flex-col">
                <span class="text-sm font-semibold text-surface-700 dark:text-surface-200">{{ usuario.fechaCreacion | date : "dd MMM yyyy" }}</span>
                <span class="text-xs text-surface-400 mt-0.5">{{ usuario.fechaCreacion | date : "HH:mm" }}</span>
             </div>
          </td>

          <td class="py-6 text-center">
            <div class="flex gap-2 justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-200">
              
              <button (click)="verDetallesUsuario(usuario)" class="w-9 h-9 flex items-center justify-center rounded-xl bg-surface-100 dark:bg-surface-800 text-surface-500 hover:text-primary-600 hover:bg-primary-50 dark:hover:bg-primary-900/20 transition-all" pTooltip="Ver" tooltipPosition="top">
                <i class="pi pi-eye"></i>
              </button>
              
              <button *appHasPermission="{module: 'usuarios', permission: permissionTypes.EDIT}" (click)="editUser(usuario)" class="w-9 h-9 flex items-center justify-center rounded-xl bg-surface-100 dark:bg-surface-800 text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 hover:bg-white border border-transparent hover:border-surface-200 dark:hover:border-surface-600 transition-all shadow-sm" pTooltip="Editar" tooltipPosition="top">
                <i class="pi pi-pencil"></i>
              </button>
              
              <button *appHasPermission="{module: 'usuarios', permission: permissionTypes.DELETE}" (click)="deleteUser(usuario)" class="w-9 h-9 flex items-center justify-center rounded-xl bg-surface-100 dark:bg-surface-800 text-surface-500 hover:text-red-600 hover:bg-red-50 dark:hover:bg-red-900/20 transition-all" pTooltip="Eliminar" tooltipPosition="top">
                <i class="pi pi-trash"></i>
              </button>

            </div>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="9" class="text-center py-32">
            <div class="flex flex-col items-center justify-center">
                <div class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6">
                    <i class="pi pi-search text-4xl text-surface-300 dark:text-surface-600"></i>
                </div>
                <h4 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">No se encontraron resultados</h4>
                <p class="text-surface-500 text-base max-w-sm mx-auto">Intenta ajustar tus términos de búsqueda.</p>
                
                <button 
                    *appHasPermission="{module: 'usuarios', permission: permissionTypes.CREATE}"
                    (click)="openNew()"
                    class="mt-8 px-6 py-3 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-xl text-sm font-bold shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all">
                    Crear Usuario
                </button>
            </div>
          </td>
        </tr>
      </ng-template>

    </p-table>
  </div>
</div>

<!-- Vista de Cards Premium Mejorada -->
<div *ngIf="currentView === 'cards'" class="mb-8 animate-fade-in">
  
  <div class="bg-white dark:bg-surface-900 rounded-[2.5rem] p-8 shadow-sm border border-surface-100 dark:border-surface-800 relative overflow-hidden transition-colors duration-300">
    
    <div class="absolute top-0 left-0 w-full h-40 bg-gradient-to-b from-surface-50 dark:from-surface-800 to-transparent pointer-events-none"></div>

    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 relative z-10">
        <div class="flex items-start gap-4">
            <div class="w-14 h-14 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-500 shadow-sm border border-surface-100 dark:border-surface-700">
                <i class="pi pi-id-card text-2xl"></i>
            </div>
            <div class="flex flex-col">
                <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight">
                    Galería de Perfiles
                </h3>
                <div class="flex items-center gap-2 text-surface-500 dark:text-surface-400 text-sm mt-1">
                    <span>Visualización de tarjetas</span>
                    <span class="w-1 h-1 rounded-full bg-surface-300 dark:bg-surface-600"></span>
                    <span class="font-semibold text-primary-600 dark:text-primary-400">
                        {{ usersFiltrados.length || 0 }} usuarios
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="relative z-10">
        
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6" *ngIf="!loading; else loadingCards">
            
            <div 
                *appHasPermission="{ module: 'usuarios', permission: permissionTypes.CREATE }"
                (click)="openNew()"
                class="group relative h-[340px] rounded-3xl border-2 border-dashed border-surface-200 dark:border-surface-700 hover:border-primary-400 dark:hover:border-primary-500/50 bg-surface-50/50 dark:bg-surface-800/20 hover:bg-surface-0 dark:hover:bg-surface-800 transition-all duration-300 cursor-pointer flex flex-col items-center justify-center gap-4 overflow-hidden"
            >
                <div class="w-20 h-20 rounded-full bg-white dark:bg-surface-800 shadow-sm group-hover:shadow-md group-hover:scale-110 transition-all duration-300 flex items-center justify-center text-surface-400 group-hover:text-primary-500">
                    <i class="pi pi-user-plus text-3xl"></i>
                </div>
                <div class="text-center z-10 px-4">
                    <h4 class="font-bold text-lg text-surface-600 dark:text-surface-300 group-hover:text-primary-600 dark:group-hover:text-primary-400 transition-colors">Registrar Usuario</h4>
                    <span class="text-xs text-surface-400 dark:text-surface-500 mt-1 block">Añadir nuevo miembro al equipo</span>
                </div>
            </div>

            <div 
              *ngFor="let usuario of usersFiltrados; trackBy: trackByUsuario; let i = index"
              class="group relative bg-surface-0 dark:bg-surface-900 rounded-3xl border border-surface-200 dark:border-surface-700 hover:border-primary-200 dark:hover:border-primary-800 shadow-sm hover:shadow-xl hover:-translate-y-1 transition-all duration-300 flex flex-col overflow-hidden h-[340px]"
              style="animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) backwards"
              [style.animation-delay]="(i * 50) + 'ms'"
            >
                <div class="absolute top-3 right-3 z-20 flex gap-1 opacity-0 group-hover:opacity-100 transition-all duration-200 translate-x-2 group-hover:translate-x-0">
                    <button 
                        (click)="editUser(usuario); $event.stopPropagation()"
                        class="w-8 h-8 rounded-full bg-white/90 dark:bg-surface-800/90 backdrop-blur shadow text-surface-500 hover:text-surface-900 dark:hover:text-surface-0 transition-colors"
                        pTooltip="Editar">
                        <i class="pi pi-pencil text-xs"></i>
                    </button>
                    <button 
                        (click)="deleteUser(usuario); $event.stopPropagation()"
                        class="w-8 h-8 rounded-full bg-white/90 dark:bg-surface-800/90 backdrop-blur shadow text-surface-500 hover:text-red-500 transition-colors"
                        pTooltip="Eliminar">
                        <i class="pi pi-trash text-xs"></i>
                    </button>
                </div>

                <div class="relative h-[45%] bg-surface-50 dark:bg-surface-800/50 flex items-center justify-center cursor-pointer overflow-hidden" (click)="verDetallesUsuario(usuario)">
                    
                    <div class="absolute inset-0 bg-gradient-to-tr from-primary-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                    
                    <div class="relative transition-transform duration-300 group-hover:scale-105 z-10">
                        <p-avatar 
                            [image]="getAvatarUrl(usuario)" 
                            [label]="getInitials(usuario)" 
                            size="xlarge" 
                            shape="circle" 
                            styleClass="w-24 h-24 text-2xl border-4 border-white dark:border-surface-900 shadow-lg bg-white text-surface-700 font-bold"
                        ></p-avatar>
                        
                        <div class="absolute bottom-1 right-1 p-1 bg-white dark:bg-surface-900 rounded-full">
                            <div class="w-4 h-4 rounded-full border border-surface-100 dark:border-surface-700" 
                                 [ngClass]="usuario.activo ? 'bg-emerald-500' : 'bg-surface-400'"
                                 pTooltip="{{ usuario.activo ? 'Activo' : 'Inactivo' }}">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 p-6 flex flex-col justify-between bg-white dark:bg-surface-900 relative">
                    
                    <div class="text-center">
                        <h4 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0 truncate leading-tight" title="{{usuario.nombres}} {{usuario.apellidos}}">
                            {{ usuario.nombres }}
                        </h4>
                        <span class="text-xs text-surface-400 dark:text-surface-500 mt-1 block font-medium">
                            {{ '@' }}{{ usuario.username }}
                        </span>
                        
                        <div class="flex justify-center gap-1.5 mt-4 flex-wrap h-6 overflow-hidden">
                            <span *ngFor="let rol of usuario.roles.slice(0, 2)" 
                                  class="inline-flex items-center px-2.5 py-0.5 rounded-md text-[10px] font-bold uppercase tracking-wider border"
                                  [ngClass]="rol === 'ADMIN' 
                                    ? 'bg-indigo-50 text-indigo-600 border-indigo-100 dark:bg-indigo-900/20 dark:text-indigo-300 dark:border-indigo-800' 
                                    : 'bg-surface-50 text-surface-500 border-surface-200 dark:bg-surface-800 dark:text-surface-400 dark:border-surface-700'">
                                {{ getRoleLabel([rol]) }}
                            </span>
                            <span *ngIf="usuario.roles.length > 2" class="text-[10px] text-surface-300 flex items-center">+{{usuario.roles.length - 2}}</span>
                        </div>
                    </div>

                    <button 
                        (click)="verDetallesUsuario(usuario)" 
                        class="w-full py-2.5 mt-2 rounded-xl bg-surface-50 dark:bg-surface-800 text-xs font-bold text-surface-600 dark:text-surface-300 hover:bg-surface-900 hover:text-white dark:hover:bg-surface-0 dark:hover:text-surface-900 transition-all opacity-0 group-hover:opacity-100 transform translate-y-4 group-hover:translate-y-0 duration-300 flex items-center justify-center gap-2">
                        <span>Ver Perfil Completo</span>
                        <i class="pi pi-arrow-right text-[10px]"></i>
                    </button>
                </div>
            </div>
        </div>

        <ng-template #loadingCards>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                <div *ngFor="let i of [1,2,3,4]" class="bg-surface-0 dark:bg-surface-900 rounded-3xl border border-surface-100 dark:border-surface-800 h-[340px] overflow-hidden">
                    <div class="h-[45%] bg-surface-50 dark:bg-surface-800 animate-pulse"></div>
                    <div class="p-6 space-y-4">
                        <div class="h-6 bg-surface-100 dark:bg-surface-800 rounded w-3/4 mx-auto animate-pulse"></div>
                        <div class="h-4 bg-surface-50 dark:bg-surface-800 rounded w-1/2 mx-auto animate-pulse"></div>
                        <div class="mt-6 h-8 bg-surface-50 dark:bg-surface-800 rounded-xl animate-pulse"></div>
                    </div>
                </div>
            </div>
        </ng-template>

    </div>
  </div>
</div>

<!-- Diálogo premium para crear/editar usuario -->
<p-dialog
  [(visible)]="userDialog"
  [style]="{ width: '1100px', maxWidth: '95vw', height: 'auto', maxHeight: '90vh' }"
  [modal]="true"
  (onHide)="hideDialog()"
  [draggable]="false"
  [resizable]="false"
  [showHeader]="false"
  [dismissableMask]="true"
  styleClass="app-dialog-zen"
  [contentStyle]="{ padding: '0', 'border-radius': '1.5rem', overflow: 'hidden' }"
>
  <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-800 sticky top-0 z-50">
    <div class="flex flex-col">
      <h2 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight flex items-center gap-3">
        {{ editMode ? 'Editar Perfil' : 'Nuevo Usuario' }}
        <span *ngIf="editMode" class="px-3 py-1 rounded-lg bg-surface-100 dark:bg-surface-800 text-sm font-mono text-surface-600 dark:text-surface-300 font-normal border border-surface-200 dark:border-surface-700">
           ID: {{ user.id }}
        </span>
      </h2>
      <span class="text-surface-500 dark:text-surface-400 text-base mt-1">
        {{ editMode ? 'Actualizar credenciales y permisos.' : 'Registrar acceso al sistema.' }}
      </span>
    </div>
    
    <button 
      (click)="hideDialog()" 
      class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-100 dark:bg-surface-800 text-surface-500 hover:bg-surface-200 dark:hover:bg-surface-700 hover:text-surface-900 dark:hover:text-surface-0 transition-all duration-300">
      <i class="pi pi-times text-lg transition-transform duration-300 group-hover:rotate-90"></i>
    </button>
  </div>

  <div class="flex flex-col lg:flex-row h-[75vh] bg-surface-0 dark:bg-surface-900">
    
    <div class="w-full lg:w-5/12 bg-surface-50 dark:bg-surface-800/50 p-10 border-r border-surface-200 dark:border-surface-800 flex flex-col items-center overflow-y-auto custom-scrollbar">
      
      <div class="relative group cursor-pointer mb-8">
          <div class="absolute inset-0 rounded-full bg-primary-200 dark:bg-primary-900/40 blur-3xl opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
          
          <div class="relative w-48 h-48 rounded-full p-1 bg-white dark:bg-surface-800 border-4 border-surface-200 dark:border-surface-700 shadow-xl group-hover:scale-105 transition-transform duration-300">
             <p-avatar
                [image]="getAvatarUrl(user)"
                [label]="getInitials(user)"
                styleClass="w-full h-full text-5xl rounded-full bg-surface-100 dark:bg-surface-700 text-surface-600 dark:text-surface-200 font-bold flex items-center justify-center"
             ></p-avatar>
             
             <div class="absolute bottom-2 right-2 w-12 h-12 bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 rounded-full flex items-center justify-center shadow-lg cursor-pointer hover:scale-110 transition-transform z-20">
                <i class="pi pi-camera text-lg"></i>
             </div>
          </div>
      </div>
      
      <div class="text-center w-full mb-8">
        <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 m-0 truncate px-4">
          {{ user.nombres || 'Nombre' }} {{ user.apellidos || 'Apellido' }}
        </h3>
        <p class="text-primary-600 dark:text-primary-400 font-medium text-lg mt-2">
          {{ user.username ? '@' + user.username : '@usuario' }}
        </p>
      </div>

      <div class="w-full bg-white dark:bg-surface-900 rounded-2xl p-6 border border-surface-200 dark:border-surface-700 shadow-sm hover:shadow-md transition-shadow">
          <div class="flex items-center justify-between mb-3">
             <span class="text-sm font-bold text-surface-500 dark:text-surface-400 uppercase tracking-wider">Acceso al Sistema</span>
             <p-inputSwitch [(ngModel)]="user.activo"></p-inputSwitch>
          </div>
          <div class="flex items-center gap-2">
             <div class="w-3 h-3 rounded-full" [ngClass]="user.activo ? 'bg-emerald-500' : 'bg-surface-400'"></div>
             <p class="text-base font-medium" [ngClass]="user.activo ? 'text-emerald-700 dark:text-emerald-400' : 'text-surface-500'">
                {{ user.activo ? 'Cuenta Habilitada' : 'Cuenta Suspendida' }}
             </p>
          </div>
      </div>

      <div *ngIf="editMode && user.fechaCreacion" class="mt-auto pt-8 text-center w-full">
         <div class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-surface-100 dark:bg-surface-800 text-sm text-surface-600 dark:text-surface-400 font-medium">
            <i class="pi pi-calendar"></i>
            <span>Miembro desde: {{ user.fechaCreacion | date:'longDate' }}</span>
         </div>
      </div>

    </div>

    <div class="w-full lg:w-7/12 p-10 overflow-y-auto custom-scrollbar">
      
      <section class="mb-12">
        <h4 class="text-sm font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-6 flex items-center gap-2">
          <i class="pi pi-id-card text-primary-500 text-lg"></i> Información Personal
        </h4>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="flex flex-col gap-3 group">
            <label class="text-base font-medium text-surface-700 dark:text-surface-200 group-focus-within:text-primary-600 transition-colors">Nombres <span class="text-red-500">*</span></label>
            <input 
                type="text" 
                pInputText 
                [(ngModel)]="user.nombres" 
                placeholder="Ej. Juan Carlos" 
                class="w-full h-14 px-4 bg-surface-50 dark:bg-surface-800 border-none rounded-xl text-lg text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-800 focus:bg-white dark:focus:bg-surface-900 transition-all shadow-inner placeholder:text-surface-400"
                [ngClass]="{'ring-2 ring-red-100 bg-red-50': submitted && !user.nombres}"
            />
            <small *ngIf="submitted && !user.nombres" class="text-red-500 text-sm font-medium flex items-center gap-1"><i class="pi pi-exclamation-circle"></i> Requerido</small>
          </div>

          <div class="flex flex-col gap-3 group">
            <label class="text-base font-medium text-surface-700 dark:text-surface-200 group-focus-within:text-primary-600 transition-colors">Apellidos <span class="text-red-500">*</span></label>
            <input 
                type="text" 
                pInputText 
                [(ngModel)]="user.apellidos" 
                placeholder="Ej. Pérez Rodriguez" 
                class="w-full h-14 px-4 bg-surface-50 dark:bg-surface-800 border-none rounded-xl text-lg text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-800 focus:bg-white dark:focus:bg-surface-900 transition-all shadow-inner placeholder:text-surface-400"
                [ngClass]="{'ring-2 ring-red-100 bg-red-50': submitted && !user.apellidos}"
            />
            <small *ngIf="submitted && !user.apellidos" class="text-red-500 text-sm font-medium flex items-center gap-1"><i class="pi pi-exclamation-circle"></i> Requerido</small>
          </div>
        </div>
      </section>

      <section class="mb-12">
        <h4 class="text-sm font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-6 flex items-center gap-2">
          <i class="pi pi-shield text-primary-500 text-lg"></i> Credenciales
        </h4>

        <div class="grid grid-cols-1 gap-6 mb-6">
          <div class="flex flex-col gap-3 group">
            <label class="text-base font-medium text-surface-700 dark:text-surface-200 group-focus-within:text-primary-600 transition-colors">Email Corporativo <span class="text-red-500">*</span></label>
            <div class="relative">
                <i class="pi pi-envelope absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 text-lg"></i>
                <input 
                    type="email" 
                    pInputText 
                    [(ngModel)]="user.email" 
                    placeholder="usuario@empresa.com"
                    class="w-full h-14 pl-12 pr-4 bg-surface-50 dark:bg-surface-800 border-none rounded-xl text-lg text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-800 focus:bg-white dark:focus:bg-surface-900 transition-all shadow-inner placeholder:text-surface-400"
                    [ngClass]="{'ring-2 ring-red-100': submitted && (!user.email || !isValidEmail(user.email))}"
                />
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="flex flex-col gap-3 group">
                <label class="text-base font-medium text-surface-700 dark:text-surface-200 group-focus-within:text-primary-600 transition-colors">Username <span class="text-red-500">*</span></label>
                <div class="relative">
                    <i class="pi pi-at absolute left-4 top-1/2 -translate-y-1/2 text-surface-400 text-lg"></i>
                    <input 
                        type="text" 
                        pInputText 
                        [(ngModel)]="user.username" 
                        placeholder="nombre.apellido"
                        class="w-full h-14 pl-12 pr-4 bg-surface-50 dark:bg-surface-800 border-none rounded-xl text-lg text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-800 focus:bg-white dark:focus:bg-surface-900 transition-all shadow-inner placeholder:text-surface-400"
                        [ngClass]="{'ring-2 ring-red-100': submitted && !user.username}"
                    />
                </div>
            </div>

            <div class="flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <label class="text-base font-medium text-surface-700 dark:text-surface-200">Contraseña</label>
                    <span *ngIf="editMode" class="text-sm text-surface-400 italic">Opcional</span>
                </div>
                
                <p-password 
                    id="password" 
                    [(ngModel)]="user.password" 
                    [toggleMask]="true" 
                    [feedback]="true"
                    styleClass="w-full" 
                    inputStyleClass="w-full h-14 px-4 bg-surface-50 dark:bg-surface-800 border-none rounded-xl text-lg text-surface-900 dark:text-surface-0 focus:ring-2 focus:ring-primary-200 dark:focus:ring-primary-800 focus:bg-white dark:focus:bg-surface-900 transition-all shadow-inner placeholder:text-surface-400"
                    placeholder="••••••••" 
                    (ngModelChange)="calculatePasswordStrength($event)">
                </p-password>
                
                <div *ngIf="user.password" class="mt-1 h-2 w-full bg-surface-100 dark:bg-surface-800 rounded-full overflow-hidden">
                    <div class="h-full transition-all duration-500 ease-out rounded-full"
                        [style.width.%]="passwordStrength"
                        [ngClass]="{
                            'bg-red-500': passwordStrength < 50,
                            'bg-orange-500': passwordStrength >= 50 && passwordStrength < 75,
                            'bg-emerald-500': passwordStrength >= 75
                        }"></div>
                </div>
            </div>
        </div>
      </section>

      <section>
        <h4 class="text-sm font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-6 flex items-center gap-2">
          <i class="pi pi-briefcase text-primary-500 text-lg"></i> Roles del Sistema
        </h4>
        
        <div class="grid grid-cols-1 gap-4">
          <div *ngFor="let role of roleOptions" 
               class="relative flex items-center p-5 rounded-2xl border-2 transition-all duration-200 cursor-pointer group"
               [ngClass]="user.roles.includes(role.value) 
                  ? 'bg-primary-50 dark:bg-primary-900/20 border-primary-200 dark:border-primary-700 shadow-sm' 
                  : 'bg-white dark:bg-surface-900 border-surface-200 dark:border-surface-700 hover:border-surface-300 dark:hover:border-surface-600 hover:bg-surface-50 dark:hover:bg-surface-800'">
            
            <div class="flex items-center h-full">
                <p-checkbox [value]="role.value" [(ngModel)]="user.roles" [inputId]="'role-' + role.value" styleClass="scale-125"></p-checkbox>
            </div>
            
            <label [for]="'role-' + role.value" class="ml-5 flex-1 cursor-pointer">
              <div class="flex items-center gap-3 mb-1">
                <span class="text-lg font-bold text-surface-800 dark:text-surface-100">{{ role.label }}</span>
                <i [class]="role.icon" class="text-lg"
                   [ngClass]="user.roles.includes(role.value) ? 'text-primary-600 dark:text-primary-400' : 'text-surface-400'"></i>
              </div>
              <p class="text-sm text-surface-500 dark:text-surface-400 leading-relaxed">{{ role.description }}</p>
            </label>
          </div>
        </div>
        
        <div *ngIf="submitted && !user.roles?.length" class="mt-4 p-3 bg-red-50 dark:bg-red-900/20 rounded-xl border border-red-100 dark:border-red-900/50 flex items-center gap-3">
            <i class="pi pi-exclamation-circle text-red-500 text-xl"></i>
            <span class="text-red-700 dark:text-red-300 font-medium">Debes asignar al menos un rol al usuario.</span>
        </div>
      </section>

    </div>
  </div>

  <ng-template pTemplate="footer">
    <div class="px-10 py-6 bg-white dark:bg-surface-900 border-t border-surface-200 dark:border-surface-800 flex justify-end items-center gap-4 sticky bottom-0 z-50">
      <button 
        pButton 
        label="Cancelar" 
        class="p-button-text text-surface-600 dark:text-surface-300 hover:text-surface-900 dark:hover:text-surface-0 font-bold text-base px-6 py-3" 
        (click)="hideDialog()">
      </button>
      <button 
        pButton 
        [label]="editMode ? 'Guardar Cambios' : 'Crear Usuario'" 
        class="bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 hover:bg-black dark:hover:bg-surface-200 border-none px-8 py-3.5 rounded-xl font-bold text-base shadow-xl transition-all transform active:scale-95 flex items-center gap-2"
        (click)="saveUser()" 
        [loading]="loading">
        <i class="pi pi-check font-bold"></i>
      </button>
    </div>
  </ng-template>
</p-dialog>

<!-- Modal de Detalles del Usuario - Diseño limpio -->
<p-dialog
  [(visible)]="detalleUsuarioDialog"
  [style]="{ width: '600px', maxWidth: '90vw' }"
  [modal]="true"
  (onHide)="hideDetalleUsuarioDialog()"
  [contentStyle]="{ padding: '0', 'border-radius': '2rem', overflow: 'hidden' }"
  [showHeader]="false"
  styleClass="app-dialog-zen"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
>
  <div *ngIf="usuarioDetalle" class="flex flex-col h-full bg-white dark:bg-surface-900">
    
    <div class="relative bg-surface-50/50 dark:bg-surface-800/30 pt-12 pb-10 px-8 flex flex-col items-center border-b border-surface-200 dark:border-surface-700 overflow-hidden">
      
      <div class="absolute top-0 inset-x-0 h-full bg-gradient-to-b from-surface-0/50 to-transparent pointer-events-none"></div>
      
      <button
        (click)="hideDetalleUsuarioDialog()"
        class="absolute top-5 right-5 w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-surface-800 text-surface-400 hover:text-surface-900 dark:hover:text-surface-0 shadow-sm hover:shadow-md transition-all duration-200 z-20"
      >
        <i class="pi pi-times"></i>
      </button>

      <div class="relative mb-6 group z-10">
        <div class="absolute inset-0 bg-gradient-to-tr from-indigo-400 to-purple-400 rounded-full blur-2xl opacity-20 group-hover:opacity-40 transition-opacity duration-500"></div>
        
        <p-avatar
          [image]="getAvatarUrl(usuarioDetalle)"
          [label]="getInitials(usuarioDetalle)"
          size="xlarge"
          shape="circle"
          styleClass="w-32 h-32 text-4xl shadow-xl border-4 border-white dark:border-surface-900 relative z-10 bg-surface-200 text-surface-700 font-bold"
        ></p-avatar>
        
        <div class="absolute -bottom-2 left-1/2 -translate-x-1/2 z-20">
             <div class="flex items-center gap-1.5 px-3 py-1 rounded-full bg-white dark:bg-surface-900 border border-surface-100 dark:border-surface-700 shadow-sm">
                <div class="w-2 h-2 rounded-full" [ngClass]="usuarioDetalle.activo ? 'bg-emerald-500' : 'bg-surface-400'"></div>
                <span class="text-xs font-bold text-surface-700 dark:text-surface-200 uppercase tracking-wide">{{ getStatusLabel(usuarioDetalle.activo) }}</span>
             </div>
        </div>
      </div>

      <h3 class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-1 tracking-tight text-center relative z-10">
        {{ usuarioDetalle.nombres }} {{ usuarioDetalle.apellidos }}
      </h3>
      <span class="text-primary-600 dark:text-primary-400 font-medium text-base mt-1 relative z-10">
        {{ '@' + usuarioDetalle.username }}
      </span>
    </div>

    <div class="p-8 bg-surface-0 dark:bg-surface-900">
      
      <div class="mb-8 pb-8 border-b border-dashed border-surface-200 dark:border-surface-700">
        <span class="block text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-widest mb-4">
            Contacto & Rol
        </span>
        <div class="flex items-start justify-between mb-5">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-2xl bg-blue-50 dark:bg-blue-900/20 flex items-center justify-center text-blue-600 dark:text-blue-400">
                    <i class="pi pi-envelope text-xl"></i>
                </div>
                <div>
                    <p class="text-base font-bold text-surface-900 dark:text-surface-0 m-0">{{ usuarioDetalle.email }}</p>
                    <p class="text-sm text-surface-500 dark:text-surface-400 m-0">Correo Electrónico</p>
                </div>
            </div>
        </div>
        
        <div class="flex flex-wrap gap-2">
            <span *ngFor="let rol of usuarioDetalle.roles || []" 
                  class="inline-flex items-center px-3 py-1.5 rounded-lg text-sm font-bold bg-surface-50 dark:bg-surface-800 text-surface-700 dark:text-surface-200 border border-surface-200 dark:border-surface-700">
                <i class="pi pi-shield mr-2 text-primary-500 text-xs"></i>
                {{ getRoleLabel([rol]) }}
            </span>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-y-8 gap-x-4">
        
        <div *ngIf="usuarioDetalle.fechaCreacion">
            <div class="flex items-center gap-2 mb-1.5">
                <i class="pi pi-calendar text-emerald-500 dark:text-emerald-400 text-sm"></i>
                <span class="text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider">Registro</span>
            </div>
            <p class="text-base font-medium text-surface-900 dark:text-surface-0 ml-6">
                {{ usuarioDetalle.fechaCreacion | date : "dd MMM yyyy" }}
            </p>
        </div>

        <div *ngIf="usuarioDetalle.fechaActualizacion">
            <div class="flex items-center gap-2 mb-1.5">
                <i class="pi pi-history text-amber-500 dark:text-amber-400 text-sm"></i>
                <span class="text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider">Actualizado</span>
            </div>
            <p class="text-base font-medium text-surface-900 dark:text-surface-0 ml-6">
                {{ usuarioDetalle.fechaActualizacion | date : "dd MMM yyyy" }}
            </p>
        </div>

        <div class="col-span-2 mt-2">
            <div class="bg-surface-50 dark:bg-surface-800/50 rounded-xl p-4 flex items-center justify-between border border-surface-100 dark:border-surface-700 group hover:border-primary-200 dark:hover:border-primary-800 transition-colors cursor-default">
                <div class="flex items-center gap-3">
                     <i class="pi pi-database text-surface-400 dark:text-surface-500"></i>
                     <div class="flex flex-col">
                        <span class="text-[10px] uppercase font-bold text-surface-400 dark:text-surface-500 tracking-wider">UUID Sistema</span>
                        <span class="font-mono text-xs text-surface-600 dark:text-surface-300 select-all">{{ usuarioDetalle.id }}</span>
                     </div>
                </div>
            </div>
        </div>
      </div>

    </div>

    <div class="px-8 pb-8 pt-2 bg-surface-0 dark:bg-surface-900">
      <button
        *appHasPermission="{ module: 'usuarios', permission: permissionTypes.EDIT }"
        (click)="editUser(usuarioDetalle!); hideDetalleUsuarioDialog()"
        class="w-full py-4 rounded-2xl bg-surface-900 dark:bg-surface-0 text-white dark:text-surface-900 font-bold text-base shadow-xl hover:shadow-2xl hover:-translate-y-0.5 active:scale-[0.98] transition-all flex items-center justify-center gap-3 group"
      >
        <span>Editar Perfil</span>
        <i class="pi pi-arrow-right text-sm group-hover:translate-x-1 transition-transform"></i>
      </button>
      
      <button
         *ngIf="!canEditUsuarios()" 
         (click)="hideDetalleUsuarioDialog()"
         class="w-full py-4 rounded-2xl border border-surface-200 dark:border-surface-700 text-surface-600 dark:text-surface-300 font-bold text-base hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
         Cerrar
      </button>
    </div>
  </div>
</p-dialog>

<!-- Modal de Estadísticas -->
<p-dialog
  [(visible)]="estadisticasDialog"
  [style]="{ width: '1100px', maxWidth: '95vw', height: '85vh' }"
  [modal]="true"
  (onHide)="hideEstadisticasDialog()"
  [contentStyle]="{ padding: '0', 'border-radius': '1.5rem', overflow: 'hidden' }"
  [showHeader]="false"
  [draggable]="false"
  [resizable]="false"
  [dismissableMask]="true"
  styleClass="app-dialog-zen"
>
  <div class="flex justify-between items-center px-8 py-6 bg-white dark:bg-surface-900 border-b border-surface-200 dark:border-surface-700 sticky top-0 z-50">
    <div class="flex items-center gap-4">
      <div class="w-12 h-12 rounded-2xl bg-surface-50 dark:bg-surface-800 flex items-center justify-center text-primary-600 dark:text-primary-400 border border-surface-100 dark:border-surface-700">
        <i class="pi pi-chart-pie text-xl"></i>
      </div>
      <div class="flex flex-col">
        <h2 class="text-xl font-bold text-surface-900 dark:text-surface-0 m-0 tracking-tight">
          Panel de Métricas
        </h2>
        <span class="text-surface-500 dark:text-surface-400 text-sm mt-0.5">
          Resumen de actividad del sistema
        </span>
      </div>
    </div>
    
    <button 
      (click)="hideEstadisticasDialog()" 
      class="group w-10 h-10 flex items-center justify-center rounded-full bg-surface-50 dark:bg-surface-800 text-surface-400 hover:bg-surface-100 dark:hover:bg-surface-700 hover:text-surface-900 dark:hover:text-surface-0 transition-all duration-300">
      <i class="pi pi-times text-lg transition-transform duration-300 group-hover:rotate-90"></i>
    </button>
  </div>

  <div class="bg-surface-50 dark:bg-surface-900/50 p-8 h-full overflow-y-auto custom-scrollbar" *ngIf="users?.length; else noStats">
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      
      <div class="bg-white dark:bg-surface-900 p-6 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col justify-between h-36">
        <div class="flex justify-between items-start">
          <span class="text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider">Total</span>
          <div class="p-2 bg-surface-50 dark:bg-surface-800 rounded-lg text-surface-400">
             <i class="pi pi-users text-lg"></i>
          </div>
        </div>
        <div>
            <div class="text-4xl font-bold text-surface-900 dark:text-surface-0 tracking-tight">
              {{ getEstadisticas().total }}
            </div>
            <p class="text-xs text-surface-400 mt-1">Usuarios registrados</p>
        </div>
      </div>

      <div class="bg-white dark:bg-surface-900 p-6 rounded-2xl border-l-4 border-emerald-500 border-y border-r border-surface-200 dark:border-surface-700 shadow-sm flex flex-col justify-between h-36">
        <div class="flex justify-between items-start">
          <span class="text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider">Activos</span>
          <div class="p-2 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg text-emerald-600 dark:text-emerald-400">
             <i class="pi pi-check-circle text-lg"></i>
          </div>
        </div>
        <div>
            <div class="flex items-baseline gap-3">
                <span class="text-4xl font-bold text-surface-900 dark:text-surface-0">{{ getEstadisticas().activos }}</span>
                <span class="text-sm font-bold text-emerald-600 dark:text-emerald-400 bg-emerald-50 dark:bg-emerald-900/20 px-2 py-0.5 rounded-md">
                    {{ getEstadisticas().porcentajeActivos }}%
                </span>
            </div>
            <p class="text-xs text-surface-400 mt-1">Cuentas habilitadas</p>
        </div>
      </div>

      <div class="bg-white dark:bg-surface-900 p-6 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col justify-between h-36">
        <div class="flex justify-between items-start">
          <span class="text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider">Crecimiento</span>
          <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600 dark:text-blue-400">
             <i class="pi pi-chart-line text-lg"></i>
          </div>
        </div>
        <div>
            <div class="text-4xl font-bold text-surface-900 dark:text-surface-0 tracking-tight">
              {{ getEstadisticas().nuevosUsuarios }}
            </div>
            <p class="text-xs text-surface-400 mt-1">Nuevos (últimos 30 días)</p>
        </div>
      </div>

      <div class="bg-white dark:bg-surface-900 p-6 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col justify-between h-36 opacity-75 hover:opacity-100 transition-opacity">
        <div class="flex justify-between items-start">
            <span class="text-xs font-bold text-surface-400 dark:text-surface-500 uppercase tracking-wider">Inactivos</span>
            <div class="p-2 bg-surface-50 dark:bg-surface-800 rounded-lg text-surface-400">
               <i class="pi pi-ban text-lg"></i>
            </div>
        </div>
        <div>
            <div class="text-4xl font-bold text-surface-500 dark:text-surface-400 tracking-tight">
                {{ getEstadisticas().total - getEstadisticas().activos }}
            </div>
            <p class="text-xs text-surface-400 mt-1">Cuentas suspendidas</p>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      
      <div class="bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col h-full">
        <div class="px-6 py-5 border-b border-surface-100 dark:border-surface-800 flex items-center justify-between">
          <h3 class="text-base font-bold text-surface-900 dark:text-surface-0 m-0">
            Distribución por Roles
          </h3>
          <i class="pi pi-shield text-surface-400"></i>
        </div>
        
        <div class="p-6 space-y-4">
          <div *ngFor="let rolestat of getEstadisticas().roleStats" 
               class="flex items-center justify-between group">
            
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-xl flex items-center justify-center transition-colors"
                   [ngClass]="'bg-' + rolestat.color + '-50 dark:bg-' + rolestat.color + '-900/20 text-' + rolestat.color + '-600 dark:text-' + rolestat.color + '-400'">
                <i [class]="rolestat.icon + ' text-xl'"></i>
              </div>
              
              <div class="flex flex-col">
                <span class="font-bold text-surface-800 dark:text-surface-100 text-sm">{{ rolestat.label }}</span>
                <span class="text-xs text-surface-500 dark:text-surface-400">Permisos de sistema</span>
              </div>
            </div>

            <div class="flex items-center gap-3">
                <div class="w-24 h-1.5 bg-surface-100 dark:bg-surface-800 rounded-full overflow-hidden hidden sm:block">
                    <div class="h-full rounded-full" 
                         [ngClass]="'bg-' + rolestat.color + '-500'"
                         [style.width.%]="(rolestat.count / getEstadisticas().total) * 100"></div>
                </div>
                <span class="font-bold text-lg text-surface-900 dark:text-surface-0 w-8 text-right">
                  {{ rolestat.count }}
                </span>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white dark:bg-surface-900 rounded-2xl border border-surface-200 dark:border-surface-700 shadow-sm flex flex-col h-full">
        <div class="px-6 py-5 border-b border-surface-100 dark:border-surface-800 flex justify-between items-center">
          <h3 class="text-base font-bold text-surface-900 dark:text-surface-0 m-0">
            Últimos Registros
          </h3>
          <button class="text-xs font-bold text-primary-600 dark:text-primary-400 hover:text-primary-700 transition-colors uppercase tracking-wider">
            Ver Todos
          </button>
        </div>

        <div class="p-2 overflow-y-auto max-h-[350px] custom-scrollbar">
          <div *ngFor="let usuario of getEstadisticas().usuariosRecientes" 
               class="flex items-center gap-4 p-3 rounded-xl hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors border border-transparent hover:border-surface-100 dark:hover:border-surface-700 cursor-pointer">
            
            <div class="relative">
              <p-avatar [image]="getAvatarUrl(usuario)" [label]="getInitials(usuario)" shape="circle" size="large" styleClass="bg-surface-200 dark:bg-surface-700 text-surface-600 dark:text-surface-300 font-bold"></p-avatar>
              <div class="absolute -bottom-0.5 -right-0.5 w-3 h-3 rounded-full border-2 border-white dark:border-surface-900"
                   [ngClass]="usuario.activo ? 'bg-emerald-500' : 'bg-surface-400'"></div>
            </div>

            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center mb-0.5">
                <h4 class="text-sm font-bold text-surface-900 dark:text-surface-100 truncate pr-2">
                    {{ usuario.nombres }} {{ usuario.apellidos }}
                </h4>
                <span class="text-xs font-medium text-surface-400 dark:text-surface-500 bg-surface-100 dark:bg-surface-800 px-2 py-0.5 rounded-md">
                    {{ usuario.fechaCreacion | date:'dd/MM' }}
                </span>
              </div>
              <p class="text-xs text-surface-500 dark:text-surface-400 truncate m-0 font-medium">{{ '@' + usuario.username }}</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <ng-template #noStats>
    <div class="flex flex-col items-center justify-center h-full py-24 text-center">
      <div class="w-24 h-24 bg-surface-50 dark:bg-surface-800 rounded-full flex items-center justify-center mb-6">
        <i class="pi pi-chart-bar text-4xl text-surface-300 dark:text-surface-600"></i>
      </div>
      <h3 class="text-xl font-bold text-surface-900 dark:text-surface-0 mb-2">Sin datos suficientes</h3>
      <p class="text-surface-500 dark:text-surface-400 text-base max-w-sm mx-auto">
        El sistema necesita registrar usuarios para generar el análisis de actividad.
      </p>
    </div>
  </ng-template>

  <ng-template pTemplate="footer">
    <div class="flex justify-between items-center px-8 py-5 border-t border-surface-200 dark:border-surface-700 bg-white dark:bg-surface-900 sticky bottom-0 z-50">
      <div class="flex items-center gap-2 text-xs text-surface-400 dark:text-surface-500 font-medium">
        <i class="pi pi-clock"></i>
        <span>Sincronizado: Hace un momento</span>
      </div>
      <div class="flex gap-3">
        <button 
            pButton 
            label="Cerrar" 
            class="p-button-text text-surface-500 dark:text-surface-400 hover:text-surface-900 dark:hover:text-surface-200 font-bold px-6" 
            (click)="hideEstadisticasDialog()">
        </button>
        <button 
            pButton 
            label="Descargar CSV" 
            icon="pi pi-download" 
            class="bg-surface-900 dark:bg-surface-0 hover:bg-black dark:hover:bg-surface-200 text-white dark:text-surface-900 border-none px-6 py-2.5 rounded-xl font-bold text-sm shadow-lg hover:shadow-xl transition-all"
            (click)="exportarEstadisticas()">
        </button>
      </div>
    </div>
  </ng-template>
</p-dialog>